var studioChatMb={initSewise:!1,web24kPath:"",filePath:"",apiUrl:"",currStudioAuth:!1,visitorSpeak:!1,fromPlatform:null,serverTime:0,pushObj:{talkPush:[],talkPushInterval:null},msgType:{text:"text",img:"img",file:"file"},socket:null,socketUrl:"",userInfo:null,init:function(){this.serverTimeUp(),this.setVisitStore(),this.whTalk.initWH(),this.setSocket(),this.setEvent(),this.setVideoList(),studioMbPop.load(this.userInfo,this.fromPlatform,{onShow:function(){$("#tVideoDiv video").hide()},onHide:function(){$("#tVideoDiv video").show()}}),this.initRoom()},initRoom:function(){this.userInfo.nickname||this.refreshNickname(!1,"匿名_"+this.userInfo.userId.substring(8,12)),"visitor"==this.userInfo.clientGroup&&(this.currStudioAuth?studioMbPop.Login.forceLogin()?studioMbPop.popBox("login",{groupId:studioChatMb.userInfo.groupId,clientGroup:studioChatMb.userInfo.clientGroup,clientStoreId:studioChatMb.userInfo.clientStoreId,platform:studioChatMb.fromPlatform,closeable:!1,showTip:!0}):window.setTimeout(function(){"visitor"==studioChatMb.userInfo.clientGroup&&(studioMbPop.Login.forceLogin(!0),studioMbPop.popBox("login",{groupId:studioChatMb.userInfo.groupId,clientGroup:studioChatMb.userInfo.clientGroup,clientStoreId:studioChatMb.userInfo.clientStoreId,platform:studioChatMb.fromPlatform,closeable:!1,showTip:!0}))},18e4):studioMbPop.popBox("login",{groupId:studioChatMb.userInfo.groupId,clientGroup:studioChatMb.userInfo.clientGroup,clientStoreId:studioChatMb.userInfo.clientStoreId,platform:studioChatMb.fromPlatform,closeable:!1}))},refreshNickname:function(t,e){this.userInfo.isSetName=t,this.userInfo.nickname=e,$("#header_ui").text(e),studioMbPop.Person.refreshNickname(e)},serverTimeUp:function(){setInterval(function(){studioChatMb.serverTime+=1e3},1e3)},setVisitStore:function(){if(!store.enabled)return void console.log("Local storage is not supported by your browser.");var t="storeInfo_"+this.userInfo.groupType,e=store.get(t),i={};if(common.isBlank(e)){var s=common.randomNumber(6);i.clientStoreId=(new Date).getTime()+"_"+s,i.userId="visitor_"+s,i.nickname="游客_"+s,i.userType=-1,store.set(t,i),$(".collect-tip").fadeIn().delay(6e4).fadeOut()}else i=e;this.userInfo.clientStoreId=i.clientStoreId,this.userInfo.visitorId=i.userId,this.userInfo.loginId=i.loginId,this.userInfo.clientGroup&&"visitor"==this.userInfo.clientGroup?(this.userInfo.nickname=i.nickname,this.userInfo.userId=i.userId,this.visitorSpeak||($("#contentText").attr("contenteditable",!1).append('<span style="margin:15px 5px;">亲，<a id="contentText_login" href="javascript:void(0);" style="text-decoration: underline;color:#3F51B5;cursor: pointer;">登录</a>&nbsp;&nbsp;后可以发言哦~</span>'),$("#contentText_login").click(function(){studioMbPop.popBox("login",{groupId:studioChatMb.userInfo.groupId,clientStoreId:studioChatMb.userInfo.clientStoreId,platform:studioChatMb.fromPlatform})}))):(i.loginId=this.userInfo.userId,store.set(t,i)),this.isNeverLogin=!common.isValid(i.loginId)},setSocket:function(){studioMbPop.loadingBlock($("#talkBoxTab")),this.socket=common.getSocket(io,this.socketUrl,this.userInfo.groupType),this.socket.on("connect",function(){console.log("connected to server!"),studioChatMb.userInfo.socketId=studioChatMb.socket.id,studioChatMb.socket.emit("login",{userInfo:studioChatMb.userInfo,lastPublishTime:$("#dialog_list>li:last").attr("id"),fromPlatform:studioChatMb.fromPlatform,allowWhisper:studioChatMb.whTalk.enable},navigator.userAgent)}),this.socket.on("onlineUserList",function(t,e){if(studioChatMb.whTalk.enable){for(var i in t)3==t[i].userType&&studioChatMb.whTalk.setCSOnline(t[i].userId,!0);studioChatMb.whTalk.getCSList()}}),this.socket.on("disconnect",function(){console.log("disconnect")}),this.socket.on("error",function(t){console.error("e:"+t)}),this.socket.on("sendMsg",function(t){t.fromUser.toUser&&1==t.fromUser.toUser.talkStyle?studioChatMb.whTalk.receiveMsg(t,!1,!1):studioChatMb.setContent(t,!1,!1)}),this.socket.on("notice",function(t){switch(t.type){case"onlineNum":var e=t.data,i=e.onlineUserInfo;3==i.userType&&studioChatMb.whTalk.enable&&studioChatMb.whTalk.setCSOnline(i.userId,e.online);break;case"removeMsg":$("#"+t.data.replace(/,/g,",#")).remove(),studioChatMb.setTalkListScroll();break;case"leaveRoom":studioChatMb.leaveRoomTip(t.flag);break;case"approvalResult":var e=t.data,s=0;if(e.refuseMsg){var o=e.publishTimeArr;for(s in o)$("#"+o[s]+" .dialog em[class=ruleTipStyle]").html("已拒绝")}else{for(s in e)studioChatMb.formatUserToContent(e[s]);studioChatMb.setTalkListScroll()}break;case"pushInfo":var e=t.data;1==e.position?(studioChatMb.whTalk.pushObj={info:e.content,publishTime:e.publishTime,infoId:e.contentId},window.setTimeout(function(){studioChatMb.whTalk.pushMsg()},60*e.timeOut*1e3)):3==e.position&&studioChatMb.talkBoxPush.initTBP(e.infos);break;case"serverTime":studioChatMb.serverTime=t.data}}),this.socket.on("loadMsg",function(t){var e=t.msgData,i=t.isAdd;if(i||$("#content_ul").html(""),e&&$.isArray(e)){e.reverse();for(var s in e)studioChatMb.formatUserToContent(e[s]);studioMbPop.loadingBlock($("#talkBoxTab"),!0),studioChatMb.setTalkListScroll(),window.setTimeout(function(){studioChatMb.setTalkListScroll()},500)}}),this.socket.on("loadWhMsg",function(t){var e=t.data;if(e&&$.isArray(e))for(var i,s=0,o=e.length;o>s;s++)i=e[s],studioChatMb.formatUserToContent(i,!0,t.toUserId);studioMbPop.loadingBlock($("#whTalkBoxTab"),!0)})},setVideoList:function(){studioMbPop.loadingBlock($("#videosTab")),this.getArticleList("teach_video_base,teach_video_gw,teach_video_expert",this.userInfo.groupId,0,1,100,'{"sequence":"asc","createDate":"desc"}',null,function(t){var e=$("#videosTab .boxcont");if(e.html(""),t&&0==t.result){for(var i=t.data,s=[],o=null,a=0,r=i?i.length:0;r>a;a++)a%5==0&&s.push('<ul class="teach-ul">'),o=i[a].detailList[0],s.push('<li><a title="'+o.title+"\" href=\"javascript:void(0)\" onclick=\"_gaq.push(['_trackEvent', 'm_24k_studio', 'teachvideo_"+a+"', 'content_middle',1,true]);\" id=\""+i[a]._id+'" vUrl="'+i[a].mediaUrl+'"><i></i><span>'+o.title+"</span></a></li>"),(a%5==4||a==r-1)&&s.push("</ul>"),e.html(s.join(""));e.find("li a").click(function(){$(this).is(".on")||($("#videosTab .boxcont li a.on").removeClass("on"),$(this).addClass("on")),studioChatMb.video.play("studio","mp4",$(this).attr("vUrl"),$(this).text())})}studioChatMb.video.start(),studioMbPop.loadingBlock($("#videosTab"),!0)})},setEvent:function(){this.setEventCen(),this.video.init(),this.setEventChat(),this.setHeight(),this.browserState.initBrowserState()},setHeight:function(){var t=0;t+=$(".videopart").is(":hidden")?0:$(".videopart").height(),t+=$(".cen-ulist").is(":hidden")?0:$(".cen-ulist").height(),t+=$("#header").is(":hidden")?0:$("#header").height(),t=$(window).height()-t,$(".cen-pubox .boxcont:gt(1)").height(t),t-=$(".float-box").height(),$(".cen-pubox .boxcont:lt(2)").height(t)},setEventCen:function(){var t=new Swiper(".cen-qhbox",{loop:!1,autoplay:!1,onSlideChangeStart:function(t){$(".cen-ulist li").eq(t.activeIndex).trigger("click")}});$(".cen-ulist li").click(function(){$(".cen-ulist li.on").removeClass("on"),$(this).addClass("on");var e=$(this).attr("t");"talkBoxTab"==e?(studioChatMb.view.boardCtrl(1),studioChatMb.whTalk.whSwitch(!1)):"whTalkBoxTab"==e?(studioChatMb.whTalk.whSwitch(!0),studioChatMb.view.boardCtrl(1)):(studioChatMb.whTalk.whSwitch(!1),studioChatMb.view.boardCtrl(0),"TradeArticleTab"==e?(_gaq.push(["_trackEvent","m_24k_studio","suggest_tab","content_middle",1,!0]),studioChatMb.setTradeArticle()):"videosTab"==e&&_gaq.push(["_trackEvent","m_24k_studio","teachvideo_tab","content_middle",1,!0])),t.slideTo($(this).index(),300,!1)}),$("#header_hb").bind("click",function(){window.location.href="/studio/home"}),$("#header_ui").bind("click",function(){studioChatMb.userInfo&&studioChatMb.userInfo.isLogin?studioMbPop.popBox("person"):studioMbPop.popBox("login",{groupId:studioChatMb.userInfo.groupId,clientGroup:studioChatMb.userInfo.clientGroup,clientStoreId:studioChatMb.userInfo.clientStoreId,platform:studioChatMb.fromPlatform})})},setEventChat:function(){$("#msgFaceBtn").bind("click",function(){$(this).blur(),$("#facePanel").is(":hidden")?studioChatMb.view.boardCtrl(2):studioChatMb.view.boardCtrl(1),studioChatMb.face.init($("#facePanel"),$("#contentText"),studioChatMb.filePath+"/face/",!studioChatMb.visitorSpeak&&"visitor"==studioChatMb.userInfo.clientGroup)}),$("#talkBoxTab .view_select").click(function(){var t=$(this);t.is(".dw")?(t.removeClass("dw"),studioChatMb.view.viewSelect=!1):(t.addClass("dw"),studioChatMb.view.viewSelect=!0)}).find(".selectlist a").click(function(){if(!$(this).is(".on")){$("#talkBoxTab .view_select .selectlist a").removeClass("on"),$("#talkBoxTab .view_select .selected").text($(this).text()),$(this).addClass("on");var t=$(this).attr("t");_gaq.push(["_trackEvent","m_24k_studio","filter_"+t,"content_left",1,!0]),studioChatMb.showViewSelect(t)}}),$(document).bind("touchstart",function(t){if(studioChatMb.view.viewSelect){var e=$("#talkBoxTab .view_select");e.is(t.target)||0!=e.find(t.target).length||e.trigger("click")}if(studioChatMb.whTalk.viewSelect){var e=$("#whThtalkBoxTab .view_select");e.is(t.target)||0!=e.find(t.target).length||e.trigger("click")}2==studioChatMb.view.viewBoard&&0==$(".float-box").find(t.target).length&&$("#contentText").trigger("blur")}),$("#contentText").keydown(function(t){var e=$(this).html();return 13==t.keyCode?(common.isValid(e)&&($(this).html(e.replace(/<div>|<\/div>/g,"")),$("#sendBtn").click()),!1):void 0}).keyup(function(t){if(8==t.keyCode){var e=$(this).find(".txt_dia");if($.trim($(this).text())==e.text()&&0==$(this).find("img").length)return e.remove(),$(this).html(""),!0}}).focus(function(){}).blur(function(){}).bind("input",function(){var t=(studioChatMb.visitorSpeak||"visitor"!=studioChatMb.userInfo.clientGroup)&&($.trim($(this).text())!=$(this).find(".txt_dia").text()||$(this).find("img").size()>0);t?$("#sendBtn").addClass("pressed"):$("#sendBtn").removeClass("pressed")}),$("#sendBtn").click(function(){if($(this).blur(),studioChatMb.view.boardCtrl(1),studioChatMb.visitorSpeak||"visitor"!=studioChatMb.userInfo.clientGroup){if(studioChatMb.userInfo.isSetName===!1)return void studioMbPop.popBox("set",{studioChatObj:studioChatMb});var t=studioChatMb.getToUser(),e=studioChatMb.getSendMsg();if(e!==!1){var i={uiId:studioChatMb.getUiId(),fromUser:studioChatMb.userInfo,content:{msgType:studioChatMb.msgType.text,value:e}};i.fromUser.toUser=t,studioChatMb.whTalk.tabCheck?studioChatMb.whTalk.sendWhMsg(i):(studioChatMb.socket.emit("sendMsg",i),studioChatMb.setContent(i,!0,!1)),$("#contentText").html("").trigger("input")}}}),$("#top_msg").click(function(){var t=$(this).find("label");$(this).slideUp(),studioChatMb.setDialog(t.attr("fuserId"),t.attr("fnickname"),0,t.attr("fuType"),null)}),$("#top_msg i").click(function(){return $("#top_msg").slideUp(),!1})},view:{viewSelect:!1,viewBoard:1,boardCtrl:function(t){if(this.viewBoard!=t){this.viewBoard=t;var e={header:$("#header"),backToLive:$("#backToLive"),facePanel:$("#facePanel"),floatBox:$(".float-box")};switch(t){case 0:e.header.show(),e.backToLive.data("showBoard",!0).trigger("show"),e.floatBox.hide();break;case 1:e.header.show(),e.backToLive.data("showBoard",!0).trigger("show"),e.floatBox.show(),e.facePanel.hide();break;case 2:e.header.hide(),e.backToLive.data("showBoard",!1).trigger("show"),e.floatBox.show(),e.facePanel.show();break;case 3:e.header.hide(),e.backToLive.data("showBoard",!1).trigger("show"),e.floatBox.show(),e.facePanel.hide()}}}},video:{initPlayer:!1,playerType:"",videoType:"",studioType:"",liveUrl:"http://ct.phgsa.cn:1935/live/01/playlist.m3u8",$panel:null,backToLivePos:{x:0,y:0},init:function(){navigator.userAgent.match(/Android/i)||-1!=navigator.userAgent.indexOf("iPhone")||-1!=navigator.userAgent.indexOf("iPod")||-1!=navigator.userAgent.indexOf("iPad")?this.playerType="video":this.playerType="sewise";var t=$(".videopart input:first");t.attr("yc"),t.attr("mc");this.$panel=$("#tVideoDiv"),this.$panel.css({"z-index":"inherit"}).height(.55*this.$panel.width()),this.setEvent()},start:function(t){var e=common.getSyllabusPlan(studioChatMb.syllabusData,studioChatMb.serverTime);!e||e.isNext||0!=e.courseType&&common.isBlank(e.studioLink)||2==e.courseType||0==e.courseType?t?studioMbPop.showMessage("目前还没有视频直播，详情请留意直播间的课程安排！"):e&&!e.isNext&&0==e.courseType?($(".videopart").hide(),studioChatMb.setHeight()):this.playMp4Vd():this.play("yy","",e.studioLink,"")},playMp4Vd:function(){if($("#studioTeachId a[class=on]").length<=0){var t=$("#videosTab li a"),e=$(t.get(common.randomIndex(t.length)));e.click()}},play:function(t,e,i,s){this.studioType=t;var o=$("#backToLive");if($(".videopart").is(":hidden")&&($(".videopart").show(),studioChatMb.setHeight()),"studio"==t?o.data("showVideo",!0).trigger("show"):($("#videosTab li a.on").removeClass("on"),o.data("showVideo",!1).trigger("show")),"video"==this.playerType)if(this.initPlayer){var a=this.$panel.find("video");a[0].pause(),a.attr("src",i),a[0].play()}else{var r=$("body").attr("fp"),n="webui"!=r&&"app"!=r;this.$panel.append('<video src="'+i+'" controls="true" autoplay="'+n+'" style="width: 100%; height: 100%; background-color: rgb(0, 0, 0);"></video>'),n||this.$panel.find("video")[0].pause(),this.initPlayer=!0,this.setEventAd()}else if(this.initPlayer)SewisePlayer.toPlay(i,s,0,!0),this.videoType=e;else{var u=[];u.push("/js/lib/sewise.player.min.js?server=vod"),u.push("type="+e),u.push("videourl="+i),u.push("autostart=true"),u.push("logo="),u.push("title="+s),u.push("buffer=5");var l=u.join("&"),d=document.createElement("script");d.type="text/javascript",d.src=l,this.initPlayer=!0,this.videoType=e,this.$panel.get(0).appendChild(d),this.setEventAd()}},setEvent:function(){$(".ctrlblock div.replay a").bind("click",function(){var t=$("#videosTab li a.on");t.trigger("click")}),$(".ctrlblock div.nextbtn a").bind("click",function(){for(var t=$("#videosTab li a"),e=0,i=t.size();i>e;e++)if(t.eq(e).is(".on")){t.eq(i-1>e?e+1:0).trigger("click");break}}),$("#backToLive").css({left:function(){return $(window).width()-$(this).width()-10},top:function(){return $(window).height()-$("#header").height()-70}}).data("showBoard",!0).data("showVideo",!0).bind("show",function(){var t=$(this);t.data("showBoard")&&t.data("showVideo")?t.show():t.hide()});var t=function(t,e){return t=Math.max(t,10),Math.min(t,e-10)};util.toucher($("#backToLive")[0]).on("singleTap",function(){studioChatMb.socket.emit("serverTime"),window.setTimeout(function(){studioChatMb.video.start(!0)},1e3)}).on("swipeStart",function(){studioChatMb.video.backToLivePos.x=parseInt(this.style.left)||0,studioChatMb.video.backToLivePos.y=parseInt(this.style.top)||0,this.style.transition="none",this.style.background=" rgba(181,144,48,0.8)"}).on("swipe",function(e){return this.style.left=t(studioChatMb.video.backToLivePos.x+e.moveX,$(window).width()-this.clientWidth)+"px",this.style.top=t(studioChatMb.video.backToLivePos.y+e.moveY,$(window).height()-this.clientHeight)+"px",!1}).on("swipeEnd",function(){return this.style.background=" rgba(181,144,48,.6)",!1})},setEventAd:function(){if("sewise"==this.playerType){var t=function(){return window.SewisePlayer?(SewisePlayer.onPause(function(){"studio"==studioChatMb.video.studioType&&window.setTimeout(function(){SewisePlayer.duration()<=SewisePlayer.playTime()&&$(".ctrlblock").show()},1e3)}),void SewisePlayer.onStart(function(){$(".ctrlblock").hide()})):void window.setTimeout(t,500)};t()}else if("video"==this.playerType){var e=this.$panel.find("video");e.bind("ended",function(){"studio"==studioChatMb.video.studioType&&$(".ctrlblock").show()}).bind("loadstart",function(){$(".ctrlblock").hide()})}}},face:{initFace:!1,init:function(t,e,i,s){this.initFace||(this.build(t,i),new Swiper(t,{pagination:".swiper-pagination",paginationClickable:!0}),t.find("img").bind("click",{panel:t,assign:e,disabled:s},function(t){t.data.disabled||t.data.assign.append($(this).clone()).trigger("input")}),this.initFace=!0)},build:function(t,e){for(var i=[],s=7,o=1;75>=o;o+=21){i.push('<div class="swiper-slide"><table border="0" cellspacing="0" cellpadding="0">');for(var a=o,r=Math.min(o+20,75);r>=a;a++)a%s==1&&i.push("<tr>"),i.push('<td><img src="'+e+a+'.gif"/></td>'),(a%s==0||a==r)&&i.push("</tr>");i.push("</table></div>")}t.find("div.face").html(i.join(""))}},setTalkListScroll:function(){$("#talkPanel").scrollTop($("#talkPanel")[0].scrollHeight)},getUiId:function(){var t=new Date;return t.getTime()+"_ms"},getArticleList:function(t,e,i,s,o,a,r,n){try{var u={code:t,platform:e,hasContent:i,pageNo:s,pageSize:o,orderByStr:a};r&&(u.authorId=common.trim(r)),$.getJSON("/studio/getArticleList",u,function(t){n(t)})}catch(l){console.error("getArticleList->"+l),n(null)}},setTradeArticle:function(){studioMbPop.loadingBlock($("#TradeArticleTab")),studioChatMb.getArticleList("trade_strategy_article",studioChatMb.userInfo.groupId,1,1,1,'{"createDate":"desc"}',null,function(t){var e=$("#TradeArticleTab ul:first"),i=[];if(t&&0==t.result){var s=t.data;if(s&&s.length>0)for(var o=null,a=null,r=0,n=s.length;n>r;r++)o=s[r].detailList[0],a=o.authorInfo||{},i.push("<li>"),i.push('<div class="himg"><img src="'+(a.avatar||"")+'"></div>'),i.push('<div class="detail">'),i.push("<h3>"+o.title+"</h3>"),i.push('<div class="subinfo">'),i.push("<span>"+(a.name||"")+"</span>"),i.push("<span>"+(s[r].publishStartDate?common.longMsTimeToDateTime(s[r].publishStartDate):"")+"</span>"),i.push("</div>"),i.push("<p>"+o.content+"</p>"),i.push("</div>")}e.html(i.join("")),$("#TradeArticleTab .detail p span").attr("style",""),studioMbPop.loadingBlock($("#TradeArticleTab"),!0)})},showViewSelect:function(t){var e=$("#dialog_list");"analyst"==t?(e.children("[utype!=2]").hide(),e.children("[utype=2]").show()):"me"==t?(e.children("[isme='false']").hide(),e.children("[isme='true']").show()):e.children().show(),studioChatMb.setTalkListScroll()},getSendMsg:function(t){if(t=t||$("#contentText"),t.text().length+t.find("img").size()>140)return studioMbPop.showMessage("消息内容超过最大长度限制（140字以内）！"),!1;var e=t.html();return e=common.clearMsgHtml(e),common.isBlank(e)?(t.html(""),!1):(t.find(".txt_dia").length>0&&(t.find(".txt_dia").remove(),e=t.html(),e=e.replace(/^(&nbsp;){1,2}/,"")),e)},getToUser:function(){var t=$("#contentText .txt_dia");return t.length>0?{userId:t.attr("uid"),nickname:t.find("label").text(),talkStyle:0,userType:t.attr("utype"),avatar:t.attr("avatar")}:null},formatPublishTime:function(t){return common.isBlank(t)?"":common.getHHMM(Number(t.replace(/_.+/g,"")))},setDialog:function(t,e,i,s,o){(studioChatMb.visitorSpeak||"visitor"!=studioChatMb.userInfo.clientGroup)&&($("#contentText .txt_dia").remove(),$("#contentText").html($("#contentText").html().replace(/^((&nbsp;)+)/g,"")),$("#contentText").prepend('&nbsp;<span class="txt_dia" contenteditable="false" uid="'+t+'" utype="'+s+'" avatar="'+o+'">@<label>'+e+"</label></span>&nbsp;").focusEnd())},setContent:function(t,e,i){var s=t.fromUser;if(e&&(s.publishTime=t.uiId),t.isVisitor)return void $("#"+t.uiId).remove();if(i&&$("#"+s.publishTime).length>0)return $("#"+s.publishTime+" .dialog em[class=ruleTipStyle]").remove(),void $("#"+s.publishTime+" input").remove();if(t.rule)return void(t.value&&t.value.needApproval?$("#"+t.uiId).attr("id",s.publishTime):$("#"+t.uiId+" .dialog").append('<em class="ruleTipStyle">'+t.value.tip+"</em>"));if(!e&&studioChatMb.userInfo.userId==s.userId&&t.serverSuccess)return $("#"+t.uiId+" .uname span").html(studioChatMb.formatPublishTime(s.publishTime)),void $("#"+t.uiId).attr("id",s.publishTime);var o=studioChatMb.formatContentHtml(t,e,i,!1),a=$("#dialog_list"),r=$("#talkPanel"),n=r.scrollTop()+r.height()+30>=r.get(0).scrollHeight;a.append(o),n&&!i&&studioChatMb.setTalkListScroll(),this.formatMsgToLink(s.publishTime);var u=$("#talkBoxTab .view_select .selectlist a[class=on]").attr("t");"all"!=u&&studioChatMb.showViewSelect(u),$("#"+s.publishTime+" .c-menu a").click(function(){var t=$(this).parents(".c-menu");studioChatMb.setDialog(t.attr("uid"),t.attr("nk"),$(this).attr("t"),t.attr("utype"))}),$("#"+s.publishTime+" .headimg").click(function(){$("#"+s.publishTime+" .c-menu a[t=0]").trigger("click")}),$("#"+s.publishTime+" .txt_dia").click(function(){studioChatMb.setDialog($(this).attr("uid"),$(this).find("label").text(),0,$(this).attr("utype"))}),$("#"+s.publishTime+" .uname").click(function(){$("#"+s.publishTime+" .c-menu a[t=0]").trigger("click")})},formatContentHtml:function(t,e,i,s){var o,a="clearfix ",r="",n="false",u="",l=t.fromUser,d=t.content,h=l.nickname,c=l.toUser,p=[];o=d.msgType==studioChatMb.msgType.img?d.needMax?'<p><a href="/studio/getBigImg?publishTime='+l.publishTime+"&userId="+l.userId+'" class="swipebox" ><img src="'+d.value+'" alt="图片"/></a></p>':'<p><a href="'+d.value+'" class="swipebox" ><img src="'+d.value+'" alt="图片" /></a></p>':'<span contt="a">'+d.value+"</span>",c&&common.isValid(c.userId)?(s?p.push(o):common.isValid(c.question)?(p.push('<p class="question"><em>'),p.push('<strong class="asker" uid="'+c.userId+'" utype="'+c.userType+'">'+c.nickname+"</strong>"),p.push("提问：</em>"),p.push('<span contt="q">'+c.question+"</span>"),p.push("</p>"),p.push('<p class="reply"><span>回复：</span>'),p.push(o),p.push("</p>")):(p.push('<span class="txt_dia" uid="'+c.userId+'" utype="'+c.userType+'">'),p.push("@<label>"+c.nickname+"</label>"),p.push("</span>"),p.push(o)),studioChatMb.userInfo.userId==c.userId&&(n="true")):p.push(o),studioChatMb.userInfo.userId==l.userId?(a+="me-li",h="我",n="true",s&&c&&(u=" csid="+c.userId)):(3==l.userType?(h+="&nbsp;（助理）",a+="admin"):2==l.userType?a+="analyst":1==l.userType&&(a+="admin"),s&&(u=" csid="+l.userId),r=s?"":studioChatMb.getDialogHtml(l.userId,h,l.userType),!i&&c&&(studioChatMb.userInfo.userId!=c.userId||s||($("#top_msg label").html(l.nickname+":@"+c.nickname).attr("tId",c.userId).attr("fuType",l.userType).attr("fnickname",l.nickname).attr("fuserId",l.userId),$("#top_msg span").html(d.value),$("#top_msg").slideDown())));var b=[];return b.push('<li class="'+a+'" id="'+l.publishTime+'" isme="'+n+'" utype="'+l.userType+'" mType="'+d.msgType+'" t="header"'+u+">"),b.push('<div class="headimg" uid="'+l.userId+'">'),b.push(studioChatMb.getUserAImgCls(l.userId,l.clientGroup,l.userType,l.avatar)),b.push("</div>"),b.push('<div class="detail">'),b.push('<span class="uname">'),studioChatMb.userInfo.userId==l.userId?(b.push("<span>"+studioChatMb.formatPublishTime(l.publishTime)+"</span>"),b.push("<strong>"+h+"</strong>")):(b.push("<strong>"+h+"</strong>"),b.push("<span>"+studioChatMb.formatPublishTime(l.publishTime)+"</span>")),b.push("</span>"),b.push('<div class="dialog">'+p.join("")+"</div>"),b.push("</div>"),b.push(r),b.push("</li>"),b.join("")},formatMsgToLink:function(t){$("#"+t+' span[contt]:contains("http:"),#'+t+' span[contt]:contains("https:")').each(function(t,e){var i,s=$(e).html(),o=s.split(/<img src="\S+">/g);for(var a in o)if(i=o[a],!common.isBlank(i)){var r=i.replace(/(http:\/\/|https:\/\/)((\w|=|\?|\.|\/|\\&|-)+)(:\d+)?(\/|\S)+/g,function(t){return'<a href="'+t+'" target="_blank" style="color:#3181c6;">'+t+"</a>"});e.innerHTML=e.innerHTML.replace(i,r)}})},getUserAImgCls:function(t,e,i,s){var o="";if(common.isValid(s))return'<img src="'+s+'">';if("vip"==e)o="user_v";else{if("active"==e){var a=0;return t&&t.length>0&&(a+=t.charCodeAt(0)+t.charCodeAt(t.length-1)),a=(a+15)%39,'<img src="'+studioChatMb.filePath+"/upload/pic/header/chat/visitor/"+a+'.png">'}if("notActive"==e)o="user_r";else if("simulate"==e)o="user_d";else if("register"==e)o="user_m";else{if("visitor"==e||-1==i){t=t||"";var a=parseInt(t.substring(t.length-2),10);return isNaN(a)&&(a=100),a=(a+17)%39,'<img src="'+studioChatMb.filePath+"/upload/pic/header/chat/visitor/"+a+'.png">'}o="user_c"}}return'<img src="images/studio_mb/'+o+'.png">'},leaveRoomTip:function(t){if("roomClose"==t)studioMbPop.showMessage("注意：房间已停用，正自动登出..."),"visitor"==studioChatMb.userInfo.clientGroup?window.setTimeout(function(){studioMbPop.reload()},2e3):window.setTimeout(function(){LoginAuto.setAutoLogin(!1),window.location.href="/studio/logout?platform="+studioChatMb.fromPlatform},2e3);else if("otherLogin"==t){if("visitor"==studioChatMb.userInfo.clientGroup)return;studioChatMb.socket.disconnect(),studioMbPop.popBox("msg",{msg:"注意：您的账号已在其他地方登陆，被踢出！",type:"logout"})}},getDialogHtml:function(t,e,i){if(studioChatMb.userInfo.userId!=t){var s=!1,o=$("#studioListId a[class~=ing]"),a='<div class="c-menu" style="display:none;" nk="'+e+'" uid="'+t+'" utype="'+i+'">';return a+="<ul>",(studioChatMb.visitorSpeak||-1==studioChatMb.userInfo.userId.indexOf("visitor_")&&t&&-1==t.indexOf("visitor_"))&&(a+='<li><a href="javascript:void(0)" t="0"><i></i>@TA</a></li>',s=!0),"true"==o.attr("aw")&&common.containSplitStr(o.attr("awr"),i)&&(a+='<li><a href="javascript:void(0)" t="1"><i></i>私信</a></li>',s=!0),a+="</ul>",s?a+"</div>":""}return""},formatUserToContent:function(t,e,i){var s={userId:t.userId,nickname:t.nickname,avatar:t.avatar,userType:t.userType,groupId:t.groupId,clientGroup:t.clientGroup,publishTime:t.publishTime,toUser:t.toUser,position:t.position};e?(s.toWhUserId=i,studioChatMb.whTalk.receiveMsg({fromUser:s,content:t.content},!1,!0)):studioChatMb.setContent({fromUser:s,content:t.content},!1,!0)},talkBoxPush:{initTBP:function(t){this.clear(),studioChatMb.pushObj.talkPush=t,this.start()},clear:function(){studioChatMb.pushObj.talkPushInterval&&(window.clearInterval(studioChatMb.pushObj.talkPushInterval),studioChatMb.pushObj.talkPushInterval=null);for(var t=studioChatMb.pushObj.talkPush,e=null,i=0,s=t.length;s>i;i++)e=t[i],e.timeoutId&&window.clearTimeout(e.timeoutId),e.intervalId&&window.clearInterval(e.intervalId)},start:function(){var t=studioChatMb.pushObj.talkPush;t&&t.length>0&&window.setInterval(function(){studioChatMb.talkBoxPush.check()},1e4)},check:function(){for(var t=studioChatMb.pushObj.talkPush,e=null,i=0,s=t.length;s>i;i++)e=t[i],e.startFlag||common.dateTimeWeekCheck(e.pushDate,!1,studioChatMb.serverTime)&&(e.startFlag=!0,window.setTimeout(studioChatMb.talkBoxPush.delayStartTask(e),60*(e.onlineMin||0)*1e3))},delayStartTask:function(t){return function(){studioChatMb.talkBoxPush.showMsg(t),t.intervalMin&&t.intervalMin>0&&(t.intervalId=window.setInterval(studioChatMb.talkBoxPush.startTask(t),60*t.intervalMin*1e3))}},startTask:function(t){return function(){common.dateTimeWeekCheck(t.pushDate,!1,studioChatMb.serverTime)?studioChatMb.talkBoxPush.showMsg(t):(window.clearInterval(t.intervalId),t.startFlag=!1)}},showMsg:function(t){var e=[];e.push('<li class="clearfix push">'),e.push(t.content),e.push("</div>");var i=$("#talkPanel"),s=i.scrollTop()+i.height()+30>=i.get(0).scrollHeight;$("#dialog_list").append(e.join("")),s&&studioChatMb.setTalkListScroll()}},browserState:{hiddenProperty:"hidden",visibilityStateProperty:"visibilityState",visibilityEvent:"visibilitychange",getBrowserPrefix:function(){if("hidden"in document)return null;for(var t=["moz","ms","o","webkit"],e=0;e<t.length;e++){var i=t[e]+"Hidden";if(i in document)return t[e]}return null},initBrowserState:function(){var t=this.getBrowserPrefix();t?(this.hiddenProperty=t+"Hidden",this.visibilityStateProperty=t+"VisibilityState",this.visibilityEvent=t+"visibilitychange"):(this.hiddenProperty="hidden",this.visibilityStateProperty="visibilityState",this.visibilityEvent="visibilitychange"),this.setBrowserStateEvent()},setBrowserStateEvent:function(){document.addEventListener(this.visibilityEvent,function(){"visible"===document[studioChatMb.browserState.visibilityStateProperty]&&studioChatMb.socket.emit("serverTime")})}},whTalk:{enable:!1,status:0,tabCheck:!1,CSMap:{},currCS:null,msgCnt:0,pushObj:null,askMsgObj:null,viewSelect:!1,initWH:function(){this.enable="true"==$("#currStudioInfo").attr("aw"),this.refreshTips(),$("#whTalkBoxTab .view_select").click(function(){var t=$(this);t.is(".dw")?(t.removeClass("dw"),studioChatMb.whTalk.viewSelect=!1):(t.addClass("dw"),studioChatMb.whTalk.viewSelect=!0)}).find(".selectlist a").live("click",function(){if(!$(this).is(".on")){var t=$(this).attr("uid");studioChatMb.whTalk.setCurrCS({userId:t})}})},whSwitch:function(t){t?(this.tabCheck=!0,this.msgCnt=0,this.refreshTips(),this.setWHTalkListScroll(),this.pushMsg()):this.tabCheck=!1},loadMsg:function(t){if(this.CSMap.hasOwnProperty(t)&&!this.CSMap[t].load){var e=this.CSMap[t];e.load=!0,studioMbPop.loadingBlock($("#whTalkBoxTab")),studioChatMb.socket.emit("getWhMsg",{clientStoreId:studioChatMb.userInfo.clientStoreId,userType:studioChatMb.userInfo.userType,groupId:studioChatMb.userInfo.groupId,groupType:studioChatMb.userInfo.groupType,userId:studioChatMb.userInfo.userId,toUser:{userId:e.userNo,userType:e.userType}})}},setCurrCS:function(t){var e=null;if(t&&t.userId)this.CSMap.hasOwnProperty(t.userId)?e=this.CSMap[t.userId]:(e={userNo:t.userId,userName:t.userName||t.nickname,online:!0,load:!1,userType:t.userType,avatar:t.avatar},this.CSMap[t.userId]=e);else{var i=null;for(var s in this.CSMap)i=this.CSMap[s],(!e||3!=e.userType&&3==i.userType||e.userType==i.userType&&!e.online&&i.online)&&(e=i)}if(!e)return null;if(e.load||this.loadMsg(e.userNo),e.userNo){this.currCS=e;var o=$("#whTalkBoxTab .view_select"),a=o.find("a[uid="+this.currCS.userNo+"]");return o.find(".selectlist a").removeClass("on"),0==a.size()?(o.find(".selectlist").append('<a href="javascript:void(0)" class="on" uid="'+this.currCS.userNo+'">'+this.currCS.userName+"</a>"),o.find(".selected").text(this.currCS.userName)):(a.addClass("on"),o.find(".selected").text(a.text())),o.find(".selectlist a").size()<=1?o.hide():(o.show(),$("#whDialog_list").children().hide(),$("#whDialog_list").children("[csid="+this.currCS.userNo+"]").show(),this.setWHTalkListScroll()),e}return null},getCSList:function(){try{$.getJSON("/studio/getCS",{groupId:studioChatMb.userInfo.groupId},function(t){if(t&&t.length>0)for(var e,i,s=0,o=t.length;o>s;s++)e=t[s],studioChatMb.whTalk.CSMap.hasOwnProperty(e.userNo)?i=studioChatMb.whTalk.CSMap[e.userNo]:(i={online:!1},studioChatMb.whTalk.CSMap[e.userNo]=i),i.userNo=e.userNo,i.userName=e.userName,i.userType=3,i.avatar=common.isValid(e.avatar)?e.avatar:"/images/studio/cm.png",i.load=!1})}catch(t){console.error("getCSList->"+t)}},setCSOnline:function(t,e){var i=null;this.CSMap.hasOwnProperty(t)?i=this.CSMap[t]:(i={},this.CSMap[t]=i),i.online=e},refreshTips:function(){studioChatMb.whTalk.msgCnt>0?$(".wh_tips").text(studioChatMb.whTalk.msgCnt).show():$(".wh_tips").hide()},setWHTalkListScroll:function(){$("#whTalkPanel").scrollTop($("#whTalkPanel")[0].scrollHeight)},receiveMsg:function(t,e,i){var s=t.fromUser;if(e&&(s.publishTime=t.uiId),t.isVisitor)return void $("#"+t.uiId).remove();if(i&&$("#"+s.publishTime).length>0)return $("#"+s.publishTime+" .dialog em.ruleTipStyle").remove(),void $("#"+s.publishTime+" input").remove();if(t.rule)return void(t.value&&t.value.needApproval?$("#"+t.uiId).attr("id",s.publishTime):$("#"+t.uiId+" .dialog").append('<em class="ruleTipStyle">'+t.value.tip+"</em>"));if(!e&&studioChatMb.userInfo.userId==s.userId&&t.serverSuccess)return $("#"+t.uiId+" .uname span").html(studioChatMb.formatPublishTime(s.publishTime)),void $("#"+t.uiId).attr("id",s.publishTime);var o=studioChatMb.formatContentHtml(t,e,i,!0),a=$("#whTalkPanel"),r=a.scrollTop()+a.height()+30>=a.get(0).scrollHeight;if(i?$("#whDialog_list").prepend(o):$("#whDialog_list").append(o),r&&this.tabCheck&&studioChatMb.whTalk.setWHTalkListScroll(),studioChatMb.formatMsgToLink(s.publishTime),t.content&&t.content.msgType==studioChatMb.msgType.img&&$("#"+s.publishTime+" .swipebox").swipebox(),studioChatMb.userInfo.userId!=s.userId&&$("#"+s.publishTime+" .uname,#"+s.publishTime+" .headimg").click(function(){var t=$(this).parents("li:first"),e={userId:t.find(".headimg").attr("uid"),nickname:t.find(".uname strong").text(),userType:t.attr("utype"),avatar:t.find(".headimg img").attr("src")};studioChatMb.whTalk.setCurrCS(e)}),this.tabCheck||i||(studioChatMb.whTalk.msgCnt++,this.refreshTips()),i||studioChatMb.userInfo.userId==s.userId||this.setCurrCS(s),i||(this.askMsgObj=null),
i&&s.toUser&&common.isValid(s.toUser.question)){var n=this.setCurrCS({userId:s.toUser.userId});this.receiveMsg({content:{maxValue:"",msgType:"text",status:1,value:s.toUser.question},fromUser:{nickname:n.userName,userId:n.userNo,userType:n.userType,avatar:n.avatar,publishTime:s.toUser.publishTime}},!1,!0)}},pushMsg:function(){this.currCS||this.setCurrCS(),this.pushObj&&this.currCS&&(this.receiveMsg({content:{maxValue:"",msgType:"text",status:1,value:this.pushObj.info},fromUser:{nickname:this.currCS.userName,userId:this.currCS.userNo,userType:this.currCS.userType,avatar:this.currCS.avatar,publishTime:this.pushObj.publishTime}},!1,!1),this.askMsgObj=this.pushObj,this.pushObj=null)},sendWhMsg:function(t){return this.currCS||this.setCurrCS(),this.currCS?(t.fromUser.toUser={userId:this.currCS.userNo,nickname:this.currCS.nickname,talkStyle:1,userType:this.currCS.userType},this.askMsgObj&&(t.fromUser.toUser.question=this.askMsgObj.info,t.fromUser.toUser.questionId=this.askMsgObj.infoId,t.fromUser.toUser.publishTime=this.askMsgObj.publishTime),studioChatMb.whTalk.receiveMsg(t,!0,!1),void studioChatMb.socket.emit("sendMsg",t)):void studioMbPop.showMessage("老师助理不在线，暂不可私聊！")}}};