var StudioChatMini={apiUrl:"",blwsPlayer:null,studioInfo:null,studioDate:"",serverTime:0,pushObj:{whPush:{},talkPush:[],talkPushInterval:null},msgType:{text:"text",img:"img",file:"file"},socket:null,socketUrl:"",userInfo:null,initStudio:!1,video:{type:"mp4",list:[],listMp4:[],index:-1},courses:null,init:function(){this.serverTimeUp(),this.setVisitStore(),this.setSocket(),this.setVideoList(),this.setEvent()},serverTimeUp:function(){StudioChatMini.clientVideoTask(),setInterval(function(){StudioChatMini.serverTime+=1e3,StudioChatMini.clientVideoTask()},1e3)},setVisitStore:function(){if(!store.enabled)return void console.log("Local storage is not supported by your browser.");var i="storeInfo_"+this.userInfo.groupType,t=store.get(i),e={};if(common.isBlank(t)){var o=common.randomNumber(6);e.clientStoreId=(new Date).getTime()+"_"+o,e.userId="visitor_"+o,e.nickname="游客_"+o,e.userType=-1,store.set(i,e)}else e=t;this.userInfo.clientStoreId=e.clientStoreId,this.userInfo.visitorId=e.userId,this.userInfo.loginId=e.loginId,this.userInfo.clientGroup&&"visitor"==this.userInfo.clientGroup?(this.userInfo.nickname=e.nickname,this.userInfo.userId=e.userId):(e.loginId=this.userInfo.userId,store.set(i,e))},clientVideoTask:function(){$("#studioVideoDiv embed").size()<1&&common.dateTimeWeekCheck(this.studioDate,!0,StudioChatMini.serverTime)&&$("#vbackbtn_live").show()},playVideo:function(i){StudioChatMini.video.type=i,"mp4"==i?(StudioChatMini.video.index=common.randomIndex(StudioChatMini.video.listMp4.length),StudioChatMini.setVideo(!1,StudioChatMini.video.listMp4[StudioChatMini.video.index])):"video"==i?(StudioChatMini.video.index=common.randomIndex(StudioChatMini.video.list.length),StudioChatMini.setVideo(!1,StudioChatMini.video.list[StudioChatMini.video.index])):common.dateTimeWeekCheck(this.studioDate,!0,StudioChatMini.serverTime)?this.setVideo(!0):StudioChatMini.playVideo("mp4")},getEmbedDom:function(i){return'<embed src="'+i+'" autostart="true" wmode="Opaque" quality="high" width="100%" height="100%" align="middle" allowScriptAccess="never" allowFullScreen="true" mode="transparent" type="application/x-shockwave-flash"></embed>'},setStudioVideoDiv:function(i,t){if(window.SewisePlayer&&(SewisePlayer.doStop(),$("#tvDivId").hide(),$("#studioTeachId a").removeClass("on")),$("#tVideoDiv iframe").remove(),-1!=i.indexOf("rtmp")){var e='<div style="position: relative; width: 100%; height: 100%; left: 0px; top: 0px;"><object type="application/x-shockwave-flash" id="sewise_player" name="sewise_player" data="/js/lib/flash/SewisePlayer.swf" width="100%" height="100%"><param name="allowfullscreen" value="true"><param name="wmode" value="transparent"><param name="allowscriptaccess" value="always"><param name="flashvars" value="autoStart=true&amp;programId=&amp;shiftTime=&amp;lang=zh_CN&amp;type=rtmp&amp;serverApi=ServerApi.execute&amp;skin=/js/lib/flash/skins/liveOrange.swf&amp;title=&amp;draggable=true&amp;published=0&amp;streamUrl='+i+'&amp;duration=3600&amp;poster=&amp;flagDatas=&amp;videosJsonUrl=&amp;adsJsonData=&amp;statistics=&amp;customDatas=&amp;playerName=Sewise Player&amp;clarityButton=enable&amp;timeDisplay=disable&amp;controlBarDisplay=enable&amp;topBarDisplay=disable&amp;customStrings=&amp;volume=0.6&amp;key=&amp;trackCallback="></object></div>';$("#studioVideoDiv").html(e)}else{if($("#stVideoDiv:visible").length>0&&$("#studioVideoDiv embed").attr("src")==i)return;$("#stVideoDiv .img-loading").fadeIn(0).delay(2e3).fadeOut(200),$("#studioVideoDiv embed").remove(),$(StudioChatMini.getEmbedDom(i)).appendTo("#studioVideoDiv")}$("#stVideoDiv").show(),$("#stVideoDiv .vtitle span").text(t),StudioChatMini.initStudio=!0},setVideo:function(i,t){try{if(i){if($("#vbackbtn_live").hide(),!this.studioInfo.url){var e=this.studioInfo.yyChannel,o=this.studioInfo.minChannel;"live"==e?this.studioInfo.url="rtmp://ct.phgsa.cn/live/"+common.trim(o):this.studioInfo.url="http://yy.com/s"+(common.isValid(e)?"/"+e:"")+(common.isValid(o)?"/"+o:"")+"/yyscene.swf"}StudioChatMini.getLiveTitle(function(i){StudioChatMini.setStudioVideoDiv(StudioChatMini.studioInfo.url,i)})}else{$("#tvDivId").show(),$("#stVideoDiv").hide(),$("#studioVideoDiv embed").remove(),$("#tVideoDiv .img-loading").fadeIn(0).delay(2e3).fadeOut(200);var a=t.url,s=t.title;if($("#tvDivId .vtitle span").text(s),-1!=a.indexOf(".html")){window.SewisePlayer&&(SewisePlayer.doStop(),$("#tVideoDiv div").hide());var n=$("#tVideoDiv iframe"),r=!0;n.size()>0&&(n.attr("src")==a?r=!1:n.remove()),r&&$("#tVideoDiv").append('<iframe frameborder=0 width="100%" height="100%" src="'+a+'" allowfullscreen></iframe>')}else if($("#tVideoDiv iframe").remove(),$("#tVideoDiv div").show(),-1!=a.indexOf("type=blws")){var l=a.split("&");if(l.length>1){var u=l[1].replace(/^vid=/g,"");StudioChatMini.blwsPlayer?StudioChatMini.blwsPlayer.changeVid(u):StudioChatMini.blwsPlayer=polyvObject("#tVideoDiv").videoPlayer({width:"100%",height:"100%",vid:u,flashvars:{autoplay:"0",setScreen:"fill"},onPlayOver:function(i){StudioChatMini.playVideo(StudioChatMini.video.type)}})}}else if(window.SewisePlayer)SewisePlayer.toPlay(a,s,0,!0);else{var d=[];d.push("/js/lib/sewise.player.min.js?server=vod"),d.push("type="+(-1!=a.indexOf(".flv")?"flv":"mp4")),d.push("videourl="+a),d.push("autostart=true"),d.push("logo="),d.push("title=VodVideo"),d.push("buffer=5");var h=d.join("&"),c=document.createElement("script");c.type="text/javascript",c.src=h,$("#tVideoDiv").get(0).appendChild(c);var m=function(){return window.SewisePlayer?void SewisePlayer.onPause(function(i){window.setTimeout(function(){SewisePlayer.duration()<=SewisePlayer.playTime()&&StudioChatMini.playVideo(StudioChatMini.video.type)},1e3)}):void window.setTimeout(m,500)};m()}}}catch(p){console.error("setVideo has error:"+p)}},getArticleList:function(i,t,e,o,a,s,n,r){try{$.getJSON("/studio/getArticleList",{authorId:common.trim(n),code:i,platform:t,hasContent:e,pageNo:o,pageSize:a,orderByStr:s},function(i){r(i)})}catch(l){console.error("getArticleList->"+l),r(null)}},setVideoList:function(){this.getArticleList("teach_video",this.userInfo.groupId,0,1,100,'{"sequence":"desc"}',null,function(i){if(i&&0==i.result){var t=i.data,e=null,o=null;for(var a in t)e=t[a],e.mediaUrl&&(o={title:e.detailList[0].title,id:e._id,type:common.isValid(e.mediaUrl)&&-1!=e.mediaUrl.indexOf(".mp4")?"mp4":"",url:e.mediaUrl},StudioChatMini.video.list.push(o),"mp4"===o.type&&StudioChatMini.video.listMp4.push(o))}navigator.userAgent.indexOf("MSIE")>=0&&$("#tVideoDiv").before('<div style="z-index: 98; position: absolute; top: 0; left: 0; background-color: #000000; width: 100%; height: 29px;"></div><iframe src="about:blank" frameborder="0" width="100%" height="29px;" style="z-index: 97; position: absolute; top: 0; left: 0;"></iframe>'),StudioChatMini.playVideo("live")})},getLiveTitle:function(i){if(StudioChatMini.courses){var t=new Date,e=(t.getHours()<10?"0":"")+t.getHours();e+=":",e+=(t.getMinutes()<10?"0":"")+t.getMinutes();for(var o=null,a=0,s=StudioChatMini.courses.length;s>a;a++)if(o=StudioChatMini.courses[a],o.startTime<=e&&o.endTime>e)return void i(o.title);i("YY直播")}else try{$.getJSON(this.apiUrl+"/getCourse",{platform:"pc"}).done(function(t){t&&0==t.result&&t.data?(StudioChatMini.courses=t.data,StudioChatMini.getLiveTitle(i)):i("YY直播")})}catch(n){i("YY直播"),console.error("getCourse->"+n)}},setEvent:function(){$("#vbackbtn_live").click(function(){StudioChatMini.playVideo("live")}),$("#vbackbtn_chg").click(function(){StudioChatMini.playVideo("video")}),$("#vbackbtn_video").click(function(){StudioChatMini.playVideo("mp4")})},setTalkListScroll:function(i){var t=$("#chatMsgContentDiv");t.hasClass("mCustomScrollbar")?(t.mCustomScrollbar("update"),i&&t.mCustomScrollbar("scrollTo","bottom")):(t.mCustomScrollbar({scrollInertia:1,scrollButtons:{enable:!0},theme:"light-2"}),t.mCustomScrollbar("scrollTo","bottom"))},formatPublishTime:function(i,t,e){var o=Number(i.replace(/_.+/g,""));return common.isBlank(i)?"":t?common.formatterDateTime(o,e):common.getHHMM(o)},setContent:function(i,t,e){var o=i.fromUser;if(t&&(o.publishTime=i.uiId),!i.isVisitor){if(e&&$("#"+o.publishTime).length>0)return $("#"+o.publishTime+" .dcont em[class=ruleTipStyle]").remove(),void $("#"+o.publishTime+" input").remove();if(i.rule)return void(i.value&&i.value.needApproval?$("#"+i.uiId).attr("id",o.publishTime):$("#"+i.uiId+" .dcont").append('<em class="ruleTipStyle">'+i.value.tip+"</em>"));if(!t&&StudioChatMini.userInfo.userId==o.userId&&i.serverSuccess)return $("#"+i.uiId+" .dtime").html(StudioChatMini.formatPublishTime(o.publishTime)),void $("#"+i.uiId).attr("id",o.publishTime);var a=StudioChatMini.formatContentHtml(i,t,e),s=$("#dialog_list");s.append(a),this.formatMsgToLink(o.publishTime),e||StudioChatMini.setTalkListScroll(!0)}},formatContentHtml:function(i,t,e){var o="dialog ",a="",s="uname ",n="false",r=i.fromUser,l=i.content,u=r.nickname,d=r.toUser,h="";d&&common.isValid(d.userId)&&(h='<span class="txt_dia" uid="'+d.userId+'" utype="'+d.userType+'">@<label>'+d.nickname+"</label></span>",StudioChatMini.userInfo.userId==d.userId&&(n="true")),a=l.value,StudioChatMini.userInfo.userId==r.userId?(o+="mine",u="我",n="true"):(2==r.userType&&(o+="analyst"),1==r.userType&&(o+="admin"),!e&&d&&StudioChatMini.userInfo.userId==d.userId&&($(".mymsg").show(),$(".mymsg em").hide(),$(".replybtn").attr("uid",r.userId),$(".replybtn").attr("ts",d.talkStyle),$(".replybtn").attr("futype",r.userType),$(".sender").html(r.nickname),$(".xcont").html(a)));var c=[];return c.push('<div class="'+o+'" id="'+r.publishTime+'" isMe="'+n+'" utype="'+r.userType+'" mType="'+l.msgType+'" t="header">'),c.push('<a href="javascript:" class="headimg" uid="'+r.userId+'">'+StudioChatMini.getUserAImgCls(r.clientGroup,r.userType,r.avatar)+"</a>"),c.push('<div class="duser">'),"true"==n?(c.push('<span class="dtime">'+StudioChatMini.formatPublishTime(r.publishTime)+"</span>"),c.push('<a href="javascript:"  class="'+s+'">'+u+"</a>")):(c.push('<a href="javascript:"  class="'+s+'">'+u+"</a>"),c.push('<span class="dtime">'+StudioChatMini.formatPublishTime(r.publishTime)+"</span>")),c.push("</div>"),c.push('<p><span class="dcont">'+h+a+"</span></p>"),c.push("</div>"),c.join("")},formatMsgToLink:function(i){$("#"+i+' .dcont:contains("http:"),#'+i+' .dcont:contains("https:")').each(function(i,t){var e=$(t).html(),o=e.split(/<img src="\S+">/g),a="";for(var s in o)if(a=o[s],!common.isBlank(a)){var n=a.replace(/(http:\/\/|https:\/\/)((\w|=|\?|\.|\/|\\&|-)+)(:\d+)?(\/|\S)+/g,function(i){return'<a href="'+i+'" target="_blank" style="color:#3181c6;">'+i+"</a>"});t.innerHTML=t.innerHTML.replace(a,n)}})},removeLoadDom:function(i){$("#"+i+" .img-loading,#"+i+" .img-load-gan,#"+i+" .shadow-box,#"+i+" .shadow-conut").remove()},getUserAImgCls:function(i,t,e){var o="";return t&&0!=t&&common.isValid(e)?'<img src="'+e+'">':(o="vip"==i?"user_v":"real"==i?"user_r":"simulate"==i?"user_d":"register"==i?"user_m":"user_c",'<img src="images/studio/'+o+'.png">')},setSocket:function(){this.socket=common.getSocket(io,this.socketUrl,this.userInfo.groupType),this.socket.on("connect",function(){console.log("connected to server!"),StudioChatMini.userInfo.socketId=StudioChatMini.socket.id;var i=$("#studioListId a[class~=ing]");StudioChatMini.socket.emit("login",{userInfo:StudioChatMini.userInfo,lastPublishTime:$("#dialog_list>div:last").attr("id"),fUserTypeStr:i.attr("awr"),allowWhisper:i.attr("aw")}),$(".img-loading[pf=chatMessage]").show()}),this.socket.on("disconnect",function(i){console.log("disconnect")}),this.socket.on("error",function(i){console.error("e:"+i)}),this.socket.on("sendMsg",function(i){i.fromUser.toUser&&1==i.fromUser.toUser.talkStyle||StudioChatMini.setContent(i,!1,!1)}),this.socket.on("notice",function(i){switch(i.type){case"removeMsg":$("#"+i.data.replace(/,/g,",#")).remove(),StudioChatMini.setTalkListScroll(!1);break;case"pushInfo":var t=i.data;3==t.position&&StudioChatMini.talkBoxPush.initTBP(t.infos)}}),this.socket.on("loadMsg",function(i){$(".img-loading[pf=chatMessage]").hide();var t=i.msgData,e=i.isAdd;if(e||$("#content_ul").html(""),t&&$.isArray(t)){t.reverse();for(var o in t)StudioChatMini.formatUserToContent(t[o])}StudioChatMini.setTalkListScroll(!0)})},formatUserToContent:function(i){var t={userId:i.userId,nickname:i.nickname,avatar:i.avatar,userType:i.userType,groupId:i.groupId,clientGroup:i.clientGroup,publishTime:i.publishTime,toUser:i.toUser,avatar:i.avatar,position:i.position};StudioChatMini.setContent({fromUser:t,content:i.content},!1,!0)},talkBoxPush:{initTBP:function(i){this.clear(),StudioChatMini.pushObj.talkPush=i,this.start()},clear:function(){StudioChatMini.pushObj.talkPushInterval&&(window.clearInterval(StudioChatMini.pushObj.talkPushInterval),StudioChatMini.pushObj.talkPushInterval=null);for(var i=StudioChatMini.pushObj.talkPush,t=null,e=0,o=i.length;o>e;e++)t=i[e],t.timeoutId&&window.clearTimeout(t.timeoutId),t.intervalId&&window.clearInterval(t.intervalId)},start:function(){var i=StudioChatMini.pushObj.talkPush;i&&i.length>0&&window.setInterval(function(){StudioChatMini.talkBoxPush.check()},1e4)},check:function(){for(var i=StudioChatMini.pushObj.talkPush,t=null,e=0,o=i.length;o>e;e++)t=i[e],t.startFlag||common.dateTimeWeekCheck(t.pushDate,!1,StudioChatMini.serverTime)&&(t.startFlag=!0,window.setTimeout(StudioChatMini.talkBoxPush.delayStartTask(t),60*(t.onlineMin||0)*1e3))},delayStartTask:function(i){return function(){StudioChatMini.talkBoxPush.showMsg(i),i.intervalMin&&i.intervalMin>0&&(i.intervalId=window.setInterval(StudioChatMini.talkBoxPush.startTask(i),60*i.intervalMin*1e3))}},startTask:function(i){return function(){common.dateTimeWeekCheck(i.pushDate,!1,StudioChatMini.serverTime)?StudioChatMini.talkBoxPush.showMsg(i):(window.clearInterval(i.intervalId),i.startFlag=!1)}},showMsg:function(i){var t=[];t.push('<div class="dialog push">'),t.push(i.content),t.push("</div>"),$("#dialog_list").append(t.join("")),StudioChatMini.setTalkListScroll(!0)}}};$(function(){StudioChatMini.init()});