var StudioChatMini={apiUrl:"",blwsPlayer:null,studioInfo:null,studioDate:"",serverTime:0,msgType:{text:"text",img:"img",file:"file"},socket:null,socketUrl:"",userInfo:null,initStudio:!1,video:{type:"mp4",list:[],listMp4:[],index:-1},courses:null,init:function(){this.serverTimeUp(),this.setVisitStore(),this.setSocket(),this.setVideoList(),this.setEvent()},serverTimeUp:function(){StudioChatMini.clientVideoTask(),setInterval(function(){StudioChatMini.serverTime+=1e4,StudioChatMini.clientVideoTask()},1e3)},setVisitStore:function(){if(!store.enabled)return void console.log("Local storage is not supported by your browser.");var i="storeInfo_"+this.userInfo.groupType,e=store.get(i),t={};if(common.isBlank(e)){var o=common.randomNumber(6);t.clientStoreId=(new Date).getTime()+"_"+o,t.userId="visitor_"+o,t.nickname="游客_"+o,t.userType=-1,store.set(i,t)}else t=e;this.userInfo.clientStoreId=t.clientStoreId,this.userInfo.visitorId=t.userId,this.userInfo.loginId=t.loginId,this.userInfo.clientGroup&&"visitor"==this.userInfo.clientGroup?(this.userInfo.nickname=t.nickname,this.userInfo.userId=t.userId):(t.loginId=this.userInfo.userId,store.set(i,t))},clientVideoTask:function(){$("#studioVideoDiv embed").size()<1&&common.dateTimeWeekCheck(this.studioDate,!0,StudioChatMini.serverTime)&&$("#vbackbtn_live").show()},playVideo:function(i){StudioChatMini.video.type=i,"mp4"==i?(StudioChatMini.video.index=common.randomIndex(StudioChatMini.video.listMp4.length),StudioChatMini.setVideo(!1,StudioChatMini.video.listMp4[StudioChatMini.video.index])):"video"==i?(StudioChatMini.video.index=common.randomIndex(StudioChatMini.video.list.length),StudioChatMini.setVideo(!1,StudioChatMini.video.list[StudioChatMini.video.index])):common.dateTimeWeekCheck(this.studioDate,!0,StudioChatMini.serverTime)?this.setVideo(!0):StudioChatMini.playVideo("mp4")},getEmbedDom:function(i){return'<embed src="'+i+'" autostart="true" wmode="Opaque" quality="high" width="100%" height="100%" align="middle" allowScriptAccess="never" allowFullScreen="true" mode="transparent" type="application/x-shockwave-flash"></embed>'},setStudioVideoDiv:function(i,e){window.SewisePlayer&&(SewisePlayer.doStop(),$("#tvDivId").hide(),$("#studioTeachId a").removeClass("on")),$("#tVideoDiv iframe").remove(),$("#stVideoDiv:visible").length>0&&$("#studioVideoDiv embed").attr("src")==i||($("#stVideoDiv .img-loading").fadeIn(0).delay(2e3).fadeOut(200),$("#studioVideoDiv embed").remove(),$(StudioChatMini.getEmbedDom(i)).appendTo("#studioVideoDiv"),$("#stVideoDiv").show(),$("#stVideoDiv .vtitle span").text(e),StudioChatMini.initStudio=!0)},setVideo:function(i,e){try{if(i){if($("#vbackbtn_live").hide(),!this.studioInfo.url){var t=this.studioInfo.yyChannel,o=this.studioInfo.minChannel;this.studioInfo.url="http://yy.com/s"+(common.isValid(t)?"/"+t:"")+(common.isValid(o)?"/"+o:"")+"/yyscene.swf"}StudioChatMini.getLiveTitle(function(i){StudioChatMini.setStudioVideoDiv(StudioChatMini.studioInfo.url,i)})}else{$("#tvDivId").show(),$("#stVideoDiv").hide(),$("#studioVideoDiv embed").remove(),$("#tVideoDiv .img-loading").fadeIn(0).delay(2e3).fadeOut(200);var s=e.url,n=e.title;if($("#tvDivId .vtitle span").text(n),-1!=s.indexOf(".html")){window.SewisePlayer&&(SewisePlayer.doStop(),$("#tVideoDiv div").hide());var r=$("#tVideoDiv iframe"),a=!0;r.size()>0&&(r.attr("src")==s?a=!1:r.remove()),a&&$("#tVideoDiv").append('<iframe frameborder=0 width="100%" height="100%" src="'+s+'" allowfullscreen></iframe>')}else if($("#tVideoDiv iframe").remove(),$("#tVideoDiv div").show(),-1!=s.indexOf("type=blws")){var d=s.split("&");if(d.length>1){var u=d[1].replace(/^vid=/g,"");StudioChatMini.blwsPlayer?StudioChatMini.blwsPlayer.changeVid(u):StudioChatMini.blwsPlayer=polyvObject("#tVideoDiv").videoPlayer({width:"100%",height:"100%",vid:u,flashvars:{autoplay:"0",setScreen:"fill"},onPlayOver:function(i){StudioChatMini.playVideo(StudioChatMini.video.type)}})}}else if(window.SewisePlayer)SewisePlayer.toPlay(s,n,0,!0);else{var l=[];l.push("/js/lib/sewise.player.min.js?server=vod"),l.push("type="+(-1!=s.indexOf(".flv")?"flv":"mp4")),l.push("videourl="+s),l.push("autostart=true"),l.push("logo="),l.push("title=VodVideo"),l.push("buffer=5");var c=l.join("&"),m=document.createElement("script");m.type="text/javascript",m.src=c,$("#tVideoDiv").get(0).appendChild(m);var h=function(){return window.SewisePlayer?void SewisePlayer.onPause(function(i){window.setTimeout(function(){SewisePlayer.duration()<=SewisePlayer.playTime()&&StudioChatMini.playVideo(StudioChatMini.video.type)},1e3)}):void window.setTimeout(h,500)};h()}}}catch(v){console.error("setVideo has error:"+v)}},getArticleList:function(i,e,t,o,s,n,r,a){try{$.getJSON("/studio/getArticleList",{authorId:common.trim(r),code:i,platform:e,hasContent:t,pageNo:o,pageSize:s,orderByStr:n},function(i){a(i)})}catch(d){console.error("getArticleList->"+d),a(null)}},setVideoList:function(){this.getArticleList("teach_video",this.userInfo.groupId,0,1,100,'{"sequence":"desc"}',null,function(i){if(i&&0==i.result){var e=i.data,t=null,o=null;for(var s in e)t=e[s],t.mediaUrl&&(o={title:t.detailList[0].title,id:t._id,type:common.isValid(t.mediaUrl)&&-1!=t.mediaUrl.indexOf(".mp4")?"mp4":"",url:t.mediaUrl},StudioChatMini.video.list.push(o),"mp4"===o.type&&StudioChatMini.video.listMp4.push(o))}StudioChatMini.playVideo("live")})},getLiveTitle:function(i){if(StudioChatMini.courses){var e=new Date,t=(e.getHours()<10?"0":"")+e.getHours();t+=":",t+=(e.getMinutes()<10?"0":"")+e.getMinutes();for(var o=null,s=0,n=StudioChatMini.courses.length;n>s;s++)if(o=StudioChatMini.courses[s],o.startTime<=t&&o.endTime>t)return void i(o.title);i("YY直播")}else try{$.getJSON(this.apiUrl+"/getCourse",{platform:"pc"},function(e){e&&0==e.result&&e.data?(StudioChatMini.courses=e.data,StudioChatMini.getLiveTitle(i)):i("YY直播")})}catch(r){i("YY直播"),console.error("getCourse->"+r)}},setEvent:function(){$("#vbackbtn_live").click(function(){StudioChatMini.playVideo("live")}),$("#vbackbtn_chg").click(function(){StudioChatMini.playVideo("video")}),$("#vbackbtn_video").click(function(){StudioChatMini.playVideo("mp4")})},setTalkListScroll:function(i){var e=$("#chatMsgContentDiv");e.hasClass("mCustomScrollbar")?(e.mCustomScrollbar("update"),i&&e.mCustomScrollbar("scrollTo","bottom")):(e.mCustomScrollbar({scrollInertia:1,scrollButtons:{enable:!0},theme:"light-2"}),e.mCustomScrollbar("scrollTo","bottom"))},formatPublishTime:function(i,e,t){var o=Number(i.replace(/_.+/g,""));return common.isBlank(i)?"":e?common.formatterDateTime(o,t):common.getHHMM(o)},setContent:function(i,e,t){var o=i.fromUser;if(e&&(o.publishTime=i.uiId),!i.isVisitor){if(t&&$("#"+o.publishTime).length>0)return $("#"+o.publishTime+" .dcont em[class=ruleTipStyle]").remove(),void $("#"+o.publishTime+" input").remove();if(i.rule)return void(i.value&&i.value.needApproval?$("#"+i.uiId).attr("id",o.publishTime):$("#"+i.uiId+" .dcont").append('<em class="ruleTipStyle">'+i.value.tip+"</em>"));if(!e&&StudioChatMini.userInfo.userId==o.userId&&i.serverSuccess)return $("#"+i.uiId+" .dtime").html(StudioChatMini.formatPublishTime(o.publishTime)),void $("#"+i.uiId).attr("id",o.publishTime);var s=StudioChatMini.formatContentHtml(i,e,t),n=$("#dialog_list");n.append(s),this.formatMsgToLink(o.publishTime),t||StudioChatMini.setTalkListScroll(!0)}},formatContentHtml:function(i,e,t){var o="dialog ",s="",n="",r="uname ",a="false",d=i.fromUser,u=i.content,l=d.nickname,c=d.toUser,m="";c&&common.isValid(c.userId)&&(m='<span class="txt_dia" uid="'+c.userId+'" utype="'+c.userType+'">@<label>'+c.nickname+"</label></span>",StudioChatMini.userInfo.userId==c.userId&&(a="true")),s=u.value,StudioChatMini.userInfo.userId==d.userId?(o+="mine",l="我",a="true"):(2==d.userType&&(o+="analyst"),1==d.userType&&(o+="admin"),!t&&c&&StudioChatMini.userInfo.userId==c.userId&&($(".mymsg").show(),$(".mymsg em").hide(),$(".replybtn").attr("uid",d.userId),$(".replybtn").attr("ts",c.talkStyle),$(".replybtn").attr("futype",d.userType),$(".sender").html(d.nickname),$(".xcont").html(s)));var h='<div class="'+o+'" id="'+d.publishTime+'" isMe="'+a+'" utype="'+d.userType+'" mType="'+u.msgType+'" t="header"><a href="javascript:" class="headimg" uid="'+d.userId+'">'+StudioChatMini.getUserAImgCls(d.clientGroup,d.userType,d.avatar)+'</a><i></i><p><a href="javascript:"  class="'+r+'">'+l+'</a><span class="dtime">'+StudioChatMini.formatPublishTime(d.publishTime)+'</span><span class="dcont">'+m+s+"</span></p>"+n+"</div>";return h},formatMsgToLink:function(i){$("#"+i+' .dcont:contains("http:"),#'+i+' .dcont:contains("https:")').each(function(i,e){var t=$(e).html(),o=t.split(/<img src="\S+">/g),s="";for(var n in o)if(s=o[n],!common.isBlank(s)){var r=s.replace(/(http:\/\/|https:\/\/)((\w|=|\?|\.|\/|\\&|-)+)(:\d+)?(\/|\S)+/g,function(i){return'<a href="'+i+'" target="_blank" style="color:#3181c6;">'+i+"</a>"});e.innerHTML=e.innerHTML.replace(s,r)}})},removeLoadDom:function(i){$("#"+i+" .img-loading,#"+i+" .img-load-gan,#"+i+" .shadow-box,#"+i+" .shadow-conut").remove()},getUserAImgCls:function(i,e,t){var o="";return e&&0!=e&&common.isValid(t)?'<img src="'+t+'">':(o="vip"==i?"user_v":"real"==i?"user_r":"simulate"==i?"user_d":"register"==i?"user_m":"user_c",'<img src="images/studio/'+o+'.png">')},setSocket:function(){this.socket=common.getSocket(io,this.socketUrl,this.userInfo.groupType),this.socket.on("connect",function(){console.log("connected to server!"),StudioChatMini.userInfo.socketId=StudioChatMini.socket.id;var i=$("#studioListId a[class~=ing]");StudioChatMini.socket.emit("login",{userInfo:StudioChatMini.userInfo,lastPublishTime:$("#dialog_list>div:last").attr("id"),fUserTypeStr:i.attr("awr"),allowWhisper:i.attr("aw")}),$(".img-loading[pf=chatMessage]").show()}),this.socket.on("disconnect",function(i){console.log("disconnect")}),this.socket.on("error",function(i){console.error("e:"+i)}),this.socket.on("sendMsg",function(i){i.fromUser.toUser&&1==i.fromUser.toUser.talkStyle||StudioChatMini.setContent(i,!1,!1)}),this.socket.on("notice",function(i){switch(i.type){case"removeMsg":$("#"+i.data.replace(/,/g,",#")).remove(),StudioChatMini.setTalkListScroll(!1)}}),this.socket.on("loadMsg",function(i){$(".img-loading[pf=chatMessage]").hide();var e=i.msgData,t=i.isAdd;if(t||$("#content_ul").html(""),e&&$.isArray(e)){e.reverse();for(var o in e)StudioChatMini.formatUserToContent(e[o])}StudioChatMini.setTalkListScroll(!0)})},formatUserToContent:function(i){var e={userId:i.userId,nickname:i.nickname,avatar:i.avatar,userType:i.userType,groupId:i.groupId,clientGroup:i.clientGroup,publishTime:i.publishTime,toUser:i.toUser,avatar:i.avatar,position:i.position};StudioChatMini.setContent({fromUser:e,content:i.content},!1,!0)}};$(function(){StudioChatMini.init()});