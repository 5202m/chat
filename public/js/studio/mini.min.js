var StudioChatMini={apiUrl:"",currStudioAuth:!1,blwsPlayer:null,syllabusData:null,serverTime:0,pushObj:{whPush:{},talkPush:[],talkPushInterval:null},msgType:{text:"text",img:"img",file:"file"},socket:null,socketUrl:"",userInfo:null,initStudio:!1,video:{type:"mp4",list:[],listMp4Index:[],index:-1},courses:null,init:function(){this.serverTimeUp(),this.setVisitStore(),this.setSocket(),this.setVideoList(),this.setEvent()},serverTimeUp:function(){StudioChatMini.clientVideoTask(),setInterval(function(){StudioChatMini.serverTime+=1e3,StudioChatMini.clientVideoTask()},1e3)},setVisitStore:function(){if(!store.enabled)return void console.log("Local storage is not supported by your browser.");var i="storeInfo_"+this.userInfo.groupType,e=store.get(i),t={};if(common.isBlank(e)){var o=common.randomNumber(6);t.clientStoreId=(new Date).getTime()+"_"+o,t.userId="visitor_"+o,t.nickname="游客_"+o,t.userType=-1,store.set(i,t)}else t=e;this.userInfo.clientStoreId=t.clientStoreId,this.userInfo.visitorId=t.userId,this.userInfo.loginId=t.loginId,this.userInfo.clientGroup&&"visitor"==this.userInfo.clientGroup?(this.userInfo.nickname=t.nickname,this.userInfo.userId=t.userId):(t.loginId=this.userInfo.userId,store.set(i,t))},clientVideoTask:function(){var i=common.getSyllabusPlan(this.syllabusData,this.serverTime),e=i&&0!=i.status&&common.isValid(i.studioLink)&&1==i.courseType&&!i.isNext;$("#studioVideoDiv embed").size()<1&&e&&$("#vbackbtn_live").show()},playVideo:function(i,e){if(StudioChatMini.video.type=i,"mp4"==i||"video"==i)StudioChatMini.setVideo(StudioChatMini.changeVideoIndex(i));else{var t=common.getSyllabusPlan(this.syllabusData,this.serverTime);!t||0!=t.courseType&&common.isBlank(t.studioLink)||t.isNext||0==t.courseType||2==t.courseType?e?alert("目前还没有视频直播，详情请留意直播间课程表！"):(StudioChatMini.playVideo("mp4"),0==t.courseType&&setTimeout(function(){window.SewisePlayer&&SewisePlayer.doStop()},1500)):($("#vbackbtn_live").hide(),this.setStudioVideoDiv(t.studioLink,t.title))}},changeVideoIndex:function(i){var e=-1,t=StudioChatMini.video.listMp4Index.length;return"mp4"!=i||0==t?(t=StudioChatMini.video.list.length,0==t?e=-1:1==t?e=0:-1==StudioChatMini.video.index?e=common.randomIndex(t):(e=common.randomIndex(t-1),e>=StudioChatMini.video.index&&e++)):1==t?e=StudioChatMini.video.listMp4Index[0]:(-1==StudioChatMini.video.index?e=common.randomIndex(t):(e=common.randomIndex(t-1),StudioChatMini.video.listMp4Index[e]>=StudioChatMini.video.index&&e++),e=StudioChatMini.video.listMp4Index[e]),StudioChatMini.video.index=e,-1==e?null:StudioChatMini.video.list[e]},getEmbedDom:function(i){return'<embed src="'+i+'" autostart="true" wmode="Opaque" quality="high" width="100%" height="100%" align="middle" allowScriptAccess="never" allowFullScreen="true" mode="transparent" type="application/x-shockwave-flash"></embed>'},setStudioVideoDiv:function(i,e){if(window.SewisePlayer&&(SewisePlayer.doStop(),$("#tvDivId").hide(),$("#studioTeachId a").removeClass("on")),$("#tVideoDiv iframe").remove(),-1!=i.indexOf("rtmp")){var t='<div style="position: relative; width: 100%; height: 100%; left: 0px; top: 0px;"><object type="application/x-shockwave-flash" id="sewise_player" name="sewise_player" data="/js/lib/flash/SewisePlayer.swf" width="100%" height="100%"><param name="allowfullscreen" value="true"><param name="wmode" value="transparent"><param name="allowscriptaccess" value="always"><param name="flashvars" value="autoStart=true&amp;programId=&amp;shiftTime=&amp;lang=zh_CN&amp;type=rtmp&amp;serverApi=ServerApi.execute&amp;skin=/js/lib/flash/skins/liveOrange.swf&amp;title=&amp;draggable=true&amp;published=0&amp;streamUrl='+i+'&amp;duration=3600&amp;poster=&amp;flagDatas=&amp;videosJsonUrl=&amp;adsJsonData=&amp;statistics=&amp;customDatas=&amp;playerName=Sewise Player&amp;clarityButton=enable&amp;timeDisplay=disable&amp;controlBarDisplay=enable&amp;topBarDisplay=disable&amp;customStrings=&amp;volume=0.6&amp;key=&amp;trackCallback="></object></div>';$("#studioVideoDiv").html(t)}else{if($("#stVideoDiv:visible").length>0&&$("#studioVideoDiv embed").attr("src")==i)return;$("#stVideoDiv .img-loading").fadeIn(0).delay(2e3).fadeOut(200),$("#studioVideoDiv embed").remove(),$(StudioChatMini.getEmbedDom(i)).appendTo("#studioVideoDiv")}$("#stVideoDiv").show(),$("#stVideoDiv .vtitle span").text(e),StudioChatMini.initStudio=!0},setVideo:function(i){try{$("#tvDivId").show(),$("#stVideoDiv").hide(),$("#studioVideoDiv embed").remove(),$("#tVideoDiv .img-loading").fadeIn(0).delay(2e3).fadeOut(200);var e=i.url,t=i.title;if($("#tvDivId .vtitle span").text(t),-1!=e.indexOf(".html")){window.SewisePlayer&&(SewisePlayer.doStop(),$("#tVideoDiv div").hide());var o=$("#tVideoDiv iframe"),a=!0;o.size()>0&&(o.attr("src")==e?a=!1:o.remove()),a&&$("#tVideoDiv").append('<iframe frameborder=0 width="100%" height="100%" src="'+e+'" allowfullscreen></iframe>')}else if($("#tVideoDiv iframe").remove(),$("#tVideoDiv div").show(),-1!=e.indexOf("type=blws")){var s=e.split("&");if(s.length>1){var n=s[1].replace(/^vid=/g,"");StudioChatMini.blwsPlayer?StudioChatMini.blwsPlayer.changeVid(n):StudioChatMini.blwsPlayer=polyvObject("#tVideoDiv").videoPlayer({width:"100%",height:"100%",vid:n,flashvars:{autoplay:"0",setScreen:"fill"},onPlayOver:function(i){StudioChatMini.playVideo(StudioChatMini.video.type)}})}}else if(window.SewisePlayer)SewisePlayer.toPlay(e,t,0,!0);else{var r=[];r.push("/js/lib/sewise.player.min.js?server=vod"),r.push("type="+(-1!=e.indexOf(".flv")?"flv":"mp4")),r.push("videourl="+e),r.push("autostart=true"),r.push("logo="),r.push("title=VodVideo"),r.push("buffer=5");var l=r.join("&"),u=document.createElement("script");u.type="text/javascript",u.src=l,$("#tVideoDiv").get(0).appendChild(u);var d=function(){return window.SewisePlayer?void SewisePlayer.onPause(function(i){window.setTimeout(function(){SewisePlayer.duration()<=SewisePlayer.playTime()&&StudioChatMini.playVideo(StudioChatMini.video.type)},1e3)}):void window.setTimeout(d,500)};d()}}catch(c){console.error("setVideo has error:"+c)}},getArticleList:function(i,e,t,o,a,s,n,r){try{$.getJSON("/studio/getArticleList",{authorId:common.trim(n),code:i,platform:e,hasContent:t,pageNo:o,pageSize:a,orderByStr:s},function(i){r(i)})}catch(l){console.error("getArticleList->"+l),r(null)}},setVideoList:function(){this.getArticleList("teach_video",this.userInfo.groupId,0,1,100,'{"sequence":"desc"}',null,function(i){if(i&&0==i.result){var e=i.data,t=null,o=null;for(var a in e)t=e[a],t.mediaUrl&&(o={title:t.detailList[0].title,id:t._id,type:common.isValid(t.mediaUrl)&&-1!=t.mediaUrl.indexOf(".mp4")?"mp4":"",url:t.mediaUrl},StudioChatMini.video.list.push(o),"mp4"===o.type&&StudioChatMini.video.listMp4Index.push(a))}StudioChatMini.playVideo("live")})},setEvent:function(){$("#vbackbtn_live").click(function(){StudioChatMini.playVideo("live",!0)}),$("#vbackbtn_chg").click(function(){StudioChatMini.playVideo("video")}),$("#vbackbtn_video").click(function(){StudioChatMini.playVideo("mp4")})},setTalkListScroll:function(i){var e=$("#chatMsgContentDiv");e.hasClass("mCustomScrollbar")?(e.mCustomScrollbar("update"),i&&e.mCustomScrollbar("scrollTo","bottom")):(e.mCustomScrollbar({scrollInertia:1,scrollButtons:{enable:!1},theme:"light-2"}),e.mCustomScrollbar("scrollTo","bottom"))},formatPublishTime:function(i,e,t){var o=Number(i.replace(/_.+/g,""));return common.isBlank(i)?"":e?common.formatterDateTime(o,t):common.getHHMM(o)},setContent:function(i,e,t){var o=i.fromUser;if(e&&(o.publishTime=i.uiId),!i.isVisitor){if(t&&$("#"+o.publishTime).length>0)return $("#"+o.publishTime+" .dcont em[class=ruleTipStyle]").remove(),void $("#"+o.publishTime+" input").remove();if(i.rule)return void(i.value&&i.value.needApproval?$("#"+i.uiId).attr("id",o.publishTime):$("#"+i.uiId+" .dcont").append('<em class="ruleTipStyle">'+i.value.tip+"</em>"));if(!e&&StudioChatMini.userInfo.userId==o.userId&&i.serverSuccess)return $("#"+i.uiId+" .dtime").html(StudioChatMini.formatPublishTime(o.publishTime)),void $("#"+i.uiId).attr("id",o.publishTime);var a=StudioChatMini.formatContentHtml(i,e,t),s=$("#dialog_list");s.append(a),this.formatMsgToLink(o.publishTime),t||StudioChatMini.setTalkListScroll(!0)}},formatContentHtml:function(i,e,t){var o="dialog ",a="",s="uname ",n="false",r=i.fromUser,l=i.content,u=r.nickname,d=r.toUser,c="";d&&common.isValid(d.userId)&&(c='<span class="txt_dia" uid="'+d.userId+'" utype="'+d.userType+'">@<label>'+d.nickname+"</label></span>",StudioChatMini.userInfo.userId==d.userId&&(n="true")),a=l.value,StudioChatMini.userInfo.userId==r.userId?(o+="mine",u="我",n="true"):(2==r.userType&&(o+="analyst"),1==r.userType&&(o+="admin"),!t&&d&&StudioChatMini.userInfo.userId==d.userId&&($(".mymsg").show(),$(".mymsg em").hide(),$(".replybtn").attr("uid",r.userId),$(".replybtn").attr("ts",d.talkStyle),$(".replybtn").attr("futype",r.userType),$(".sender").html(r.nickname),$(".xcont").html(a)));var h=[];return h.push('<div class="'+o+'" id="'+r.publishTime+'" isMe="'+n+'" utype="'+r.userType+'" mType="'+l.msgType+'" t="header">'),h.push('<a href="javascript:" class="headimg" uid="'+r.userId+'">'+StudioChatMini.getUserAImgCls(r.clientGroup,r.userType,r.avatar)+"</a>"),h.push('<div class="duser">'),"true"==n?(h.push('<span class="dtime">'+StudioChatMini.formatPublishTime(r.publishTime)+"</span>"),h.push('<a href="javascript:"  class="'+s+'">'+u+"</a>")):(h.push('<a href="javascript:"  class="'+s+'">'+u+"</a>"),h.push('<span class="dtime">'+StudioChatMini.formatPublishTime(r.publishTime)+"</span>")),h.push("</div>"),h.push('<p><span class="dcont">'+c+a+"</span></p>"),h.push("</div>"),h.join("")},formatMsgToLink:function(i){$("#"+i+' .dcont:contains("http:"),#'+i+' .dcont:contains("https:")').each(function(i,e){var t=$(e).html(),o=t.split(/<img src="\S+">/g),a="";for(var s in o)if(a=o[s],!common.isBlank(a)){var n=a.replace(/(http:\/\/|https:\/\/)((\w|=|\?|\.|\/|\\&|-)+)(:\d+)?(\/|\S)+/g,function(i){return'<a href="'+i+'" target="_blank" style="color:#3181c6;">'+i+"</a>"});e.innerHTML=e.innerHTML.replace(a,n)}})},removeLoadDom:function(i){$("#"+i+" .img-loading,#"+i+" .img-load-gan,#"+i+" .shadow-box,#"+i+" .shadow-conut").remove()},getUserAImgCls:function(i,e,t){var o="";return e&&0!=e&&common.isValid(t)?'<img src="'+t+'">':(o="vip"==i?"user_v":"active"==i||"notActive"==i?"user_r":"simulate"==i?"user_d":"register"==i?"user_m":"user_c",'<img src="images/studio/'+o+'.png">')},setSocket:function(){this.socket=common.getSocket(io,this.socketUrl,this.userInfo.groupType),this.socket.on("connect",function(){console.log("connected to server!"),StudioChatMini.userInfo.socketId=StudioChatMini.socket.id;var i=$("#studioListId a[class~=ing]");StudioChatMini.socket.emit("login",{userInfo:StudioChatMini.userInfo,lastPublishTime:$("#dialog_list>div:last").attr("id"),fUserTypeStr:i.attr("awr"),allowWhisper:i.attr("aw")}),$(".img-loading[pf=chatMessage]").show()}),this.socket.on("disconnect",function(i){console.log("disconnect")}),this.socket.on("error",function(i){console.error("e:"+i)}),this.socket.on("sendMsg",function(i){i.fromUser.toUser&&1==i.fromUser.toUser.talkStyle||StudioChatMini.setContent(i,!1,!1)}),this.socket.on("notice",function(i){switch(i.type){case"removeMsg":$("#"+i.data.replace(/,/g,",#")).remove(),StudioChatMini.setTalkListScroll(!1);break;case"pushInfo":var e=i.data;3==e.position&&StudioChatMini.talkBoxPush.initTBP(e.infos)}}),this.socket.on("loadMsg",function(i){$(".img-loading[pf=chatMessage]").hide();var e=i.msgData,t=i.isAdd;if(t||$("#content_ul").html(""),e&&$.isArray(e)){e.reverse();for(var o in e)StudioChatMini.formatUserToContent(e[o])}StudioChatMini.setTalkListScroll(!0)})},formatUserToContent:function(i){var e={userId:i.userId,nickname:i.nickname,avatar:i.avatar,userType:i.userType,groupId:i.groupId,clientGroup:i.clientGroup,publishTime:i.publishTime,toUser:i.toUser,avatar:i.avatar,position:i.position};StudioChatMini.setContent({fromUser:e,content:i.content},!1,!0)},talkBoxPush:{initTBP:function(i){this.clear(),StudioChatMini.pushObj.talkPush=i,this.start()},clear:function(){StudioChatMini.pushObj.talkPushInterval&&(window.clearInterval(StudioChatMini.pushObj.talkPushInterval),StudioChatMini.pushObj.talkPushInterval=null);for(var i=StudioChatMini.pushObj.talkPush,e=null,t=0,o=i.length;o>t;t++)e=i[t],e.timeoutId&&window.clearTimeout(e.timeoutId),e.intervalId&&window.clearInterval(e.intervalId)},start:function(){var i=StudioChatMini.pushObj.talkPush;i&&i.length>0&&window.setInterval(function(){StudioChatMini.talkBoxPush.check()},1e4)},check:function(){for(var i=StudioChatMini.pushObj.talkPush,e=null,t=0,o=i.length;o>t;t++)e=i[t],e.startFlag||common.dateTimeWeekCheck(e.pushDate,!1,StudioChatMini.serverTime)&&(e.startFlag=!0,window.setTimeout(StudioChatMini.talkBoxPush.delayStartTask(e),60*(e.onlineMin||0)*1e3))},delayStartTask:function(i){return function(){StudioChatMini.talkBoxPush.showMsg(i),i.intervalMin&&i.intervalMin>0&&(i.intervalId=window.setInterval(StudioChatMini.talkBoxPush.startTask(i),60*i.intervalMin*1e3))}},startTask:function(i){return function(){common.dateTimeWeekCheck(i.pushDate,!1,StudioChatMini.serverTime)?StudioChatMini.talkBoxPush.showMsg(i):(window.clearInterval(i.intervalId),i.startFlag=!1)}},showMsg:function(i){var e=[];e.push('<div class="dialog push">'),e.push(i.content),e.push("</div>"),$("#dialog_list").append(e.join("")),StudioChatMini.setTalkListScroll(!0)}}};$(function(){StudioChatMini.init()});