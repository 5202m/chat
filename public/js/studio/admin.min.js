var studioChat={filePath:"",msgType:{text:"text",img:"img",file:"file"},socket:null,socketUrl:"",userInfo:null,init:function(){this.setEvent(),this.setSocket(),this.setVideo()},setVideo:function(){try{$.getJSON("/studio/getSyllabus?t="+(new Date).getTime(),{groupType:studioChat.userInfo.groupType,groupId:studioChat.userInfo.groupId},function(t){var e=t.data;if(e&&common.isValid(e.studioLink)){var i=JSON.parse(e.studioLink),s="";for(var a in i)if(1==i[a].code){s=i[a].url;break}if(common.isValid(s)&&0==$("#yyVideoDiv embed").length)if(-1!=s.indexOf("rtmp:")){var o='<div style="position: relative; width: 100%; height: 100%; left: 0px; top: 0px;"><object type="application/x-shockwave-flash" id="sewise_player" name="sewise_player" data="/js/lib/flash/SewisePlayer.swf" width="100%" height="100%"><param name="allowfullscreen" value="true"><param name="wmode" value="transparent"><param name="allowscriptaccess" value="always"><param name="flashvars" value="autoStart=true&amp;programId=&amp;shiftTime=&amp;lang=zh_CN&amp;type=rtmp&amp;serverApi=ServerApi.execute&amp;skin=/js/lib/flash/skins/liveOrange.swf&amp;title=&amp;draggable=true&amp;published=0&amp;streamUrl='+s+'&amp;duration=3600&amp;poster=&amp;flagDatas=&amp;videosJsonUrl=&amp;adsJsonData=&amp;statistics=&amp;customDatas=&amp;playerName=Sewise Player&amp;clarityButton=enable&amp;timeDisplay=disable&amp;controlBarDisplay=enable&amp;topBarDisplay=disable&amp;customStrings=&amp;volume=0.6&amp;key=&amp;trackCallback="></object></div>';$("#yyVideoDiv").html(o)}else $("#yyVideoDiv").html('<embed src="'+s+'" quality="high" width="100%" height="100%" align="middle" allowScriptAccess="never" allowFullScreen="true" mode="transparent" type="application/x-shockwave-flash"></embed>')}})}catch(t){console.error("setVideo has error:"+t)}},setTalkTop:function(t,e){if(t){var i=e.fromUser;$(".mymsg").show(),$(".mymsg em").hide(),$(".replybtn").attr("tm",i.publishTime).attr("uid",i.userId).attr("ts",i.talkStyle).attr("utype",i.userType),$(".sender").html(i.nickname),$(".xcont").html(e.content.value),$("#talk_top_id").prepend('<section class="ss-tk-info clearfix" tm="'+i.publishTime+'"><label><strong>'+i.nickname+'</strong>：</label><span style="margin-left:5px;text-align:justify;">'+e.content.value+'</span><button type="button">关闭</button><button type="button" uid="'+i.userId+'" utype="'+i.userType+'">回复</button></section>');var s=$("#talk_top_id .ss-tk-info[tm="+i.publishTime+"]");s.find("button").click(function(){var t=$(this).parents(".ss-tk-info"),e=$(this).attr("uid"),i=t.attr("tm");common.isValid(e)?studioChat.setDialog(null,e,t.find("strong").addClass("reply-st").html(),$(this).attr("ts"),$(this).attr("utype"),i):(t.remove(),$("#show_top_btn strong,#top_num").text("【"+$("#talk_top_id .ss-tk-info").length+"】"),$(".mymsg .replybtn[tm="+i+"]").parent().hide(),$("#contentText .txt_dia[tm="+i+"]").length>0&&$("#contentText").html(""))})}else e.publishTime&&($("#talk_top_id .ss-tk-info[tm="+e.publishTime+"]").remove(),$(".mymsg .replybtn[tm="+e.publishTime+"]").parent().hide());$("#show_top_btn strong,#top_num").text("【"+$("#talk_top_id .ss-tk-info").length+"】")},getUiId:function(){var t=new Date;return t.getTime()+"_ms"},getVisitorList:function(t){if(!common.isBlank(t))try{$(".searchResult").hide(),$(".searchResult ul").html(""),$.getJSON("/studio/getVistiorByName",{groupType:studioChat.userInfo.groupType,groupId:studioChat.userInfo.groupId,nickname:t},function(t){if(t){$(".searchResult").show();var e=0,i="";for(var s in t)i=t[s].userId||t[s].visitorId,$(".searchResult ul li[uid="+i+"]").length>0||(e=t[s].onlineStatus,$(".searchResult ul").append('<li uid="'+i+'" cg="'+t[s].clientGroup+'"  '+(1==e?"":'class="off"')+"><label>"+t[s].nickname+"</label></li>"));$(".searchResult ul li").click(function(){$(".searchResult").hide();var t=$(this).attr("uid");studioChat.setWhVisitors(-1!=t.indexOf("visitor_")?-1:0,$(this).attr("cg"),t,$(this).find("label").text(),!$(this).hasClass("off")),$(".visitorDiv ul li[uid="+$(this).attr("uid")+"]").click()})}})}catch(e){alert("查询异常,请联系管理员！"),console.error("getVistiorByName->"+e)}},setWhBox:function(t){t&&$("#newMsgShowBtn").attr("t","hide"),$("#newMsgTipBtn").click()},setWhTipInfo:function(t){t&&$("#newMsgTipBtn").attr("uid",t),studioChat.setWhTipImgPlay(t)},getWhToUser:function(){var t=$(".visitorDiv ul li[class~=on]");return{userId:t.attr("uid"),nickname:t.find("label").text(),talkStyle:1,userType:t.attr("utype")}},sendWhMsg:function(t){var e=studioChat.getSendMsg(t);if(e!==!1){var i={uiId:studioChat.getUiId(),fromUser:studioChat.userInfo,content:{msgType:studioChat.msgType.text,value:e}};i.fromUser.toUser=this.getWhToUser(),studioChat.socket.emit("sendMsg",i),studioChat.setWhContent(i,!0,!1),t.html("")}},setWhOnlineTip:function(t,e,i){if(e){if(i){var s="";"-1"==i.userType&&common.isValid(i.loginId)?(s=$(".visitorDiv ul li[uid="+i.loginId+"]"),s.length>0&&(s.attr("uid",i.userId),s.find(".wrtip").text(""),$("#wh_msg_"+i.loginId).attr("id","wh_msg_"+i.userId))):"0"==i.userType&&common.isValid(i.visitorId)&&(s=$(".visitorDiv ul li[uid="+i.visitorId+"]"),s.find(".wrtip").text(studioChat.getWhUserCGTip(i.userType,i.clientGroup)),s.length>0&&(s.attr("uid",i.userId),$("#wh_msg_"+i.visitorId).attr("id","wh_msg_"+i.userId)));var a=$("#wh_msg_"+t+" .wh-title label").text(),o=$("#wh_msg_"+t+" .wh-title .title-tip");common.isValid(a)&&a!=i.nickname?o.text("账号转变:"+a+" --> "+i.nickname).show():o.text("").hide(),$(".visitorDiv ul li[uid="+t+"] label,#wh_msg_"+t+" .wh-title label").text(i.nickname)}$(".visitorDiv ul li[uid="+t+"]").removeClass("off"),$("#wh_msg_"+t+" .wh-title strong").text("在线")}else $(".visitorDiv ul li[uid="+t+"]").addClass("off"),$("#wh_msg_"+t+" .wh-title strong").text("离线")},getWhUserCGTip:function(t,e){return 0==t?"active"==e?"真实A":"notActive"==e?"真实N":"simulate"==e?"模拟":"register"==e?"注册":"":1==t?"管理员":2==t?"分析师":3==t?"客服":""},setWhVisitors:function(t,e,i,s,a,o){if(0==$(".visitorDiv ul li[uid="+i+"]").length){$(".visitorDiv ul").append('<li uid="'+i+'"  '+(a?"":'class="off"')+' utype="'+t+'"><span  class="user-row"><label>'+s+'</label><em class="close ym" t="0"></em><em class="wrtip">'+studioChat.getWhUserCGTip(t,e)+"</em></span></li>");var n=$(".visitorDiv ul li[uid="+i+"]");if(o){var r=n.find(".close"),l=parseInt(r.attr("t"))+1;r.attr("t",l).text(l).addClass("ym")}n.find(".close").click(function(){var t=$(this).parent().parent();t.remove(),$("#wh_msg_"+t.attr("uid")).remove(),$(".visitorDiv ul li").length>0&&$(".visitorDiv ul li:last").click()}),n.click(function(){$(".visitorDiv ul li").removeClass("on"),$(this).addClass("on"),$(this).find(".close").attr("t",0).text("").removeClass("ym");var t=$(this).attr("uid"),e="wh_msg_"+t,i=$(this).attr("utype");if(studioChat.closeWhTipMsg(t),$(".wh-right").children().hide(),0==$("#"+e).length){var s='<div id="'+e+'" class="wh-tab-msg"><div class="wh-title"><span><label>'+$(this).find("label").text()+'</label>【<strong></strong>】</span><span class="title-tip"></span></div><div class="wh-content"></div><div class="wh-txt"><div class="toolbar"><a href="javascript:" class="facebtn">表情</a><label for="file_'+e+'" class="send-wh-img" title="发送图片"></label><input type="file" id="file_'+e+'" style="position:absolute;clip:rect(0 0 0 0);" class="fileBtn"/></div><div contenteditable="true" class="ctextarea" id="whTxt_'+t+'" data-placeholder="按回车键发送"></div></div></div>';$(".wh-right").append(s),$("#"+e).find(".ctextarea").keydown(function(t){return 13==t.keyCode?(studioChat.sendWhMsg($(this)),!1):void 0}),$("#"+e).find(".facebtn").qqFace({id:"faceId_"+t,zIndex:1e6,assign:"whTxt_"+t,path:studioChat.filePath+"/face/"}),$("#"+e).find(".fileBtn")[0].addEventListener("change",function(){var t=this,e=t.files[0];if(!e)return!1;if(0!=e.type.indexOf("image")||!e.type||!/\.(?:jpg|png|gif)$/.test(e.name.toLowerCase()))return alert("目前暂支持jpg,gif,png格式的图片！"),!1;var i=e.size;if(i>=5242880)return alert("发送的图片大小不要超过5MB."),!1;var s=new FileReader;s.readAsDataURL(e),s.onload=function(t){studioChat.setUploadImg(t.target.result)},s.onprogress=function(t){},s.onloadend=function(t){}},!1),studioChat.socket.emit("getWhMsg",{userType:studioChat.userInfo.userType,groupId:studioChat.userInfo.groupId,groupType:studioChat.userInfo.groupType,userId:studioChat.userInfo.userId,toUser:{userId:t,userType:i}})}else $("#"+e).show(),studioChat.setTalkListScroll(!0,$("#"+e+" .wh-content"),"dark");studioChat.setWhOnlineTip(t,!$(this).hasClass("off"))})}},getWhBox:function(){return $(".window-container[wid=newMsgShowBtn]")},setWhTipImgPlay:function(t){$(".wh_msg_ftip").attr("uid",t).attr("k",1).show().addClass("have"),$("#userListId li[id="+t+"]").attr("k",1),studioChat.whTipIntervalId=setInterval(function(){$("#userListId li[k=1],.wh_msg_ftip[k=1]").toggleClass("have_op")},1e3)},closeWhTipMsg:function(t){$(".wh_msg_ftip[uid="+t+"]").attr("k",0).removeClass("have have_op"),$("#userListId li[id="+t+"]").attr("k",0).removeClass("have_op"),0==$("#userListId[k=1]").length&&0==$(".wh_msg_ftip[k=1]").length&&studioChat.whTipIntervalId&&(clearInterval(studioChat.whTipIntervalId),studioChat.whTipIntervalId=null)},fillWhBox:function(t,e,i,s,a,o){var n=this.getWhBox();if(0==n.length)return studioChat.setWhBox(!0),studioChat.setWhVisitors(t,e,i,s,!0,o),a&&studioChat.setWhTipInfo(i),!1;var r=$(".visitorDiv ul li[uid="+i+"]");if(0==r.length){if(studioChat.setWhVisitors(t,e,i,s,!0,o),!n.is(":hidden"))return!1;a&&studioChat.setWhTipInfo(i)}else{if(o&&!r.hasClass("on")){var l=r.find(".close"),u=parseInt(l.attr("t"))+1;l.attr("t",u).text(u).addClass("ym")}if(n.is(":hidden")){var d=$("#wh_msg_"+i+" .wh-content");if(0==d.length)return!1;a&&studioChat.setWhTipImgPlay(i)}else!r.hasClass("on")&&a&&studioChat.setWhTipImgPlay(i)}return!0},setWhContent:function(t,e,i){var s=t.fromUser,a="dialog ",o=t.content,n="",r="",l="";if(t.rule)return void $("#"+t.uiId+" .dcont").append('<em class="ruleTipStyle">'+t.value.tip+"</em>");if(i||(s.toWhUserId=s.userId),studioChat.userInfo.userId==s.userId){if(e&&(s.publishTime=t.uiId,s.toWhUserId=s.toUser.userId,l='<em class="img-loading"></em>',r='<span class="shadow-box"></span><s class="shadow-conut"></s>'),t.serverSuccess){if($("#"+t.uiId+" .dtime").html(studioChat.formatPublishTime(s.publishTime)),$("#"+t.uiId).attr("id",s.publishTime),t.content.msgType==studioChat.msgType.img){studioChat.removeLoadDom(s.publishTime);var u=$("#"+s.publishTime+" p"),d=t.content.needMax?"/studio/getBigImg?publishTime="+s.publishTime+"&userId="+s.userId:u.find("a img").attr("src");u.find("a[class=swipebox]").attr("href",d),$(".swipebox").swipebox()}return}a+="mine",n='<span class="wh-dia-title"><label class="dtime">'+studioChat.formatPublishTime(s.publishTime,i,"/")+'</label><label class="wh-nk">我</label></span>'}else{if(!i){var h=this.fillWhBox(s.userType,s.clientGroup,s.userId,s.nickname,!0,!0);if($(".visitorDiv ul").prepend($(".visitorDiv ul li[uid="+s.toWhUserId+"]")),!h)return}n='<span class="wh-dia-title"><label class="wh-nk">'+s.nickname+'</label><label class="dtime">'+studioChat.formatPublishTime(s.publishTime,i,"/")+"</label></span>"}if(common.isBlank(s.toWhUserId))return void console.error("setWhContent->fromUser toWhUserId is null,please check!");var c="",p=$("#wh_msg_"+s.toWhUserId+" .wh-content"),m=p.find(".mCSB_container"),f="";o.msgType==studioChat.msgType.img?(c=o.needMax?'<p><a href="/studio/getBigImg?publishTime='+s.publishTime+"&userId="+s.userId+'" class="swipebox" ><img src="'+o.value+'" alt="图片"/></a>'+r+"</p>":'<p><a href="'+o.value+'" class="swipebox" ><img src="'+o.value+'" alt="图片" /></a>'+r+"</p>",c+=l):(!e&&common.isValid(s.toUser.question)&&(f='<div class="dialog mine"><div><span class="wh-dia-title"><label class="dtime">'+studioChat.formatPublishTime(s.toUser.publishTime,i,"/")+'</label><label class="wh-nk">我</label></span></div><div class="whblt">'+s.toUser.question+"</div></div>",m.length>0?m.append(f):p.append(f)),c='<p><span class="dcont">'+o.value+"</span></p>"),f='<div class="'+a+'" id="'+s.publishTime+'" utype="'+s.userType+'" mType="'+o.msgType+'" t="header"><div>'+n+"</div>"+c+"</div>",m.length>0?m.append(f):p.append(f),this.formatMsgToLink(s.publishTime),i||studioChat.setTalkListScroll(!0,p,"dark")},clearPasteImg:function(){$(".paste-img").is(":hidden")||$(".paste-img").hide().find("img").attr("src","").attr("h",120).attr("w",100)},setUploadImg:function(t){var e=studioChat.getUiId(),i={};common.copyObject(i,studioChat.userInfo,!0),i.toUser=this.getWhToUser();var s={uiId:e,fromUser:i,content:{msgType:studioChat.msgType.img,value:"",needMax:0,maxValue:""}};studioChat.setWhContent(s,!0,!1),s.content.value=t,studioChat.zipImg(s,100,60,function(t,i){if(t.error)return alert(t.error),$("#"+e).remove(),!1;var s=$("#"+t.uiId+" img");s.attr("src",i).attr("needMax",t.content.needMax),studioChat.dataUpload(t)})},zipImg:function(t,e,i,s){var a=new Image;a.onload=function(){var o=document.createElement("canvas");o||s({error:"发送图片功能目前只支持Chrome、Firefox、IE10或以上版本的浏览器！"});var n=a.width,r=a.height;if(r>=9*n)return s({error:"该图片高度太高，暂不支持发送！"}),!1;e>0&&(r>e||n>e)&&(t.content.needMax=1,r>e&&e>=n?(n=e/r*n,r=e):(r=e/n*r,n=e),a.height=r,a.width=n);var l=o.getContext("2d");o.width=n,o.height=r,l.clearRect(0,0,o.width,o.height),l.drawImage(a,0,0,n,r),s(t,o.toDataURL("image/jpeg",i/100))},a.src=t.content.value},dataUpload:function(t){var e=new XMLHttpRequest;e.open("POST","/studio/uploadData"),e.addEventListener("progress",function(e){if(e.lengthComputable){var i=(e.loaded/e.total*100|0)+"%";$("#"+t.uiId+" .shadow-box").css({height:"'+ra+'"}),$("#"+t.uiId+" .shadow-conut").html(i)}},!1),e.setRequestHeader("Content-Type","application/json; charset=utf-8"),e.onreadystatechange=function(){4===e.readyState&&200===e.status&&console.log("dataUpload success!")},t.fromUser.socketId=studioChat.socket.id,e.send(JSON.stringify(t))},setEvent:function(){$("#header_img_id").attr("src",studioChat.userInfo.avatar);var t=$("#groupInfoId"),e=t.attr("awr"),i=t.attr("aw");"true"==i&&common.containSplitStr(e,studioChat.userInfo.userType)&&$(".wh_msg_ftip").show(),jqWindowsEngineZIndex=1e5,$("#newMsgTipBtn").click(function(){var t=$(this).attr("uid");studioChat.closeWhTipMsg(t);var e=studioChat.getWhBox();if(e.length>0)return e.show(),void $(".visitorDiv ul li[uid="+t+"]").click();var i=[];i.push('<div class="wh-box"><div class="wh-left"><div class="searchDiv">'),i.push('<input type="text" id="vSearchTxt"/><a href="javascript:" id="vSearchTxtBtn"><em></em></a>'),i.push('<div class="searchResult"><ul></ul></div></div><div class="visitorDiv">'),i.push('<ul></ul></div></div><div class="wh-right"></div></div>'),$("#newMsgShowBtn").newWindow({windowTitle:"私聊",content:i.join(""),windowType:"normal",minimizeButton:!0,maximizeButton:!1,statusBar:!1,resizeIcon:"",width:680,height:550,beforeMinimize:function(t){return t.hide(),!1}}),$("#newMsgShowBtn").click(),$("#vSearchTxt").keydown(function(t){13==t.keyCode&&studioChat.getVisitorList(this.value)}),$("#vSearchTxtBtn").click(function(){studioChat.getVisitorList($("#vSearchTxt").val())})}),$(".wh_msg_ftip").click(function(){var t=$(this).attr("uid");studioChat.closeWhTipMsg(t);var e=studioChat.getWhBox();e.length>0?($(".visitorDiv ul li[uid="+t+"]").click(),e.show()):$("#newMsgTipBtn").click()}),$("#approveAllHandler button").click(function(){var t=[],e=[];return $("#dialog_list .approve input:checked").each(function(){var i=$(this).parents("div");t.push(i.attr("id"));for(var s=i.attr("fuId"),a=!1,o=0,n=e.length;n>o;o++)if(s===e[o]){a=!0;break}a||e.push(s)}),0==t.length?(alert("请选择聊天记录！"),!1):void studioChat.socket.emit("approvalMsg",{fromUser:studioChat.userInfo,status:$(this).attr("btnType"),publishTimeArr:t,fuIdArr:e})}),$("#approveCheckAll").click(function(){var t=$(this).prop("checked");$("#dialog_list .approve input[type=checkbox]").each(function(){$(this).prop("checked",t)})}),$("#close-top-box").click(function(){$(".top-box").hide()}),$("#show_top_btn").click(function(){$(".top-box").toggle()}),$(document).click(function(t){$("div[id^=faceId]").hide(),$(t.target).hasClass("headimg")||$(t.target).parent().hasClass("headimg")||"header"==$(t.target).parent().attr("t")||$(t.target).hasClass("uname")||$(".dialogbtn").hide(),$(t.target).hasClass("searchResult")||$(".searchResult").hide()}),$(".facebtn").qqFace({id:"faceId",assign:"contentText",path:studioChat.filePath+"/face/"}),$(".replybtn").click(function(){studioChat.setDialog(null,$(this).attr("uid"),$(".sender").html(),$(this).attr("ts"),$(this).attr("utype"),$(this).attr("tm")),$(".mymsg em").show()}),$(".closebtn").click(function(){$(".mymsg,.mymsg em").hide()}),$(".clearbtn").click(function(){$("#dialog_list").html(""),studioChat.setTalkListScroll()}),$(".scrollbtn").click(function(){$(this).hasClass("on")?$(this).removeClass("on"):($(this).addClass("on"),studioChat.setTalkListScroll(!0))}),$(".view_select .se_cont").hover(function(){$(this).parent().addClass("dw")},function(){$(this).parent().removeClass("dw")}).find(".selectlist a").click(function(){$(this).is(".on")||($(".view_select .selectlist a").removeClass("on"),$(".view_select .selected").text($(this).text()),$(this).addClass("on"),studioChat.showViewSelect($(this).attr("t")),studioChat.setTalkListScroll(!0))}),$("#contentText").keydown(function(t){if(13==t.keyCode)return $("#sendBtn").click(),!1;if(8==t.keyCode){var e=$(this).find(".txt_dia");if($.trim($(this).text())==e.text())return e.remove(),$(this).html(""),!0}}).autocomplete({source:function(t,e){/^@.*$/g.test(t.term)&&e(studioChat.searchUserList(t.term.substring(1,t.term.length)))},delay:500,minLength:2,position:{my:"left bottom",at:"left top"},select:function(t,e){return $("#contentText").html("").append('<span class="txt_dia" contenteditable="false" uid="'+e.item.value+'" utype="'+e.item.userType+'">@<label>'+e.item.label+"</label></span>&nbsp;").focusEnd(),!1}}).autocomplete("instance")._renderItem=function(t,e){return $("<li>").append("<a>"+e.label+"</a>").appendTo(t)},$("#sendBtn").click(function(){var t=studioChat.getToUser(),e=studioChat.getSendMsg();if(e!==!1){var i={uiId:studioChat.getUiId(),fromUser:studioChat.userInfo,content:{msgType:studioChat.msgType.text,value:e}};i.fromUser.toUser=t,studioChat.socket.emit("sendMsg",i),studioChat.setContent(i,!0,!1),$("#contentText").html("")}})},searchUserList:function(t){var e=$("#userListId li[t!=14][t!=0]").map(function(){var e=$(this).find(".uname").text();return-1!=e.indexOf(t)?{value:this.id,label:e,userType:$(this).attr("utype")}:null}).get();return e},showViewSelect:function(t){"analyst"==t?($("#dialog_list").children("[utype!=2]").hide(),$("#dialog_list").children("[utype=2]").show()):"me"==t?($("#dialog_list").children("[isMe=false]").hide(),$("#dialog_list").children("[isMe=true]").show()):$("#dialog_list").children().show()},getSendMsg:function(t){var t=t?t:$("#contentText"),e=t.find(".txt_dia");t.find(".txt_dia").length>0&&(studioChat.setTalkTop(!1,{publishTime:e.attr("tm")}),t.find(".txt_dia").remove());var i=common.clearMsgHtml(t.html());return common.isBlank(i)?(t.html(""),!1):i},setListScroll:function(t){$(t).hasClass("mCustomScrollbar")?$(t).mCustomScrollbar("update"):$(t).mCustomScrollbar({scrollButtons:{enable:!0},theme:"dark"})},setTalkListScroll:function(t,e,i){var s=e?e:$("#chatMsgContentDiv");s.hasClass("mCustomScrollbar")?(s.mCustomScrollbar("update"),t&&s.mCustomScrollbar("scrollTo","bottom")):(s.mCustomScrollbar({scrollInertia:1,scrollButtons:{enable:!0},theme:i?i:"light-2"}),s.mCustomScrollbar("scrollTo","bottom"))},getToUser:function(){var t=$("#contentText .txt_dia");return t.length>0?{userId:t.attr("uid"),nickname:t.find("label").text(),talkStyle:0,userType:t.attr("utype")}:null},formatPublishTime:function(t,e,i){var s=Number(t.replace(/_.+/g,""));return common.isBlank(t)?"":e?common.formatterDateTime(s,i):common.getHHMM(s)},setDialog:function(t,e,i,s,a,o){1==s?(studioChat.fillWhBox(a,t,e,i,!1),studioChat.getWhBox().show(),$(".visitorDiv ul li[uid="+e+"]").click()):($("#contentText .txt_dia").remove(),$("#contentText").html($("#contentText").html().replace(/^((&nbsp;)+)/g,"")),$("#contentText").prepend('<span class="txt_dia" contenteditable="false" uid="'+e+'" tm="'+o+'" utype="'+a+'">@<label>'+i+"</label></span>&nbsp;").focusEnd(),$("#talk_top_id .ss-tk-info[tm="+o+"]").find("strong").addClass("reply-st"))},setContent:function(t,e,i){var s=t.fromUser;if(e&&(s.publishTime=t.uiId),i&&$("#"+s.publishTime).length>0)return $("#"+s.publishTime+" .dcont em[class=ruleTipStyle]").remove(),void $("#"+s.publishTime+" .approve").remove();if(t.rule)return void(t.value&&t.value.needApproval?$("#"+t.uiId).attr("id",s.publishTime):$("#"+t.uiId+" .dcont").append('<em class="ruleTipStyle">'+t.value.tip+"</em>"));if(!e&&studioChat.userInfo.userId==s.userId&&t.serverSuccess)return $("#"+t.uiId+" .dtime").html(studioChat.formatPublishTime(s.publishTime)),void $("#"+t.uiId).attr("id",s.publishTime);var a=studioChat.formatContentHtml(t,e,i),o=$("#dialog_list");o.append(a),this.formatMsgToLink(s.publishTime);var n=$(".view_select .selectlist a[class=on]").attr("t");"all"!=n&&studioChat.showViewSelect(n),!i&&$(".scrollbtn").hasClass("on")&&studioChat.setTalkListScroll(!0),$("#"+s.publishTime+" .headimg").click(function(){var t=$(this).parent(),e=t.find(".dialogbtn");e.attr("tm",t.attr("id")),studioChat.openDiaLog(e)}),$("#"+s.publishTime+" .uname").click(function(){var t=$(this).parent().parent(),e=t.find(".dialogbtn");e.attr("tm",t.attr("id")),studioChat.openDiaLog(e),e.css("left","62px"),e.css("top","30px")}),$("#"+s.publishTime+" .txt_dia").click(function(){studioChat.setDialog(null,$(this).attr("uid"),$(this).find("label").text(),0,$(this).attr("utype"))}),$("#"+s.publishTime+" .approve button").click(function(){var t=[],e=[],i=$(this).parents("div");t.push(i.attr("id")),e.push(i.attr("fuId")),studioChat.socket.emit("approvalMsg",{fromUser:studioChat.userInfo,status:$(this).attr("btnType"),publishTimeArr:t,fuIdArr:e})})},openDiaLog:function(t){$(".dialogbtn").not(t).hide(),t.css("left","0");var e=t.parent();if(common.isValid(e.attr("utype"))){var i=0===e.next().size();t.parent().hasClass("analyst")?t.css("top",i?"-67px":"53px"):t.css("top",i?"-39px":"39px")}return t.is(":hidden")?(t.show(),void t.find("a").click(function(){var t=$(this).parent();studioChat.setDialog(t.attr("cg"),t.attr("uId"),t.attr("nk"),$(this).attr("t"),t.attr("utype"),t.attr("tm")),t.hide()})):(t.hide(),!1)},formatContentHtml:function(t,e,i){var s="dialog ",a="",o="",n="uname ",r="false",l=t.fromUser,u=t.content,d=l.nickname,h=l.toUser,c="";h&&common.isValid(h.userId)&&(c='<span class="txt_dia" uid="'+h.userId+'" utype="'+h.userType+'">@<label>'+h.nickname+"</label></span>",studioChat.userInfo.userId==h.userId&&(r="true")),a=u.value,studioChat.userInfo.userId==l.userId?(s+="mine",d="我",r="true"):(2==l.userType&&(s+="analyst"),1==l.userType&&(s+="admin"),o=studioChat.getDialogHtml(l.clientGroup,l.userId,d,l.userType,l.isMobile),!i&&h&&studioChat.userInfo.userId==h.userId&&studioChat.setTalkTop(!0,t));var p='<div class="'+s+'" id="'+l.publishTime+'" isMe="'+r+'" utype="'+l.userType+'" mType="'+u.msgType+'" t="header"><a href="javascript:" class="headimg" uId="'+l.userId+'">'+studioChat.getUserAImgCls(l.clientGroup,l.userType,l.avatar)+'</a><i></i><p><a href="javascript:"  class="'+n+'">'+d+'</a><span class="dtime">'+studioChat.formatPublishTime(l.publishTime)+"</span>";return 0==u.status&&(p+='<span class="approve"><input type="checkbox"/><button btnType="1">通过</button><button btnType="2">拒绝</button></span>',$("#approveAllHandler").show()),p+='<span class="dcont">'+c+a+"</span></p>"+o+"</div>"},formatMsgToLink:function(t){$("#"+t+' .dcont:contains("http:"),#'+t+' .dcont:contains("https:")').each(function(t,e){var i=$(e).html(),s=i.split(/<img src="\S+">/g),a="";for(var o in s)if(a=s[o],!common.isBlank(a)){var n=a.replace(/(http:\/\/|https:\/\/)((\w|=|\?|\.|\/|\\&|-)+)(:\d+)?(\/|\S)+/g,function(t){return'<a href="'+t+'" target="_blank" style="color:#3181c6;">'+t+"</a>"});e.innerHTML=e.innerHTML.replace(a,n)}})},removeLoadDom:function(t){$("#"+t+" .img-loading,#"+t+" .img-load-gan,#"+t+" .shadow-box,#"+t+" .shadow-conut").remove()},getUserAImgCls:function(t,e,i){var s="";return e&&0!=e&&common.isValid(i)?'<img src="'+i+'">':(s="vip"==t?"user_v":"real"==t?"user_r":"simulate"==t?"user_d":"register"==t?"user_m":"user_c",'<img src="/images/studio/'+s+'.png">')},getDialogHtml:function(t,e,i,s,a){if(studioChat.userInfo.userId!=e&&-1==studioChat.userInfo.userId.indexOf("visitor_")){var o=!1,n=$("#groupInfoId"),r='<div class="dialogbtn" style="display:none;" cg="'+t+'" nk="'+i+'" uId="'+e+'" utype="'+s+'">';return r+='<a href="javascript:" class="d1" t="0"><span>@TA</span></a>',o=!0,!a&&"true"==n.attr("aw")&&common.containSplitStr(n.attr("awr"),studioChat.userInfo.userType)&&(r+='<a href="javascript:" class="d2" t="1"><span>私聊</span></a>',o=!0),o?r+"</div>":""}return""},setOnlineUser:function(t){$("#userListId li[id='"+t.userId+"']").remove();var e=studioChat.getDialogHtml(t.clientGroup,t.userId,t.nickname,t.userType,t.isMobile),i="",s=t.sequence,a=t.isMobile?'<em class="mb-cls">(mb)</em>':"";studioChat.userInfo.userId==t.userId&&(i="【我】",a="",s=0);var o=$("#userListId li"),n='<li id="'+t.userId+'" t="'+s+'" utype="'+t.userType+'"  ismb="'+t.isMobile+'">'+e+'<a href="javascript:" t="header" class="uname"><div class="headimg">'+studioChat.getUserAImgCls(t.clientGroup,t.userType,t.avatar)+'</div><label class="nk-lb">'+t.nickname+i+"</label>"+a+"</a></li>";if(0==o.length)$("#userListId").append(n);else if(""!=i)o.first().before(n);else{var r=!1,l=0,u="";o.each(function(){return l=parseInt($(this).attr("t")),t.sequence<l?($(this).before(n),r=!0,!1):t.sequence==l&&(u=$(this).find("a").text(),t.nickname<=u)?($(this).before(n),r=!0,!1):void 0}),r||$("#userListId").append(n)}return common.isValid(e)&&$("#userListId li[id="+t.userId+"] a[t=header]").click(function(){var t=$(this).parent();studioChat.closeWhTipMsg(t.attr("id")),$(".dialogbtn").hide(),$(".user_box li").removeClass("zin"),t.addClass("zin"),studioChat.openDiaLog($(this).prev()),$(".dialogbtn",$(this).parent()).css("left","7px")}),!0},leaveRoomTip:function(t){if("visitor"!=studioChat.userInfo.clientGroup){var e="";"roomClose"==t&&(e="房间已停用，"),"otherLogin"==t&&(e="您的账号已在其他地方进入该房间，"),"forcedOut"==t&&(e="您已被管理员强制退出房间，"),$("#tipMsgBox").fadeIn(0).delay(6e3).fadeOut(200).find("span").text("注意："+e+"正自动退出....."),window.setTimeout(function(){window.close()},3e3)}},setSocket:function(){this.socket=common.getSocket(io,this.socketUrl,this.userInfo.groupType),this.socket.on("connect",function(){console.log("connected to server!"),studioChat.userInfo.socketId=studioChat.socket.id;var t=$("#groupInfoId");studioChat.socket.emit("login",{userInfo:studioChat.userInfo,lastPublishTime:$("#content_ul li:last").attr("id"),fUserTypeStr:t.attr("awr"),allowWhisper:t.attr("aw")}),$(".img-loading[pf=chatMessage]").show()}),this.socket.on("onlineUserList",function(t,e){$("#userListId").html("");var i=null;for(var s in t)i=t[s],studioChat.setOnlineUser(i);$("#onLineSizeNum").text(e),studioChat.setListScroll(".user_box")}),this.socket.on("disconnect",function(t){console.log("disconnect")}),this.socket.on("error",function(t){console.error("e:"+t)}),this.socket.on("sendMsg",function(t){t.fromUser.toUser&&1==t.fromUser.toUser.talkStyle?(studioChat.setWhContent(t,!1,!1),t.content.msgType==studioChat.msgType.img&&$(".swipebox").swipebox()):studioChat.setContent(t,!1,!1)}),this.socket.on("notice",function(t){switch(t.type){case"onlineNum":var e=t.data,i=e.onlineUserInfo;e.online?studioChat.setOnlineUser(i):studioChat.userInfo.userId!=i.userId&&($("#userListId #"+i.userId).remove(),studioChat.setListScroll(".user_box")),$("#onLineSizeNum").text($("#userListId li").length),studioChat.setWhOnlineTip(i.userId,e.online,i);break;case"removeMsg":$("#"+t.data.replace(/,/g,",#")).remove(),studioChat.setTalkListScroll();break;case"leaveRoom":studioChat.leaveRoomTip(t.flag);break;case"approvalResult":var e=t.data;if(e.fromUserId==studioChat.userInfo.userId)if(e.isOK){var s=e.publishTimeArr;if(2==e.status){for(var a in s)$("#"+s[a]).remove();studioChat.setTalkListScroll()}else for(var a in s)$("#"+s[a]+" .approve").remove();$("#approveCheckAll").prop("checked",!1),0==$("#dialog_list .approve").size()&&$("#approveAllHandler").hide()}else alert("操作出现异常，请重新执行！");else if(e.refuseMsg){var s=e.publishTimeArr;for(var a in s)$("#"+s[a]).remove();studioChat.setTalkListScroll()}else{for(var a in e)studioChat.formatUserToContent(e[a]);studioChat.setTalkListScroll(!0)}}}),this.socket.on("loadMsg",function(t){$(".img-loading[pf=chatMessage]").hide();var e=t.msgData,i=t.isAdd;if(i||$("#content_ul").html(""),e&&$.isArray(e)){e.reverse();for(var s in e){var a=e[s];a.content.status=a.status,studioChat.formatUserToContent(a)}studioChat.setTalkListScroll(!0)}}),this.socket.on("loadWhMsg",function(t){var e=t.data;if("offline"==t.type){if(e&&!$.isEmptyObject(e)){studioChat.setWhBox(!0);var i="";for(var s in e)i=s,studioChat.setWhVisitors(e[s].userType,e[s].clientGroup,s,e[s].nickname,$("#userListId li[id='"+s+"']").length>0);studioChat.setWhTipInfo(i)}}else if(e&&$.isArray(e)){var a=0,o=null;e.reverse();for(var n in e)o=e[n],studioChat.formatUserToContent(o,!0,t.toUserId),o.content.msgType==studioChat.msgType.img&&a++;a>0&&$(".swipebox").swipebox(),studioChat.setTalkListScroll(!0,$("#wh_msg_"+t.toUserId+" .wh-content"),"dark")}})},formatUserToContent:function(t,e,i){var s={userId:t.userId,nickname:t.nickname,avatar:t.avatar,userType:t.userType,groupId:t.groupId,clientGroup:t.clientGroup,publishTime:t.publishTime,toUser:t.toUser,avatar:t.avatar};e?(s.toWhUserId=i,studioChat.setWhContent({fromUser:s,content:t.content},!1,!0)):studioChat.setContent({fromUser:s,content:t.content},!1,!0)}};$(function(){studioChat.init()});