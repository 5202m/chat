var studioChat={filePath:"",apiUrl:"",msgType:{text:"text",img:"img",file:"file"},socket:null,socketUrl:"",userInfo:null,oldTalkDivH:0,newTalkDivH:0,init:function(){this.setEvent(),this.setSocket(),this.setVideo()},setVideo:function(){try{if(0==$("#yyVideoDiv embed").length){var t=$("#yyVideoDiv"),e=t.attr("yc"),s=t.attr("mc");$('<embed src="http://yy.com/s/'+e+(common.isValid(s)?"/"+s:"")+'/mini.swf" quality="high" width="100%" height="100%" align="middle" allowScriptAccess="never" allowFullScreen="true" mode="transparent" type="application/x-shockwave-flash"></embed>').appendTo("#yyVideoDiv")}$("#yyVideoDiv").show()}catch(i){console.error("setVideo has error:"+i)}},getUiId:function(){var t=new Date;return t.getTime()+"_ms"},setEvent:function(){$("#header_img_id").attr("src",studioChat.userInfo.avatar),$("#approveAllHandler button").click(function(){var t=[],e=[];return $("#dialog_list .approve input:checked").each(function(){var s=$(this).parents("div");t.push(s.attr("id"));for(var i=s.attr("fuId"),a=!1,o=0,n=e.length;n>o;o++)if(i===e[o]){a=!0;break}a||e.push(i)}),0==t.length?(alert("请选择聊天记录！"),!1):void studioChat.socket.emit("approvalMsg",{fromUser:studioChat.userInfo,status:$(this).attr("btnType"),publishTimeArr:t,fuIdArr:e})}),$("#approveCheckAll").click(function(){var t=$(this).prop("checked");$("#dialog_list .approve input[type=checkbox]").each(function(){$(this).prop("checked",t)})}),$("#contentText").keydown(function(t){if(13==t.keyCode){var e=$("#contentText").html();common.isValid(e)&&$("#contentText").html(e.replace(/<div>|<\/div>/g,""))}}),$(document).click(function(t){$("#faceId").hide().remove(),$(t.target).hasClass("headimg")||$(t.target).parent().hasClass("headimg")||"header"==$(t.target).parent().attr("t")||$(t.target).hasClass("uname")||$(".dialogbtn").hide()}),$(".facebtn").qqFace({id:"faceId",assign:"contentText",path:studioChat.filePath+"/face/"}),$(".replybtn").click(function(){studioChat.setDialog($(this).attr("uId"),$(".sender").html(),$(this).attr("ts"),$(this).attr("futype"))}),$(".closebtn").click(function(){$(".mymsg").hide()}),$(".clearbtn").click(function(){$("#dialog_list").html(""),studioChat.setTalkListScroll()}),$(".scrollbtn").click(function(){$(this).hasClass("on")?$(this).removeClass("on"):(studioChat.setTalkListScroll(),$(this).addClass("on"))}),$(".view_select").hover(function(){$(this).addClass("dw")},function(){$(this).removeClass("dw")}).find(".selectlist a").click(function(){$(this).is(".on")||($(".view_select .selectlist a").removeClass("on"),$(".view_select .selected").text($(this).text()),$(this).addClass("on"),"analyst"==$(this).attr("t")?($("#dialog_list").children("[utype!=2]").hide(),$("#dialog_list").children("[utype=2]").show()):"me"==$(this).attr("t")?($("#dialog_list").children("[isMe=false]").hide(),$("#dialog_list").children("[isMe=true]").show()):$("#dialog_list").children().show(),studioChat.setTalkListScroll())}),$(".send_select").hover(function(){$(this).addClass("dw"),studioChat.setUserListScroll()},function(){$(this).removeClass("dw")}),$("#send_selelct_list a").bind("click",function(){$(this).is(".on")||($(".send_select div.selectlist a").removeClass("on"),$(".send_select div.selected").text($(this).text()),$(this).addClass("on"))}),$("#contentText").keydown(function(t){if(13==t.keyCode){var e=$("#contentText").html();return common.isValid(e)&&($("#contentText").html(e.replace(/<div>|<\/div>/g,"")),$("#sendBtn").click()),!1}}),$("#sendBtn").click(function(){var t=studioChat.getSendMsg();if(t!==!1){var e={uiId:studioChat.getUiId(),fromUser:studioChat.userInfo,content:{msgType:studioChat.msgType.text,value:t}},s=studioChat.getToUser(),i=$(".replybtn");s&&s.userId==i.attr("uId")&&s.talkStyle==i.attr("ts")&&$(".mymsg").hide(),e.fromUser.toUser=s,studioChat.socket.emit("sendMsg",e),studioChat.setContent(e,!0,!1),$("#contentText").html("")}})},getSendMsg:function(){var t=$("#contentText").html();return t=t.replace(/<\/?(?!(img|IMG)\s+src="[^>"]+\/face\/[^>"]+"\s*>)[^>]*>/g,""),common.isBlank(t)?($("#contentText").html(""),!1):t},setUserListScroll:function(){$(".scrollbox").jscroll({W:"6px",BgUrl:"url(/images/studio/scroll.png)",Bg:"0 0 repeat-y",Bar:{Pos:"up",Bd:{Out:"#b3cfe2",Hover:"#4e90bd"},Bg:{Out:"-10px center repeat-y",Hover:"-20px center repeat-y",Focus:"-20px center repeat-y"}},Btn:{btn:!1}}),$(".jscroll-h,.jscroll-e").css({border:"0",width:"6px"})},setTalkListScroll:function(t){var e=$("#dialog_list").height(),s=$(".scrollbox2").height(),i="down";s>e&&(i="up"),$(".scrollbox2").jscroll({W:"6px",BgUrl:"url(/images/studio/scroll2.png)",Bg:"0 0 repeat-y",Bar:{Pos:i,isCurr:t,Bd:{Out:"#b3cfe2",Hover:"#4e90bd"},Bg:{Out:"-10px center repeat-y",Hover:"-20px center repeat-y",Focus:"-20px center repeat-y"}},Btn:{btn:!1},Fn:function(){!$(".scrollbtn").hasClass("on")&&studioChat.newTalkDivH>studioChat.oldTalkDivH&&studioChat.newTalkDivH>350&&(studioChat.setTalkListScroll(!0),studioChat.oldTalkDivH=studioChat.newTalkDivH)}}),$(".jscroll-h,.jscroll-e").css({border:"0",width:"6px"})},getToUser:function(){var t=$("#send_selelct_list a[class=on]"),e=t.attr("uId"),s=t.attr("ts"),i=t.attr("utype");return"all"!=e?{userId:e,nickname:t.find("label[t=nk]").html(),talkStyle:s,userType:i}:null},formatPublishTime:function(t){return common.isBlank(t)?"":common.getHHMM(Number(t.replace(/_.+/g,"")))},setDialog:function(t,e,s,i){$(".send_select div.selectlist a").removeClass("on");var a=$(".send_select div.selectlist a[uId="+t+"]"),o="1"==s?" (私聊)":"";if($(".send_select div.selected").text(e+o),a.length>0)a.find("label[t=wh]").html(o),a.attr("ts",s),a.addClass("on");else{var n=$('<a href="javascript:void(0)" class="on" uId="'+t+'" ts="'+s+'" utype="'+i+'"><label t="nk">'+e+'</label><label t="wh">'+o+"</label></a>");$("#send_selelct_list").append(n),n.click(function(){$(this).is(".on")||($(".send_select div.selectlist a").removeClass("on"),$(".send_select div.selected").text($(this).text()),$(this).addClass("on"))})}},setContent:function(t,e,s){var i=t.fromUser;if(e&&(i.publishTime=t.uiId),t.isVisitor)return $("#"+t.uiId).remove(),void studioChat.openLoginBox();if(s&&$("#"+i.publishTime).length>0)return $("#"+i.publishTime+" .talk-content p em[class=ruleTipStyle]").remove(),void $("#"+i.publishTime+" .approve").remove();if(t.rule)return void(t.value&&t.value.needApproval?$("#"+t.uiId).attr("id",i.publishTime):$("#"+t.uiId+" .talk-content p").append('<em class="ruleTipStyle">'+t.value.tip+"</em>"));if(!e&&studioChat.userInfo.userId==i.userId&&t.serverSuccess)return $("#"+t.uiId).attr("id",i.publishTime),void $("#"+t.uiId+" .dtime").html(studioChat.formatPublishTime(i.publishTime));var a=studioChat.formatContentHtml(t,e,s),o=$("#dialog_list");o.append(a),!s&&$(".scrollbtn").hasClass("on")&&studioChat.setTalkListScroll(),$("#"+i.publishTime+" .headimg").click(function(){studioChat.openDiaLog($("#"+i.publishTime+" .dialogbtn"))}),$("#"+i.publishTime+" .uname").click(function(){var t=$("#"+i.publishTime+" .dialogbtn");studioChat.openDiaLog(t),t.css("left","62px"),t.css("top","30px")}),$("#"+i.publishTime+" .approve button").click(function(){var t=[],e=[],s=$(this).parents("div");t.push(s.attr("id")),e.push(s.attr("fuId")),studioChat.socket.emit("approvalMsg",{fromUser:studioChat.userInfo,status:$(this).attr("btnType"),publishTimeArr:t,fuIdArr:e})});var n=$(".view_select .se_cont a[class=on]");"on"!=n.attr("t")&&n.click(),studioChat.newTalkDivH=$("#dialog_list").height()},openDiaLog:function(t){$(".dialogbtn").not(t).hide(),t.css("left","0");var e=t.parent();if(common.isValid(e.attr("utype"))){var s=0===e.next().size();t.parent().hasClass("analyst")?t.css("top",s?"-67px":"53px"):t.css("top",s?"-39px":"39px")}return t.is(":hidden")?(t.show(),void t.find("a").click(function(){var t=$(this).parent();studioChat.setDialog(t.attr("uId"),t.attr("nk"),$(this).attr("t"),t.attr("utype")),t.hide()})):(t.hide(),!1)},formatContentHtml:function(t,e,s){var i="dialog ",a="",o="",n="uname ",r="false",l=t.fromUser,d=t.content,u=l.nickname,c=l.toUser,h="";c&&common.isValid(c.userId)&&(h='<span class="to">对<b class="toname" uId="'+c.userId+'">'+c.nickname+(1==c.talkStyle?" (私聊)":"")+"</b></span>",studioChat.userInfo.userId==c.userId&&(r="true")),a=d.value,studioChat.userInfo.userId==l.userId?(i+="mine",u="我",r="true"):(2==l.userType&&(i+="analyst"),1==l.userType&&(i+="admin"),o=studioChat.getDialogHtml(l.userId,u,l.userType),!s&&c&&studioChat.userInfo.userId==c.userId&&($(".mymsg").show(),$(".replybtn").attr("uId",l.userId),$(".replybtn").attr("ts",c.talkStyle),$(".replybtn").attr("futype",l.userType),$(".sender").html(l.nickname),$(".xcont").html(a)));var p='<div class="'+i+'" id="'+l.publishTime+'" isMe="'+r+'" utype="'+l.userType+'" mType="'+d.msgType+'" t="header"><a href="javascript:" class="headimg" uId="'+l.userId+'">'+studioChat.getUserAImgCls(l.clientGroup,l.userType,l.avatar)+'</a><i></i><p><a href="javascript:"  class="'+n+'">'+u+"</a>"+h+'<span class="dtime">'+studioChat.formatPublishTime(l.publishTime)+"</span>";return 0==d.status&&(p+='<span class="approve"><input type="checkbox"/><button btnType="1">通过</button><button btnType="2">拒绝</button></span>',$("#approveAllHandler").show()),p+='<span class="dcont">'+a+"</span></p>"+o+"</div>"},removeLoadDom:function(t){$("#"+t+" .img-loading,#"+t+" .img-load-gan,#"+t+" .shadow-box,#"+t+" .shadow-conut").remove()},getUserAImgCls:function(t,e,s){var i="";return e&&0!=e&&common.isValid(s)?'<img src="'+s+'">':(i="vip"==t?"user_v":"real"==t?"user_r":"simulate"==t?"user_d":"register"==t?"user_m":"user_c",'<img src="/images/studio/'+i+'.png">')},getDialogHtml:function(t,e,s){return studioChat.userInfo.userId!=t&&-1==studioChat.userInfo.userId.indexOf("visitor_")&&-1==t.indexOf("visitor_")?'<div class="dialogbtn" style="display:none;" nk="'+e+'" uId="'+t+'" utype="'+s+'"><a href="javascript:" class="d1" t="0"><span><b></b>对话</span></a>'+("true"==$("#groupInfoId").attr("aw")?'<a href="javascript:" class="d2" t="1"><span><b></b>私聊</span></a>':"")+"</div>":""},setOnlineUser:function(t){$("#userListId li[id='"+t.userId+"']").remove();var e=studioChat.getDialogHtml(t.userId,t.nickname,t.userType),s="",i="uname",a=t.sequence;studioChat.userInfo.userId==t.userId&&(s="【我】",i+=" ume",a="0");var o=$("#userListId li"),n='<li id="'+t.userId+'" t="'+a+'">'+e+'<a href="javascript:" t="header" class="uname"><div class="headimg">'+studioChat.getUserAImgCls(t.clientGroup,t.userType,t.avatar)+"</div>"+t.nickname+s+"</a></li>";if(0==o.length)$("#userListId").append(n);else if(""!=s)o.first().before(n);else{var r=!1,l=0,d="";o.each(function(){return l=parseInt($(this).attr("t")),t.sequence<l?($(this).before(n),r=!0,!1):t.sequence==l?(d=$(this).find("a").text(),t.nickname<=d&&$(this).before(n),r=!0,!1):void 0}),r||$("#userListId").append(n)}return common.isValid(e)&&$("#userListId li[id="+t.userId+"] a[t=header]").click(function(){$(".dialogbtn").hide(),$(".user_box li").removeClass("zin"),$(this).parent().addClass("zin"),$(".dialogbtn",$(this).parent()).css("left","7px"),studioChat.openDiaLog($(this).prev())}),!0},leaveRoomTip:function(t){if("visitor"!=studioChat.userInfo.clientGroup){var e="";"roomClose"==t&&(e="房间已停用，"),"otherLogin"==t&&(e="您的账号已在其他地方进入该房间，"),"forcedOut"==t&&(e="您已被管理员强制退出房间，"),$("#tipMsgBox").fadeIn(0).delay(6e3).fadeOut(200).find("span").text("注意："+e+"正自动退出....."),window.setTimeout(function(){window.close()},3e3)}},setSocket:function(){this.socket=common.getSocket(io,this.socketUrl,this.userInfo.groupType),this.socket.on("connect",function(){console.log("connected to server!"),studioChat.userInfo.socketId=studioChat.socket.id,studioChat.socket.emit("login",{userInfo:studioChat.userInfo,lastPublishTime:$("#content_ul li:last").attr("id"),allowWhisper:$("#groupInfoId").attr("aw")}),$(".img-loading[pf=chatMessage]").show()}),this.socket.on("onlineUserList",function(t){var e=null;for(var s in t)e=t[s],studioChat.setOnlineUser(e);studioChat.setUserListScroll(),$("#onLineSizeNum").text($("#userListId li").length)}),this.socket.on("disconnect",function(t){console.log("disconnect")}),this.socket.on("error",function(t){console.error("e:"+t)}),this.socket.on("sendMsg",function(t){studioChat.setContent(t,!1,!1)}),this.socket.on("notice",function(t){switch(t.type){case"onlineNum":var e=t.data;if(e.online)studioChat.setOnlineUser(e.onlineUserInfo);else{var s=e.onlineUserInfo;studioChat.userInfo.userId!=s.userId&&$("#userListId #"+s.userId).remove()}$("#onLineSizeNum").text($("#userListId li").length);break;case"removeMsg":$("#"+t.data.replace(/,/g,",#")).remove();break;case"leaveRoom":studioChat.leaveRoomTip(t.flag);break;case"approvalResult":var e=t.data;if(e.fromUserId==studioChat.userInfo.userId)if(e.isOK){var i=e.publishTimeArr;if(2==e.status)for(var a in i)$("#"+i[a]).remove();else for(var a in i)$("#"+i[a]+" .approve").remove();$("#approveCheckAll").prop("checked",!1),0==$("#dialog_list .approve").size()&&$("#approveAllHandler").hide()}else alert("操作出现异常，请重新执行！");else if(e.refuseMsg){var i=e.publishTimeArr;for(var a in i)$("#"+i[a]).remove()}else{for(var a in e)studioChat.formatUserToContent(e[a]);studioChat.setTalkListScroll()}}}),this.socket.on("loadMsg",function(t){$(".img-loading[pf=chatMessage]").hide();var e=t.msgData,s=t.isAdd;if(s||$("#content_ul").html(""),e&&$.isArray(e)){e.reverse();for(var i in e){var a=e[i];a.content.status=a.status,studioChat.formatUserToContent(a)}s||(this.oldTalkDivH=this.newTalkDivH,studioChat.setTalkListScroll())}})},formatUserToContent:function(t){var e={userId:t.userId,nickname:t.nickname,avatar:t.avatar,userType:t.userType,groupId:t.groupId,clientGroup:t.clientGroup,publishTime:t.publishTime,toUser:t.toUser,avatar:t.avatar};studioChat.setContent({fromUser:e,content:t.content},!1,!0)}};$(function(){studioChat.init()});