var studioChat={blwsPlayer:null,web24kPath:"",filePath:"",apiUrl:"",currStudioAuth:!1,syllabusData:null,isNeverLogin:!1,serverTime:0,hasAcLink:!1,towMinTime:0,verifyCodeIntervalId:null,pushObj:{whPush:{},talkPush:[],talkPushInterval:null},teachIndex:0,msgType:{text:"text",img:"img",file:"file"},socket:null,socketUrl:"",userInfo:LoginAuto.sessionUser,initStudio:!1,init:function(){this.serverTimeUp(),this.setVisitStore(),this.setSocket(),this.setVideoList(),this.setEvent(),this.initRoom(),this.setScrollNotice(),this.setPrice()},serverTimeUp:function(){studioChat.clientVideoTask(),studioChat.towMinTime=studioChat.serverTime,setInterval(function(){studioChat.serverTime+=1e3,studioChat.serverTime-studioChat.towMinTime>=12e4&&(studioChat.towMinTime=studioChat.serverTime,studioChat.clientVideoTask())},1e3)},getTimeCal:function(t){return 10>t&&(t="0"+t),t},getAcLink:function(t){try{common.getJson("/studio/getAcLink",null,function(e){e&&($("body").data("acLink",{url:e.activityUrl,endTime:e.activityEnd,overTime:e.activityOverTime}),e.activityOverTime&&e.activityOverTime>studioChat.serverTime?$(".redbag").show():$(".redbag").hide(),t(!0))},!0,function(t){console.error("getAcLink error,please check it!"+t)})}catch(e){console.error("getAcLink error,please check it!"+e)}},openPacket:function(t,e){$(".redbag").addClass("on"),$(".redbag_ad").css({width:"0"}),$("#shinebg").rotate({angle:0,duration:5e3,animateTo:360,easing:0}),t.text("红包");var i=$("body").data("acLink");e.removeClass("time").html('<a href="'+(i&&common.isValid(i.url)?i.url:"javasrcipt:")+"\" target=\"_blank\" onclick=\"_gaq.push(['_trackEvent', 'pmchat_studio', 'packet_click','红包点击']);\">&nbsp;&nbsp;拆&nbsp;&nbsp;</a>")},setRPacket:function(t){var e=new Date(studioChat.serverTime);if(0!=e.getDay()&&6!=e.getDay())if(t)$(".redbag .redbag_cont").hover(function(){$(".redbag").hasClass("on")||$(".redbag_ad").animate({width:"199px"},800)},function(){$(".redbag").hasClass("on")||$(".redbag_ad").animate({width:"0"},800)}),$(".redbag .rb_close").click(function(){$(".redbag").hide()}),this.getAcLink(function(){studioChat.setRPacket(!1)});else{var i=common.dateTimeWeekCheck(studioChat.studioDate,!0,studioChat.serverTime),s=common.getHHMMSS(studioChat.serverTime),o=$(".redbag_box .redbag_cont b"),a=$(".redbag_box .redbag_cont h4"),n=0,r=s>="14:45:00"&&"15:15:00">s,d=s>="20:00:00"&&"20:30:00">s||s>="21:00:00"&&"21:30:00">s;if(i&&(s>="09:30:00"&&"10:00:00">s||r||d)){a.text("红包");var l=new Date(studioChat.serverTime);r&&(n=15),d&&(n=30);var u=new Date(l.getFullYear(),l.getMonth(),l.getDate(),l.getHours()+1,n,0).getTime()-studioChat.serverTime,h=this.getTimeCal(parseInt(u/1e3/60%60,10)),c=this.getTimeCal(parseInt(u/1e3%60,10));o.addClass("time").text(h+":"+c)}else if(i&&(s>="10:00:00"&&"10:01:00">s||s>="15:15:00"&&"15:16:00">s||s>="20:30:00"&&"20:31:00">s||s>="21:30:00"&&"21:31:00">s)){var m=$("body").data("acLink");!m||common.isBlank(m.url)||common.isValid(m.endTime)&&Number(m.endTime)<=studioChat.serverTime?studioChat.hasAcLink||(studioChat.getAcLink(function(){studioChat.openPacket(a,o)}),studioChat.hasAcLink=!0):(studioChat.hasAcLink=!0,studioChat.openPacket(a,o))}else studioChat.hasAcLink=!1,$("#shinebg").stopRotate(),$("#shinebg").attr("style",""),$(".redbag").removeClass("on"),o.removeClass("time"),a.text("下一轮"),s>="21:31:00"?o.text("10:00"):s>="20:31:00"?o.text("21:30"):s>="15:16:00"?o.text("20:30"):s>="10:01:00"?o.text("15:15"):o.text("10:00")}},setVisitStore:function(){if(!store.enabled)return void console.log("Local storage is not supported by your browser.");var t="storeInfo_"+this.userInfo.groupType,e=store.get(t),i={};if(common.isBlank(e)){var s=common.randomNumber(6);i.clientStoreId=(new Date).getTime()+"_"+s,i.userId="visitor_"+s,i.nickname="游客_"+s,i.userType=-1,i.autoLogin=!1,store.set(t,i)}else i=e;this.userInfo.clientStoreId=i.clientStoreId,this.userInfo.visitorId=i.userId,this.userInfo.loginId=i.loginId,this.userInfo.clientGroup&&"visitor"==this.userInfo.clientGroup?(this.userInfo.nickname=i.nickname,this.userInfo.userId=i.userId):(i.loginId=this.userInfo.userId,store.set(t,i)),this.isNeverLogin=!common.isValid(i.loginId)},autoLogin:function(){var t=common.getJson("/studio/login",{userId:studioChat.userInfo.loginId,clientStoreId:studioChat.userInfo.clientStoreId});return t.isOK?(studioChat.toRefreshView(),!0):!1},initRoom:function(){this.userInfo.nickname||this.refreshNickname(!1,"匿名_"+this.userInfo.userId.substring(8,12)),this.currStudioAuth||"visitor"!=this.userInfo.clientGroup?this.setAdvertisement():$("#login_a").trigger("click",{hideClose:!0})},showTwoCS:function(){$(".cm_wrap a").each(function(t,e){1>=t?$(e).show():$(e).hide()})},isAllowWh:function(){return"true"==$("#studioListId a[class~=ing]").attr("aw")},setCSList:function(){if(this.isAllowWh())try{$.getJSON("/studio/getCS",{groupId:this.userInfo.groupId},function(t){if(t&&t.length>0){$(".cmtalk").show(),$(".cm_wrap").html("");var e="";for(var i in t)e='<a href="javascript:" uid="'+t[i].userNo+'" class="cm_item"><img src="'+(common.isValid(t[i].avatar)?t[i].avatar:"/images/studio/cm.png")+'"><span>'+t[i].userName+"</span></a>",$("#userListId li[id="+t[i].userNo+"]").length>0?$(".cm_wrap").prepend(e):($(".cm_wrap").append(e),$(".cm_wrap a[uid="+t[i].userNo+"] img").addClass("have_op"));studioChat.showTwoCS(),$(".cm_wrap a").click(function(){var t=$(this).attr("uid");studioChat.closeWhTipMsg(t),studioChat.fillWhBox(3,t,$(this).find("span").text(),!1),studioChat.setWhAvatar(3,t,$(this).find("img").attr("src")),studioChat.getWhBox().show(),$(".mult_dialog a[uid="+t+"]").click()})}$(".cm_wrap a").length>2?$(".cm_prev,.cm_next").show().click(function(){if($(this).hasClass("cm_next")){var t=$(".cm_wrap a:not(:hidden):last").next();t.length>0&&($(".cm_wrap a:not(:hidden):first").hide(),t.show())}else{var e=$(".cm_wrap a:not(:hidden):first").prev();e.length>0&&($(".cm_wrap a:not(:hidden):last").hide(),e.show())}}):($(".cmtalk").css({"margin-left":"5px"}),$(".cm_prev,.cm_next").hide())})}catch(t){$(".cmtalk").hide(),console.error("setCSList->"+t)}},clientVideoTask:function(){var t=$("#studioVideoDiv embed").attr("src");t&&-1==t.indexOf("yy.com")&&0==$("#studioVideoDiv").find("object").length&&studioChat.playVideoByDate(!1)},playVideoByDate:function(t){if(!($("#studioTeachId a[class=on]").length>0)){var e=common.getSyllabusPlan(this.syllabusData,this.serverTime);!e||0!=e.courseType&&common.isBlank(e.studioLink)||e.isNext||0==e.courseType?t?alert("目前还没有视频直播，详情请留意直播间的课程安排！"):(this.playMp4Vd(),e&&!e.isNext&&0==e.courseType&&setTimeout(function(){window.SewisePlayer&&SewisePlayer.doStop()},1500)):this.setStudioVideoDiv(e.studioLink)}},playMp4Vd:function(){if($("#studioTeachId a[class=on]").length<=0){var t=$("#studioTeachId li a[t=mp4]");if(t.length<=0)$("#studioTeachId li:first a").click();else{var e=$(t.get(common.randomIndex(t.length)));e.click(),$(".videolist_box").mCustomScrollbar("scrollTo","#"+e.attr("id"))}}},getEmbedDom:function(t){return'<embed src="'+t+'" autostart="true" wmode="Opaque" quality="high" width="100%" height="100%" align="middle" allowScriptAccess="never" allowFullScreen="true" mode="transparent" type="application/x-shockwave-flash"></embed>'},setStudioVideoDiv:function(t){if($("#tvDivId").hide(),window.SewisePlayer&&(SewisePlayer.doStop(),$("#studioTeachId a").removeClass("on")),$("#tVideoDiv iframe").remove(),-1!=t.indexOf("rtmp")){var e='<div style="position: relative; width: 100%; height: 100%; left: 0px; top: 0px;"><object type="application/x-shockwave-flash" id="sewise_player" name="sewise_player" data="/js/lib/flash/SewisePlayer.swf" width="100%" height="100%"><param name="allowfullscreen" value="true"><param name="wmode" value="transparent"><param name="allowscriptaccess" value="always"><param name="flashvars" value="autoStart=true&amp;programId=&amp;shiftTime=&amp;lang=zh_CN&amp;type=rtmp&amp;serverApi=ServerApi.execute&amp;skin=/js/lib/flash/skins/liveOrange.swf&amp;title=&amp;draggable=true&amp;published=0&amp;streamUrl='+t+'&amp;duration=3600&amp;poster=&amp;flagDatas=&amp;videosJsonUrl=&amp;adsJsonData=&amp;statistics=&amp;customDatas=&amp;playerName=Sewise Player&amp;clarityButton=enable&amp;timeDisplay=disable&amp;controlBarDisplay=enable&amp;topBarDisplay=disable&amp;customStrings=&amp;volume=0.6&amp;key=&amp;trackCallback="></object></div>';$("#studioVideoDiv").html(e)}else{if($("#stVideoDiv:visible").length>0&&$("#studioVideoDiv embed").attr("src")==t)return;$("#stVideoDiv .img-loading").fadeIn(0).delay(2e3).fadeOut(200),$("#studioVideoDiv embed").remove(),$(studioChat.getEmbedDom(t)).appendTo("#studioVideoDiv")}$("#stVideoDiv").show(),!studioChat.initStudio&&studioChat.isNeverLogin&&$(".guide1").show().find(".gclose").click(function(){$(".guide1").hide()}),studioChat.initStudio=!0},setVideo:function(t){try{$("#tvDivId").show(),$("#stVideoDiv").hide(),$("#studioVideoDiv").html(""),$("#tVideoDiv .img-loading").fadeIn(0).delay(2e3).fadeOut(200);var e=t.attr("vUrl"),i=t.text();if(-1!=e.indexOf(".html")){window.SewisePlayer&&(SewisePlayer.doStop(),$("#tVideoDiv div").hide());var s=$("#tVideoDiv iframe"),o=!0;s.size()>0&&(s.attr("src")==e?o=!1:s.remove()),o&&$("#tVideoDiv").append('<iframe frameborder=0 width="100%" height="100%" src="'+e+'" allowfullscreen></iframe>')}else if($("#tVideoDiv iframe").remove(),$("#tVideoDiv div").show(),-1!=e.indexOf("type=blws")){var a=e.split("&");if(a.length>1){var n=a[1].replace(/^vid=/g,"");studioChat.blwsPlayer?studioChat.blwsPlayer.changeVid(n):studioChat.blwsPlayer=polyvObject("#tVideoDiv").videoPlayer({width:"100%",height:"100%",vid:n,flashvars:{autoplay:"0",setScreen:"fill"},onPlayOver:function(t){$("#tVideoCtrl").show(),$("#tVideoCtrl div.video_ad").show();var e=$("#tVideoCtrl a.ad").is(":hidden")?"-68px":"-150px";$("#tVideoCtrl div.vcenter").css("margin-top",e)},onPlayStart:function(){$("#tVideoCtrl").hide()}})}}else if(window.SewisePlayer)SewisePlayer.toPlay(e,i,0,!0);else{var r=[];r.push("/js/lib/sewise.player.min.js?server=vod"),r.push("type="+(-1!=e.indexOf(".flv")?"flv":"mp4")),r.push("videourl="+e),r.push("autostart=true"),r.push("title="+i),r.push("buffer=5");var d=r.join("&"),l=document.createElement("script");l.type="text/javascript",l.src=d,$("#tVideoDiv").get(0).appendChild(l),studioChat.isNeverLogin&&$(".guide2").show().find(".gclose").click(function(){$(".guide2").hide()});var u=function(){return window.SewisePlayer?(SewisePlayer.onPause(function(t){window.setTimeout(function(){if(SewisePlayer.duration()<=SewisePlayer.playTime()){$("#tVideoCtrl").show(),$("#tVideoCtrl div.video_ad").show();var t=$("#tVideoCtrl a.ad").is(":hidden")?"-68px":"-150px";$("#tVideoCtrl div.vcenter").css("margin-top",t)}},1e3)}),void SewisePlayer.onStart(function(){$("#tVideoCtrl").hide()})):void window.setTimeout(u,500)};u()}$(".window-container #studioVideoDiv").length>0&&$(".vopenbtn[t=v]").click()}catch(h){console.error("setVideo has error:"+h)}},getUiId:function(){var t=new Date;return t.getTime()+"_ms"},setPrice:function(){getAllMarketpriceIndex("ws://kdata.gwfx.com:8087/websocket.do","service=HqDataWebSocketService&method=pushMarketprice&symbol=XAGUSD|XAUUSD|USDX|CLWTI&dataType=simpleMarketPrice","http://kdata.gwfx.com:8099/gateway.do?service=HqDataService&method=getMarkrtPriceDataFromCache",{downCss:"red",upCss:"green"}),$(".pro_notice").slide({titCell:".num ul",mainCell:".pro_box",effect:"fade",autoPlay:!0,delayTime:800,interTime:5e3,autoPage:!1,prevCell:".pro_prev",nextCell:".pro_next"})},getNewsInfoList:function(t,e,i,s){try{var o=i||5;$.getJSON(this.apiUrl+"/getNewsInfoList",{pageNo:1,pageSize:o,lang:"zh",contentType1:t,contentType2:e}).done(function(t){s(t)})}catch(a){console.error("getNewsInfoList->"+a)}},setScrollNotice:function(){this.getNewsInfoList(2,null,3,function(t){$(".sro_list").html("");var e=null;if(t&&0==(e=t.informations).result){var i=e.informationList,s=null;for(var o in i)s=i[o],$(".sro_list").append('<li><i></i><a href="'+studioChat.web24kPath+("/zh/news/"+s.id+".html")+'" target="_blank" style="color:#ffffff;"><span>'+s.title+"</span></a></li>");$(".sro_notice").slide({mainCell:".sro_list",effect:"topLoop",autoPlay:!0,delayTime:600,interTime:3e3,autoPage:!1})}else console.error("提取数据有误！")})},setNewsInfo:function(t,e,i,s){$(t).html(""),this.getNewsInfoList(e,i,s,function(e){var s=null;if(e&&0==(s=e.informations).result){var o=s.informationList,a=null;for(var n in o)a=o[n],$(t).append('<li><a href="'+studioChat.web24kPath+"/zh/goldreview/"+a.id+"_"+a.contenttype2+'.html" target="_blank"><span class="ndate">'+a.datestr+"</span>"+a.title+"</a></li>");$(t).append('<li><a href="'+studioChat.web24kPath+"/zh/goldreview/goldreviewlist_"+i+'.html" target="_blank" class="listmore">更多</a></li>')}else console.error("提取数据有误！")})},getArticleList:function(t,e,i,s,o,a,n,r){try{$.getJSON("/studio/getArticleList",{authorId:common.trim(n),code:t,platform:e,hasContent:i,pageNo:s,pageSize:o,orderByStr:a},function(t){r(t)})}catch(d){console.error("getArticleList->"+d),r(null)}},setVideoList:function(){$(".img-loading[pf=studioTeachId]").show(),this.getArticleList("teach_video",this.userInfo.groupId,0,1,100,'{"sequence":"desc"}',null,function(t){if($("#studioTeachId").html(""),$(".img-loading[pf=studioTeachId]").hide(),t&&0==t.result){var e=t.data,i=null;for(var s in e)i=e[s].detailList[0],$("#studioTeachId").append('<li><a title="'+i.title+'" href="javascript:" id="'+e[s]._id+'" t="'+(common.isValid(e[s].mediaUrl)&&-1!=e[s].mediaUrl.indexOf(".mp4")?"mp4":"")+'" vUrl="'+e[s].mediaUrl+"\" onclick=\"_gaq.push(['_trackEvent', 'pmchat_studio', 'video_play',$(this).text()]);\"><i></i>"+i.title+"</a></li>");$("#studioTeachId li a").click(function(){$("#studioTeachId li a.on").removeClass("on"),$(this).addClass("on"),studioChat.setVideo($(this))}),studioChat.setListScroll(".videolist_box")}studioChat.playVideoByDate(!1)})},setAdvertisement:function(){studioChat.isNeverLogin?($(".blackbg").show(),$("#main_ad_box").css({background:"url(/images/studio/ban_new.jpg) 0 0 no-repeat"}).show(),$("#main_ad_box .pop_close").click(function(){$("#main_ad_box").hide(),$(".blackbg").hide()})):($(".blackbg").show(),$("#act_ad_box").css({background:"url(/images/studio/ban_act.png) 0 0 no-repeat"}).show(),$("#act_ad_box .pop_close").click(function(){$("#act_ad_box").hide(),$(".blackbg").hide()})),this.getArticleList("video_advertisement",this.userInfo.groupId,0,1,1,'{"createDate":"desc"}',null,function(t){var e=$("#tVideoCtrl a.ad");if(t&&0==t.result&&t.data&&1===t.data.length){var i=t.data[0];e.attr("href",i.linkUrl||"javascript:void(0);"),e.find("img").attr("src",i.mediaUrl)}else e.hide(),e.next().hide()})},toRefreshView:function(){window.location.reload()},setVerifyCodeTime:function(t){var e=parseInt($(t).attr("t"))||60;studioChat.verifyCodeIntervalId||(studioChat.verifyCodeIntervalId=setInterval("studioChat.setVerifyCodeTime('"+t+"')",1e3)),e>1?$(t).attr("t",e-1).html(e-1+"秒后重新获取"):(clearInterval(studioChat.verifyCodeIntervalId),studioChat.verifyCodeIntervalId="",$(t).attr("t",60).html("获取验证码").addClass("pressed"))},setVdEvent:function(){$("#tVideoCtrl a.close_ad").bind("click",function(){$("#tVideoCtrl div.vcenter").css("margin-top","-68px"),$("#tVideoCtrl div.video_ad").hide()}),$("#tVideoCtrl div.replay a").bind("click",function(){var t=$("#studioTeachId li a.on");t.trigger("click")}),$("#tVideoCtrl div.nextbtn a").bind("click",function(){var t=$("#studioTeachId li a.on").parent().next();0===t.size()&&(t=$("#studioTeachId li:first")),t.find("a").trigger("click")}),$(".vbackbtn").click(function(){$("#studioTeachId a[class=on]").removeClass("on"),studioChat.playVideoByDate(!0)})},doPlayTeachVideo:function(){window.SewisePlayer&&SewisePlayer.duration()>SewisePlayer.playTime()&&SewisePlayer.doPlay()},setWhBox:function(t){t&&$("#newMsgShowBtn").attr("t","hide"),$("#newMsgTipBtn").click()},setWhTipInfo:function(t,e,i){i&&$("#newMsgTipBtn").attr("uid",i),$(".pletter_hint p span").html((3==t?"老师助理":"")+e+"发来了一条私聊信息"),$(".pletter_hint").show()},sendWhMsg:function(t){var e=studioChat.getSendMsg(t);if(e!==!1){var i={uiId:studioChat.getUiId(),fromUser:studioChat.userInfo,content:{msgType:studioChat.msgType.text,value:e}},s=$(".mult_dialog a[class=on]"),o=s.attr("uid");i.fromUser.toUser={userId:o,nickname:s.find("label").text(),talkStyle:1,userType:s.attr("utype")};var a=$("#wh_msg_"+o+" .dialog:last"),n=a.find(".whblt");n.length>0&&(i.fromUser.toUser.question=n.html(),i.fromUser.toUser.questionId=n.attr("rid"),i.fromUser.toUser.publishTime=a.attr("id")),studioChat.socket.emit("sendMsg",i),studioChat.setWhContent(i,!0,!1),t.html("")}},setWhOnlineTip:function(t,e){var i=$("#wh_msg_"+t+" .tit strong");0!=i.length&&($("#wh_msg_"+t+" .tit strong").text(e?"在线":"离线"),$(".mult_dialog a[uid="+t+"]").find("img").css({opacity:e?1:.5}))},setWhVisitors:function(t,e,i,s,o){if(0==$(".mult_dialog a[uid="+e+"]").length){$(".mult_dialog").append('<a href="javascript:" uid="'+e+'" utype="'+t+'"><span><img src=""/><label>'+i+'</label></span><i class="num dn" t="0"></i><i class="close"></i></a>');var a=$(".mult_dialog a[uid="+e+"]");if(o){var n=a.find(".num"),r=parseInt(n.attr("t"))+1;n.attr("t",r).text(r).show()}a.find(".close").click(function(){var t=$(this).parent();t.remove(),$("#wh_msg_"+t.attr("uid")).remove(),0==$(".mult_dialog a").length?studioChat.getWhBox().remove():$(".mult_dialog a:last").click()}),a.click(function(){$(".mult_dialog a").removeClass("on"),$(this).addClass("on"),$(this).find(".num").attr("t",0).text("").hide();var t=$(this).attr("uid"),e="wh_msg_"+t,i=$(this).attr("utype");if(studioChat.closeWhTipMsg(t),$(".wh-right").children().hide(),0==$("#"+e).length){var s=[];s.push('<div class="cont" id="'+e+'"><div class="tit">'+$(this).find("label").text()+'【<strong></strong>】</div><div class="chat_content"><div class="wh-content" style="height:213px">'),s.push('</div></div><div class="input_box"><div class="toolbar"><a href="javascript:" class="facebtn" title="添加表情">表情</a></div>'),s.push('<div class="input_area"><div class="adiv"><div contenteditable="true" class="ctextarea" id="whTxt_'+t+'"></div></div>'),s.push('<a href="javascript:" class="sendbtn"><span>发送</span></a></div></div></div>'),$(".wh-right").append(s.join("")),$("#"+e).find(".ctextarea").keydown(function(t){return 13==t.keyCode?(studioChat.sendWhMsg($(this)),!1):void 0}),$("#"+e).find(".sendbtn").click(function(t){studioChat.sendWhMsg($(this).parents(".cont").find(".ctextarea"))}),studioChat.socket.emit("getWhMsg",{clientStoreId:studioChat.userInfo.clientStoreId,userType:studioChat.userInfo.userType,groupId:studioChat.userInfo.groupId,groupType:studioChat.userInfo.groupType,userId:studioChat.userInfo.userId,toUser:{userId:t,userType:i}}),$("#"+e).find(".facebtn").qqFace({id:"faceId_"+t,zIndex:1e6,assign:"whTxt_"+t,path:studioChat.filePath+"/face/"})}else $("#"+e).show(),studioChat.setTalkListScroll(!0,$("#"+e+" .wh-content"),"dark");$("#"+e).find(".ctextarea").focus(),studioChat.setWhOnlineTip(t,$("#userListId li[id='"+t+"']").length>0)})}},getWhBox:function(){return $(".window-container[wid=newMsgShowBtn]")},closeWhTipMsg:function(t){$(".pletter_hint").hide()},fillWhBox:function(t,e,i,s,o){var a=this.getWhBox();if(0==a.length)return studioChat.setWhBox(!0),studioChat.setWhVisitors(t,e,i,!0,o),s&&studioChat.setWhTipInfo(t,'<label class="tip_nk">'+i+"</label>",e),!1;var n=$(".mult_dialog a[uid="+e+"]");if(0==n.length){if(studioChat.setWhVisitors(t,e,i,!0,o),s&&studioChat.setWhTipInfo(t,'<label class="tip_nk">'+i+"</label>",e),a.is(":hidden"))return!1}else{if(o&&!n.hasClass("on")){var r=n.find(".num"),d=parseInt(r.attr("t"))+1;r.attr("t",d).text(d).show()}if(a.is(":hidden")){var l=$("#wh_msg_"+e+" .wh-content");if(0==l.length)return!1}}return!0},setWhAvatar:function(t,e,i){if("3"==t){var s=$(".cm_wrap a[uid="+e+"] img").attr("src");common.isValid(s)&&(i=s)}$(".mult_dialog a[uid="+e+"] img").attr("src",common.isValid(i)?i:"/images/studio/cm.png")},setWhContent:function(t,e,i,s){var o=t.fromUser,a="dialog ",n=t.content,r="";if(t.rule)return void $("#"+t.uiId+" .dcont").append('<em class="ruleTipStyle">'+t.value.tip+"</em>");if(i||(o.toWhUserId=o.userId),studioChat.userInfo.userId==o.userId||"0"==studioChat.userInfo.userType&&"-1"==o.userType||"-1"==studioChat.userInfo.userType&&"0"==o.userType){if(e&&(o.publishTime=t.uiId,o.toWhUserId=o.toUser.userId),t.serverSuccess)return $("#"+t.uiId+" .dtime").html(studioChat.formatPublishTime(o.publishTime)),void $("#"+t.uiId).attr("id",o.publishTime);a+="mine",r='<span class="wh-dia-title"><label class="dtime">'+studioChat.formatPublishTime(o.publishTime,i,"/")+'</label><label class="wh-nk">我</label></span>'}else{if(!i&&!s){var d=this.fillWhBox(o.userType,o.userId,o.nickname,!0,!0);if(studioChat.setWhAvatar(o.userType,o.userId,o.avatar),!d)return}r='<span class="wh-dia-title"><label class="wh-nk">'+o.nickname+'</label><label class="dtime">'+studioChat.formatPublishTime(o.publishTime,i,"/")+"</label></span>"}if(common.isBlank(o.toWhUserId))return void console.error("setWhContent->fromUser toWhUserId is null,please check!");var l="",u=$("#wh_msg_"+o.toWhUserId+" .wh-content"),h=u.find(".mCSB_container"),c="";n.msgType==studioChat.msgType.img?l=n.needMax?'<p><a href="/studio/getBigImg?publishTime='+o.publishTime+"&userId="+o.userId+'" class="swipebox" ><img src="'+n.value+'" alt="图片"/></a></p>':'<p><a href="'+n.value+'" class="swipebox" ><img src="'+n.value+'" alt="图片" /></a></p>':s?l='<div class="whblt" rid="'+n.infoId+'">'+n.value+"</div>":(!e&&common.isValid(o.toUser.question)&&(c='<div class="dialog" id="'+o.toUser.publishTime+'"><div><span class="wh-dia-title"><label class="wh-nk">'+o.toUser.nickname+'</label><label class="dtime">'+studioChat.formatPublishTime(o.toUser.publishTime,i,"/")+'</label></span></div><div class="whblt">'+o.toUser.question+"</div></div>",h.length>0?h.append(c):u.append(c)),l='<p><span class="dcont">'+n.value+"</span></p>"),c='<div class="'+a+'" id="'+o.publishTime+'" utype="'+o.userType+'" mType="'+n.msgType+'" t="header"><div>'+r+"</div>"+l+"</div>",h.length>0?h.append(c):u.append(c),this.formatMsgToLink(o.publishTime),i||studioChat.setTalkListScroll(!0,u,"dark")},adjustWhBoxStyle:function(){var t=studioChat.getWhBox();t.css({border:"1px solid #868484",left:$(window).width()-680+"px",top:$(".right_row").height()-$(".right_row .chat_input").height()-350+"px"}),t.find(".window-content").css({height:"370px",width:"598px","background-color":"#475364"}),t.find(".window-titleBar").css({"background-color":"#858888"})},setEvent:function(){$(".mod_video").hover(function(){$(".vopenbtn,.vrefreshbtn").show()},function(){$(".vopenbtn,.vrefreshbtn").hide()}),this.teachSlide(),jqWindowsEngineZIndex=1e5,$("#newMsgTipBtn").click(function(){studioChat.closeWhTipMsg($(this).attr("uid"));var t=studioChat.getWhBox();if(t.length>0)return t.show(),void $(".mult_dialog a[uid="+$(this).attr("uid")+"]").click();var e=[];e.push('<div class="pletter_win clearfix mult"><div class="mult_dialog"></div><div class="wh-right"></div></div>'),$("#newMsgShowBtn").newWindow({windowTitle:"私聊",content:e.join(""),windowType:"normal",minimizeButton:!0,maximizeButton:!1,statusBar:!1,width:600,height:396,beforeMinimize:function(t){return t.hide(),!1}}),studioChat.adjustWhBoxStyle(),$("#newMsgShowBtn").click()}),$(".pl_close").click(function(){$("."+$(this).attr("t")).hide()}),$(".point-close").click(function(){$("#teacherListId a").removeClass("on"),$(".pointlist").hide()}),$("#mdr_nk").bind("input propertychange",function(){$("#nketip").text("")}),$("#resetNickname").click(function(){return!1}),$(".vopenbtn").click(function(){jqWindowsEngineZIndex=1e5;$(".window-container #studioVideoDiv").length>0&&($("#stVideoDiv").get(0).appendChild($("#studioVideoDiv").parent().get(0)),$("#studioVideoDiv embed,.window-container").remove(),$("#stVideoDiv .vopenbtn").show(),$("#stVideoDiv .tipMsg").hide()),$("#showOutTV").newWindow({windowTitle:"教学视频",content:$("#tvDivId .tv-div")[0],windowType:"video",minimizeButton:!1,resizeIcon:"<= =>",width:640,height:540,afterClose:function(t){$("#tvDivId .tipMsg").hide(),$("#tvDivId .vopenbtn").show(),$("#tvDivId").get(0).appendChild(t),studioChat.doPlayTeachVideo(),studioChat.setVdEvent()}}),$("#showOutTV").click(),$("#tvDivId .vopenbtn").hide(),window.setTimeout(function(){$("#tvDivId .tipMsg").show(),studioChat.doPlayTeachVideo()},500)}),$(".vrefreshbtn").click(function(){$("#studioVideoDiv embed").remove(),studioChat.playVideoByDate(!0)}),this.setVdEvent(),$(".te_ctrl .show_btn").click(function(){$(".te_list").animate({height:"53px"},"slow"),$(".te_ctrl a").removeClass("show"),$(".te_ctrl .hide_btn").addClass("show")}),$(".te_ctrl .hide_btn").click(function(){$(".te_list").animate({height:0},"slow"),$(".te_ctrl a").removeClass("show"),$(".te_ctrl .show_btn").addClass("show")}),$("#msgFaceBtn").qqFace({id:"faceId",assign:"contentText",path:studioChat.filePath+"/face/"}),$(document).click(function(t){$("div[id^=faceId]").hide(),$(t.target).hasClass("headimg")||$(t.target).parents().hasClass("headimg")||"header"==$(t.target).parent().attr("t")||$(t.target).hasClass("uname")||$(t.target).parents().hasClass("te_ul")||$(".dialogbtn").hide()}),$("#studioListId a").click(function(){var t=$(this);return t.hasClass("ing")?!1:"false"==t.attr("av")&&studioChat.checkClientGroup("visitor")?($("#login_a").trigger("click",{groupId:t.attr("id")}),!1):t.hasClass("locked")?(studioChat.checkClientGroup("vip")?alert("该房间仅对新客户开放，如有疑问，请联系老师助理。"):alert("已有真实账户并激活的客户才可进入Vip专场，您还不满足条件。如有疑问，请联系老师助理。"),!1):void common.getJson("/studio/checkGroupAuth",{groupId:t.attr("id")},function(t){t.isOK?studioChat.toRefreshView():studioChat.checkClientGroup("vip")?alert("该房间仅对新客户开放，如有疑问，请联系老师助理。"):alert("已有真实账户并激活的客户才可进入Vip专场，您还不满足条件。如有疑问，请联系老师助理。")},!0,function(t){"success"!=t&&alert("操作失败，请联系客服！")})}),$(".username").click(function(){$(".blackbg").children("div").hide(),$("#mdr_nk").val($("#mdr_nk").attr("t")),$("#userInfoBox,.blackbg").show()}),$(".upg_btn").click(function(){try{$(".upg_list").show(),$("#up_loading").show(),$.getJSON("/studio/getClientGroupList",null,function(t){if($("#up_loading").hide(),t){$("#upg_tbody_id").html("");var e="",i=0,s=null;for(var o in t)t[o]._id==studioChat.userInfo.clientGroup&&(i=t[o].sequence);for(var a in t){s=t[a],e=s._id==studioChat.userInfo.clientGroup?"当前级别":"visitor"!=s._id&&i<s.sequence?"vip"==s._id?"联系客服升级":'<a href="javascript:" t="'+s._id+'">升级</a>':"---";var n=[];n.push('<tr><td align="center" valign="middle">'+studioChat.getUserLevelShortName(s._id)+"</td>"),n.push('<td align="center" valign="middle">'+common.trim(s.remark)+"</td>"),n.push('<td align="center" valign="middle">'+common.trim(s.authorityDes)+"</td>"),n.push('<td align="center" valign="middle">'+e+"</td></tr>"),$("#upg_tbody_id").append(n.join(""))}$("#upg_tbody_id a").click(function(){var t=$(this),e=t.attr("t");common.getJson("/studio/upgrade",{clientGroup:e},function(i){if(t.attr("disabled",!1),i.isOK)"active"===i.clientGroup&&"notActive"===e?$("#studioUpgA").show():$("#studioUpgA").hide(),$(".upg_succ").show();else{var s="";"active"===e?s="很遗憾，您未激活金道真实交易账户，升级失败！<br>如有疑问请联系客服！":"notActive"===e?s="很遗憾，您未开通金道真实交易账户，升级失败！<br>如有疑问请联系客服！":"simulate"===e&&(s="很遗憾，您未开通金道模拟交易账户，升级失败！<br>如有疑问请联系客服！"),$("#upg_fail span:first").html(s),$("#upg_fail").show()}},!0,function(e){t.attr("disabled",!1)})})}})}catch(t){$("#up_loading").hide(),console.error("getClientGroupList->"+t)}}),$(".in_rbtn .qu_btn").hover(function(){$(".upg_tip").addClass("show")},function(){$(".upg_tip").removeClass("show")}),$("#toPmLogin").click(function(){$("#loginComBox").hide(),$("#loginPmBox").show()}),$(".mod_tab .tab_nav a").click(function(){$(".mod_tab .tab_nav a").removeClass("on"),$(".mod_tab .tab_box").removeClass("on"),$(this).addClass("on"),$($(".mod_tab .tab_box")[$(this).index()]).addClass("on");var t=$(this).attr("t");if("tradeInfoTab"==t)studioChat.setNewsInfo("#tradeInfoTab",3,5);else if("commentTab"==t)studioChat.setNewsInfo("#commentTab",3,3);else if("studioPlanTab"==t){if(!studioChat.syllabusData)return;var e=common.formatSyllabus(studioChat.syllabusData.courses,studioChat.serverTime,1),i=$("#studioPlanTab");i.html(e),i.find(".sy_nav a").bind("click",function(){var t=$(this);$(this).parent().find(".dir").hide(),$(this).find(".dir").show(),t.siblings(".active").removeClass("active"),t.addClass("active");var e=t.attr("d"),i=t.parent().next();i.find("tbody:visible").hide(),i.find("tbody[d='"+e+"']").show()}),i.find(".sy_nav a.active").trigger("click"),studioChat.setListScroll($("#studioPlanTab").parent()[0])}else"bulletinTab"==t?studioChat.getArticleList("bulletin_system",studioChat.userInfo.groupId,1,1,1,'{"sequence":"asc"}',null,function(t){if($("#bulletinTab").html(""),t&&0==t.result){var e=t.data;e&&e.length>0&&($("#bulletinTab").html(e[0].detailList[0].content),studioChat.setListScroll($("#bulletinTab").parent()[0]))}}):"downloadTab"==t&&studioChat.getArticleList("download",studioChat.userInfo.groupId,1,1,100,'{"sequence":"asc"}',null,function(t){if($("#downloadTab").html(""),t&&0==t.result){var e=t.data,i=null;for(var s in e)i=e[s].detailList[0],$("#downloadTab").append("<li><span>"+i.title+'</span><a href="'+e[s].mediaUrl+'" target="_blank" class="downbtn" onclick="_gaq.push([\'_trackEvent\', \'pmchat_studio\', \'file_download\',$(this).prev().text()]);" >下载</a></li>');studioChat.setListScroll($("#downloadTab").parent()[0])}})}),$(".mod_tab .tab_nav a[t='studioPlanTab']").click(),$("#login_a,#lrtip_l").bind("click",function(t,e){e=e||{},studioChat.preGroupId=e.groupId,studioChat.openLoginBox(e.hideClose),common.isValid($(this).attr("tp"))&&_gaq.push(["_trackEvent","pmchat_studio","login",$(this).attr("tp"),1,!0])}),$(".logout").bind("click",function(){LoginAuto.setAutoLogin(!1),window.location.href="/studio/logout"}),$("#loginForm input[name=mobilePhone]").bind("input propertychange",function(){var t=$(this).parents("form").find(".rbtn");parseInt(t.attr("t"))<60&&0==t.is(".pressed")||(common.isMobilePhone(this.value)?t.addClass("pressed"):t.removeClass("pressed"))}),$(".rbtn").click(function(){if($(this).hasClass("pressed")){$(this).removeClass("pressed").html("发送中...");var t=$(this).attr("pf"),e=$(this).attr("ut"),i=$("#"+t+" input[name=mobilePhone]").val();try{$.getJSON("/studio/getMobileVerifyCode?t="+(new Date).getTime(),{mobilePhone:i,useType:e},function(e){e&&0==e.result?studioChat.setVerifyCodeTime(".rbtn[pf="+t+"]"):("1005"==e.errcode?alert(e.errmsg):console.error("提取数据有误！"),studioChat.resetVerifyCode("#"+t))})}catch(s){studioChat.resetVerifyCode("#"+t),console.error("setMobileVerifyCode->"+s)}}}),$(".popup_box .pop_close,.formbtn[t=close]").click(function(){"userInfo"==$(this).attr("t")?($("#mdr_nk").attr("readonly",!0),$("#nketip").text("")):($(".blackbg form").each(function(){this.reset()}),$(".wrong-info").html("").attr("tId",""));var t=$(this).parent().parent(),e=t.parent().attr("id"),i=t.attr("id");t.hide(),"loginBox"!=e&&!t.parent().hasClass("blackbg")||"modifyPwdBox"==i||$(".blackbg").hide().children().hide()}),$("#loginForm input[type=text]").blur(function(){common.isValid(this.value)&&$("#loginForm .wrong-info[tId="+this.name+"]").html("")}),$("input[type='password']").bind("paste",function(){return!1}),$("#loginForm input[name='verifyCode']").keydown(function(t){return 13==t.keyCode?($("#loginForm a[tn='loginBtn']").trigger("click"),!1):void 0}),$("#pmInfoSetBtn").click(function(){if(studioChat.checkFormInput("#pmInfoSetForm")){$(this).prop("disabled",!0);var t=this;$("#pmInfoSetLoad").show(),common.getJson("/studio/modifyName",$("#pmInfoSetForm").serialize(),function(e){return $("#pmInfoSetForm .wrong-info").html(""),$(t).attr("disabled",!1),$("#pmInfoSetLoad").hide(),e.isOK?($("#pmInfoSetBox .pop_close").trigger("click"),studioChat.refreshNickname(!0,e.nickname),$("#sendBtn").trigger("click"),void 0):($("#pmInfoSetForm .wrong-info").html(e.msg?e.msg:"修改失败，请联系客服！"),!1)},!0,function(e){$(t).attr("disabled",!1),$("#pmInfoSetLoad").hide()})}}),$("#loginForm a[tn=loginBtn]").click(function(){
var t=$(this).parents("form").attr("id");if($("#"+t+" input[name=clientStoreId]").val(studioChat.userInfo.clientStoreId),studioChat.checkFormInput("#"+t)){$(this).attr("disabled",!0);var e=this;$("#formBtnLoad").show(),common.getJson("/studio/login",$("#"+t).serialize(),function(i){return $("#"+t+" .wrong-info").html(""),$(e).attr("disabled",!1),$("#formBtnLoad").hide(),i.isOK?($(".blackbg,#loginBox").hide(),LoginAuto.setAutoLogin($("#autoLogin").prop("checked")),studioChat.userInfo.clientGroup=i.userInfo.clientGroup,studioChat.preGroupId?common.getJson("/studio/checkGroupAuth",{groupId:studioChat.preGroupId},function(t){t.isOK||(studioChat.checkClientGroup("vip")?alert("该房间仅对新客户开放，如有疑问，请联系老师助理。"):alert("已有真实账户并激活的客户才可进入Vip专场，您还不满足条件。如有疑问，请联系老师助理。")),studioChat.toRefreshView()},!0,function(t){"success"!=t&&alert("操作失败，请联系客服！")}):(studioChat.checkClientGroup("vip")&&alert("您已具备进入Vip专场的条件，我们将为您自动进入VIP专场。"),studioChat.toRefreshView()),void 0):($("#"+t+" input[name=verifyCode]").val(""),$("#"+t+" .wrong-info").html(i.error.errmsg),!1)},!0,function(i){$("#"+t+" input[name=pwd]").val(""),$(e).attr("disabled",!1),$("#formBtnLoad").hide()})}}),$("#registBtn").click(function(){if($("#registFrom input[name=clientStoreId]").val(studioChat.userInfo.clientStoreId),studioChat.checkFormInput("#registFrom")){$(this).attr("disabled",!0);var t=this;$("#registLoad").show(),common.getJson("/studio/reg",$("#registFrom").serialize(),function(e){return $("#registFrom .wrong-info").html(""),$(t).attr("disabled",!1),$("#registLoad").hide(),e.isOK?($("#registTipBox").show(),$("#registFromBox").hide(),studioChat.toRefreshView(),void 0):($("#registFrom .wrong-info").html(e.error.errmsg),!1)},!0,function(e){$(t).attr("disabled",!1),$("#registLoad").hide()})}}),$(".frbtn,#toGetPwd").click(function(){$(".blackbg").children("div").hide(),studioChat.resetVerifyCode("#mobileCheckBox"),$("#mobileCheckBox").show()}),$("#mobileCheckBtn,#getPwdBtn").click(function(){var t="#"+$(this).attr("pf"),e=$(".img-loading[pf="+$(this).attr("pf")+"]");if(studioChat.checkFormInput(t)){$(this).attr("disabled",!0);var i=this;e.show(),common.getJson("/studio/getPwd",$(t).serialize(),function(s){return $(t+" .wrong-info").html(""),$(i).attr("disabled",!1),e.hide(),s.isOK?void("#mobileCheckForm"==t?($("#getPwdForm input[name=mobilePhone]").val($("#mobileCheckForm input[name=mobilePhone]").val()),$("#getPwdForm input[name=verifyCode]").val($("#mobileCheckForm input[name=verifyCode]").val()),$("#getPwdBox").show(),$("#mobileCheckBox").hide()):($("#getPwdBox").hide(),$("#getPwdTipBox").show())):($(t+" .wrong-info").html(s.error.errmsg),!1)},!0,function(t){$(i).attr("disabled",!1),e.hide()})}}),$("#resetPwdLink").click(function(){$("#modifyPwdForm")[0].reset(),$(".blackbg").children().not("#userInfoBox").hide(),$(".blackbg,#modifyPwdBox").show()}),$("#modifyPwdBtn").click(function(){var t=$(".img-loading[pf="+$(this).attr("pf")+"]");if(studioChat.checkFormInput("#modifyPwdForm")){$(this).attr("disabled",!0);var e=this;t.show(),common.getJson("/studio/resetPwd",$("#modifyPwdForm").serialize(),function(i){return $("#modifyPwdForm .wrong-info").html(""),$(e).attr("disabled",!1),t.hide(),i.isOK?($("#modifyPwdBox,#userInfoBox").hide(),void $("#modifyPwdTipBox").show()):($("#modifyPwdForm .wrong-info").html(i.error.errmsg),!1)},!0,function(i){$(e).attr("disabled",!1),t.hide()})}}),$(".replybtn").click(function(){studioChat.setDialog($(this).attr("uId"),$(".sender").html(),$(this).attr("ts"),$(this).attr("futype")),$(".mymsg em").show()}),$(".closebtn").click(function(){$(".mymsg,.mymsg em").hide()}),$(".clearbtn").click(function(){$("#dialog_list").html(""),studioChat.setTalkListScroll()}),$(".scrollbtn").click(function(){$(this).hasClass("on")?$(this).removeClass("on"):($(this).addClass("on"),studioChat.setTalkListScroll(!0))}),$(".view_select").hover(function(){$(this).addClass("dw")},function(){$(this).removeClass("dw")}).find(".selectlist a").click(function(){$(this).is(".on")||($(".view_select .selectlist a").removeClass("on"),$(".view_select .selected").text($(this).text()),$(this).addClass("on"),studioChat.showViewSelect($(this).attr("t")),studioChat.setTalkListScroll(!0))}),$("#contentText").keydown(function(t){var e=$(this).html();if(13==t.keyCode)return common.isValid(e)&&($(this).html(e.replace(/<div>|<\/div>/g,"")),$("#sendBtn").click()),!1;if(8==t.keyCode){var i=$(this).find(".txt_dia");if($.trim($(this).text())==i.text())return i.remove(),$(this).html(""),!0}}).autocomplete({source:function(t,e){/^@.*$/g.test(t.term)&&e(studioChat.searchUserList(t.term.substring(1,t.term.length)))},delay:500,minLength:2,position:{my:"left bottom",at:"left top"},select:function(t,e){return $("#contentText").html("").append('&nbsp;<span class="txt_dia" contenteditable="false" uid="'+e.item.value+'" utype="'+e.item.userType+'">@<label>'+e.item.label+"</label></span>&nbsp;").focusEnd(),!1}}).autocomplete("instance")._renderItem=function(t,e){return $("<li>").append("<a>"+e.label+"</a>").appendTo(t)},$("#sendBtn").click(function(){if(studioChat.userInfo.isSetName===!1)return void studioChat.openInfoSetBox();var t=studioChat.getToUser(),e=studioChat.getSendMsg();if(e!==!1){var i={uiId:studioChat.getUiId(),fromUser:studioChat.userInfo,content:{msgType:studioChat.msgType.text,value:e}},s=$(".replybtn");t&&t.userId==s.attr("uid")&&t.talkStyle==s.attr("ts")&&$(".mymsg,.mymsg em").hide(),i.fromUser.toUser=t,studioChat.socket.emit("sendMsg",i),studioChat.setContent(i,!0,!1),$("#contentText").html("")}}),this.placeholderSupport()},checkClientGroup:function(t){var e=studioChat.userInfo.clientGroup,i=!1;switch(t){case"visitor":i="visitor"==e;break;case"vip":i="vip"==e||"active"==e;break;case"new":i="vip"!=e&&"active"!=e}return i},refreshNickname:function(t,e){studioChat.userInfo.isSetName=t,studioChat.userInfo.nickname=e,$(".username").text(e);var i=$("#userListId li a.ume");i.html(i.find("div").clone(!0)),i.append(e+"【我】"),$("#mdr_nk").attr("t",e).val(e)},searchUserList:function(t){var e=$("#userListId li[t!=14][t!=0]").map(function(){var e=$(this).find(".uname").text();return-1!=e.indexOf(t)?{value:this.id,label:e,userType:$(this).attr("utype")}:null}).get(),i=$("#teacherListId li").map(function(){var e=$(this).find("strong").text();return-1!=e.indexOf(t)?{value:this.id,label:e,userType:$(this).attr("utype")}:null}).get();return e.concat(i)},showViewSelect:function(t){"analyst"==t?($("#dialog_list").children("[utype!=2]").hide(),$("#dialog_list").children("[utype=2]").show()):"me"==t?($("#dialog_list").children("[isMe=false]").hide(),$("#dialog_list").children("[isMe=true]").show()):$("#dialog_list").children().show()},getSendMsg:function(t){var t=t?t:$("#contentText");if(t.text().length+t.find("img").size()>140)return alert("消息内容超过最大长度限制（140字以内）！"),!1;t.find(".txt_dia").length>0&&t.find(".txt_dia").remove();var e=common.clearMsgHtml(t.html());return common.isBlank(e)?(t.html(""),!1):e},placeholderSupport:function(){var t="placeholder"in document.createElement("input");t||$(".formcont .in_line input[placeholder]").each(function(){var t=$(this).attr("placeholder");if(t){var e=$(this),i=$('<span class="placeholder">'+t+"</span>");e.before(i),i.bind("click",function(){$(this).hide(),$(this).next().focus()}),e.bind("focus",function(){$(this).prev().hide()}),e.bind("blur",function(){""===$(this).val()&&$(this).prev().show()}),""!=e[0].defaultValue&&e.prev().hide(),$(this).attr("placeholder","")}})},setListScroll:function(t){$(t).hasClass("mCustomScrollbar")?$(t).mCustomScrollbar("update"):$(t).mCustomScrollbar({theme:"minimal-dark"})},setTalkListScroll:function(t,e,i){var s=e?e:$("#chatMsgContentDiv");s.hasClass("mCustomScrollbar")?(s.mCustomScrollbar("update"),t&&s.mCustomScrollbar("scrollTo","bottom")):(s.mCustomScrollbar({scrollInertia:1,scrollButtons:{enable:!0},theme:i?i:"light-2"}),s.mCustomScrollbar("scrollTo","bottom"))},getToUser:function(){var t=$("#contentText .txt_dia");return t.length>0?{userId:t.attr("uid"),nickname:t.find("label").text(),talkStyle:0,userType:t.attr("utype")}:null},checkFormInput:function(t){var e=!0,i=$(t+" .wrong-info");return i.attr("tId","").html(""),$(t+" input").each(function(){return common.isBlank($(this).val())?("mobilePhone"==this.name&&i.attr("tId",this.name).html("手机号码不能为空！"),"verifyCode"==this.name&&i.attr("tId",this.name).html("验证码不能为空！"),"nickname"==this.name&&i.attr("tId",this.name).html("昵称不能为空！"),e=!1):"mobilePhone"!=this.name||($(this).val($.trim($(this).val())),common.isMobilePhone(this.value))?"nickname"!=this.name||common.isRightName(this.value)?void 0:(i.attr("tId",this.name).html("昵称为2至10位字符(数字、英文、中文、下划线),不能全是数字"),e=!1):(i.attr("tId",this.name).html("手机号码输入有误！"),e=!1)}),e},resetVerifyCode:function(t){studioChat.verifyCodeIntervalId&&(clearInterval(studioChat.verifyCodeIntervalId),studioChat.verifyCodeIntervalId=""),$(t+" .rbtn").attr("t",60).html("获取验证码"),$(t+" input[name=mobilePhone]").trigger("input")},openLoginBox:function(t){$("#loginForm")[0].reset(),this.resetVerifyCode("#loginForm"),$(".blackbg").children().hide(),t?$("#loginBox .pop_close").hide():$("#loginBox .pop_close").show(),$("#loginBox,.blackbg").show()},openInfoSetBox:function(){$("#pmInfoSetForm")[0].reset(),$(".blackbg").children().hide(),$("#pmInfoSetBox,.blackbg").show()},formatPublishTime:function(t,e,i){var s=Number(t.replace(/_.+/g,""));return common.isBlank(t)?"":e?common.formatterDateTime(s,i):common.getHHMM(s)},setDialog:function(t,e,i,s,o){if(1==i){studioChat.fillWhBox(s,t,e,!1),studioChat.getWhBox().show();var a=$(".mult_dialog a[uid="+t+"]");a.click(),common.isValid(o)&&a.find("img").attr("src",o)}else $("#contentText .txt_dia").remove(),$("#contentText").html($("#contentText").html().replace(/^((&nbsp;)+)/g,"")),$("#contentText").prepend('&nbsp;<span class="txt_dia" contenteditable="false" uid="'+t+'" utype="'+s+'">@<label>'+e+"</label></span>&nbsp;").focusEnd()},setContent:function(t,e,i){var s=t.fromUser;if(e&&(s.publishTime=t.uiId),t.isVisitor)return $("#"+t.uiId).remove(),void studioChat.openLoginBox();if(i&&$("#"+s.publishTime).length>0)return $("#"+s.publishTime+" .dcont em[class=ruleTipStyle]").remove(),void $("#"+s.publishTime+" input").remove();if(t.rule)return void(t.value&&t.value.needApproval?$("#"+t.uiId).attr("id",s.publishTime):$("#"+t.uiId+" .dcont").append('<em class="ruleTipStyle">'+t.value.tip+"</em>"));if(!e&&studioChat.userInfo.userId==s.userId&&t.serverSuccess)return $("#"+t.uiId+" .dtime").html(studioChat.formatPublishTime(s.publishTime)),void $("#"+t.uiId).attr("id",s.publishTime);var o=studioChat.formatContentHtml(t,e,i),a=$("#dialog_list");a.append(o),this.formatMsgToLink(s.publishTime);var n=$(".view_select .selectlist a[class=on]").attr("t");"all"!=n&&studioChat.showViewSelect(n),!i&&$(".scrollbtn").hasClass("on")&&studioChat.setTalkListScroll(!0),$("#"+s.publishTime+" .headimg").click(function(){studioChat.openDiaLog($("#"+s.publishTime+" .dialogbtn").attr("avs",$(this).find("img").attr("src")))}),$("#"+s.publishTime+" .txt_dia").click(function(){studioChat.setDialog($(this).attr("uid"),$(this).find("label").text(),0,$(this).attr("utype"))}),$("#"+s.publishTime+" .uname").click(function(){var t=$("#"+s.publishTime+" .dialogbtn");t.attr("avs",$(this).parent().parent().find(".headimg img").attr("src")),studioChat.openDiaLog(t),t.css("left","62px"),t.css("top","30px")})},openDiaLog:function(t){if($(".dialogbtn").not(t).hide(),!t.is(":hidden"))return t.hide(),!1;t.css("left","0");var e=t.parent();common.isValid(e.attr("utype"))&&(0===e.next().size()?t.css("top",-11-t.height()+"px"):t.css("top",e.hasClass("analyst")?"53px":"39px")),t.show();var i=t.find("a"),s=t.attr("avs");common.isValid(s)?(i.attr("avs",s),t.attr("avs","")):i.attr("avs",""),i.click(function(){var t=$(this).parent();studioChat.setDialog(t.attr("uid"),t.attr("nk"),$(this).attr("t"),t.attr("utype"),$(this).attr("avs")),t.hide()})},formatContentHtml:function(t,e,i){var s="dialog ",o="",a="",n="uname ",r="false",d=t.fromUser,l=t.content,u=d.nickname,h=d.toUser,c="";h&&common.isValid(h.userId)&&(c='<span class="txt_dia" uid="'+h.userId+'" utype="'+h.userType+'">@<label>'+h.nickname+"</label></span>",studioChat.userInfo.userId==h.userId&&(r="true")),o=l.value,studioChat.userInfo.userId==d.userId?(s+="mine",u="我",r="true"):(2==d.userType&&(s+="analyst"),1==d.userType&&(s+="admin"),a=studioChat.getDialogHtml(d.userId,u,d.userType),!i&&h&&studioChat.userInfo.userId==h.userId&&($(".mymsg").show(),$(".mymsg em").hide(),$(".replybtn").attr("uid",d.userId),$(".replybtn").attr("ts",h.talkStyle),$(".replybtn").attr("futype",d.userType),$(".sender").html(d.nickname),$(".xcont").html(o)));var m='<div class="'+s+'" id="'+d.publishTime+'" isMe="'+r+'" utype="'+d.userType+'" mType="'+l.msgType+'" t="header"><a href="javascript:" class="headimg" uid="'+d.userId+'">'+studioChat.getUserAImgCls(d.clientGroup,d.userType,d.avatar)+'</a><i></i><p><a href="javascript:"  class="'+n+'">'+u+'</a><span class="dtime">'+studioChat.formatPublishTime(d.publishTime)+'</span><span class="dcont">'+c+o+"</span></p>"+a+"</div>";return m},formatMsgToLink:function(t){$("#"+t+' .dcont:contains("http:"),#'+t+' .dcont:contains("https:")').each(function(t,e){var i=$(e).html(),s=i.split(/<img src="\S+">/g),o="";for(var a in s)if(o=s[a],!common.isBlank(o)){var n=o.replace(/(http:\/\/|https:\/\/)((\w|=|\?|\.|\/|\\&|-)+)(:\d+)?(\/|\S)+/g,function(t){return'<a href="'+t+'" target="_blank" style="color:#3181c6;">'+t+"</a>"});e.innerHTML=e.innerHTML.replace(o,n)}})},removeLoadDom:function(t){$("#"+t+" .img-loading,#"+t+" .img-load-gan,#"+t+" .shadow-box,#"+t+" .shadow-conut").remove()},getUserAImgCls:function(t,e,i){var s="";return e&&0!=e&&common.isValid(i)?'<img src="'+i+'">':(s="vip"==t?"user_v":"active"==t||"notActive"==t?"user_r":"simulate"==t?"user_d":"register"==t?"user_m":"user_c",'<img src="images/studio/'+s+'.png">')},getUserLevelShortName:function(t){var e="";switch(t){case"vip":e="[V]";break;case"real":e="[R]";break;case"active":e="[A]";break;case"notActive":e="[N]";break;case"simulate":e="[D]";break;case"register":e="[M]";break;default:e="游客"}return e},getDialogHtml:function(t,e,i){if(t&&studioChat.userInfo.userId!=t){var s=!1,o=$("#studioListId a[class~=ing]"),a='<div class="dialogbtn" style="display:none;" nk="'+e+'" uid="'+t+'" utype="'+i+'">';return a+='<a href="javascript:" class="d1" t="0"><span>@TA</span></a>',s=!0,"true"==o.attr("aw")&&common.containSplitStr(o.attr("awr"),i)&&(a+='<a href="javascript:" class="d2" t="1"><span>私聊</span></a>',s=!0),s?a+"</div>":""}return""},teachSlide:function(){studioChat.teachIndex=0,$("#teacherListId").width(0),$(".te_next").click(function(){var t=$(".te_ul li:first").width();$(".te_ul").width()-studioChat.teachIndex*t-$(".te_list .tempwrap").width()>0&&($(".pointlist").hide(),$("#teacherListId a.on").removeClass("on"),studioChat.teachIndex++,$(".te_ul").animate({left:-studioChat.teachIndex*t},"slow"))}),$(".te_prev").click(function(){if(0!=studioChat.teachIndex){$(".pointlist").hide(),$("#teacherListId a.on").removeClass("on"),studioChat.teachIndex--;var t=$(".te_ul li:first").width();$(".te_ul").animate({left:-studioChat.teachIndex*t},"slow")}})},setOnlineUser:function(t){if(2==t.userType){$("#teacherListId li[uid='"+t.userId+"']").remove();var e=$("#teacherListId li").length,i=$('<li uid="'+t.userId+'" utype="'+t.userType+'" t="'+e+'"><a title="'+(t.introduction||"")+'" href="javascript:" class="te_btn"><img class="headimg" src="'+t.avatar+'"><span><strong>'+t.nickname+"</strong><i>"+(t.position||"")+'</i></span><div class="mp"><b></b>老师<br>观点</div></a></li>');$("#teacherListId").append(i),$("#teacherListId").width($("#teacherListId").width()+i.width()),$(".te_dialoglist").append(studioChat.getDialogHtml(t.userId,t.nickname,t.userType)),i.click(function(){if($(".te_dialoglist div").length>0){var t=$(".te_dialoglist .dialogbtn").eq($(this).index());t.attr("avs",$(this).find(".headimg").attr("src")),studioChat.openDiaLog(t),t.css("left",$(this).offset().left-$(".chat").offset().left+5)}}).find(".mp").click(function(t){window.event?window.event.cancelBubble=!0:t&&t.stopPropagation();var e=$(this).parent();if(!e.hasClass("on")){$("#teacherListId a").removeClass("on"),e.addClass("on");var i=$(".te_ul li:first").width(),s=e.parent(),o=(parseInt(s.attr("t"))-Math.abs(studioChat.teachIndex))*i+38,a=$(".pointlist").width(),n=$(".chat").width();o+a>=n&&(o=n-a);var r=s.attr("uid");studioChat.getArticleList("trade_strategy_article",studioChat.userInfo.groupId,1,1,1,'{"createDate":"desc"}',r,function(t){if($(".pointlist").attr("uid",r),t&&0==t.result&&t.data&&t.data.length>0){var e=t.data[0],i=e.detailList[0];$(".pointlist .tit label").text(i.title),$(".pointlist .te-txt").html(i.content)}else $(".pointlist .tit label").text("亲，老师还未发布观点哦"),$(".pointlist .te-txt").html("")}),$(".pointlist").css({left:o+"px"}).show()}})}else{$("#userListId li[id='"+t.userId+"']").remove();var s=studioChat.getDialogHtml(t.userId,t.nickname,t.userType),o="",a="uname",n=t.sequence;studioChat.userInfo.userId==t.userId&&(o="【我】",a+=" ume",n="0");var r=$("#userListId li"),d='<li id="'+t.userId+'" t="'+n+'" utype="'+t.userType+'">'+s+'<a href="javascript:" t="header" class="'+a+'"><div class="headimg">'+studioChat.getUserAImgCls(t.clientGroup,t.userType,t.avatar)+"</div>"+t.nickname+o+"</a></li>";if(0==r.length)$("#userListId").append(d);else if(""!=o)r.first().before(d);else{var l=!1,u=0,h="";r.each(function(){return u=parseInt($(this).attr("t")),t.sequence<u?($(this).before(d),l=!0,!1):t.sequence==u&&(h=$(this).find("a").text(),t.nickname<=h)?($(this).before(d),l=!0,!1):void 0}),l||$("#userListId").append(d)}common.isValid(s)&&$("#userListId li[id="+t.userId+"] a[t=header]").click(function(){$(".user_box li").removeClass("zin"),$(this).parent().addClass("zin");var t=$(this).prev();t.attr("avs",$(this).find(".headimg img").attr("src")),studioChat.openDiaLog(t),$(".dialogbtn",$(this).parent()).css("left","7px")})}return!0},leaveRoomTip:function(t,e){if("forcedOut"!=t){if("visitor"!=studioChat.userInfo.clientGroup){var i="";"roomClose"==t&&(i="房间已停用，"),"otherLogin"==t&&(i="您的账号已在其他地方登陆，"),$(".blackbg").show(),$("#tipMsgBox").fadeIn(0).delay(6e3).fadeOut(200).find("span").text("注意："+i+"正自动登出....."),window.setTimeout(function(){$(".logout").trigger("click")},3e3)}}else if(e)for(var s in e)$("#teacherListId li[uid='"+e[s]+"']").remove(),$(".pointlist[uid='"+e[s]+"']").hide()},setSocket:function(){this.socket=common.getSocket(io,this.socketUrl,this.userInfo.groupType),this.socket.on("connect",function(){console.log("connected to server!"),studioChat.userInfo.socketId=studioChat.socket.id;var t=$("#studioListId a[class~=ing]");studioChat.socket.emit("login",{userInfo:studioChat.userInfo,lastPublishTime:$("#dialog_list>div:last").attr("id"),fUserTypeStr:t.attr("awr"),allowWhisper:t.attr("aw")}),$(".img-loading[pf=chatMessage]").show()}),this.socket.on("onlineUserList",function(t,e){if($("#userListId").html(""),"true"==$("#studioListId a[class~=ing]").attr("av")&&200>=e)for(var i=0,s=10>=e?60:200/e*3+10,o=0;s>o;o++)i=common.randomNumber(6),t["visitor_"+i]={userId:"visitor_"+i,clientGroup:"visitor",nickname:"游客_"+i,sequence:15,userType:-1};var a=null;for(var o in t)a=t[o],studioChat.setOnlineUser(a);studioChat.setCSList(),studioChat.setListScroll(".user_box")}),this.socket.on("disconnect",function(t){console.log("disconnect")}),this.socket.on("error",function(t){console.error("e:"+t)}),this.socket.on("sendMsg",function(t){t.fromUser.toUser&&1==t.fromUser.toUser.talkStyle?studioChat.setWhContent(t,!1,!1):studioChat.setContent(t,!1,!1)}),this.socket.on("notice",function(t){switch(t.type){case"onlineNum":var e=t.data,i=e.onlineUserInfo;if(e.online){if(studioChat.setOnlineUser(i),3==i.userType&&studioChat.isAllowWh()){var s=$(".cm_wrap a[uid="+i.userId+"]");s.find("img").removeClass("have_op"),$(".cm_wrap").prepend(s),studioChat.showTwoCS()}}else if(2==i.userType)$("#teacherListId li[uid='"+i.userId+"']").remove(),$(".pointlist[uid='"+i.userId+"']").hide();else if(studioChat.userInfo.userId!=i.userId&&($("#userListId #"+i.userId).remove(),studioChat.setListScroll(".user_box")),3==i.userType&&studioChat.isAllowWh()){var s=$(".cm_wrap a[uid="+i.userId+"]");s.find("img").addClass("have_op"),$(".cm_wrap").append(s),$(".cm_wrap a:not(:hidden)").length>0&&studioChat.showTwoCS()}studioChat.setWhOnlineTip(i.userId,e.online);break;case"removeMsg":$("#"+t.data.replace(/,/g,",#")).remove(),studioChat.setTalkListScroll();break;case"leaveRoom":studioChat.leaveRoomTip(t.flag,t.userIds);break;case"pushInfo":var e=t.data;1==e.position?(studioChat.pushObj.whPush={info:e.content,publishTime:e.publishTime,infoId:e.contentId},window.setTimeout(function(){var t=$(".cm_wrap a");if(0==studioChat.getWhBox().length&&t.length>0){var e=t.find("img:not(.have_op)"),i=null;i=e.length>0?$(e.get(common.randomIndex(e.length))).parent():$(t.get(common.randomIndex(t.length))),i.click()}},60*e.timeOut*1e3)):3==e.position&&studioChat.talkBoxPush.initTBP(e.infos);break;case"approvalResult":var e=t.data;if(e.refuseMsg){var o=e.publishTimeArr;for(var a in o)$("#"+o[a]+" .dcont em[class=ruleTipStyle]").html("已拒绝")}else{for(var a in e)studioChat.formatUserToContent(e[a]);studioChat.setTalkListScroll(!0)}}}),this.socket.on("loadMsg",function(t){$(".img-loading[pf=chatMessage]").hide();var e=t.msgData,i=t.isAdd;if(i||$("#content_ul").html(""),e&&$.isArray(e)){e.reverse();for(var s in e)studioChat.formatUserToContent(e[s])}studioChat.setTalkListScroll(!0)}),this.socket.on("loadWhMsg",function(t){var e=t.data;if("offline"==t.type){if(e&&!$.isEmptyObject(e)){studioChat.setWhBox(!0);var i,s=0,o="",a="";for(var n in e)0==s&&(a='<label class="tip_nk">'+e[n].nickname+"</label>",o=n,i=e[n].userType),studioChat.setWhVisitors(e[n].userType,n,e[n].nickname,$("#userListId li[id='"+n+"']").length>0),studioChat.setWhAvatar(e[n].userType,n,e[n].avatar);studioChat.setWhTipInfo(i,a,o)}}else if(e&&$.isArray(e)){var r=0,d=null;e.reverse();var l=0,u=$(".mult_dialog a[uid="+t.toUserId+"]");for(var h in e)d=e[h],3==d.userType&&studioChat.setWhPushInfo(u,d.publishTime)&&l++,studioChat.formatUserToContent(d,!0,t.toUserId),d.content.msgType==studioChat.msgType.img&&r++;0==l&&studioChat.setWhPushInfo(u,null),r>0&&$(".swipebox").swipebox(),studioChat.setTalkListScroll(!0,$("#wh_msg_"+t.toUserId+" .wh-content"),"dark")}})},setWhPushInfo:function(t,e){if($.isEmptyObject(studioChat.pushObj.whPush))return!1;if(e&&e<studioChat.pushObj.whPush.publishTime)return!1;var i=t.attr("uid"),s=t.find("span").text();if($("#wh_msg_"+i+" div[id="+studioChat.pushObj.whPush.publishTime+"]").length>0)return!1;var o={fromUser:{publishTime:studioChat.pushObj.whPush.publishTime,userId:i,nickname:s,userType:3},content:{msgType:studioChat.msgType.text,value:studioChat.pushObj.whPush.info,infoId:studioChat.pushObj.whPush.infoId}};return studioChat.setWhContent(o,!1,!1,!0),!0},formatUserToContent:function(t,e,i){var s={userId:t.userId,nickname:t.nickname,avatar:t.avatar,userType:t.userType,groupId:t.groupId,clientGroup:t.clientGroup,publishTime:t.publishTime,toUser:t.toUser,avatar:t.avatar,position:t.position};e?(s.toWhUserId=i,studioChat.setWhContent({fromUser:s,content:t.content},!1,!0)):studioChat.setContent({fromUser:s,content:t.content},!1,!0)},talkBoxPush:{initTBP:function(t){this.clear(),studioChat.pushObj.talkPush=t,this.start()},clear:function(){studioChat.pushObj.talkPushInterval&&(window.clearInterval(studioChat.pushObj.talkPushInterval),studioChat.pushObj.talkPushInterval=null);for(var t=studioChat.pushObj.talkPush,e=null,i=0,s=t.length;s>i;i++)e=t[i],e.timeoutId&&window.clearTimeout(e.timeoutId),e.intervalId&&window.clearInterval(e.intervalId)},start:function(){var t=studioChat.pushObj.talkPush;t&&t.length>0&&(studioChat.pushObj.talkPushInterval=window.setInterval(function(){studioChat.talkBoxPush.check()},1e4))},check:function(){for(var t=studioChat.pushObj.talkPush,e=null,i=0,s=t.length;s>i;i++)e=t[i],e.startFlag||common.dateTimeWeekCheck(e.pushDate,!1,studioChat.serverTime)&&(e.startFlag=!0,e.timeoutId=window.setTimeout(studioChat.talkBoxPush.delayStartTask(e),60*(e.onlineMin||0)*1e3))},delayStartTask:function(t){return function(){studioChat.talkBoxPush.showMsg(t),t.intervalMin&&t.intervalMin>0&&(t.intervalId=window.setInterval(studioChat.talkBoxPush.startTask(t),60*t.intervalMin*1e3))}},startTask:function(t){return function(){common.dateTimeWeekCheck(t.pushDate,!1,studioChat.serverTime)?studioChat.talkBoxPush.showMsg(t):(window.clearInterval(t.intervalId),t.startFlag=!1)}},showMsg:function(t){var e=[];e.push('<div class="dialog push">'),e.push(t.content),e.push("</div>"),$("#dialog_list").append(e.join("")),$(".scrollbtn").hasClass("on")&&studioChat.setTalkListScroll(!0)}}};$(function(){studioChat.init()});