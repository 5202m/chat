var studioChat={initSewise:!1,web24kPath:"",filePath:"",apiUrl:"",studioDate:"",verifyCodeIntervalId:null,msgType:{text:"text",img:"img",file:"file"},socket:null,socketUrl:"",userInfo:null,oldTalkDivH:0,newTalkDivH:0,init:function(){this.setSocket(),this.setVideoList(),this.setEvent(),this.setScrollNotice(),this.setPrice(!0)},playVideoByDate:function(){common.dateTimeWeekCheck(this.studioDate,!0)?this.setVideo(!0):$("#studioTeachId li:first a").click()},setVideo:function(t,e){try{if(t){if(this.initSewise&&(SewisePlayer.doStop(),$("#tVideoDiv").parent().hide()),0==$("#yyVideoDiv embed").length){var i=$("#studioListId a[class~=ing]"),s=i.attr("yc"),o=i.attr("mc");$('<embed src="http://yy.com/s/'+s+(common.isValid(o)?"/"+o:"")+'/mini.swf" wmode="Opaque" quality="high" width="100%" height="100%" align="middle" allowScriptAccess="never" allowFullScreen="true" mode="transparent" type="application/x-shockwave-flash"></embed>').appendTo("#yyVideoDiv")}$("#yyVideoDiv").show()}else{$("#tVideoDiv").parent().show(),$("#yyVideoDiv").hide();var n=e.attr("vUrl"),a=e.text();if(this.initSewise)SewisePlayer.toPlay(n,a,0,!0);else{var r=[];r.push("/js/lib/sewise.player.min.js?server=vod"),r.push("type=mp4"),r.push("videourl="+n),r.push("autostart=true"),r.push("logo="),r.push("title=VodVideo"),r.push("buffer=5");var l=r.join("&"),d=document.createElement("script");d.type="text/javascript",d.src=l,$("#tVideoDiv").get(0).appendChild(d),this.initSewise=!0}}}catch(u){console.error("setVideo has error:"+u)}},getUiId:function(){var t=new Date;return t.getTime()+"_ms"},setPrice:function(t){try{$.getJSON(this.apiUrl+"/get24kPrice").done(function(t){if(!t)return $(".pro_box .pro_c,.pro_box .pro_n").text("--"),!1;var e=t.result.row,i=null;$.each(e,function(t,e){if(null!=e){i=e.attr;var s=i.gmcode,o=i.bid,n=i.change,a=""!=$.trim(n)&&-1!=n.indexOf("-")?"down":"up",r=n/(o-n)*100,l=$(".pro_box div[name="+s+"]");l.find(".pro_c").text(Number(o).toFixed(2));var d=l.find(".pro_n");d.text(Number(r).toFixed(2)+"%"),"up"==a?d.removeClass("red").addClass("green"):"down"==a&&d.removeClass("green").addClass("red")}})}),t&&$(".pro_notice").slide({titCell:".num ul",mainCell:".pro_box",effect:"fade",autoPlay:!0,delayTime:800,interTime:5e3,autoPage:!1,prevCell:".pro_prev",nextCell:".pro_next",endFun:function(){studioChat.setPrice(!1)}})}catch(e){console.error("setPrice->"+e)}},getNewsInfoList:function(t,e,i,s){try{var o=i||5;$.getJSON(this.apiUrl+"/getNewsInfoList",{pageNo:1,pageSize:o,lang:"zh",contentType1:t,contentType2:e},function(t){s(t)})}catch(n){console.error("getNewsInfoList->"+n)}},setScrollNotice:function(){this.getNewsInfoList(2,null,3,function(t){$(".sro_list").html("");var e=null;if(t&&0==(e=t.informations).result){var i=e.informationList,s=null;for(var o in i)s=i[o],$(".sro_list").append('<li><i></i><a href="'+studioChat.web24kPath+("/zh/news/"+s.id+".html")+'" target="_blank" style="color:#ffffff;"><span>'+s.title+"</span></a></li>");$(".sro_notice").slide({mainCell:".sro_list",effect:"topLoop",autoPlay:!0,delayTime:600,interTime:3e3,autoPage:!1})}else console.error("提取数据有误！")})},setNewsInfo:function(t,e,i,s){$(t).html(""),this.getNewsInfoList(e,i,s,function(e){var s=null;if(e&&0==(s=e.informations).result){var o=s.informationList,n=null;for(var a in o)n=o[a],$(t).append('<li><a href="'+studioChat.web24kPath+"/zh/goldreview/"+n.id+"_"+n.contenttype2+'.html" target="_blank"><span class="ndate">'+n.datestr+"</span>"+n.title+"</a></li>");$(t).append('<li><a href="'+studioChat.web24kPath+"/zh/goldreview/goldreviewlist_"+i+'.html" target="_blank" class="listmore">更多</a></li>')}else console.error("提取数据有误！")})},getArticleList:function(t,e,i,s,o,n,a){try{$.getJSON("/studio/getArticleList",{code:t,platform:e,hasContent:i,pageNo:s,pageSize:o,orderByStr:n},function(t){a(t)})}catch(r){console.error("getArticleList->"+r),a(null)}},setVideoList:function(){$(".img-loading[pf=studioTeachId]").show(),this.getArticleList("teach_video",this.userInfo.groupId,0,1,100,'{"sequence":"asc"}',function(t){if($("#studioTeachId").html(""),$(".img-loading[pf=studioTeachId]").hide(),t&&0==t.result){var e=t.data,i=null;for(var s in e)i=e[s].detailList[0],$("#studioTeachId").append('<li><a title="'+i.title+'" href="javascript:" id="'+e[s]._id+'" vUrl="'+e[s].mediaUrl+"\" onclick=\"_gaq.push(['_trackEvent', 'studio', 'video_play',$(this).text()]);\"><i></i>"+i.title+"</a></li>");$("#studioTeachId li a").click(function(){$(this).is(".on")||($("#studioTeachId li a.on").removeClass("on"),$(this).addClass("on")),studioChat.setVideo(!1,$(this))})}studioChat.playVideoByDate()})},toRefreshView:function(){window.location.reload()},setVerifyCodeTime:function(t){var e=parseInt($(t).attr("t"))||60;studioChat.verifyCodeIntervalId||(studioChat.verifyCodeIntervalId=setInterval("studioChat.setVerifyCodeTime('"+t+"')",1e3)),e>1?$(t).attr("t",e-1).html(e-1+"秒后重新获取"):(clearInterval(studioChat.verifyCodeIntervalId),studioChat.verifyCodeIntervalId="",$(t).attr("t",60).html("获取验证码").addClass("pressed"))},setEvent:function(){$(".vbackbtn").click(function(){studioChat.setVideo(!0)}),$(".te_ctrl .show_btn").click(function(){$(".te_list").animate({height:"53px"},"slow"),$(".te_ctrl a").removeClass("show"),$(".te_ctrl .hide_btn").addClass("show")}),$(".te_ctrl .hide_btn").click(function(){$(".te_list").animate({height:0},"slow"),$(".te_ctrl a").removeClass("show"),$(".te_ctrl .show_btn").addClass("show")}),$(".facebtn").qqFace({id:"faceId",assign:"contentText",path:studioChat.filePath+"/face/"}),$(document).click(function(t){$("#faceId").hide().remove(),$(t.target).hasClass("headimg")||$(t.target).parents().hasClass("headimg")||"header"==$(t.target).parent().attr("t")||$(t.target).hasClass("uname")||$(t.target).parents().hasClass("te_ul")||$(".dialogbtn").hide()}),$("#studioListId a").click(function(){return $(this).hasClass("ing")?!1:"disable"==$(this).attr("disable")?(alert("您未获取访问该直播间的权限，如需进入请升级直播间等级或联系客服！"),!1):void common.getJson("/studio/checkGroupAuth",{groupId:this.id},function(t){t.isOK?studioChat.toRefreshView():alert("您未获取访问该直播间的权限，如需进入请升级直播间等级或联系客服！")},!0,function(t){"success"!=t&&alert("操作失败，请联系客服！")})}),$(".username").click(function(){$(".blackbg").children("div").hide(),$("#userInfoBox,.blackbg").show()}),$(".upg_btn").click(function(){try{$(".upg_list").show(),$("#up_loading").show(),$.getJSON("/studio/getClientGroupList",null,function(t){if($("#up_loading").hide(),t){$("#upg_tbody_id").html("");var e="",i=0,s=null;for(var o in t)t[o]._id==studioChat.userInfo.clientGroup&&(i=t[o].sequence);for(var n in t){s=t[n],e=s._id==studioChat.userInfo.clientGroup?"当前级别":"visitor"!=s._id&&i<s.sequence?"vip"==s._id?"联系客服升级":'<a href="javascript:" t="'+s._id+'">升级</a>':"---";var a=[];a.push('<tr><td align="center" valign="middle">'+studioChat.getUserLevelShortName(s._id)+"</td>"),a.push('<td align="center" valign="middle">'+common.trim(s.remark)+"</td>"),a.push('<td align="center" valign="middle">'+common.trim(s.authorityDes)+"</td>"),a.push('<td align="center" valign="middle">'+e+"</td></tr>"),$("#upg_tbody_id").append(a.join(""))}$("#upg_tbody_id a").click(function(){var t=$(this);common.getJson("/studio/upgrade",null,function(e){if(t.attr("disabled",!1),e.isOK)$(".upg_succ").show();else{var i=t.attr("t"),s="";"real"===i?s="很遗憾，您未开通金道真实交易账户，升级失败！<br>如有疑问请联系客服！":"simulate"===i&&(s="很遗憾，您未开通金道模拟交易账户，升级失败！<br>如有疑问请联系客服！"),$("#upg_fail span:first").html(s),$("#upg_fail").show()}},!0,function(e){t.attr("disabled",!1)})})}})}catch(t){$("#up_loading").hide(),console.error("getClientGroupList->"+t)}}),$(".in_rbtn .qu_btn").hover(function(){$(".upg_tip").addClass("show")},function(){$(".upg_tip").removeClass("show")}),$("#toPmLogin").click(function(){$("#loginComBox").hide(),$("#loginPmBox").show()}),$(".mod_tab .tab_nav a").click(function(){$(".mod_tab .tab_nav a").removeClass("on"),$(".mod_tab .tab_box").removeClass("on"),$(this).addClass("on"),$($(".mod_tab .tab_box")[$(this).index()]).addClass("on");var t=$(this).attr("t");"tradeInfoTab"==t?studioChat.setNewsInfo("#tradeInfoTab",3,5):"commentTab"==t?studioChat.setNewsInfo("#commentTab",3,3):"studioPlanTab"==t?studioChat.getArticleList("studio_plan",studioChat.userInfo.groupId,1,1,1,'{"sequence":"asc"}',function(t){if($("#studioPlanTab").html(""),t&&0==t.result){var e=t.data;e&&e.length>0&&($("#studioPlanTab").html(e[0].detailList[0].content),studioChat.setTabInfoScroll())}}):"bulletinTab"==t?studioChat.getArticleList("bulletin_system",studioChat.userInfo.groupId,1,1,1,'{"sequence":"asc"}',function(t){if($("#bulletinTab").html(""),t&&0==t.result){var e=t.data;e&&e.length>0&&($("#bulletinTab").html(e[0].detailList[0].content),studioChat.setTabInfoScroll())}}):"downloadTab"==t&&studioChat.getArticleList("download",studioChat.userInfo.groupId,1,1,100,'{"sequence":"asc"}',function(t){if($("#downloadTab").html(""),t&&0==t.result){var e=t.data,i=null;for(var s in e)i=e[s].detailList[0],$("#downloadTab").append("<li><span>"+i.title+'</span><a href="'+e[s].mediaUrl+'" target="_blank" class="downbtn" onclick="_gaq.push([\'_trackEvent\', \'studio\', \'file_download\',$(this).prev().text()]);" >下载</a></li>');studioChat.setTabInfoScroll()}})}),$(".mod_tab .tab_nav a[t=bulletinTab]").click(),$("#login_a,#login_b,#login_c").click(function(){studioChat.openLoginBox()}),$("#register_a,#register_b,#toRegister").click(function(){studioChat.openRegistBox()}),$.each(["#loginPmForm input[name=mobilePhone]","#mobileCheckForm input[name=mobilePhone]","#registFrom input[name=mobilePhone]"],function(t,e){$(e).bind("input propertychange",function(){var t=$(this).parents("form").find(".rbtn");common.isMobilePhone(this.value)?t.addClass("pressed"):t.removeClass("pressed")})}),$(".rbtn").click(function(){if($(this).hasClass("pressed")){$(this).removeClass("pressed").html("");var t=$(this).attr("pf"),e=$("#"+t+" input[name=mobilePhone]").val();try{studioChat.setVerifyCodeTime(".rbtn[pf="+t+"]"),$.getJSON("/studio/getMobileVerifyCode",{mobilePhone:e},function(e){e&&e.isOK||(console.error("提取数据有误！"),studioChat.resetVerifyCode("#"+t))})}catch(i){console.error("setMobileVerifyCode->"+i)}}}),$(".popup_box .pop_close,.formbtn[t=close]").click(function(){$(".blackbg form").each(function(){this.reset()}),$(".wrong-info").html("").attr("tId","");var t=$(this).parent().parent(),e=t.parent().attr("id"),i=t.attr("id");t.hide(),"loginBox"!=e&&"registBox"!=e&&!t.parent().hasClass("blackbg")||"modifyPwdBox"==i||$(".blackbg").hide().children().hide()}),$("#loginForm input[type=text]").blur(function(){common.isValid(this.value)&&$("#loginForm .wrong-info[tId="+this.name+"]").html("")}),$("input[type='password']").bind("paste",function(){return!1}),$("#loginComForm input[name='pwd']").keydown(function(t){return 13==t.keyCode?($("#loginComForm a[tn='loginBtn']").trigger("click"),!1):void 0}),$("#loginPmForm input[name='verifyCode']").keydown(function(t){return 13==t.keyCode?($("#loginPmForm a[tn='loginBtn']").trigger("click"),!1):void 0}),$("#loginComForm a[tn=loginBtn],#loginPmForm a[tn=loginBtn]").click(function(){var t=$(this).parents("form").attr("id");if(studioChat.checkFormInput("#"+t)){$(this).attr("disabled",!0);var e=this;$("#formBtnLoad").show(),common.getJson("/studio/login",$("#"+t).serialize(),function(i){return $("#"+t+" .wrong-info").html(""),$(e).attr("disabled",!1),$("#formBtnLoad").hide(),i.isOK?(_gaq.push(["_trackEvent","studio","login","成功登录数"]),$(".blackbg,#loginBox").hide(),studioChat.toRefreshView(),void 0):i.hasPM?($("#pmInfoSetForm input[name=mobilePhone]").val(i.mobilePhone),$("#pmInfoSetForm input[name=clientGroup]").val(i.clientGroup),$("#pmInfoSetForm input[name=verifyCode]").val(i.verifyCode),$("#loginBox").hide(),$("#pmInfoSetBox").show(),$("#pmInfoSetBtn").click(function(){if(studioChat.checkFormInput("#pmInfoSetForm")){$(this).attr("disabled",!0);var t=this;$("#pmInfoSetLoad").show(),common.getJson("/studio/reg",$("#pmInfoSetForm").serialize(),function(e){return $("#pmInfoSetForm .wrong-info").html(""),$(t).attr("disabled",!1),$("#pmInfoSetLoad").hide(),e.isOK?(_gaq.push(["_trackEvent","studio","register","成功注册数"]),$("#pmInfoSetBox").hide(),studioChat.toRefreshView(),void 0):($("#pmInfoSetForm .wrong-info").html(e.error.errmsg),!1)},!0,function(e){$(t).attr("disabled",!1),$("#pmInfoSetLoad").hide()})}}),!1):($("#"+t+" input[name=verifyCode],#loginForm input[name=pwd]").val(""),$("#"+t+" .wrong-info").html(i.error.errmsg),!1)},!0,function(i){$("#"+t+" input[name=pwd]").val(""),$(e).attr("disabled",!1),$("#formBtnLoad").hide()})}}),$("#registBtn").click(function(){if(studioChat.checkFormInput("#registFrom")){$(this).attr("disabled",!0);var t=this;$("#registLoad").show(),common.getJson("/studio/reg",$("#registFrom").serialize(),function(e){return $("#registFrom .wrong-info").html(""),$(t).attr("disabled",!1),$("#registLoad").hide(),e.isOK?(_gaq.push(["_trackEvent","studio","register","成功注册数"]),$("#registTipBox").show(),$("#registFromBox").hide(),studioChat.toRefreshView(),void 0):($("#registFrom .wrong-info").html(e.error.errmsg),!1)},!0,function(e){$(t).attr("disabled",!1),$("#registLoad").hide()})}}),$(".frbtn,#toGetPwd").click(function(){$(".blackbg").children("div").hide(),studioChat.resetVerifyCode("#mobileCheckBox"),$("#mobileCheckBox").show()}),$("#mobileCheckBtn,#getPwdBtn").click(function(){var t="#"+$(this).attr("pf"),e=$(".img-loading[pf="+$(this).attr("pf")+"]");if(studioChat.checkFormInput(t)){$(this).attr("disabled",!0);var i=this;e.show(),common.getJson("/studio/getPwd",$(t).serialize(),function(s){return $(t+" .wrong-info").html(""),$(i).attr("disabled",!1),e.hide(),s.isOK?void("#mobileCheckForm"==t?($("#getPwdForm input[name=mobilePhone]").val($("#mobileCheckForm input[name=mobilePhone]").val()),$("#getPwdForm input[name=verifyCode]").val($("#mobileCheckForm input[name=verifyCode]").val()),$("#getPwdBox").show(),$("#mobileCheckBox").hide()):($("#getPwdBox").hide(),$("#getPwdTipBox").show())):($(t+" .wrong-info").html(s.error.errmsg),!1)},!0,function(t){$(i).attr("disabled",!1),e.hide()})}}),$("#resetPwdLink").click(function(){$("#modifyPwdForm")[0].reset(),$(".blackbg").children().not("#userInfoBox").hide(),$(".blackbg,#modifyPwdBox").show()}),$("#modifyPwdBtn").click(function(){var t=$(".img-loading[pf="+$(this).attr("pf")+"]");if(studioChat.checkFormInput("#modifyPwdForm")){$(this).attr("disabled",!0);var e=this;t.show(),common.getJson("/studio/resetPwd",$("#modifyPwdForm").serialize(),function(i){return $("#modifyPwdForm .wrong-info").html(""),$(e).attr("disabled",!1),t.hide(),i.isOK?($("#modifyPwdBox,#userInfoBox").hide(),void $("#modifyPwdTipBox").show()):($("#modifyPwdForm .wrong-info").html(i.error.errmsg),!1)},!0,function(i){$(e).attr("disabled",!1),t.hide()})}}),$(".replybtn").click(function(){studioChat.setDialog($(this).attr("uId"),$(".sender").html(),$(this).attr("ts"),$(this).attr("futype"))}),$(".closebtn").click(function(){$(".mymsg").hide()}),$(".clearbtn").click(function(){$("#dialog_list").html(""),studioChat.setTalkListScroll()}),$(".scrollbtn").click(function(){$(this).hasClass("on")?$(this).removeClass("on"):(studioChat.setTalkListScroll(),$(this).addClass("on"))}),$(".view_select").hover(function(){$(this).addClass("dw")},function(){$(this).removeClass("dw")}).find(".selectlist a").click(function(){$(this).is(".on")||($(".view_select .selectlist a").removeClass("on"),$(".view_select .selected").text($(this).text()),$(this).addClass("on"),"analyst"==$(this).attr("t")?($("#dialog_list").children("[utype!=2]").hide(),$("#dialog_list").children("[utype=2]").show()):"me"==$(this).attr("t")?($("#dialog_list").children("[isMe=false]").hide(),$("#dialog_list").children("[isMe=true]").show()):$("#dialog_list").children().show(),studioChat.setTalkListScroll())}),$(".send_select").hover(function(){$(this).addClass("dw"),studioChat.setUserListScroll()},function(){$(this).removeClass("dw")}),$("#send_selelct_list a").bind("click",function(){$(this).is(".on")||($("#teacherListId a.te_btn.on").removeClass("on"),$("#teacherListId li[uid='"+$(this).attr("uid")+"']").trigger("talking"),$(".send_select div.selectlist a").removeClass("on"),$(".send_select div.selected").text($(this).text()),$(this).addClass("on"))}),$("#contentText").keydown(function(t){if(13==t.keyCode){var e=$("#contentText").html();return common.isValid(e)&&($("#contentText").html(e.replace(/<div>|<\/div>/g,"")),$("#sendBtn").click()),!1}}),$("#sendBtn").click(function(){var t=studioChat.getSendMsg();if(t!==!1){var e={uiId:studioChat.getUiId(),fromUser:studioChat.userInfo,content:{msgType:studioChat.msgType.text,value:t}},i=studioChat.getToUser(),s=$(".replybtn");i&&i.userId==s.attr("uid")&&i.talkStyle==s.attr("ts")&&$(".mymsg").hide(),e.fromUser.toUser=i,studioChat.socket.emit("sendMsg",e),studioChat.setContent(e,!0,!1),$("#contentText").html("")}}),this.placeholderSupport()},getSendMsg:function(){if($("#contentText").text().length+$("#contentText img").size()>140)return alert("消息内容超过最大长度限制（140字以内）！"),!1;var t=$("#contentText").html();return t=t.replace(/<\/?(?!img\s+src="[^>"]+\/face\/[^>"]+"\s*>)[^>]*>/g,""),common.isBlank(t)?($("#contentText").html(""),!1):t},placeholderSupport:function(){var t="placeholder"in document.createElement("input");t||$(".formcont .in_line input[placeholder]").each(function(){var t=$(this).attr("placeholder");if(t){var e=$(this),i=$('<span class="placeholder">'+t+"</span>");e.before(i),i.bind("click",function(){$(this).hide(),$(this).next().focus()}),e.bind("focus",function(){$(this).prev().hide()}),e.bind("blur",function(){""===$(this).val()&&$(this).prev().show()}),""!=e[0].defaultValue&&e.prev().hide(),$(this).attr("placeholder","")}})},setTabInfoScroll:function(){$(".tab_box[t=needScoll]").jscroll({W:"6px",BgUrl:"url(/images/studio/scroll.png)",Bg:"0 0 repeat-y",Bar:{Pos:"up",Bd:{Out:"#b3cfe2",Hover:"#4e90bd"},Bg:{Out:"-10px center repeat-y",Hover:"-20px center repeat-y",Focus:"-20px center repeat-y"}},Btn:{btn:!1}})},setUserListScroll:function(){$(".scrollbox").jscroll({W:"6px",BgUrl:"url(/images/studio/scroll.png)",Bg:"0 0 repeat-y",Bar:{Pos:"up",Bd:{Out:"#b3cfe2",Hover:"#4e90bd"},Bg:{Out:"-10px center repeat-y",Hover:"-20px center repeat-y",Focus:"-20px center repeat-y"}},Btn:{btn:!1}}),$(".jscroll-h,.jscroll-e").css({border:"0",width:"6px"})},setTalkListScroll:function(t){var e=$("#dialog_list").height(),i=$(".scrollbox2").height(),s="down";i>e&&(s="up"),$(".scrollbox2").jscroll({W:"6px",BgUrl:"url(/images/studio/scroll2.png)",Bg:"0 0 repeat-y",Bar:{Pos:s,isCurr:t,Bd:{Out:"#b3cfe2",Hover:"#4e90bd"},Bg:{Out:"-10px center repeat-y",Hover:"-20px center repeat-y",Focus:"-20px center repeat-y"}},Btn:{btn:!1},Fn:function(){!$(".scrollbtn").hasClass("on")&&studioChat.newTalkDivH>studioChat.oldTalkDivH&&studioChat.newTalkDivH>350&&(studioChat.setTalkListScroll(!0),studioChat.oldTalkDivH=studioChat.newTalkDivH)}}),$(".jscroll-h,.jscroll-e").css({border:"0",width:"6px"})},getToUser:function(){var t=$("#send_selelct_list a[class=on]"),e=t.attr("uid"),i=t.attr("ts"),s=t.attr("utype");return"all"!=e?{userId:e,nickname:t.find("label[t=nk]").html(),talkStyle:i,userType:s}:null},checkFormInput:function(t){var e=!0,i=$(t+" .wrong-info");return i.attr("tId","").html(""),$(t+" input").each(function(){if(common.isBlank($(this).val()))return"mobilePhone"==this.name&&i.attr("tId",this.name).html("手机号码不能为空！"),("pwd"==this.name||"firstPwd"==this.name)&&i.attr("tId",this.name).html("密码不能为空！"),"verifyCode"==this.name&&i.attr("tId",this.name).html("验证码不能为空！"),"oldPwd"==this.name&&i.attr("tId",this.name).html("原密码不能为空！"),e=!1;if("mobilePhone"==this.name&&($(this).val($.trim($(this).val())),!common.isMobilePhone(this.value)))return i.attr("tId",this.name).html("手机号码输入有误！"),e=!1;if("nickname"==this.name&&!/^.{2,10}$/.test(this.value))return i.attr("tId",this.name).html("昵称输入有误，请输入2至10位字符！"),e=!1;if("pwd"==this.name){if(!/^[A-Za-z0-9]{6,16}$/.test(this.value))return i.attr("tId",this.name).html("密码输入有误，请输入6至16位字母或数字组合！"),e=!1;var s=$(t).find("input[name=firstPwd]");if(s.length>0&&s.val()!=this.value)return i.attr("tId",this.name).html("两次密码不一致！"),e=!1}}),e},resetVerifyCode:function(t){studioChat.verifyCodeIntervalId&&(clearInterval(studioChat.verifyCodeIntervalId),studioChat.verifyCodeIntervalId=""),$(t+" .rbtn").attr("t",60).html("获取验证码"),$(t+" input[name=mobilePhone]").trigger("input")},openLoginBox:function(){$("#loginBox form").each(function(){this.reset()}),this.resetVerifyCode("#loginPmBox"),$(".blackbg").children().hide(),$("#loginPmBox").hide(),$("#loginBox,#loginComBox,.blackbg").show()},openRegistBox:function(){$("#registFrom")[0].reset(),this.resetVerifyCode("#registFrom"),$(".blackbg").children().hide(),$("#registBox,#registFromBox,.blackbg").show()},formatPublishTime:function(t){return common.isBlank(t)?"":common.getHHMM(Number(t.replace(/_.+/g,"")))},setDialog:function(t,e,i,s){$("#teacherListId a.te_btn.on").removeClass("on"),$("#teacherListId li[uid='"+t+"']").trigger("talking"),$(".send_select div.selectlist a").removeClass("on");var o=$(".send_select div.selectlist a[uid="+t+"]"),n="1"==i?" (私聊)":"";if($(".send_select div.selected").text(e+n),o.length>0)o.find("label[t=wh]").html(n),o.attr("ts",i),o.addClass("on");else{var a=$('<a href="javascript:void(0)" class="on" uid="'+t+'" ts="'+i+'" utype="'+s+'"><label t="nk">'+e+'</label><label t="wh">'+n+"</label></a>");$("#send_selelct_list").append(a),a.click(function(){$(this).is(".on")||($("#teacherListId a.te_btn.on").removeClass("on"),$("#teacherListId li[uid='"+$(this).attr("uid")+"']").trigger("talking"),$(".send_select div.selectlist a").removeClass("on"),$(".send_select div.selected").text($(this).text()),$(this).addClass("on"))})}},setContent:function(t,e,i){var s=t.fromUser;if(e&&(s.publishTime=t.uiId),t.isVisitor)return $("#"+t.uiId).remove(),void studioChat.openLoginBox();if(i&&$("#"+s.publishTime).length>0)return $("#"+s.publishTime+" .dcont em[class=ruleTipStyle]").remove(),void $("#"+s.publishTime+" input").remove();if(t.rule)return void(t.value&&t.value.needApproval?$("#"+t.uiId).attr("id",s.publishTime):$("#"+t.uiId+" .dcont").append('<em class="ruleTipStyle">'+t.value.tip+"</em>"));if(!e&&studioChat.userInfo.userId==s.userId&&t.serverSuccess)return $("#"+t.uiId).attr("id",s.publishTime),void $("#"+t.uiId+" .dtime").html(studioChat.formatPublishTime(s.publishTime));var o=studioChat.formatContentHtml(t,e,i),n=$("#dialog_list");n.append(o),!i&&$(".scrollbtn").hasClass("on")&&studioChat.setTalkListScroll(),$("#"+s.publishTime+" .headimg").click(function(){studioChat.openDiaLog($("#"+s.publishTime+" .dialogbtn"))}),$("#"+s.publishTime+" .uname").click(function(){var t=$("#"+s.publishTime+" .dialogbtn");studioChat.openDiaLog(t),t.css("left","62px"),t.css("top","30px")});var a=$(".view_select .se_cont a[class=on]");"on"!=a.attr("t")&&a.click(),studioChat.newTalkDivH=$("#dialog_list").height()},openDiaLog:function(t){if($(".dialogbtn").not(t).hide(),!t.is(":hidden"))return t.hide(),!1;t.css("left","0");var e=t.parent();common.isValid(e.attr("utype"))&&(0===e.next().size()?t.css("top",-11-t.height()+"px"):t.css("top",e.hasClass("analyst")?"53px":"39px")),"2"!=t.attr("utype")&&2!=studioChat.userInfo.userType&&t.find("a[t=1]").hide(),t.show(),t.find("a").click(function(){var t=$(this).parent();studioChat.setDialog(t.attr("uid"),t.attr("nk"),$(this).attr("t"),t.attr("utype")),t.hide()})},formatContentHtml:function(t,e,i){var s="dialog ",o="",n="",a="uname ",r="false",l=t.fromUser,d=t.content,u=l.nickname,c=l.toUser,h="";c&&common.isValid(c.userId)&&(h='<span class="to">对<b class="toname" uid="'+c.userId+'">'+c.nickname+(1==c.talkStyle?" (私聊)":"")+"</b></span>",studioChat.userInfo.userId==c.userId&&(r="true")),o=d.value,studioChat.userInfo.userId==l.userId?(s+="mine",u="我",r="true"):(2==l.userType&&(s+="analyst"),1==l.userType&&(s+="admin"),n=studioChat.getDialogHtml(l.userId,u,l.userType),!i&&c&&studioChat.userInfo.userId==c.userId&&($(".mymsg").show(),$(".replybtn").attr("uid",l.userId),$(".replybtn").attr("ts",c.talkStyle),$(".replybtn").attr("futype",l.userType),$(".sender").html(l.nickname),$(".xcont").html(o)));var m='<div class="'+s+'" id="'+l.publishTime+'" isMe="'+r+'" utype="'+l.userType+'" mType="'+d.msgType+'" t="header"><a href="javascript:" class="headimg" uid="'+l.userId+'">'+studioChat.getUserAImgCls(l.clientGroup,l.userType,l.avatar)+'</a><i></i><p><a href="javascript:"  class="'+a+'">'+u+"</a>"+h+'<span class="dtime">'+studioChat.formatPublishTime(l.publishTime)+'</span><span class="dcont">'+o+"</span></p>"+n+"</div>";return m},removeLoadDom:function(t){$("#"+t+" .img-loading,#"+t+" .img-load-gan,#"+t+" .shadow-box,#"+t+" .shadow-conut").remove()},getUserAImgCls:function(t,e,i){var s="";return 1==e||2==e?'<img src="'+i+'">':(s="vip"==t?"user_v":"real"==t?"user_r":"simulate"==t?"user_d":"register"==t?"user_m":"user_c",'<img src="images/studio/'+s+'.png">')},getUserLevelShortName:function(t){var e="";switch(t){case"vip":e="[V]";break;case"real":e="[R]";break;case"simulate":e="[D]";break;case"register":e="[M]";break;default:e="游客"}return e},getDialogHtml:function(t,e,i){return studioChat.userInfo.userId!=t&&-1==studioChat.userInfo.userId.indexOf("visitor_")&&-1==t.indexOf("visitor_")?'<div class="dialogbtn" style="display:none;" nk="'+e+'" uid="'+t+'" utype="'+i+'"><a href="javascript:" class="d1" t="0"><span><b></b>对话</span></a>'+("true"==$("#studioListId a[class~=ing]").attr("aw")?'<a href="javascript:" class="d2" t="1"><span><b></b>私聊</span></a>':"")+"</div>":""},setOnlineUser:function(t){if(2==t.userType){if($("#teacherListId li[uid='"+t.userId+"']").length>0)return!1;var e=$('<li uid="'+t.userId+'" utype="'+t.userType+'"><a title="'+(t.introduction||"")+'" href="javascript:" class="te_btn"><img class="headimg" src="'+t.avatar+'"><span><strong>'+t.nickname+"</strong><i>"+(t.position||"")+'</i></span><div class="mp"><b></b></div></a></li>');$("#teacherListId").append(e),$("#teacherListId").width($("#teacherListId").width()+e.width()),"true"==$("#studioListId a[class~=ing]").attr("aw")&&$(".te_dialoglist").append(studioChat.getDialogHtml(t.userId,t.nickname,t.userType)),e.bind("talking",function(){$(this).find(".te_btn").addClass("on")}),e.click(function(){var t=$(this).find("a").is(".on");if($(".te_dialoglist div").length>0){t&&studioChat.setDialog("all","对所有人说");var e=$(".te_dialoglist .dialogbtn").eq($(this).index());studioChat.openDiaLog(e),e.css("left",$(this).offset().left-$(".chat").offset().left+5)}else t?studioChat.setDialog("all","对所有人说"):studioChat.setDialog($(this).attr("uid"),$(this).find("strong").text(),0,$(this).attr("utype"))})}else{if($("#userListId #"+t.userId).length>0)return!1;var i=studioChat.getDialogHtml(t.userId,t.nickname,t.userType),s="",o="uname",n=t.sequence;studioChat.userInfo.userId==t.userId&&(s="【我】",o+=" ume",n="0");var a=$("#userListId li"),r='<li id="'+t.userId+'" t="'+n+'">'+i+'<a href="javascript:" t="header" class="'+o+'"><div class="headimg">'+studioChat.getUserAImgCls(t.clientGroup)+"</div>"+t.nickname+s+"</a></li>";if(0==a.length)$("#userListId").append(r);else if(""!=s)a.first().before(r);else{var l=!1,d=0,u="";a.each(function(){return d=parseInt($(this).attr("t")),t.sequence<d?($(this).before(r),l=!0,!1):t.sequence==d&&(u=$(this).find("a").text(),t.nickname<=u)?($(this).before(r),l=!0,!1):void 0}),l||$("#userListId").append(r)}common.isValid(i)&&$("#userListId li[id="+t.userId+"] a[t=header]").click(function(){$(".user_box li").removeClass("zin"),$(this).parent().addClass("zin"),$(".dialogbtn",$(this).parent()).css("left","7px"),studioChat.openDiaLog($(this).prev())})}return!0},setSocket:function(){this.socket=io.connect(this.socketUrl),this.socket.on("connect",function(){console.log("connected to server!"),studioChat.socket.emit("login",{userInfo:studioChat.userInfo,lastPublishTime:$("#dialog_list>div:last").attr("id")})}),this.socket.on("onlineUserList",function(t){$("#userListId").html("");var e=t.length;if("true"==$("#studioListId a[class~=ing]").attr("av")&&200>=e)for(var i=0,s=10>=e?60:200/e*3+10,o=0;s>o;o++)i=common.randomNumber(6),t.push({userId:"visitor_"+i,clientGroup:"visitor",nickname:"游客_"+i,sequence:14,userType:0});var n=null;for(var o in t)n=t[o],studioChat.setOnlineUser(n);studioChat.setUserListScroll()}),this.socket.on("disconnect",function(t){console.log("disconnect")}),this.socket.on("error",function(t){console.error("e:"+t)}),this.socket.on("sendMsg",function(t){studioChat.setContent(t,!1,!1)}),this.socket.on("notice",function(t){switch(t.type){case"onlineNum":var e=t.data;if(e.online)studioChat.setOnlineUser(e.onlineUserInfo);else{var i=e.onlineUserInfo;2==i.userType?$("#teacherListId li[uid='"+i.userId+"']").remove():studioChat.userInfo.userId!=i.userId&&$("#userListId #"+i.userId).remove()}break;case"removeMsg":$("#"+t.data.replace(/,/g,",#")).remove();break;case"approvalResult":var e=t.data;if(e.refuseMsg){var s=e.publishTimeArr;for(var o in s)$("#"+s[o]+" .dcont em[class=ruleTipStyle]").html("已拒绝")}else{for(var o in e)studioChat.formatUserToContent(e[o]);studioChat.setTalkListScroll()}}}),this.socket.on("loadMsg",function(t){var e=t.msgData,i=t.isAdd;if(i||$("#content_ul").html(""),$(".loading-box").hide(),e&&$.isArray(e)){e.reverse();for(var s in e)studioChat.formatUserToContent(e[s]);i||(this.oldTalkDivH=this.newTalkDivH,studioChat.setTalkListScroll())}})},formatUserToContent:function(t){var e={userId:t.userId,nickname:t.nickname,avatar:t.avatar,userType:t.userType,groupId:t.groupId,clientGroup:t.clientGroup,publishTime:t.publishTime,toUser:t.toUser,avatar:t.avatar,position:t.position};studioChat.setContent({fromUser:e,content:t.content},!1,!0)}};$(function(){studioChat.init()});