var adminChat={maxRows:50,desktopNotice:null,msgType:{text:"text",img:"img",file:"file"},imgDB:{},isCanReSend:!0,socket:null,socketUrl:"",userInfo:null,init:function(){this.setSocket(),this.setEvent(),this.createImgDB(),this.setPageUserInfo()},createImgDB:function(){try{adminChat.imgDB=openDatabase("imgDB","1.0","imgDB",15728640),adminChat.imgDB.transaction(function(t){t.executeSql("create table if not exists bigImg (id unique, data)",[],function(){adminChat.clearImgTable()})})}catch(t){adminChat.isCanReSend=!1}},deleteImgDataById:function(t){adminChat.imgDB.transaction(function(e){e.executeSql("delete from bigImg where id=?",[t])})},clearImgTable:function(){adminChat.imgDB.transaction(function(t){t.executeSql("delete from bigImg")})},getImgDataById:function(t,e){try{adminChat.imgDB.transaction(function(n){n.executeSql("select * from bigImg where id=?",[t],function(t,n){e(n.rows.item(0).data)},null)})}catch(n){console.log("getImgDataById has error:"+n)}},insertImgDBData:function(t){try{adminChat.imgDB.transaction(function(e){e.executeSql("insert into bigImg (id, data) values (?, ?)",[t.id,t.data])})}catch(e){console.log("insertImgDBData has error:"+e)}},getUiId:function(){var t=new Date;return t.getTime()+"_ms"},refreshVerifyCode:function(){$("#verifyCodeId img").attr("src","/getVerifyCode?v="+Math.random())},setPageUserInfo:function(){$(".user-name").html(adminChat.userInfo.nickname),$(".user-img img").attr("src",adminChat.userInfo.avatar)},setTalkTop:function(t,e){if(t){$("#talk_top_id").prepend('<section class="ss-tk-info clearfix" tId="'+e.fromUser.publishTime+'"><label><strong>'+e.fromUser.nickname+'</strong>：</label><span style="margin-left:5px;text-align:justify;">'+e.content.value+'</span><button type="button">关闭</button><button type="button" fuserId="'+e.fromUser.userId+'" uType="'+e.fromUser.userType+'">回复</button></section>');var n=$("#talk_top_id .ss-tk-info[tId="+e.fromUser.publishTime+"]");n.find("button").click(function(){var t=$(this).parents(".ss-tk-info");common.isValid($(this).attr("fuserId"))?adminChat.setTxtOfNickname($(this).attr("fuserId"),t.find("strong").addClass("reply-st").html(),t.find("span").html(),t.attr("tId"),$(this).attr("uType")):(t.remove(),$("#top_info label[ptime="+e.publishTime+"]").html("").parent().hide(),$("#txtNicknameId[ptime="+e.publishTime+"]").length>0&&adminChat.removeTxtOfNickname(),$("#show_top_btn strong,#top_num").text("【"+$("#talk_top_id .ss-tk-info").length+"】"))})}else e.publishTime&&($("#talk_top_id .ss-tk-info[tId="+e.publishTime+"]").remove(),$("#top_info label[ptime="+e.publishTime+"]").html("").parent().hide());$("#show_top_btn strong,#top_num").text("【"+$("#talk_top_id .ss-tk-info").length+"】")},setEvent:function(){$("#close-top-box").click(function(){$(".top-box").hide()}),$("#show_top_btn").click(function(){$(".top-box").show()}),$(".operator-tool .btn").click(function(){var t=[],e=[];return $("#content_ul li input[type=checkbox]:checked").each(function(){var n=$(this).parents("li");t.push(n.attr("id"));var a=n.attr("fuId");if(e.length>0){var i=","+e.join(",")+",";-1==i.indexOf(","+a+",")&&e.push(a)}else e.push(a)}),0==t.length?(alert("请选择聊天记录！"),!1):void adminChat.socket.emit("approvalMsg",{fromUser:adminChat.userInfo,status:$(this).attr("btnType"),publishTimeArr:t,fuIdArr:e})}),$(".operator-tool input[type=checkbox]").click(function(){var t=this.checked;$("#content_ul li input[type=checkbox]").each(function(){this.checked=t})}),$("#top_info label").click(function(){adminChat.setTxtOfNickname($(this).attr("fuserId"),$(this).attr("fnickname"),$("#top_info span").html(),$(this).attr("ptime"),$(this).attr("fuType")),$(this).html(""),$("#top_info").hide(),$(".talk-infobox").css("margin-top","25px")}),$("#close_top_btn").click(function(){$("#top_info").hide()}),$(".paste-close").click(function(){adminChat.clearPasteImg(),$("#sendBtn").hide(),$("#addBtn").show()}),$(".min-img img").mouseover(function(){var t=$(this).attr("h");$(".paste-img .show-img").css("top",-(parseInt(t)+8)).height(t).width($(this).attr("w")).show().find("img").attr("src",$(this).attr("src"))}).mouseout(function(){$(".paste-img .show-img").hide().find("img").attr("src","")}),$("#contentText").pastableTextarea(),$("#contentText").on("pasteImage",function(t,e){adminChat.removeTxtOfNickname(),$(".paste-img").show(),$(".paste-img .min-img img").attr("src",e.dataURL).attr("h",e.height).attr("w",e.width),$("#addBtn").hide(),$("#sendBtn").show()}),$("#contentText")[0].addEventListener("input",function(t){common.isValid(this.value)?(adminChat.clearPasteImg(),$("#sendBtn").show(),$("#addBtn").hide()):($("#addBtn").show(),$("#sendBtn").hide())},!1),$("#contentText").focus(function(){$(".add-img").hide()}),$("#contentText").keydown(function(t){return 8==t.keyCode&&common.isBlank($(this).val())&&adminChat.removeTxtOfNickname(),13==t.keyCode?($("#sendBtn").click(),t.returnValue=!1,!1):void 0}),$("#sendBtn").click(function(){var t=adminChat.getToUser();if(3==adminChat.userInfo.userType&&(!t||common.isBlank(t.userId)))return alert("请选择某个客户，再发言！"),!1;if(!$(".paste-img").is(":hidden"))return adminChat.setUploadImg($(".paste-img .min-img img").attr("src")),void $(".paste-close").click();var e=$("#contentText").val();if(common.isValid(e)){e=e.replace(/<[^>].*?>/g,"");var n="(((https|http)://)?)[A-Za-z0-9-_]+\\.[A-Za-z0-9-_&\\?/.=]+",a=new RegExp(n,"gi");e=e.replace(a,function(t){return isNaN(t)?'<a href="'+t+'" target="_blank">'+t+"</a>":t});var i={uiId:adminChat.getUiId(),fromUser:adminChat.userInfo,content:{msgType:adminChat.msgType.text,value:e}};i.fromUser.toUser=t,adminChat.socket.emit("sendMsg",i),adminChat.setContent(i,!0,!1),i.fromUser.toUser=null,adminChat.setTalkTop(!1,{publishTime:$("#txtNicknameId").attr("ptime")}),adminChat.removeTxtOfNickname(),$("#contentText").val(""),$(this).hide(),$("#addBtn").show()}}),$("#addBtn").click(function(){$(".add-img").show()}),$("#fileBtn")[0].addEventListener("change",function(){var t=this;$(".add-img").hide();var e=t.files[0];if(!e)return!1;if(0!=e.type.indexOf("image")||!e.type||!/\.(?:jpg|png|gif)$/.test(e.name.toLowerCase()))return alert("目前暂支持jpg,gif,png格式的图片！"),!1;var n=e.size;if(n>=5242880)return alert("发送的图片大小不要超过5MB."),!1;var a=new FileReader;a.readAsDataURL(e),a.onload=function(t){adminChat.setUploadImg(t.target.result)},a.onprogress=function(t){},a.onloadend=function(t){}},!1)},clearPasteImg:function(){$(".paste-img").is(":hidden")||$(".paste-img").hide().find("img").attr("src","").attr("h",120).attr("w",100)},setUploadImg:function(t){var e=adminChat.getUiId();adminChat.setContent({uiId:e,fromUser:adminChat.userInfo,content:{msgType:adminChat.msgType.img,value:"",needMax:0}},!0,!1);var n={uiId:e,fromUser:adminChat.userInfo,content:{msgType:adminChat.msgType.img,value:"",needMax:0,maxValue:""}};n.content.value=t,adminChat.zipImg(n,100,60,function(t,n){if(t.error)return alert(t.error),$("#"+e).remove(),!1;var a=$("#"+t.uiId+" img");a.attr("src",n),a.attr("needMax",t.content.needMax),adminChat.dataUpload(t),1==t.content.needMax&&adminChat.isCanReSend&&adminChat.insertImgDBData({id:e,data:t.content.value})})},getToUser:function(){var t=$("#txtNicknameId .dt-send-name");if(t.length>0){var e=common.trim(t.attr("uType")),n={userId:common.trim(t.attr("tId")),nickname:t.find("label").text(),userType:e,talkStyle:"3"==e?1:0},a=t.find("span");return a.length>0&&(n.question=a.text()),3==adminChat.userInfo.userType&&(n.talkStyle=1),n}return null},dataUpload:function(t){var e=new XMLHttpRequest;e.open("POST","/wechat/uploadData"),e.addEventListener("progress",function(e){if(e.lengthComputable){var n=(e.loaded/e.total*100|0)+"%";$("#"+t.uiId+" .shadow-box").css({height:"'+ra+'"}),$("#"+t.uiId+" .shadow-conut").html(n)}},!1),e.setRequestHeader("Content-Type","application/json; charset=utf-8"),e.onreadystatechange=function(){4===e.readyState&&200===e.status&&console.log("dataUpload success!")},t.fromUser.socketId=adminChat.socket.id,e.send(JSON.stringify(t))},zipImg:function(t,e,n,a){var i=new Image;i.onload=function(){var s=document.createElement("canvas"),o=i.width,r=i.height;if(r>=9*o)return a({error:"该图片高度太高，暂不支持发送！"}),!1;e>0&&(r>e||o>e)&&(t.content.needMax=1,r>e&&e>=o?(o=e/r*o,r=e):(r=e/o*r,o=e),i.height=r,i.width=o);var d=s.getContext("2d");s.width=o,s.height=r,d.clearRect(0,0,s.width,s.height),d.drawImage(i,0,0,o,r),a(t,s.toDataURL("image/jpeg",n/100))},i.src=t.content.value},checkSendStatus:function(t,e){var n=$("#"+t),a=$(".img-loading",n);a.removeClass("img-loading").addClass("img-load-gan").attr("title","重发"),a.length>0&&e&&adminChat.isCanReSend&&a.click(function(){var t=$(this).parents("li").attr("id");if(a.removeClass("img-load-gan").addClass("img-loading"),n.attr("mType")==adminChat.msgType.img){var e={uiId:t,fromUser:adminChat.userInfo,content:{msgType:adminChat.msgType.img,value:"",needMax:0,maxValue:""}},i=$("#"+t+" img");e.content.needMax=i.attr("needMax"),1==e.content.needMax?adminChat.getImgDataById(t,function(t){e.content.maxValue=t,adminChat.dataUpload(e)}):(e.content.value=i.attr("src"),adminChat.dataUpload(e))}else adminChat.socket.emit("sendMsg",{uiId:t,fromUser:adminChat.userInfo,content:{msgType:adminChat.msgType.text,value:$(".talk-content .contents",n).html()}});adminChat.timeOutSend(t,!1)})},removeTxtOfNickname:function(){var t=$("#txtNicknameId");common.isValid(t.html())&&(t.html("").attr("ptime",""),$(".dt-send-name").addClass("reply-def").removeClass("reply-st"),$(".sp-nick").removeClass("reply-st"),$("#talk_top_id label strong").removeClass("reply-st"),$("#contentText").css({"padding-left":"1%"}).width("98%"))},setTxtOfNickname:function(t,e,n,a,i){adminChat.clearPasteImg(),$("#contentText").width("98%");var s="";common.isValid(n)&&(s='<span style="display:none;">'+n+"</span>"),$("#txtNicknameId").attr("ptime",a?a:"").html('<span class="dt-send-name reply-st" tId="'+t+'" uType="'+i+'">@<label >'+e+"</label>"+s+"</span>");var o=parseInt($("#txtNicknameId").width());$("#contentText").css({"padding-left":o+5}).width($("#contentText").width()-o)},timeOutSend:function(t,e){window.setTimeout(function(){adminChat.checkSendStatus(t,e)},6e4)},formatPublishTime:function(t){return common.isBlank(t)?"":common.longMsTimeToDateTime(Number(t.replace(/_.+/g,"")),".")},setContent:function(t,e,n){var a=t.fromUser;if(e&&(a.publishTime=t.uiId,adminChat.timeOutSend(t.uiId,!0)),t.rule)return adminChat.removeLoadDom(t.uiId),void $("#"+t.uiId+" .talk-content .contents").append('<em class="ruleTipStyle">'+t.value.tip+"</em>");if(n&&$("#"+a.publishTime).length>0)return void $("#"+a.publishTime+" input").remove();if(e||adminChat.userInfo.userId!=a.userId||!t.serverSuccess){var i=$("#content_div")[0],s=i.scrollTop+$(i).height()>=i.scrollHeight,o=adminChat.formatContentHtml(t,e),r=$("#content_ul");if(r.append(o),!n&&s&&($("#content_div")[0].scrollTop=$("#content_div")[0].scrollHeight),t.content.msgType==adminChat.msgType.text&&a.toUser&&common.isValid(a.toUser.userId)){n||a.toUser.userId!=adminChat.userInfo.userId||a.userId==adminChat.userInfo.userId||($("#top_info").show(),$(".talk-infobox").css("margin-top",25+$("#top_info").height()+"px"),$("#top_info label").html(a.nickname+":@"+a.toUser.nickname).attr("tId",a.toUser.userId).attr("fuType",a.userType).attr("ptime",a.publishTime).attr("fnickname",a.nickname).attr("fuserId",a.userId),$("#top_info span").html(t.content.value),adminChat.setTalkTop(!0,t));var d=null;common.isValid(a.toUser.question)?(d=$("#"+a.publishTime+" .dialog .asker"),d.click(function(){adminChat.setTxtOfNickname($(this).attr("tId"),$(this).html(),null,null,$(this).attr("uType"))})):(d=$("#"+a.publishTime+" .talk-content .dt-send-name"),d.click(function(){adminChat.setTxtOfNickname($(this).attr("tId"),$(this).find("label").text(),null,null,$(this).attr("uType"))}))}$("#"+a.publishTime+" .talk-dlbox .sp-nick").click(function(){var t=$(this).find(".dt-send-name");$(".sp-nick").removeClass("reply-st"),$(this).addClass("reply-st"),$(".dt-send-name").addClass("reply-def").removeClass("reply-st"),t.removeClass("reply-def").addClass("reply-st"),adminChat.setTxtOfNickname(t.attr("tId"),t.next().text(),null,null,t.attr("uType"))}),$("#content_ul li[id="+a.publishTime+"] .btn").click(function(){var t=[],e=[],n=$(this).parents("li");t.push(n.attr("id")),e.push(n.attr("fuId")),adminChat.socket.emit("approvalMsg",{fromUser:adminChat.userInfo,status:$(this).attr("btnType"),publishTimeArr:t,fuIdArr:e})}),$("#content_ul li[id="+a.publishTime+"] input[type=checkbox]").click(function(){$(".operator-tool input[type=checkbox]")[0].checked=0==$("#content_ul li input[type=checkbox]:not(:checked)").length})}else if(adminChat.removeLoadDom(t.uiId),$("#"+t.uiId).attr("id",a.publishTime),$("#"+t.uiId+" dd[tId=time]").html(adminChat.formatPublishTime(a.publishTime)),t.content.msgType==adminChat.msgType.img){1==t.content.needMax&&adminChat.isCanReSend&&adminChat.deleteImgDataById(t.uiId);var m=$("#"+a.publishTime+" .talk-content p"),c=t.content.needMax?"/wechat/getBigImg?publishTime="+a.publishTime+"&userId="+a.userId:m.find("a img").attr("src");m.find("a[class=swipebox]").attr("href",c),$(".swipebox").swipebox()}},getUserTypeName:function(t){return 1==t?"(管理员)":2==t?"(分析师)":3==t?"(客服)":void 0},formatNickname:function(t,e,n){if(t||0==t)return e;var a="";return common.isValid(n)&&(a=n+"-"),a+=e+this.getUserTypeName(t)},formatContentHtml:function(t,e){var n="",a="",i="",s="",o="",r="",d=t.fromUser,m=t.content,c=adminChat.formatNickname(d.userType,d.nickname,d.position),l='<dt class="dt-send-name reply-def" tId="'+d.userId+'" uType="'+d.userType+'">@</dt>';adminChat.userInfo.userId==d.userId?(l="",n="me-li",c="我",e&&(o='<i class="img-loading"></i>',s='<span class="shadow-box"></span><s class="shadow-conut"></s>')):2==d.userType&&adminChat.msgType.img!=m.msgType&&(n="expert-li"),m.msgType==adminChat.msgType.img?(l="",a="talk-img",i=m.needMax?'<p><a href="/wechat/getBigImg?publishTime='+d.publishTime+"&userId="+d.userId+'" class="swipebox" ><img src="'+m.value+'" alt="图片"/></a>'+s+"</p>":'<p><a href="'+m.value+'" class="swipebox" ><img src="'+m.value+'" alt="图片" /></a>'+s+"</p>"):m.msgType==adminChat.msgType.text&&d.toUser&&common.isValid(d.toUser.userId)?common.isValid(d.toUser.question)?(r='<div class="dialog"><p class="question"><span class="asker" tId="'+d.toUser.userId+'" uType="'+d.toUser.userType+'">'+d.toUser.nickname+"</span><label>&nbsp;:&nbsp;</label><span>"+d.toUser.question+"</span></p>",r+='<p class="reply"><span>回复</span><label>:&nbsp;</label>'+common.encodeHtml(m.value)+"</p></div>"):r='<p class="cp"><span class="dt-send-name" tId="'+d.toUser.userId+'" uType="'+d.toUser.userType+'">@<label>'+d.toUser.nickname+'</label></span><span class="contents">'+common.encodeHtml(m.value)+"</span></p>":r='<p class="cp"><span class="contents">'+common.encodeHtml(m.value)+"</span></p>";var u='<li class="'+n+' clearfix" id="'+d.publishTime+'" uType="'+d.userType+'" mType="'+m.msgType+'" fuId="'+d.userId+'">';return 0==m.status?(u+='<dl class="talk-dlbox"><input type="checkbox"/>'+l+"<dt>"+c+'</dt><dd tId="time">'+adminChat.formatPublishTime(d.publishTime)+'</dd><input type="button" class="btn" value="通过" btnType="1" /><input type="button" class="btn" value="拒绝" btnType="2"/></dl>',$(".operator-tool").show(),$(".add-btn").css({top:"30px"}),$(".send-btn").css({top:"30px"})):u+='<dl class="talk-dlbox"><span class="sp-nick">'+l+"<dt>"+c+'</dt></span><dd tId="time">'+adminChat.formatPublishTime(d.publishTime)+"</dd></dl>",u+='<section class="talk-content '+a+'"><seciton class="arrow-outer jian-position1"><seciton class="arrow-shadow"></seciton></seciton>'+o+r+i+"</section></li>"},removeLoadDom:function(t){$("#"+t+" .img-loading,#"+t+" .img-load-gan,#"+t+" .shadow-box,#"+t+" .shadow-conut").remove()},setDesktopNotice:function(t){this.desktopNotice?this.desktopNotice.update({type:"info",text:t.fromUser.nickname+"："+t.content.value,icon:t.fromUser.avatar}):(PNotify.desktop.permission(),this.desktopNotice=new PNotify({title:"客户求助信息",text:t.fromUser.nickname+"："+t.content.value,desktop:{desktop:!0,icon:t.fromUser.avatar}}),this.desktopNotice.get().click(function(t){$(".ui-pnotify-closer, .ui-pnotify-sticker, .ui-pnotify-closer *, .ui-pnotify-sticker *").is(t.target)||($(this).trigger("pnotify.history-all"),alert("你有新的信息！"))}))},setSocket:function(){this.socket=common.getSocket(io,this.socketUrl,this.userInfo.groupType),this.socket.on("connect",function(){console.log("connected to server!"),$(".loading-box").show(),adminChat.userInfo.socketId=adminChat.socket.id,adminChat.socket.emit("login",{userInfo:adminChat.userInfo,lastPublishTime:$("#content_ul li:last").attr("id")})}),this.socket.on("loginResult",function(t){}),this.socket.on("disconnect",function(t){console.log("disconnect")}),this.socket.on("error",function(t){console.log("e:"+t)}),this.socket.on("sendMsg",function(t){3==adminChat.userInfo.userType?(t.fromUser.toUser&&t.fromUser.toUser.userId==adminChat.userInfo.userId||adminChat.userInfo.userId==t.fromUser.userId)&&(adminChat.setContent(t,!1,!1),adminChat.userInfo.userId!=t.fromUser.userId&&adminChat.setDesktopNotice(t)):(adminChat.setContent(t,!1,!1),t.content&&t.content.msgType==adminChat.msgType.img&&$(".swipebox").swipebox())}),this.socket.on("notice",function(t){switch(t.type){case"onlineNum":$("#onlineUserNum").text(t.data.onlineUserNum);break;case"removeMsg":$("#"+t.data.replace(/,/g,",#")).remove();break;case"approvalResult":var e=t.data;if(e.fromUserId==adminChat.userInfo.userId)if(e.isOK){var n=e.publishTimeArr;if(2==e.status)for(var a in n)$("#"+n[a]).remove();else for(var a in n)$("#"+n[a]+" input").remove();$(".operator-tool input[type=checkbox]").attr("checked",!1)}else alert("操作出现异常，请重新执行！");else if(e.refuseMsg){var n=e.publishTimeArr;for(var a in n)$("#"+n[a]).remove()}else{for(var a in e)adminChat.formatUserToContent(e[a]);$(".swipebox").swipebox(),$("#content_div")[0].scrollTop=$("#content_div")[0].scrollHeight}}}),this.socket.on("loadMsg",function(t){var e=t.msgData,n=t.isAdd;n||$("#content_ul").html(""),$(".loading-box").hide();var a=null;if(e&&$.isArray(e)){e.reverse();for(var i in e)a=e[i],a.content.status=a.status,adminChat.formatUserToContent(a);$(".swipebox").swipebox(),n||($("#content_div")[0].scrollTop=$("#content_div")[0].scrollHeight)}})},formatUserToContent:function(t){var e={userId:t.userId,nickname:t.nickname,avatar:t.avatar,userType:t.userType,groupId:t.groupId,publishTime:t.publishTime,toUser:t.toUser,avatar:t.avatar,position:t.position};adminChat.setContent({fromUser:e,content:t.content},!1,!0)}};$(function(){adminChat.init()});