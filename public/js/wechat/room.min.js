var room={maxRows:50,msgType:{text:"text",img:"img",file:"file"},imgDB:{},isCanReSend:!0,socket:null,socketUrl:"",userInfo:null,verifyCodeIntervalId:"",init:function(){room.wrapAdjust(),this.setUserInfo(),this.setSocket(),this.setEvent(),this.createImgDB(),this.setAdvertisement(),this.setPrice(),setInterval("room.setPrice()",5e3)},getUserAvatar:function(e,t){return common.isValid(e)?e:t&&0!=t?"/images/wechat/def_b_user.png":"/images/wechat/user.jpg"},setUserInfo:function(){$(".user-name").html(room.userInfo.nickname),$(".user-stadus").html(),$(".user-img img").attr("src",this.getUserAvatar(room.userInfo.avatar,room.userInfo.userType))},getArticleList:function(e,t,o,n,i,r,s){try{$.getJSON("/wechat/getArticleList",{code:e,platform:t,hasContent:o,pageNo:n,pageSize:i,orderByStr:r},function(e){s(e)})}catch(a){console.error("getArticleList->"+a),s(null)}},setAdvertisement:function(){this.getArticleList("advertisement","wechat_room","0",1,1,"",function(e){if(0==e.result){var t=e.data;t&&(common.isValid(t[0].linkUrl)&&$("#room_advertisement a").attr("href",t[0].linkUrl),$("#room_advertisement img").attr("src",t[0].mediaUrl),$("#room_advertisement").show(),room.wrapAdjust())}})},createImgDB:function(){try{room.imgDB=openDatabase("imgDB","1.0","imgDB",15728640),room.imgDB.transaction(function(e){e.executeSql("create table if not exists bigImg (id unique, data)",[],function(){room.clearImgTable()})})}catch(e){room.isCanReSend=!1}},deleteImgDataById:function(e){room.imgDB.transaction(function(t){t.executeSql("delete from bigImg where id=?",[e])})},clearImgTable:function(){room.imgDB.transaction(function(e){e.executeSql("delete from bigImg")})},getImgDataById:function(e,t){try{room.imgDB.transaction(function(o){o.executeSql("select * from bigImg where id=?",[e],function(e,o){t(o.rows.item(0).data)},null)})}catch(o){console.error("getImgDataById has error:"+o)}},insertImgDBData:function(e){try{room.imgDB.transaction(function(t){t.executeSql("insert into bigImg (id, data) values (?, ?)",[e.id,e.data])})}catch(t){console.error("insertImgDBData has error:"+t)}},getUiId:function(){var e=new Date;return e.getTime()+"_ms"},setPrice:function(){try{$.getJSON(this.apiUrl+"/get24kPrice").done(function(e){if(!e)return $("#product_price_ul li .date-sz").text("--"),!1;var t=e.result.row,o=null;$.each(t,function(e,t){if(null!=t){o=t.attr;var n=o.gmcode,i=o.bid,r=o.change,s=""!=$.trim(r)&&-1!=r.indexOf("-")?"down":"up",a=r/(i-r)*100,m=$("#product_price_ul li[name="+n+"]");"up"==s?m.attr("class","date-up"):"down"==s&&m.attr("class","date-down"),m.find("p.date-sz").text(Number(i).toFixed(2)),m.find("span:eq(0)").text(Number(r).toFixed(2)),m.find("span:eq(1)").text(Number(a).toFixed(2)+"%")}})})}catch(e){console.error("setPrice->"+e)}},wrapAdjust:function(){$(".wrapper").css("top",$("#header").height())},setEvent:function(){$("#loginForm input[name=mobilePhone]")[0].addEventListener("input",function(e){var t=$(this).parents("form").find(".rbtn");common.isMobilePhone(this.value)?t.attr("disabled",!1):t.attr("disabled",!0)},!1),$("#loginForm .rbtn").click(function(){if($(".wrong-info").html(""),!$(this).is(":disabled")){$(this).attr("disabled",!0);var e=$("#loginForm input[name=mobilePhone]").val();try{$.getJSON("/wechat/getMobileVerifyCode",{mobilePhone:e},function(e){e&&e.isOK?room.setVerifyCodeTime("#loginForm .rbtn"):(console.error("提取数据有误！"),room.setVerifyCodeTime("#loginForm .rbtn",0))})}catch(t){room.setVerifyCodeTime("#loginForm .rbtn",0),console.error("setMobileVerifyCode->"+t)}}}),$(".date-box .hide-btn").click(function(){$(".date-box").hide(),$(".hq-btn").show(),room.wrapAdjust()}),$(".hq-btn").click(function(){$(".date-box").show(),$(this).hide(),room.wrapAdjust()}),$("#room_advertisement s").click(function(){$("#room_advertisement").hide(),room.wrapAdjust()}),$(".set-btn").click(function(){$(".set-bar").show()}),$(".set-bar .set-close").click(function(){$(".set-bar").hide()}),$("#readSet").click(function(){$(this).hasClass("guan-fon")?($(this).removeClass("guan-fon").addClass("on-fon"),$("#content_ul li[utype!=2]").hide()):($(this).removeClass("on-fon").addClass("guan-fon"),$("#content_ul li").show()),room.setScrollToBottom()}),$("#contentText").focus(function(){$(".add-img").hide(),$(".wrapper").css("top","0px"),$("#header").fadeOut("fast"),room.setScrollToBottom()}).blur(function(){room.wrapAdjust(),$("#header").fadeIn("fast"),room.setScrollToBottom()}),$("#contentText")[0].addEventListener("input",function(e){common.isValid(this.value)?($("#sendBtn").show(),$("#addBtn").hide()):($("#addBtn").show(),$("#sendBtn").hide())},!1),$("#contentText").keydown(function(e){8==e.keyCode&&common.isBlank($(this).val())&&room.removeTxtOfNickname()}),$("#content_div")[0].addEventListener("touchstart",function(e){0==$(".wrapper").position().top&&$("#contentText").blur()},!1),$("#top_info label").click(function(){room.setTxtOfNickname($(this).attr("fuserId"),$(this).attr("fnickname"),$("#top_info span").html()),$(this).html(""),$("#top_info").hide(),$(".talk-infobox").css("margin-top","25px")}),$("#loginSection .del-btn,#tipSection .del-btn").click(function(){common.isValid(room.verifyCodeIntervalId)&&(clearInterval(room.verifyCodeIntervalId),$(".rbtn").val("获取验证码")),common.hideBox("#openBox"),$("#formBtnLoad").hide(),$("#loginForm")[0].reset(),$(".wrong-info").html("")}),$("#close_top_btn").click(function(){$("#top_info").hide()}),$("#loginForm input[type=text]").blur(function(){common.isValid(this.value)&&$(".wrong-info[tId="+this.name+"]").html("")}),$("#formBtn").click(function(){$(".wrong-info").html(""),room.checkLoginInput()&&($("#formBtn").attr("disabled",!0),$("#formBtnLoad").show(),common.getJson("/wechat/checkClient",$("#loginForm").serialize(),function(e){if($(".wrong-info").html(""),$("#formBtn").attr("disabled",!1),$("#formBtnLoad").hide(),e.errcode)return $(".wrong-info").html(e.errmsg),!1;var t=e.flag;e.isSys?e.isOK?(room.userInfo.nickname=e.nickname,room.userInfo.userType=e.userType,$(".user-stadus").html(""),$("#loginSection").hide(),$("#tipSection h2").html("验证成功"),$("#tipSection .succ-p-info").html("尊贵的客户：欢迎光临金道贵金属聊天室！"),$("#tipSection").show()):$(".wrong-info").html("账号或手机号验证不通过，请重新输入！"):1==t||3==t?($("#loginSection").hide(),$("#tipSection h2").html("登录成功"),$("#tipSection .succ-p-info").html("尊贵的客户：欢迎光临金道贵金属聊天室，即时参与和分析师互动，让投资变得更简单！"),$("#tipSection").show(),$(".user-stadus").html("")):2==t?($("#loginSection").hide(),$("#tipSection h2").html("提示"),$("#tipSection .succ-p-info").html("欢迎光临金道贵金属聊天室，目前发言功能暂仅对激活客户开放，了解更多请咨询金道微信客户！"),$("#tipSection").show()):4==t?$(".wrong-info").html("该账号已被占用，请输入其他账号！"):$(".wrong-info").html("账号或手机号验证不通过，请重新输入！")},!0,function(e){$("#formBtn").attr("disabled",!1),$("#formBtnLoad").hide()}))}),$("#sendBtn").click(function(){var e=$("#contentText").val();if(common.isValid(e)){if(e.length>=80)return room.showTipBox("注意：消息内容超过最大长度限制（80字以内）！"),!1;e=e.replace(/<[^>].*?>/g,"");var t="(((https|http)://)?)[A-Za-z0-9-_]+\\.[A-Za-z0-9-_&\\?\\/.=]+",o=new RegExp(t,"gi");e=e.replace(o,function(e){return isNaN(e)?'<a href="'+e+'" target="_blank">'+e+"</a>":e});var n={uiId:room.getUiId(),fromUser:room.userInfo,content:{msgType:room.msgType.text,value:e}};n.fromUser.toUser=room.getToUser(),room.socket.emit("sendMsg",n),room.setContent(n,!0,!1),n.fromUser.toUser=null,room.removeTxtOfNickname(),$("#contentText").val(""),$(this).hide(),$("#addBtn").show()}}),$("#addBtn").click(function(){$(".add-img").show()}),$("#fileBtn")[0].addEventListener("change",function(){var e=this;$(".add-img").hide(),room.checkSendAuthority(function(t){if(t){var o=e.files[0];if(!o)return!1;if(0!=o.type.indexOf("image")||!o.type||!/\.(?:jpg|png|gif)$/.test(o.name.toLowerCase()))return alert("目前暂支持jpg,gif,png格式的图片！"),!1;var n=o.size;if(n>=5242880)return alert("发送的图片大小不要超过5MB."),!1;var i=new FileReader;i.readAsDataURL(o);var r=room.getUiId();room.setContent({uiId:r,fromUser:room.userInfo,content:{msgType:room.msgType.img,value:"",needMax:0}},!0,!1),i.onload=function(e){var t={uiId:r,fromUser:room.userInfo,content:{msgType:room.msgType.img,value:"",needMax:0,maxValue:""}};t.content.value=e.target.result,room.zipImg(t,100,60,function(e,o){if(e.error)return alert(e.error),$("#"+r).remove(),!1;t.content.value.length<o.length&&(o=t.content.value);var n=$("#"+e.uiId+" .dialog .imgdiv img");n.attr("src",o),n.attr("needMax",e.content.needMax),room.dataUpload(e),1==e.content.needMax&&room.isCanReSend&&room.insertImgDBData({id:r,data:e.content.value})})},i.onprogress=function(e){},i.onloadend=function(e){}}})},!1)},dataUpload:function(e){var t=new XMLHttpRequest;t.open("POST","/wechat/uploadData"),t.addEventListener("progress",function(t){if(t.lengthComputable){var o=(t.loaded/t.total*100|0)+"%";$("#"+e.uiId+" .shadow-box").css({height:"'+ra+'"}),$("#"+e.uiId+" .shadow-conut").html(o)}},!1),t.setRequestHeader("Content-Type","application/json; charset=utf-8"),t.onreadystatechange=function(){4===t.readyState&&200===t.status&&console.log("success!")},e.fromUser.socketId=room.socket.id,t.send(JSON.stringify(e))},zipImg:function(e,t,o,n){var i=new Image;i.onload=function(){var r=document.createElement("canvas"),s=i.width,a=i.height;if(a>=9*s)return n({error:"该图片高度太高，暂不支持发送！"}),!1;t>0&&(a>t||s>t)&&(e.content.needMax=1,a>t&&t>=s?(s=t/a*s,a=t):(a=t/s*a,s=t),i.height=a,i.width=s);var m=r.getContext("2d");r.width=s,r.height=a,m.clearRect(0,0,r.width,r.height),m.drawImage(i,0,0,s,a),n(e,r.toDataURL("image/jpeg",o/100))},i.src=e.content.value},checkSendStatus:function(e,t,o){var n=$("#"+e),i=null;o==room.msgType.img?(i=$(".imgdiv .sending",n),i.siblings(".shadow-conut").html(""),i.addClass("sfailed").removeClass("sending").attr("title","重发")):(i=$(".txtBox .sending",n),i.addClass("sfailed").removeClass("sending").attr("title","重发"))},checkSendAuthority:function(e){common.getJson("/wechat/checkSendAuthority",{accountNo:room.userInfo.accountNo,userId:room.userInfo.userId,groupId:room.userInfo.groupId,fromPlatform:room.userInfo.fromPlatform},function(t){t.isVisitor?(room.openLoginBox(),e(!1)):e(!0)},!0)},setWechatTip:function(){$("#loginSection").hide(),$("#tipSection h2").html("提示"),$("#tipSection .succ-p-info").html('您的微信还未绑定金道交易账号，绑定金道交易账号，尊享更多专业服务！<a href="http://wechat.24k.hk/WeixinFront/article/details.action?id=2931" style="font-weight:bold;color:blue;" >如何绑定</a>'),$("#tipSection").show()},removeTxtOfNickname:function(){var e=$("#txtNicknameId");common.isValid(e.text())&&(e.html(""),$("#contentText").css({"padding-left":"1%"}).width("98%"))},setTxtOfNickname:function(e,t,o){$("#contentText").width("98%");var n="";common.isValid(o)&&(n='<span style="display:none;">'+o+"</span>"),$("#txtNicknameId").html('<span class="dt-send-name" tId="'+e+'">@<label>'+t+"</label>"+n+"</span>");var i=parseInt($("#txtNicknameId").width());$("#contentText").css({"padding-left":i+5}).width($("#contentText").width()-i)},checkLoginInput:function(){var e=!0;return $("#loginForm input[type=text]").each(function(){return common.isBlank($(this).val())?("accountNo"==this.name&&$(".wrong-info").attr("tId",this.name).html("账号不能为空！"),"mobilePhone"==this.name&&$(".wrong-info").attr("tId",this.name).html("手机号码不能为空！"),"verifyCode"==this.name&&$(".wrong-info").attr("tId",this.name).html("验证码不能为空！"),e=!1):"mobilePhone"!=this.name||common.isMobilePhone($(this).val())?void 0:($(".wrong-info").attr("tId",this.name).html("手机号码输入有误！"),e=!1)}),e},setVerifyCodeTime:function(e,t){var o=0;o=t?t:parseInt($(e).attr("t"))||60,common.isBlank(room.verifyCodeIntervalId)&&(room.verifyCodeIntervalId=setInterval("room.setVerifyCodeTime('"+e+"')",1e3)),o>1?$(e).attr("t",o-1).val(o-1+"秒后重新获取"):($(e).attr("t",60).attr("disabled",!1).val("获取验证码"),clearInterval(room.verifyCodeIntervalId),room.verifyCodeIntervalId="")},openLoginBox:function(){$("#loginForm")[0].reset(),$("#loginForm input[type=hidden]").each(function(){$(this).val(room.userInfo[this.name])}),$("#tipSection").hide(),$("#loginSection").show(),common.showBox("#openBox")},setLoadImg:function(e,t){t?e.parent().find(".loading-box").show():e.parent().find(".loading-box").hide()},timeOutSend:function(e,t,o){window.setTimeout(function(){room.checkSendStatus(e,t,o)},6e4)},formatPublishTime:function(e){return common.isBlank(e)?"":common.longMsTimeToDateTime(Number(e.replace(/_.+/g,"")),".")},getToUser:function(){var e=$("#txtNicknameId .dt-send-name");if(e.length>0){var t={userId:e.attr("tId"),nickname:e.find("label").text(),talkStyle:0},o=e.find("span");return o.length>0&&(t.question=o.text()),t}return null},setContent:function(e,t,o){var n=e.fromUser;if(t&&(n.publishTime=e.uiId,room.timeOutSend(e.uiId,!0,e.content.msgType)),e.isVisitor)return $("#"+e.uiId).remove(),void room.openLoginBox();if(o&&$("#"+n.publishTime).length>0)return void $("#"+n.publishTime+" .dialog em[class=ruleTipStyle]").remove();if(e.rule)return room.removeLoadDom(e.uiId),void(e.value&&(e.value.leaveRoom?room.leaveRoomTip():e.value.needApproval?$("#"+e.uiId).attr("id",n.publishTime):$("#"+e.uiId+" .dialog").append('<em class="ruleTipStyle">'+e.value.tip+"</em>")));if(e.isShowWechatTip&&(room.setWechatTip(),common.showBox("#openBox")),t||room.userInfo.userId!=n.userId||!e.serverSuccess){var i=$("#content_div")[0],r=i.scrollTop+$(i).height()>=i.scrollHeight,s=room.formatContentHtml(e,t),a=$("#content_ul");if(a.append(s),!o&&r&&room.setScrollToBottom(),e.content.msgType==room.msgType.text&&n.toUser&&common.isValid(n.toUser.userId)){o||n.toUser.userId!=room.userInfo.userId||n.userId==room.userInfo.userId||($("#top_info").show(),$(".talk-infobox").css("margin-top",25+$("#top_info").height()+"px"),$("#top_info label").html(n.nickname+":@"+n.toUser.nickname).attr("tId",n.toUser.userId).attr("fnickname",n.nickname).attr("fuserId",n.userId),$("#top_info span").html(e.content.value));var m=null;common.isValid(n.toUser.question)?(m=$("#"+n.publishTime+" .dialog .asker"),m.click(function(){room.setTxtOfNickname($(this).attr("tId"),$(this).html())})):(m=$("#"+n.publishTime+" .dialog .dt-send-name"),m.click(function(){room.setTxtOfNickname($(this).attr("tId"),$(this).find("label").text())}))}$("#"+n.publishTime+" .headimg img").click(function(){var e=$(this).parent().parent();room.setTxtOfNickname($(this).parent().attr("tId"),e.find(".uname strong").text())}),$("#readSet").hasClass("on-fon")&&$("#content_ul li[utype!=2]").hide()}else if(room.removeLoadDom(e.uiId),$("#"+e.uiId).attr("id",n.publishTime),$("#"+e.uiId+" .uname label").html(room.formatPublishTime(n.publishTime)),e.content.msgType==room.msgType.img){1==e.content.needMax&&room.isCanReSend&&room.deleteImgDataById(e.uiId);var c=$("#"+n.publishTime+" .imgdiv"),l=e.content.needMax?"/wechat/getBigImg?publishTime="+n.publishTime+"&userId="+n.userId:c.find("a img").attr("src");c.find("a[class=swipebox]").attr("href",l),$(".swipebox").swipebox()}},getUserTypeName:function(e){return 1==e?"(管理员)":2==e?"(分析师)":3==e?"(客服)":void 0},formatNickname:function(e,t,o){if(e&&0!=e){var n="";return common.isValid(o)&&(n=o+"-"),n+=t+this.getUserTypeName(e)}return t},formatContentHtml:function(e,t){var o="",n="",i="",r="",s="",a=[],m=e.fromUser,c=e.content,l=room.formatNickname(m.userType,m.nickname,m.position);if(room.userInfo.userId==m.userId?(o="me-li",l="我",n="<label>"+room.formatPublishTime(m.publishTime)+"</label><strong>"+l+"</strong>",t&&(s='<i class="sending"></i>',r=s+'<span class="shadow-box"></span><s class="shadow-conut"></s>')):2==m.userType?room.msgType.img!=c.msgType&&(o="expert-li"):o="visitor-li",common.isBlank(n)&&(n="<strong>"+l+"</strong>"+room.formatPublishTime(m.publishTime)),a.push('<li class="'+o+' clearfix" id="'+m.publishTime+'" utype="'+m.userType+'" mType="'+c.msgType+'">'),a.push('<div class="headimg" tId="'+m.userId+'"><img src="'+room.getUserAvatar(m.avatar,m.userType)+'"/></div>'),a.push('<div class="detail">'),a.push('<span class="uname">'+n+"</span>"),c.msgType==room.msgType.img){a.push('<div class="dialog sendimg">'),a.push('<div class="imgdiv">');c.needMax?a.push('<a href="/wechat/getBigImg?publishTime='+m.publishTime+"&userId="+m.userId+'" class="swipebox" ><img src="'+c.value+'" alt="图片"/></a>'):a.push('<a href="'+c.value+'" class="swipebox" ><img src="'+c.value+'" alt="图片" /></a>'),a.push(r),a.push("</div></div>")}else c.msgType==room.msgType.text&&m.toUser&&common.isValid(m.toUser.userId)?common.isValid(m.toUser.question)&&!t?(a.push('<div class="dialog">'),a.push('<p class="question"><span class="asker" tId="'+m.toUser.userId+'">'+m.toUser.nickname+"</span><label>&nbsp;:&nbsp;</label><span>"+m.toUser.question+"</span></p>"),a.push('<p class="reply"><span>回复:</span>'+common.encodeHtml(c.value)+"</p></div>")):(i='<span class="dt-send-name" tId="'+m.toUser.userId+'">@<label>'+m.toUser.nickname+"</label></span>",a.push('<div class="dialog"><span class="to"></span>'+i+common.encodeHtml(c.value)+"</div>")):a.push('<div class="dialog txtBox"><span class="to"></span>'+s+common.encodeHtml(c.value)+"</div>");return a.push("</div></li>"),a.join("")},leaveRoomTip:function(){this.showTipBox("注意：房间已停用，正自动退出房间！"),window.location.href="/wechat"},showTipBox:function(e){var t=$(".errorbox");t.find("span").html(e),t.fadeIn(0).delay(6e3).fadeOut(200)},removeLoadDom:function(e){$("#"+e+" .sending,#"+e+" .shadow-box,#"+e+" .shadow-conut").remove()},setSocket:function(){this.socket=io.connect(this.socketUrl),this.socket.on("connect",function(){console.log("connected to server!"),room.socket.emit("login",{userInfo:room.userInfo,lastPublishTime:$("#content_ul li:last").attr("id")}),room.setLoadImg($("#content_ul"),!0)}),this.socket.on("disconnect",function(e){console.log("disconnect")}),this.socket.on("error",function(e){console.error("e:"+e)}),this.socket.on("sendMsg",function(e){room.setContent(e,!1,!1),e.content&&e.content.msgType==room.msgType.img&&$(".swipebox").swipebox()}),this.socket.on("notice",function(e){var t=e.data;switch(e.type){case"onlineNum":$("#onlineUserNum").text(t.onlineUserNum),room.userInfo.userId!=t.userId||t.hasRegister?$(".user-stadus").hide():$(".user-stadus").html("游客");break;case"removeMsg":$("#"+t.replace(/,/g,",#")).remove();break;case"leaveRoom":room.leaveRoomTip();break;case"approvalResult":if(t.refuseMsg){var o=t.publishTimeArr;for(var n in o)$("#"+o[n]+" .dialog em[class=ruleTipStyle]").html("已拒绝")}else{for(var n in t)room.formatUserToContent(t[n]);$(".swipebox").swipebox(),room.setScrollToBottom()}}}),this.socket.on("loadMsg",function(e){var t=e.msgData,o=e.isAdd;if(o||$("#content_ul").html(""),room.setLoadImg($("#content_ul"),!1),t&&$.isArray(t)){t.reverse();for(var n in t)room.formatUserToContent(t[n]);$(".swipebox").swipebox(),o||room.setScrollToBottom()}})},setScrollToBottom:function(){$("#content_div").scrollTop($("#content_div")[0].scrollHeight)},formatUserToContent:function(e){var t={userId:e.userId,nickname:e.nickname,avatar:e.avatar,userType:e.userType,groupId:e.groupId,publishTime:e.publishTime,toUser:e.toUser,avatar:e.avatar,position:e.position};room.setContent({fromUser:t,content:e.content},!1,!0)}};$(function(){room.init()});