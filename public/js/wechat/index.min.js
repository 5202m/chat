var wechat={userInfo:null,socketUrl:"",socket:null,onlineNumArr:{},tabSwiper:null,init:function(){this.setEvent(),this.setRoomList(0),this.setAdvertisement(),this.setBulletin(),this.setSocket()},getOutRoomOnline:function(){var t=$(".expert-ul li .enter-on").map(function(){return $(this).attr("rId")}).get();wechat.socket.emit("outRoomGet",{groupIds:t,groupType:wechat.userInfo.groupType})},setSocket:function(){this.socket=common.getSocket(io,this.socketUrl,this.userInfo.groupType),this.socket.on("connect",function(){wechat.socket.emit("outRoomLogin",{groupType:wechat.userInfo.groupType}),console.log("connected to server!")}),this.socket.on("disconnect",function(t){console.log("disconnect")}),this.socket.on("error",function(t){console.error("e:"+t)}),this.socket.on("notice",function(t){switch(t.type){case"onlineNum":var e=t.data;if(e.rOnlineSizeArr){var i=0,n=null;for(var a in e.rOnlineSizeArr){i=e.rOnlineSizeArr[a],wechat.onlineNumArr[a]=i,n=$(".expert-ul li .fj-rens[rId="+a+"]"),n.html(i);var o=$(".expert-ul li .fxs-btn a[rId="+a+"]");"true"==o.attr("dw")&&(parseInt(n.next("label").text())<=i?o.removeClass("enter-on").addClass("enter-off"):o.removeClass("enter-ff").addClass("enter-on"))}wechat.calOnlineTotalNum()}if(e.groupId){if(wechat.onlineNumArr[e.groupId]=e.onlineUserNum,-1==e.groupId.indexOf("oRoomId")){var s=$(".expert-ul li .fj-rens[rId="+e.groupId+"]"),o=$(".expert-ul li .fxs-btn a[rId="+e.groupId+"]");s.html(e.onlineUserNum),"true"==o.attr("dw")&&(parseInt(s.next("label").text())<=e.onlineUserNum?o.removeClass("enter-on").addClass("enter-off"):o.removeClass("enter-ff").addClass("enter-on"))}wechat.calOnlineTotalNum()}}})},calOnlineTotalNum:function(){var t=0;for(var e in wechat.onlineNumArr)t+=wechat.onlineNumArr[e];$("#onlineUserNum").html(t)},setEvent:function(){this.tabSwiper=new Swiper(".cen-qhbox",{loop:!1,autoplay:!1,onSlideChangeStart:function(t){$(".cen-ulist li").removeClass("on"),$($(".cen-ulist li")[t.activeIndex]).addClass("on"),0==t.activeIndex?($(".expert-ul").html(""),wechat.setRoomList(t.activeIndex)):($(".tactics-ul").html(""),wechat.setTradeInfo(1))},onInit:function(t){$(".cen-qhcon").height(function(){return $($(".cen-pubox")[t.activeIndex]).find(".boxcont").height()})}}),$(".cen-ulist li").click(function(){return $(this).hasClass("on")?!1:($(".cen-ulist li").removeClass("on"),$(this).addClass("on"),void wechat.tabSwiper.slideTo($(this).index(),300,!0))}),$(".pop-close").click(function(){$(".videobox iframe,.videobox video").remove(),wechat.hideBox()}),$(".expert-intro .conut-on").click(function(){wechat.setPraise($(this))}),$(".moreitem").click(function(){var t=$(this).attr("pageNo"),e=$(this).attr("totalR");return common.isBlank(t)||common.isBlank(e)?!1:(t=parseInt(t),3*t>=parseInt(e)?($(this).html("已加载全部策略"),!1):($(this).html("加载中..."),void wechat.setTradeInfo(t+1)))})},formatOpenDate:function(t,e){var i=[];if(e=e?new Date(e):new Date,common.isValid(t)){t=JSON.parse(t);var n=t.weekTime;if(common.isValid(n)){var a=null;for(var o in n){a=n[o];var s="";common.isValid(a.beginTime)&&(s+=a.beginTime.substr(0,5)),common.isValid(a.endTime)&&a.endTime!=a.beginTime&&(s+="-"+a.endTime.substr(0,5)),a.week&&e.getDay()!=a.week||i.push(s)}}return i.length>0?common.arrayUnique(i).join(" "):"不限"}return"不限"},hideBox:function(){$(".popupbox").hide(),$(".popupbg").fadeOut()},showBox:function(t,e){$(".popupbox").hide(),t.show(),e||$(".popupbg").fadeIn()},setLoadImg:function(t,e){e?t.parent().find(".loading-box").show():t.parent().find(".loading-box").hide()},getBackUserAvatar:function(t){return common.isValid(t)?t:"/images/wechat/def_b_user.png"},setRoomList:function(t){try{this.setLoadImg($(".expert-ul"),!0),$.getJSON("/wechat/getRoomList",function(e){wechat.setLoadImg($(".expert-ul"),!1);var i=e.rList,n=e.serverDate;if(i){var a=[],o=null,s=null,r=[],l=!1;for(var c in i)o=i[c],s=o.defaultAnalyst,s&&(l=common.dateTimeWeekCheck(o.openDate,!0,n),a.push('<li><aside class="fangj-ac clearfix">'),a.push("<p>"+o.name+"</p>"),a.push("<p>开放时间："+wechat.formatOpenDate(o.openDate,n)+"</p>"),a.push('<p>房间人数：<span class="fj-rens" rId="'+o._id+'">0</span>/<label>'+o.maxCount+"</label></p>"),a.push("</aside>"),a.push('<article class="fangj-space clearfix" rId="'+o._id+'" uid="'+s._id+'">'),a.push('<figure class="fxs-img fl"><img src="'+wechat.getBackUserAvatar(s.avatar)+'" width="100%" alt="" /></figure>'),a.push('<aside class="fxs-name fl">'),a.push("<h3>"+s.userName+"</h3>"),a.push("<p>"+s.position+"</p>"),a.push("</aside>"),a.push('<nav class="fxs-btn fr"><a href="javascript://" class="conut-on" uid="'+s._id+'"><i></i><span></span><b>+1</b></a><a href="javascript:" dw="'+l+'" class="'+(l?"enter-on":"enter-off")+'" rId="'+o._id+'">进入</a></nav>'),a.push("</article></li>"),r.push(s._id));$(".expert-ul").html(a.join("")),wechat.getOutRoomOnline(),r.length>0&&$.getJSON("/wechat/getUserPraiseNum",{praiseId:r.join(",")},function(t){if(t)for(var e in t)$(".expert-ul li .conut-on[uid="+t[e].praiseId+"] span").html(t[e].praiseNum)}),$(".fxs-img,.fxs-name h3").click(function(){var t=$(this).parents(".fangj-space");$(".expert-intro .conut-on").attr("uid",t.attr("uid")).find("span").html(t.find(".conut-on span").html()),$.getJSON("/wechat/getUserInfo",{id:t.attr("uid")},function(t){common.isValid(t)&&($(".expert-intro img").attr("src",t.descImg).attr("alt",t.name),$(".expert-intro .zw").html(t.desc))}),wechat.showBox($(".expert-intro"))}),$(".expert-ul .conut-on").click(function(){wechat.setPraise($(this))}),$(".expert-ul .enter-on").click(function(){wechat.joinRooms($(this))}),$(".cen-qhcon").height(function(){return $($(".cen-pubox")[t]).find(".boxcont").height()})}})}catch(e){console.error("setRoomList->"+e)}},setPraise:function(t){try{common.getJson("/wechat/setUserPraise",{clientId:wechat.userInfo.userId,praiseId:t.attr("uid")},function(e){var i=t.parents(".expert-intro");if(e.isOK){if(t.hasClass("conut-on")){t.find("b").fadeIn().delay(400).fadeOut();var n=t.find("span"),a=n.html();n.html(parseInt(common.isBlank(a)?0:a)+1),t.removeClass("conut-on").addClass("conut-off"),i.length>0&&$(".expert-ul .conut-on[uid="+t.attr("uid")+"] span").html(n.html())}}else wechat.showTipBox("亲，已点赞，当天只能点赞一次！")},!0)}catch(e){console.error("setPraise->"+e)}},joinRooms:function(t){var e=t.parents("li"),i=e.find(".fj-rens"),n=i.text(),a=i.parent().find("label").text();parseInt(n)>=parseInt(a)?wechat.showTipBox("亲，已满员，换个房间吧"):window.location.href="/wechat/room?groupId="+t.attr("rId")},showTipBox:function(t){$(".errorbox").hide().find("div").html(t),$(".errorbox").fadeIn().delay(1e3).fadeOut(200)},getArticleList:function(t,e,i,n,a,o,s){try{$.getJSON("/wechat/getArticleList",{code:t,platform:e,hasContent:i,pageNo:n,pageSize:a,orderByStr:o},function(t){s(t)})}catch(r){console.error("getArticleList->"+r),s(null)}},setBulletin:function(){this.getArticleList("bulletin_system","wechat_home","1",1,5,"",function(t){$("#bulletinDomId").html(""),0==t.result&&($.each(t.data,function(t,e){if(null!=e){var i=e.detailList[0];$("#bulletinDomId").append('<li class="swiper-slide"><span txt="txt" style="display:none;">'+i.content+'</span><a href="javascript:">'+i.title+"</a><i>"+common.formatterDate(e.publishStartDate,".")+"</i></li>")}}),$("#bulletinDomId li").click(function(){wechat.showBulletin($(this).children("a").text(),$(this).children("i").text(),$(this).children("span[txt]").html())}),$(".anounce").slide({mainCell:".anouncelist",effect:"topLoop",autoPlay:!0,delayTime:600,interTime:3e3,autoPage:!1}))})},setAdvertisement:function(){this.getArticleList("advertisement","wechat_home","0",1,3,'{"sequence":"asc"}',function(t){if(0==t.result){var e=t.data;for(var i in e)$("#slider ul").append('<li class="swiper-slide"><a href="'+(common.isBlank(e[i].linkUrl)?"javascript:":e[i].linkUrl)+'" target="_blank"><img width="100%" alt="" src="'+e[i].mediaUrl+'"></a></li>'),e.length>1&&$("#position").append('<span class="'+(0==parseInt(i)?"p-click":"")+'"></span>');e&&e.length>1&&new Swiper(".scroll-imbd",{pagination:".dot-infobox",paginationClickable:!0,loop:!0,autoplay:5e3,autoplayDisableOnInteraction:!1})}})},getTradeInfoDom:function(t){var e=[],i=t.categoryId,n=t._id,a=t.publishStartDate,o=t.detailList[0];if(o){if(-1!=i.indexOf("video"))e.push('<li id="'+n+'"><a href="javascript:" class="ali video-li"><dl class="trade-cl clearfix">'),e.push('<dt class="dt-fon fl"><img src="images/wechat/cate2.jpg" width="100%" alt="" /></dt>'),e.push('<dd><p class="trade-time"><i>'+o.tag+"</i>"+common.formatterDateTime(a)+"</p>"),e.push("<h3>"+(common.isValid(o.author)?"<span>【"+o.author+"】</span>":"")+o.title+"</h3>"),e.push('<div class="thumb"><img src="'+t.mediaImgUrl+'"><div class="iplay"><i></i></div></div>'),e.push('<span class="morelink">详情 &gt;</span>'),e.push("</dd></dl></a></li>");else if(-1!=i.indexOf("audio"))e.push('<li id="'+n+'"><dl class="trade-cl clearfix voice-li"><dt class="dt-fon fl"><img src="images/wechat/cate3.jpg" width="100%" alt="" /></dt><dd>'),e.push('<p class="trade-time"><i>'+o.tag+"</i>"+common.formatterDateTime(a)+"</p>"),e.push("<h3>"+(common.isValid(o.author)?"<span>【"+o.author+"】</span>":"")+o.title+"</h3>"),e.push('<a class="voicebar"><i></i><span>00:00</span><audio style="display:none;" src="'+t.mediaUrl+'"></audio></a>'),e.push("</dd></dl></li>");else{var s=o.author,r="images/wechat/cate1.jpg";if(common.isValid(o.author)&&-1!=o.author.indexOf(";")){var l=o.author.split(";");s=l[0],common.isValid(l[1])&&(r=l[1])}e.push('<li id="'+n+'"><a href="javascript:" class="ali text-li"><dl class="trade-cl clearfix">'),e.push('<dt class="dt-fon fxs-img fl"><img src="'+r+'" width="100%" alt="" /></dt>'),e.push('<dd><p class="trade-time"><i>'+o.tag+"</i>"+common.formatterDateTime(a)+"</p>"),e.push("<h3>"+(common.isValid(s)?"<span>【"+s+"】</span>":"")+o.title+"</h3>"),e.push('<p class="miaox-p">'+(common.isValid(o.remark)&&o.remark.length>40?o.remark.substr(0,40)+" ....":o.remark)+"<span>详情 &gt;</span></p>"),e.push("</dd></dl></a></li>")}return e.join("")}},getArticleInfo:function(t,e){try{$.getJSON("/wechat/getArticleInfo",{id:t},function(t){e(t)})}catch(i){console.error("getArticleInfo->"+i),e(null)}},formatAudioPlayTime:function(t){if(!t)return"00:00";var e=parseInt(t),i=parseInt(e/60);10>i&&(i="0"+i);var n=parseInt(e%60);return 10>n&&(n="0"+n),i+":"+n},setTradeInfo:function(t){this.setLoadImg($(".tactics-ul"),!0),this.getArticleList("trade_strategy","wechat_home","0",t||1,3,"",function(t){if(wechat.setLoadImg($(".tactics-ul"),!1),$(".moreitem").html("更多交易策略..."),0==t.result){var e=t.data;for(var i in e)$(".tactics-ul").append(wechat.getTradeInfoDom(e[i]));$(".cen-qhcon").height(function(){return $($(".cen-pubox")[1]).find(".boxcont").height()}),$(".voicebar").click(function(){var t=$(this).find("audio"),e=t[0];$(this).addClass("read"),e.paused?($(this).addClass("on"),e.play(),$(this).find("span").html(wechat.formatAudioPlayTime(e.duration))):(e.pause(),$(this).removeClass("on"))}),$(".moreitem").attr("pageNo",t.pageNo).attr("totalR",t.totalRecords),$(".text-li").click(function(){wechat.showBox($(".text-info"));var t=$(this).parent().attr("id");return t==$(".text-info").attr("id")?!1:void wechat.getArticleInfo(t,function(t){if(common.isValid(t)){var e=t.detailList[0];$(".text-info").attr("id",t._id),$(".text-info .titlebar2 h3").html(e.title),$(".text-info .titlebar2 label").html(common.formatterDateTime(t.publishStartDate)),$(".text-info .zw").html(e.content||""),$(".text-info .zw img").width("100%").height("auto")}})}),$(".video-li").click(function(){wechat.showBox($(".video-info"));var t=$(this).parent().attr("id");wechat.getArticleInfo(t,function(t){if($(".videobox").html(""),common.isValid(t)){var e=t.detailList[0];$(".video-info").attr("id",t._id),$(".video-info .titlebar2 h3").html(e.title||""),$(".video-info .titlebar2 label").html(common.formatterDateTime(t.publishStartDate)),$(".video-info .brief").html("<i>摘要</i>"+(e.remark||"")),common.isValid(t.mediaUrl)&&(-1!=t.mediaUrl.indexOf(".html")?$(".videobox").append('<iframe frameborder=0 width="100%" src="'+t.mediaUrl+'" allowfullscreen></iframe>'):$(".videobox").append('<video poster="'+t.mediaImgUrl+'" src="'+t.mediaUrl+'" controls="controls">您的浏览器不支持video标签。</video>'))}})})}})},setImgSwipBox:function(t){t.length>0&&(t.width("100%").height("auto"),t.click(function(t){t.preventDefault();var e=$(this);$.swipebox([{href:e.attr("src")}])}))},showBulletin:function(t,e,i){$(".anounce-info .titlebar2 h3").html(t),$(".anounce-info .titlebar2 span").html(e),$(".anounce-info .zw").html(i),wechat.showBox($(".anounce-info")),$(".anounce-info img").width("100%").height("auto")}};$(function(){wechat.init()});