var fxchat={userInfo:null,socketUrl:"",socket:null,onlineNumArr:{},tabSwiper:null,init:function(){this.setEvent(),this.setRoomList(0),this.setAdvertisement(),this.setBulletin(),this.setSocket()},getOutRoomOnline:function(){var t=$(".expert-ul li .enter-on").map(function(){return $(this).attr("rId")}).get();fxchat.socket.emit("outRoomGet",{groupIds:t,groupType:fxchat.userInfo.groupType})},setSocket:function(){this.socket=common.getSocket(io,this.socketUrl,this.userInfo.groupType),this.socket.on("connect",function(){fxchat.socket.emit("outRoomLogin",{groupType:fxchat.userInfo.groupType}),console.log("connected to server!")}),this.socket.on("disconnect",function(t){console.log("disconnect")}),this.socket.on("error",function(t){console.error("e:"+t)}),this.socket.on("notice",function(t){switch(t.type){case"onlineNum":var e=t.data;if(e.rOnlineSizeArr){var i=0,a=null;for(var n in e.rOnlineSizeArr){i=e.rOnlineSizeArr[n],fxchat.onlineNumArr[n]=i,a=$(".expert-ul li .fj-rens[rId="+n+"]"),a.html(i);var o=$(".expert-ul li .fxs-btn a[rId="+n+"]");"true"==o.attr("dw")&&(parseInt(a.next("label").text())<=i?o.removeClass("enter-on").addClass("enter-off"):o.removeClass("enter-ff").addClass("enter-on"))}fxchat.calOnlineTotalNum()}if(e.groupId){if(fxchat.onlineNumArr[e.groupId]=e.onlineUserNum,-1==e.groupId.indexOf("oRoomId")){var s=$(".expert-ul li .fj-rens[rId="+e.groupId+"]"),o=$(".expert-ul li .fxs-btn a[rId="+e.groupId+"]");s.html(e.onlineUserNum),"true"==o.attr("dw")&&(parseInt(s.next("label").text())<=e.onlineUserNum?o.removeClass("enter-on").addClass("enter-off"):o.removeClass("enter-ff").addClass("enter-on"))}fxchat.calOnlineTotalNum()}}})},calOnlineTotalNum:function(){var t=0;for(var e in fxchat.onlineNumArr)t+=fxchat.onlineNumArr[e];$("#onlineUserNum").html(t)},setEvent:function(){this.tabSwiper=new Swiper(".cen-qhbox",{loop:!1,autoplay:!1,onSlideChangeStart:function(t){$(".cen-ulist li").removeClass("on"),$($(".cen-ulist li")[t.activeIndex]).addClass("on"),0==t.activeIndex?($(".expert-ul").html(""),fxchat.setRoomList(t.activeIndex)):($(".tactics-ul").html(""),fxchat.setTradeInfo(1))},onInit:function(t){$(".cen-qhcon").height(function(){return $($(".cen-pubox")[t.activeIndex]).find(".boxcont").height()})}}),$(".cen-ulist li").click(function(){return $(this).hasClass("on")?!1:($(".cen-ulist li").removeClass("on"),$(this).addClass("on"),void fxchat.tabSwiper.slideTo($(this).index(),300,!0))}),$(".pop-close").click(function(){$(".videobox iframe,.videobox video").remove(),fxchat.hideBox()}),$(".expert-intro .conut-on").click(function(){fxchat.setPraise($(this))}),$(".moreitem").click(function(){var t=$(this).attr("pageNo"),e=$(this).attr("totalR");return common.isBlank(t)||common.isBlank(e)?!1:(t=parseInt(t),3*t>=parseInt(e)?($(this).html("已加载全部策略"),!1):($(this).html("加载中..."),void fxchat.setTradeInfo(t+1)))})},formatOpenDate:function(t,e,i){var a=[];if(i=i?new Date(i):new Date,common.isValid(t)){t=JSON.parse(t);var n=t.weekTime;if(common.isValid(n)){var o=null;for(var s in n){o=n[s];var r="";common.isValid(o.beginTime)&&(r+=o.beginTime.substr(0,5)),common.isValid(o.endTime)&&o.endTime!=o.beginTime&&(r+="-"+o.endTime.substr(0,5)),o.week&&i.getDay()!=o.week||(o.week&&i.getDay()==o.week&&common.isBlank(r)&&(r="不限"),a.push(r))}}return a.length>0?common.arrayUnique(a).join(" "):e?"不限":"不开放"}return"不限"},hideBox:function(){$(".popupbox").hide(),$(".popupbg").fadeOut()},showBox:function(t,e){$(".popupbox").hide(),t.show(),e||$(".popupbg").fadeIn()},setLoadImg:function(t,e){e?t.parent().find(".loading-box").show():t.parent().find(".loading-box").hide()},getBackUserAvatar:function(t){return common.isValid(t)?t:"/images/fxchat/def_b_user.png"},setRoomList:function(t){try{this.setLoadImg($(".expert-ul"),!0),$.getJSON("/fxchat/getRoomList",function(e){fxchat.setLoadImg($(".expert-ul"),!1);var i=e.rList,a=e.serverDate;if(i){var n=[],o=null,s=null,r=[],l=!1;for(var c in i)o=i[c],s=o.defaultAnalyst,s&&(l=common.dateTimeWeekCheck(o.openDate,!0,a),n.push('<li><aside class="fangj-ac clearfix">'),n.push("<p>"+o.name+"</p>"),n.push("<p>开放时间："+fxchat.formatOpenDate(o.openDate,l,a)+"</p>"),n.push('<p>房间人数：<span class="fj-rens" rId="'+o._id+'">0</span>/<label>'+o.maxCount+"</label></p>"),n.push("</aside>"),n.push('<article class="fangj-space clearfix" rId="'+o._id+'" uid="'+s._id+'">'),n.push('<figure class="fxs-img fl"><img src="'+fxchat.getBackUserAvatar(s.avatar)+'" width="100%" alt="" /></figure>'),n.push('<aside class="fxs-name fl">'),n.push("<h3>"+s.userName+"</h3>"),n.push("<p>"+s.position+"</p>"),n.push("</aside>"),n.push('<nav class="fxs-btn fr"><a href="javascript://" class="conut-on" uid="'+s._id+'"><i></i><span></span><b>+1</b></a><a href="javascript:" dw="'+l+'" class="'+(l?"enter-on":"enter-off")+'" rId="'+o._id+'">进入</a></nav>'),n.push("</article></li>"),r.push(s._id));$(".expert-ul").html(n.join("")),fxchat.getOutRoomOnline(),r.length>0&&$.getJSON("/fxchat/getUserPraiseNum",{praiseId:r.join(",")},function(t){if(t)for(var e in t)$(".expert-ul li .conut-on[uid="+t[e].praiseId+"] span").html(t[e].praiseNum)}),$(".fxs-img,.fxs-name h3").click(function(){var t=$(this).parents(".fangj-space");$(".expert-intro .conut-on").attr("uid",t.attr("uid")).find("span").html(t.find(".conut-on span").html()),$.getJSON("/fxchat/getUserInfo",{id:t.attr("uid")},function(t){common.isValid(t)&&($(".expert-intro img").attr("src",t.descImg).attr("alt",t.name),$(".expert-intro .zw").html(t.desc))}),fxchat.showBox($(".expert-intro"))}),$(".expert-ul .conut-on").click(function(){fxchat.setPraise($(this))}),$(".expert-ul .enter-on").click(function(){fxchat.joinRooms($(this))}),$(".cen-qhcon").height(function(){return $($(".cen-pubox")[t]).find(".boxcont").height()})}})}catch(e){console.error("setRoomList->"+e)}},setPraise:function(t){try{common.getJson("/fxchat/setUserPraise",{clientId:fxchat.userInfo.userId,praiseId:t.attr("uid")},function(e){var i=t.parents(".expert-intro");if(e.isOK){if(t.hasClass("conut-on")){t.find("b").fadeIn().delay(400).fadeOut();var a=t.find("span"),n=a.html();a.html(parseInt(common.isBlank(n)?0:n)+1),t.removeClass("conut-on").addClass("conut-off"),i.length>0&&$(".expert-ul .conut-on[uid="+t.attr("uid")+"] span").html(a.html())}}else fxchat.showTipBox("亲，已点赞，当天只能点赞一次！")},!0)}catch(e){console.error("setPraise->"+e)}},joinRooms:function(t){var e=t.parents("li"),i=e.find(".fj-rens"),a=i.text(),n=i.parent().find("label").text();parseInt(a)>=parseInt(n)?fxchat.showTipBox("亲，已满员，换个房间吧"):window.location.href="/fxchat/room?groupId="+t.attr("rId")},showTipBox:function(t){$(".errorbox").hide().find("div").html(t),$(".errorbox").fadeIn().delay(1e3).fadeOut(200)},getArticleList:function(t,e,i,a,n,o,s){try{$.getJSON("/fxchat/getArticleList",{code:t,platform:e,hasContent:i,pageNo:a,pageSize:n,orderByStr:o},function(t){s(t)})}catch(r){console.error("getArticleList->"+r),s(null)}},getSyllabus:function(t,e,i){try{$.getJSON("/fxchat/getSyllabus?t="+(new Date).getTime(),{groupType:t,groupId:e},function(t){var e="";try{t&&t.courses&&(e=common.formatSyllabus(t.courses,t.currTime,2))}catch(a){console.error("getSyllabus->"+a),e=""}var n="";e.length>0&&(n='<li class="swiper-slide"><span txt="txt" style="display:none;">'+e+'</span><a href="javascript:">'+t.title+"</a><i>"+common.formatterDate(t.updateDate,".")+"</i></li>"),i(n)})}catch(a){console.error("getSyllabus->"+a),i("")}},setBulletin:function(){fxchat.getSyllabus(fxchat.userInfo.groupType,"",function(t){$("#bulletinDomId").html(t),fxchat.getArticleList("bulletin_system","fxchat_home","1",1,5,"",function(t){0==t.result&&$.each(t.data,function(t,e){if(null!=e){var i=e.detailList[0];$("#bulletinDomId").append('<li class="swiper-slide"><span txt="txt" style="display:none;">'+i.content+'</span><a href="javascript:">'+i.title+"</a><i>"+common.formatterDate(e.publishStartDate,".")+"</i></li>")}}),$("#bulletinDomId li").click(function(){fxchat.showBulletin($(this).children("a").text(),$(this).children("i").text(),$(this).children("span[txt]").html())}),$(".anounce").slide({mainCell:".anouncelist",effect:"topLoop",autoPlay:!0,delayTime:600,interTime:3e3,autoPage:!1})})})},setAdvertisement:function(){this.getArticleList("advertisement","fxchat_home","0",1,3,'{"sequence":"asc"}',function(t){if(0==t.result){var e=t.data;for(var i in e)$("#slider ul").append('<li class="swiper-slide"><a href="'+(common.isBlank(e[i].linkUrl)?"javascript:":e[i].linkUrl)+'" target="_blank"><img width="100%" alt="" src="'+e[i].mediaUrl+'"></a></li>'),e.length>1&&$("#position").append('<span class="'+(0==parseInt(i)?"p-click":"")+'"></span>');e&&e.length>1&&new Swiper(".scroll-imbd",{pagination:".dot-infobox",paginationClickable:!0,loop:!0,autoplay:5e3,autoplayDisableOnInteraction:!1})}})},getTradeInfoDom:function(t){var e=[],i=t.categoryId,a=t._id,n=t.publishStartDate,o=t.detailList[0];if(o){if(-1!=i.indexOf("video"))e.push('<li id="'+a+'"><a href="javascript:" class="ali video-li"><dl class="trade-cl clearfix">'),e.push('<dt class="dt-fon fl"><img src="images/fxchat/cate2.jpg" width="100%" alt="" /></dt>'),e.push('<dd><p class="trade-time"><i>'+o.tag+"</i>"+common.formatterDateTime(n)+"</p>"),e.push("<h3>"+(common.isValid(o.author)?"<span>【"+o.author+"】</span>":"")+o.title+"</h3>"),e.push('<div class="thumb"><img src="'+t.mediaImgUrl+'"><div class="iplay"><i></i></div></div>'),e.push('<span class="morelink">详情 &gt;</span>'),e.push("</dd></dl></a></li>");else if(-1!=i.indexOf("audio"))e.push('<li id="'+a+'"><dl class="trade-cl clearfix voice-li"><dt class="dt-fon fl"><img src="images/fxchat/cate3.jpg" width="100%" alt="" /></dt><dd>'),e.push('<p class="trade-time"><i>'+o.tag+"</i>"+common.formatterDateTime(n)+"</p>"),e.push("<h3>"+(common.isValid(o.author)?"<span>【"+o.author+"】</span>":"")+o.title+"</h3>"),e.push('<a class="voicebar"><i></i><span>00:00</span><audio style="display:none;" src="'+t.mediaUrl+'"></audio></a>'),e.push("</dd></dl></li>");else{var s=o.author,r="images/fxchat/cate1.jpg";if(common.isValid(o.author)&&-1!=o.author.indexOf(";")){var l=o.author.split(";");s=l[0],common.isValid(l[1])&&(r=l[1])}e.push('<li id="'+a+'"><a href="javascript:" class="ali text-li"><dl class="trade-cl clearfix">'),e.push('<dt class="dt-fon fxs-img fl"><img src="'+r+'" width="100%" alt="" /></dt>'),e.push('<dd><p class="trade-time"><i>'+o.tag+"</i>"+common.formatterDateTime(n)+"</p>"),e.push("<h3>"+(common.isValid(s)?"<span>【"+s+"】</span>":"")+o.title+"</h3>"),e.push('<p class="miaox-p">'+(common.isValid(o.remark)&&o.remark.length>40?o.remark.substr(0,40)+" ....":o.remark)+"<span>详情 &gt;</span></p>"),e.push("</dd></dl></a></li>")}return e.join("")}},getArticleInfo:function(t,e){try{$.getJSON("/fxchat/getArticleInfo",{id:t},function(t){e(t)})}catch(i){console.error("getArticleInfo->"+i),e(null)}},formatAudioPlayTime:function(t){if(!t)return"00:00";var e=parseInt(t),i=parseInt(e/60);10>i&&(i="0"+i);var a=parseInt(e%60);return 10>a&&(a="0"+a),i+":"+a},setTradeInfo:function(t){this.setLoadImg($(".tactics-ul"),!0),this.getArticleList("trade_strategy","fxchat_home","0",t||1,3,"",function(t){if(fxchat.setLoadImg($(".tactics-ul"),!1),$(".moreitem").html("更多交易策略..."),0==t.result){var e=t.data;for(var i in e)$(".tactics-ul").append(fxchat.getTradeInfoDom(e[i]));$(".cen-qhcon").height(function(){return $($(".cen-pubox")[1]).find(".boxcont").height()}),$(".voicebar").click(function(){var t=$(this).find("audio"),e=t[0];$(this).addClass("read"),e.paused?($(this).addClass("on"),e.play(),$(this).find("span").html(fxchat.formatAudioPlayTime(e.duration))):(e.pause(),$(this).removeClass("on"))}),$(".moreitem").attr("pageNo",t.pageNo).attr("totalR",t.totalRecords),$(".text-li").click(function(){fxchat.showBox($(".text-info"));var t=$(this).parent().attr("id");return t==$(".text-info").attr("id")?!1:void fxchat.getArticleInfo(t,function(t){if(common.isValid(t)){var e=t.detailList[0];$(".text-info").attr("id",t._id),$(".text-info .titlebar2 h3").html(e.title),$(".text-info .titlebar2 label").html(common.formatterDateTime(t.publishStartDate)),$(".text-info .zw").html(e.content||""),$(".text-info .zw img").width("100%").height("auto")}})}),$(".video-li").click(function(){fxchat.showBox($(".video-info"));var t=$(this).parent().attr("id");fxchat.getArticleInfo(t,function(t){if($(".videobox").html(""),common.isValid(t)){var e=t.detailList[0];$(".video-info").attr("id",t._id),$(".video-info .titlebar2 h3").html(e.title||""),$(".video-info .titlebar2 label").html(common.formatterDateTime(t.publishStartDate)),$(".video-info .brief").html("<i>摘要</i>"+(e.remark||"")),common.isValid(t.mediaUrl)&&(-1!=t.mediaUrl.indexOf(".html")?$(".videobox").append('<iframe frameborder=0 width="100%" src="'+t.mediaUrl+'" allowfullscreen></iframe>'):$(".videobox").append('<video poster="'+t.mediaImgUrl+'" src="'+t.mediaUrl+'" controls="controls">您的浏览器不支持video标签。</video>'))}})})}})},setImgSwipBox:function(t){t.length>0&&(t.width("100%").height("auto"),t.click(function(t){t.preventDefault();var e=$(this);$.swipebox([{href:e.attr("src")}])}))},showBulletin:function(t,e,i){$(".anounce-info .titlebar2 h3").html(t),$(".anounce-info .titlebar2 span").html(e),$(".anounce-info .zw").html(i),fxchat.showBox($(".anounce-info")),$(".anounce-info img").width("100%").height("auto")}};$(function(){fxchat.init()});