var studioChat={filePath:"",enable:!0,storeInfoKey:"storeWhMsg_",whTipIntervalId:{},hasWhTipIntervalId:{},msgType:{text:"text",img:"img",file:"file"},socket:null,socketUrl:"",userInfo:null,init:function(){this.enable=store&&store.enabled,!this.enable&&console&&console.log("Local storage is not supported by your browser."),this.setEvent(),this.setSocket(),this.setVideo()},setVideo:function(){try{$.getJSON("/studio/getSyllabus?t="+(new Date).getTime(),{groupType:studioChat.userInfo.groupType,groupId:studioChat.userInfo.groupId},function(t){var e=t.data;if(e&&common.isValid(e.studioLink)){var s=JSON.parse(e.studioLink),i="";for(var a in s)if(1==s[a].code){i=s[a].url;break}if(common.isValid(i)&&0==$("#yyVideoDiv embed").length)if(-1!=i.indexOf("rtmp:")){var o='<div style="position: relative; width: 100%; height: 100%; left: 0px; top: 0px;"><object type="application/x-shockwave-flash" id="sewise_player" name="sewise_player" data="/js/lib/flash/SewisePlayer.swf" width="100%" height="100%"><param name="allowfullscreen" value="true"><param name="wmode" value="transparent"><param name="allowscriptaccess" value="always"><param name="flashvars" value="autoStart=true&amp;programId=&amp;shiftTime=&amp;lang=zh_CN&amp;type=rtmp&amp;serverApi=ServerApi.execute&amp;skin=/js/lib/flash/skins/liveOrange.swf&amp;title=&amp;draggable=true&amp;published=0&amp;streamUrl='+i+'&amp;duration=3600&amp;poster=&amp;flagDatas=&amp;videosJsonUrl=&amp;adsJsonData=&amp;statistics=&amp;customDatas=&amp;playerName=Sewise Player&amp;clarityButton=enable&amp;timeDisplay=disable&amp;controlBarDisplay=enable&amp;topBarDisplay=disable&amp;customStrings=&amp;volume=0.6&amp;key=&amp;trackCallback="></object></div>';$("#yyVideoDiv").html(o)}else $("#yyVideoDiv").html('<embed src="'+i+'" quality="high" width="100%" height="100%" align="middle" allowScriptAccess="never" allowFullScreen="true" mode="transparent" type="application/x-shockwave-flash"></embed>')}})}catch(t){console.error("setVideo has error:"+t)}},setTalkTop:function(t,e){if(t){var s=e.fromUser;$(".mymsg").show(),$(".mymsg em").hide(),$(".replybtn").attr("tm",s.publishTime).attr("uid",s.userId).attr("ts",s.talkStyle).attr("utype",s.userType),$(".sender").html(s.nickname),$(".xcont").html(e.content.value),$("#talk_top_id").prepend('<section class="ss-tk-info clearfix" tm="'+s.publishTime+'"><label><strong>'+s.nickname+'</strong>：</label><span style="margin-left:5px;text-align:justify;">'+e.content.value+'</span><button type="button">关闭</button><button type="button" uid="'+s.userId+'" utype="'+s.userType+'">回复</button></section>');var i=$("#talk_top_id .ss-tk-info[tm="+s.publishTime+"]");i.find("button").click(function(){var t=$(this).parents(".ss-tk-info"),e=$(this).attr("uid"),s=t.attr("tm");if(common.isValid(e)){var i=$(this);studioChat.setDialog(null,e,t.find("strong").addClass("reply-st").html(),i.attr("ts"),i.attr("utype"),s,i.siblings("span").html())}else t.remove(),$("#show_top_btn strong,#top_num").text("【"+$("#talk_top_id .ss-tk-info").length+"】"),$(".mymsg .replybtn[tm="+s+"]").parent().hide(),$("#contentText .txt_dia[tm="+s+"]").length>0&&$("#contentText").html("")})}else e.publishTime&&($("#talk_top_id .ss-tk-info[tm="+e.publishTime+"]").remove(),$(".mymsg .replybtn[tm="+e.publishTime+"]").parent().hide());$("#show_top_btn strong,#top_num").text("【"+$("#talk_top_id .ss-tk-info").length+"】")},getUiId:function(){var t=new Date;return t.getTime()+"_ms"},getVisitorList:function(t){if(!common.isBlank(t))try{$(".searchResult").hide(),$(".searchResult ul").html(""),$.getJSON("/studio/getVistiorByName",{groupType:studioChat.userInfo.groupType,groupId:studioChat.userInfo.groupId,nickname:t},function(t){if(t){$(".searchResult").show();var e=0,s="";for(var i in t)s=t[i].userId||t[i].visitorId,$(".searchResult ul li[uid="+s+"]").length>0||(e=t[i].onlineStatus,$(".searchResult ul").append('<li uid="'+s+'" cg="'+t[i].clientGroup+'"  '+(1==e?"":'class="off"')+"><label>"+t[i].nickname+"</label></li>"));$(".searchResult ul li").click(function(){$(".searchResult").hide();var t=$(this).attr("uid");studioChat.setWhVisitors(-1!=t.indexOf("visitor_")?-1:0,$(this).attr("cg"),t,$(this).find("label").text(),!$(this).hasClass("off")),$(".visitorDiv ul li[uid="+$(this).attr("uid")+"]").click()})}})}catch(e){alert("查询异常,请联系管理员！"),console.error("getVistiorByName->"+e)}},setWhBox:function(t){t&&$("#newMsgShowBtn").attr("t","hide"),$("#newMsgTipBtn").click()},setWhTipInfo:function(t){t&&$("#newMsgTipBtn").attr("uid",t),studioChat.setWhTipImgPlay(t)},getWhToUser:function(){var t=$(".visitorDiv ul li[class~=on]");return{userId:t.attr("uid"),nickname:t.find("label").text(),talkStyle:1,userType:t.attr("utype")}},sendWhMsg:function(t){var e=studioChat.getSendMsg(t);if(e!==!1){var s={uiId:studioChat.getUiId(),fromUser:studioChat.userInfo,content:{msgType:studioChat.msgType.text,value:e}};s.fromUser.toUser=this.getWhToUser(),studioChat.socket.emit("sendMsg",s),studioChat.setWhContent(s,!0,!1),t.html("")}},setWhOnlineTip:function(t,e,s){if(e){if(s){var i="";"-1"==s.userType&&common.isValid(s.loginId)?(i=$(".visitorDiv ul li[uid="+s.loginId+"]"),i.length>0&&(i.attr("uid",s.userId),i.find(".wrtip").text(""),$("#wh_msg_"+s.loginId).attr("id","wh_msg_"+s.userId))):"0"==s.userType&&common.isValid(s.visitorId)&&(i=$(".visitorDiv ul li[uid="+s.visitorId+"]"),i.find(".wrtip").text(studioChat.getWhUserCGTip(s.userType,s.clientGroup)),i.length>0&&(i.attr("uid",s.userId),$("#wh_msg_"+s.visitorId).attr("id","wh_msg_"+s.userId)));var a=$("#wh_msg_"+t+" .wh-title label").text(),o=$("#wh_msg_"+t+" .wh-title .title-tip");common.isValid(a)&&a!=s.nickname?o.text("账号转变:"+a+" --> "+s.nickname).show():o.text("").hide(),$(".visitorDiv ul li[uid="+t+"] label,#wh_msg_"+t+" .wh-title label").text(s.nickname)}$(".visitorDiv ul li[uid="+t+"]").removeClass("off"),$("#wh_msg_"+t+" .wh-title strong").text("在线")}else $(".visitorDiv ul li[uid="+t+"]").addClass("off"),$("#wh_msg_"+t+" .wh-title strong").text("离线")},getWhUserCGTip:function(t,e){return 0==t?"active"==e?"真实A":"notActive"==e?"真实N":"simulate"==e?"模拟":"register"==e?"注册":"":1==t?"管理员":2==t?"分析师":3==t?"客服":""},setWhVisitors:function(t,e,s,i,a,o){if(0==$(".visitorDiv ul li[uid="+s+"]").length){$(".visitorDiv ul").append('<li uid="'+s+'"  '+(a?"":'class="off"')+' utype="'+t+'"><span  class="user-row"><label>'+i+'</label><em class="close ym" t="0"></em><em class="wrtip">'+studioChat.getWhUserCGTip(t,e)+"</em></span></li>");var n=$(".visitorDiv ul li[uid="+s+"]");if(o){var r=n.find(".close"),l=parseInt(r.attr("t"))+1;r.attr("t",l).text(l).addClass("ym")}n.find(".close").click(function(){var t=$(this).parent().parent();t.remove(),$("#wh_msg_"+t.attr("uid")).remove(),$(".visitorDiv ul li").length>0&&$(".visitorDiv ul li:last").click()}),n.click(function(){$(".visitorDiv ul li").removeClass("on"),$(this).addClass("on"),$(this).find(".close").attr("t",0).text("").removeClass("ym");var t=$(this).attr("uid"),e="wh_msg_"+t,s=$(this).attr("utype");if(studioChat.closeWhTipMsg(t),$(".wh-right").children().hide(),0==$("#"+e).length){var i='<div id="'+e+'" class="wh-tab-msg"><div class="wh-title"><span><label>'+$(this).find("label").text()+'</label>【<strong></strong>】</span><span class="title-tip"></span></div><div class="wh-content"></div><div class="wh-txt"><div class="toolbar"><a href="javascript:" class="facebtn">表情</a><label for="file_'+e+'" class="send-wh-img" title="发送图片"></label><input type="file" id="file_'+e+'" style="position:absolute;clip:rect(0 0 0 0);" class="fileBtn"/></div><div contenteditable="true" class="ctextarea" id="whTxt_'+t+'" data-placeholder="按回车键发送"></div></div></div>';studioChat.updateWhTipStore(studioChat.userStoreInfoKey(studioChat.userInfo),t),$(".wh-right").append(i),$("#"+e).find(".ctextarea").keydown(function(t){return 13==t.keyCode?(studioChat.sendWhMsg($(this)),!1):void 0}),$("#"+e).find(".facebtn").qqFace({id:"faceId_"+t,zIndex:1e6,assign:"whTxt_"+t,path:studioChat.filePath+"/face/"}),$("#"+e).find(".fileBtn")[0].addEventListener("change",function(){var t=this,e=t.files[0];if(!e)return!1;if(0!=e.type.indexOf("image")||!e.type||!/\.(?:jpg|png|gif)$/.test(e.name.toLowerCase()))return alert("目前暂支持jpg,gif,png格式的图片！"),!1;var s=e.size;if(s>=5242880)return alert("发送的图片大小不要超过5MB."),!1;var i=new FileReader;i.readAsDataURL(e),i.onload=function(t){studioChat.setUploadImg(t.target.result)},i.onprogress=function(t){},i.onloadend=function(t){}},!1),studioChat.socket.emit("getWhMsg",{userType:studioChat.userInfo.userType,groupId:studioChat.userInfo.groupId,groupType:studioChat.userInfo.groupType,userId:studioChat.userInfo.userId,toUser:{userId:t,userType:s}})}else $("#"+e).show(),studioChat.setTalkListScroll(!0,$("#"+e+" .wh-content"),"dark");studioChat.setWhOnlineTip(t,!$(this).hasClass("off"))})}},getWhBox:function(){return $(".window-container[wid=newMsgShowBtn]")},setWhTipImgPlay:function(t){var e=0;-1==$(".wh_msg_ftip").attr("class").indexOf(" have")&&($(".wh_msg_ftip").attr("uid",t).attr("k",1).show().addClass("have"),e=1),$("#userListId li[id="+t+"]").attr("k",1),void 0==studioChat.hasWhTipIntervalId[t]&&(studioChat.whTipIntervalId[t]=setInterval(function(){$("#userListId li[id="+t+"][k=1]").toggleClass("have_op"),studioChat.hasWhTipIntervalId[t]=!0,1==e&&$(".wh_msg_ftip[k=1]").toggleClass("have_op")},1e3))},closeWhTipMsg:function(t){$("#userListId li[id="+t+"]").attr("k",0).removeClass("have_op"),$("#userListId [k=1]").length>0?$(".wh_msg_ftip").attr("uid",$("#userListId [k=1]:first").attr("id")):$(".wh_msg_ftip[uid="+t+"]").attr("k",0).removeClass("have have_op"),0==$("#userListId[k=1]").length&&0==$(".wh_msg_ftip[k=1]").length&&studioChat.whTipIntervalId[t]&&(clearInterval(studioChat.whTipIntervalId[t]),studioChat.whTipIntervalId[t]=null,studioChat.hasWhTipIntervalId[t]&&(studioChat.hasWhTipIntervalId[t]=null))},fillWhBox:function(t,e,s,i,a,o){var n=this.getWhBox(),r=studioChat.userStoreInfoKey(this.userInfo);if(0==n.length)return studioChat.setWhBox(!0),studioChat.setWhVisitors(t,e,s,i,!0,o),a&&studioChat.setWhTipStore(r,s),!1;var l=$(".visitorDiv ul li[uid="+s+"]");if(0==l.length){if(studioChat.setWhVisitors(t,e,s,i,!0,o),!n.is(":hidden"))return!1;a&&studioChat.setWhTipStore(r,s)}else{if(o&&!l.hasClass("on")){var u=l.find(".close"),d=parseInt(u.attr("t"))+1;u.attr("t",d).text(d).addClass("ym")}if(n.is(":hidden")){var h=$("#wh_msg_"+s+" .wh-content");if(0==h.length)return!1;a&&studioChat.setWhTipStore(r,s)}else!l.hasClass("on")&&a&&studioChat.setWhTipStore(r,s)}return!0},setWhContent:function(t,e,s){var i=t.fromUser,a="dialog ",o=t.content,n="",r="",l="";if(t.rule)return void $("#"+t.uiId+' span[contt="a"]').append('<em class="ruleTipStyle">'+t.value.tip+"</em>");if(s||(i.toWhUserId=i.userId),studioChat.userInfo.userId==i.userId){if(e&&(i.publishTime=t.uiId,i.toWhUserId=i.toUser.userId,l='<em class="img-loading"></em>',r='<span class="shadow-box"></span><s class="shadow-conut"></s>'),t.serverSuccess){if($("#"+t.uiId+" .dtime").html(studioChat.formatPublishTime(i.publishTime)),$("#"+t.uiId).attr("id",i.publishTime),t.content.msgType==studioChat.msgType.img){studioChat.removeLoadDom(i.publishTime);var u=$("#"+i.publishTime+" p"),d=t.content.needMax?"/studio/getBigImg?publishTime="+i.publishTime+"&userId="+i.userId:u.find("a img").attr("src");u.find("a[class=swipebox]").attr("href",d),$(".swipebox").swipebox()}return}a+="mine",n='<span class="wh-dia-title"><label class="dtime">'+studioChat.formatPublishTime(i.publishTime,s,"/")+'</label><label class="wh-nk">我</label></span>'}else{if(!s){var h=this.fillWhBox(i.userType,i.clientGroup,i.userId,i.nickname,!0,!0);if($(".visitorDiv ul").prepend($(".visitorDiv ul li[uid="+i.toWhUserId+"]")),!h)return}n='<span class="wh-dia-title"><label class="wh-nk">'+i.nickname+'</label><label class="dtime">'+studioChat.formatPublishTime(i.publishTime,s,"/")+"</label></span>"}if(common.isBlank(i.toWhUserId))return void console.error("setWhContent->fromUser toWhUserId is null,please check!");var c="",p=$("#wh_msg_"+i.toWhUserId+" .wh-content"),m=p.find(".mCSB_container"),f="";o.msgType==studioChat.msgType.img?(c=o.needMax?'<p><a href="/studio/getBigImg?publishTime='+i.publishTime+"&userId="+i.userId+'" class="swipebox" ><img src="'+o.value+'" alt="图片"/></a>'+r+"</p>":'<p><a href="'+o.value+'" class="swipebox" ><img src="'+o.value+'" alt="图片" /></a>'+r+"</p>",c+=l):(!e&&common.isValid(i.toUser.question)&&(f='<div class="dialog mine"><div><span class="wh-dia-title"><label class="dtime">'+studioChat.formatPublishTime(i.toUser.publishTime,s,"/")+'</label><label class="wh-nk">我</label></span></div><div class="whblt">'+i.toUser.question+"</div></div>",m.length>0?m.append(f):p.append(f)),c='<p><span class="dcont" contt="a">'+o.value+"</span></p>"),f='<div class="'+a+'" id="'+i.publishTime+'" utype="'+i.userType+'" mType="'+o.msgType+'" t="header"><div>'+n+"</div>"+c+"</div>",m.length>0?m.append(f):p.append(f),this.formatMsgToLink(i.publishTime),s||studioChat.setTalkListScroll(!0,p,"dark")},clearPasteImg:function(){$(".paste-img").is(":hidden")||$(".paste-img").hide().find("img").attr("src","").attr("h",120).attr("w",100)},setUploadImg:function(t){var e=studioChat.getUiId(),s={};common.copyObject(s,studioChat.userInfo,!0),s.toUser=this.getWhToUser();var i={uiId:e,fromUser:s,content:{msgType:studioChat.msgType.img,value:"",needMax:0,maxValue:""}};studioChat.setWhContent(i,!0,!1),i.content.value=t,studioChat.zipImg(i,100,60,function(t,s){if(t.error)return alert(t.error),$("#"+e).remove(),!1;var i=$("#"+t.uiId+" img");i.attr("src",s).attr("needMax",t.content.needMax),studioChat.dataUpload(t)})},zipImg:function(t,e,s,i){var a=new Image;a.onload=function(){var o=document.createElement("canvas");o||i({error:"发送图片功能目前只支持Chrome、Firefox、IE10或以上版本的浏览器！"});var n=a.width,r=a.height;if(r>=9*n)return i({error:"该图片高度太高，暂不支持发送！"}),!1;e>0&&(r>e||n>e)&&(t.content.needMax=1,r>e&&e>=n?(n=e/r*n,r=e):(r=e/n*r,n=e),a.height=r,a.width=n);var l=o.getContext("2d");o.width=n,o.height=r,l.clearRect(0,0,o.width,o.height),l.drawImage(a,0,0,n,r),i(t,o.toDataURL("image/jpeg",s/100))},a.src=t.content.value},dataUpload:function(t){var e=new XMLHttpRequest;e.open("POST","/studio/uploadData"),e.addEventListener("progress",function(e){if(e.lengthComputable){var s=(e.loaded/e.total*100|0)+"%";$("#"+t.uiId+" .shadow-box").css({height:"'+ra+'"}),$("#"+t.uiId+" .shadow-conut").html(s)}},!1),e.setRequestHeader("Content-Type","application/json; charset=utf-8"),e.onreadystatechange=function(){4===e.readyState&&200===e.status&&console.log("dataUpload success!")},t.fromUser.socketId=studioChat.socket.id,e.send(JSON.stringify(t))},setEvent:function(){$("#header_img_id").attr("src",studioChat.userInfo.avatar);var t=$("#groupInfoId"),e=t.attr("awr"),s=t.attr("aw");"true"==s&&common.containSplitStr(e,studioChat.userInfo.userType)&&$(".wh_msg_ftip").show(),jqWindowsEngineZIndex=1e5,$("#newMsgTipBtn").click(function(){var t=$(this).attr("uid"),e=studioChat.getWhBox();if(e.length>0)return e.show(),void $(".visitorDiv ul li[uid="+t+"]").click();var s=[];s.push('<div class="wh-box"><div class="wh-left"><div class="searchDiv">'),s.push('<input type="text" id="vSearchTxt"/><a href="javascript:" id="vSearchTxtBtn"><em></em></a>'),s.push('<div class="searchResult"><ul></ul></div></div><div class="visitorDiv">'),s.push('<ul></ul></div></div><div class="wh-right"></div></div>'),$("#newMsgShowBtn").newWindow({windowTitle:"私聊",content:s.join(""),windowType:"normal",minimizeButton:!0,maximizeButton:!1,statusBar:!1,resizeIcon:"",width:680,height:550,beforeMinimize:function(t){return t.hide(),!1}}),$("#newMsgShowBtn").click(),$("#vSearchTxt").keydown(function(t){13==t.keyCode&&studioChat.getVisitorList(this.value)}),$("#vSearchTxtBtn").click(function(){studioChat.getVisitorList($("#vSearchTxt").val())})}),$(".wh_msg_ftip").click(function(){var t=$(this).attr("uid"),e=studioChat.getWhBox();e.length>0?($(".visitorDiv ul li[uid="+t+"]").click(),e.show()):($('.dialogbtn[uid="'+t+'"] a.d2').click(),$("#newMsgTipBtn").click())}),$("#approveAllHandler button").click(function(){var t=[],e=[];return $("#dialog_list .approve input:checked").each(function(){var s=$(this).parents("div");t.push(s.attr("id"));for(var i=s.attr("fuId"),a=!1,o=0,n=e.length;n>o;o++)if(i===e[o]){a=!0;break}a||e.push(i)}),0==t.length?(alert("请选择聊天记录！"),!1):void studioChat.socket.emit("approvalMsg",{fromUser:studioChat.userInfo,status:$(this).attr("btnType"),publishTimeArr:t,fuIdArr:e})}),$("#approveCheckAll").click(function(){var t=$(this).prop("checked");$("#dialog_list .approve input[type=checkbox]").each(function(){$(this).prop("checked",t)})}),$("#close-top-box").click(function(){$(".top-box").hide()}),$("#show_top_btn").click(function(){$(".top-box").toggle()}),$(document).click(function(t){$("div[id^=faceId]").hide(),$(t.target).hasClass("headimg")||$(t.target).parent().hasClass("headimg")||"header"==$(t.target).parent().attr("t")||$(t.target).hasClass("uname")||$(".dialogbtn").hide(),$(t.target).hasClass("searchResult")||$(".searchResult").hide()}),$(".facebtn").qqFace({id:"faceId",assign:"contentText",path:studioChat.filePath+"/face/"}),$(".replybtn").click(function(){var t=$(this);studioChat.setDialog(null,t.attr("uid"),$(".sender").html(),t.attr("ts"),t.attr("utype"),t.attr("tm"),t.parent().find(".xcont").html()),$(".mymsg em").show()}),$(".closebtn").click(function(){$(".mymsg,.mymsg em").hide()}),$(".clearbtn").click(function(){$("#dialog_list").html(""),studioChat.setTalkListScroll()}),$(".scrollbtn").click(function(){$(this).hasClass("on")?$(this).removeClass("on"):($(this).addClass("on"),studioChat.setTalkListScroll(!0))}),$(".view_select .se_cont").hover(function(){$(this).parent().addClass("dw")},function(){$(this).parent().removeClass("dw")}).find(".selectlist a").click(function(){$(this).is(".on")||($(".view_select .selectlist a").removeClass("on"),$(".view_select .selected").text($(this).text()),$(this).addClass("on"),studioChat.showViewSelect($(this).attr("t")),studioChat.setTalkListScroll(!0))}),$("#contentText").keydown(function(t){if(13==t.keyCode)return $("#sendBtn").click(),!1;if(8==t.keyCode){var e=$(this).find(".txt_dia");if($.trim($(this).text())==e.text())return e.remove(),$(this).html(""),!0}}).autocomplete({source:function(t,e){/^@.*$/g.test(t.term)&&e(studioChat.searchUserList(t.term.substring(1,t.term.length)))},delay:500,minLength:2,position:{my:"left bottom",at:"left top"},select:function(t,e){return $("#contentText").html("").append('<span class="txt_dia" contenteditable="false" uid="'+e.item.value+'" utype="'+e.item.userType+'">@<label>'+e.item.label+"</label></span>&nbsp;").focusEnd(),!1}}).autocomplete("instance")._renderItem=function(t,e){return $("<li>").append("<a>"+e.label+"</a>").appendTo(t)},$("#sendBtn").click(function(){var t=studioChat.getToUser(),e=studioChat.getSendMsg();if(e!==!1){var s={uiId:studioChat.getUiId(),fromUser:studioChat.userInfo,content:{msgType:studioChat.msgType.text,value:e}};s.fromUser.toUser=t,studioChat.socket.emit("sendMsg",s),studioChat.setContent(s,!0,!1),$("#contentText").html("")}})},searchUserList:function(t){var e=$("#userListId li[t!=14][t!=0]").map(function(){var e=$(this).find(".uname").text();return-1!=e.indexOf(t)?{value:this.id,label:e,userType:$(this).attr("utype")}:null}).get();return e},showViewSelect:function(t){"analyst"==t?($("#dialog_list").children("[utype!=2]").hide(),$("#dialog_list").children("[utype=2]").show()):"me"==t?($("#dialog_list").children("[isMe=false]").hide(),$("#dialog_list").children("[isMe=true]").show()):$("#dialog_list").children().show()},getSendMsg:function(t){var t=t?t:$("#contentText"),e=t.find(".txt_dia");t.find(".txt_dia").length>0&&(studioChat.setTalkTop(!1,{publishTime:e.attr("tm")}),t.find(".txt_dia").remove());var s=common.clearMsgHtml(t.html());return common.isBlank(s)?(t.html(""),!1):s},setListScroll:function(t){$(t).hasClass("mCustomScrollbar")?$(t).mCustomScrollbar("update"):$(t).mCustomScrollbar({scrollButtons:{enable:!0},theme:"dark"})},setTalkListScroll:function(t,e,s){var i=e?e:$("#chatMsgContentDiv");i.hasClass("mCustomScrollbar")?(i.mCustomScrollbar("update"),t&&i.mCustomScrollbar("scrollTo","bottom")):(i.mCustomScrollbar({scrollInertia:1,scrollButtons:{enable:!0},theme:s?s:"light-2"}),i.mCustomScrollbar("scrollTo","bottom"))},getToUser:function(){var t=$("#contentText .txt_dia");if(t.length>0){var e={userId:t.attr("uid"),nickname:t.find("label").text(),talkStyle:0,userType:t.attr("utype")},s=t.find("input");return s.length>0&&(e.question=s.val()),e}return null},formatPublishTime:function(t,e,s){var i=Number(t.replace(/_.+/g,""));return common.isBlank(t)?"":e?common.formatterDateTime(i,s):common.getHHMM(i)},setDialog:function(t,e,s,i,a,o,n){if(1==i)studioChat.fillWhBox(a,t,e,s,!1),studioChat.getWhBox().show(),$(".visitorDiv ul li[uid="+e+"]").click();else{$("#contentText .txt_dia").remove(),$("#contentText").html($("#contentText").html().replace(/^((&nbsp;)+)/g,""));var r="";if(n){r='<input type="hidden" value="">';var l=$("<div>"+n+"</div>");l.find(".txt_dia").remove(),n=l.html()}var u=$('<span class="txt_dia" contenteditable="false" uid="'+e+'" tm="'+o+'" utype="'+a+'">'+r+"@<label>"+s+"</label></span>&nbsp;");u.find("input").val(n),$("#contentText").prepend(u).focusEnd(),$("#talk_top_id .ss-tk-info[tm="+o+"]").find("strong").addClass("reply-st")}},setContent:function(t,e,s){var i=t.fromUser;if(e&&(i.publishTime=t.uiId),s&&$("#"+i.publishTime).length>0)return $("#"+i.publishTime+" span[contt] em[class=ruleTipStyle]").remove(),void $("#"+i.publishTime+" .approve").remove();if(t.rule)return void(t.value&&t.value.needApproval?$("#"+t.uiId).attr("id",i.publishTime):$("#"+t.uiId+' span[contt="a"]').append('<em class="ruleTipStyle">'+t.value.tip+"</em>"));if(!e&&studioChat.userInfo.userId==i.userId&&t.serverSuccess)return $("#"+t.uiId+" .dtime").html(studioChat.formatPublishTime(i.publishTime)),void $("#"+t.uiId).attr("id",i.publishTime);var a=studioChat.formatContentHtml(t,e,s),o=$("#dialog_list");o.append(a),this.formatMsgToLink(i.publishTime);var n=$(".view_select .selectlist a[class=on]").attr("t");"all"!=n&&studioChat.showViewSelect(n),!s&&$(".scrollbtn").hasClass("on")&&studioChat.setTalkListScroll(!0),$("#"+i.publishTime+" .headimg,#"+i.publishTime+" .uname").click(function(){var t=$(this).parents(".dialog"),e=t.find(".dialogbtn");e.attr("tm",t.attr("id")),studioChat.openDiaLog(e,!0)}),$("#"+i.publishTime+" .dialogbtn a").click(function(){var t=$(this).parent(),e=$(this).attr("t"),s="";"2"==e&&(e=0,s=t.prev().find("span[contt='a']").html()),studioChat.setDialog(t.attr("cg"),t.attr("uId"),t.attr("nk"),e,t.attr("utype"),t.attr("tm"),s),t.hide()}),$("#"+i.publishTime+" .txt_dia").click(function(){studioChat.setDialog(null,$(this).attr("uid"),$(this).find("label").text(),0,$(this).attr("utype"))}),$("#"+i.publishTime+" .approve button").click(function(){var t=[],e=[],s=$(this).parents("div");t.push(s.attr("id")),e.push(s.attr("fuId")),studioChat.socket.emit("approvalMsg",{fromUser:studioChat.userInfo,status:$(this).attr("btnType"),publishTimeArr:t,fuIdArr:e})})},openDiaLog:function(t,e){$(".dialogbtn").not(t).hide(),t.css("left","0");var s=t.parent();if(common.isValid(s.attr("utype"))){var i=0===s.next().size();t.parent().hasClass("analyst")?t.css("top",e&&i?"-120px":"53px"):t.css("top",e&&i?"-92px":"39px")}return t.is(":hidden")?void t.show():(t.hide(),!1)},formatContentHtml:function(t,e,s){var i="dialog ",a="",o="",n="uname ",r="false",l=t.fromUser,u=t.content,d=l.nickname,h=l.toUser,c="";h&&common.isValid(h.userId)&&(c='<span class="txt_dia" uid="'+h.userId+'" utype="'+h.userType+'">@<label>'+h.nickname+"</label></span>",studioChat.userInfo.userId==h.userId&&(r="true")),a=u.value,studioChat.userInfo.userId==l.userId?(i+="mine",d="我",r="true"):(2==l.userType&&(i+="analyst"),1==l.userType&&(i+="admin"),o=studioChat.getDialogHtml(l.clientGroup,l.userId,d,l.userType,l.isMobile,!0),!s&&h&&studioChat.userInfo.userId==h.userId&&studioChat.setTalkTop(!0,t));var p='<div class="'+i+'" id="'+l.publishTime+'" isMe="'+r+'" utype="'+l.userType+'" mType="'+u.msgType+'" t="header"><a href="javascript:" class="headimg" uId="'+l.userId+'">'+studioChat.getUserAImgCls(l.clientGroup,l.userType,l.avatar)+'</a><i></i><p><a href="javascript:"  class="'+n+'">'+d+'</a><span class="dtime">'+studioChat.formatPublishTime(l.publishTime)+"</span>";return 0==u.status&&(p+='<span class="approve"><input type="checkbox"/><button btnType="1">通过</button><button btnType="2">拒绝</button></span>',$("#approveAllHandler").show()),p+=h&&common.isValid(h.question)?'<span class="dcont"><span uid="'+h.userId+'" utype="'+h.userType+'">'+h.nickname+'</span>提问：<span contt="q">'+h.question+'</span><span class="dialog_reply">回复：<span contt="a">'+a+"</span></span>":'<span class="dcont" contt="a">'+c+a+"</span>",p+="</span></p>"+o+"</div>"},formatMsgToLink:function(t){$("#"+t+' span[contt]:contains("http:"),#'+t+' span[contt]:contains("https:")').each(function(t,e){var s=$(e).html(),i=s.split(/<img src="\S+">/g),a="";for(var o in i)if(a=i[o],!common.isBlank(a)){var n=a.replace(/(http:\/\/|https:\/\/)((\w|=|\?|\.|\/|\\&|-)+)(:\d+)?(\/|\S)+/g,function(t){return'<a href="'+t+'" target="_blank" style="color:#3181c6;">'+t+"</a>"});e.innerHTML=e.innerHTML.replace(a,n)}})},removeLoadDom:function(t){$("#"+t+" .img-loading,#"+t+" .img-load-gan,#"+t+" .shadow-box,#"+t+" .shadow-conut").remove()},getUserAImgCls:function(t,e,s){var i="";return e&&0!=e&&common.isValid(s)?'<img src="'+s+'">':(i="vip"==t?"user_v":"active"==t||"notActive"==t?"user_r":"simulate"==t?"user_d":"register"==t?"user_m":"user_c",'<img src="/images/studio_admin/'+i+'.png">')},getDialogHtml:function(t,e,s,i,a,o){if(studioChat.userInfo.userId!=e&&-1==studioChat.userInfo.userId.indexOf("visitor_")){var n=$("#groupInfoId"),r=[];return r.push('<div class="dialogbtn" style="display:none;" cg="'+t+'" nk="'+s+'" uId="'+e+'" utype="'+i+'">'),r.push('<a href="javascript:" class="d1" t="0"><span>@TA</span></a>'),"true"==n.attr("aw")&&common.containSplitStr(n.attr("awr"),studioChat.userInfo.userType)&&r.push('<a href="javascript:" class="d2" t="1"><span>私聊</span></a>'),o&&r.push('<a href="javascript:" class="d1" t="2"><span>回复</span></a>'),r.length>1?r.join("")+"</div>":""}return""},setOnlineUser:function(t){var e={notActive:"(N)",active:"(A)"};$("#userListId li[id='"+t.userId+"']").remove();var s=studioChat.getDialogHtml(t.clientGroup,t.userId,t.nickname,t.userType,t.isMobile,!1),i="",a=t.sequence,o=common.isBlank(e[t.clientGroup])?"":e[t.clientGroup],n=t.isMobile?'<em class="mb-cls">(mb)'+o+"</em>":'<em class="mb-cls">'+o+"</em>";studioChat.userInfo.userId==t.userId&&(i="【我】",n="",a=0);var r=$("#userListId li"),l=$('<li id="'+t.userId+'" t="'+a+'" utype="'+t.userType+'"  ismb="'+t.isMobile+'">'+s+'<a href="javascript:" t="header" class="uname"><div class="headimg">'+studioChat.getUserAImgCls(t.clientGroup,t.userType,t.avatar)+'</div><label class="nk-lb">'+t.nickname+i+"</label>"+n+"</a></li>");if(0==r.length)$("#userListId").append(l);else if(""!=i)r.first().before(l);else{var u=!1,d=0,h="";r.each(function(){return d=parseInt($(this).attr("t")),t.sequence<d?($(this).before(l),u=!0,!1):t.sequence==d&&(h=$(this).find("a").text(),t.nickname<=h)?($(this).before(l),u=!0,!1):void 0}),u||$("#userListId").append(l)}return common.isValid(s)&&($("#userListId li[id="+t.userId+"] a[t=header]").click(function(){var t=$(this).parent();$(".dialogbtn").hide(),$(".user_box li").removeClass("zin"),t.addClass("zin"),studioChat.openDiaLog($(this).prev(),!1),$(".dialogbtn",$(this).parent()).css("left","7px")}),l.find(".dialogbtn a").click(function(){var t=$(this).parent();studioChat.setDialog(t.attr("cg"),t.attr("uId"),t.attr("nk"),$(this).attr("t"),t.attr("utype"),t.attr("tm")),t.hide()})),!0},leaveRoomTip:function(t){if("visitor"!=studioChat.userInfo.clientGroup){var e="";"roomClose"==t&&(e="房间已停用，"),"otherLogin"==t&&(e="您的账号已在其他地方进入该房间，"),"forcedOut"==t&&(e="您已被管理员强制退出房间，"),$("#tipMsgBox").fadeIn(0).delay(6e3).fadeOut(200).find("span").text("注意："+e+"正自动退出....."),window.setTimeout(function(){window.close()},3e3)}},setSocket:function(){this.socket=common.getSocket(io,this.socketUrl,this.userInfo.groupType),this.socket.on("connect",function(){console.log("connected to server!"),studioChat.userInfo.socketId=studioChat.socket.id;var t=$("#groupInfoId");studioChat.socket.emit("login",{userInfo:studioChat.userInfo,lastPublishTime:$("#content_ul li:last").attr("id"),fUserTypeStr:t.attr("awr"),allowWhisper:t.attr("aw")}),$(".img-loading[pf=chatMessage]").show()}),this.socket.on("onlineUserList",function(t,e){$("#userListId").html("");var s=null;for(var i in t)s=t[i],studioChat.setOnlineUser(s);$("#onLineSizeNum").text(e),studioChat.setListScroll(".user_box"),studioChat.loadWhTipStore(studioChat.userStoreInfoKey(studioChat.userInfo))}),this.socket.on("disconnect",function(t){console.log("disconnect")}),this.socket.on("error",function(t){console.error("e:"+t)}),this.socket.on("sendMsg",function(t){t.fromUser.toUser&&1==t.fromUser.toUser.talkStyle?(studioChat.setWhContent(t,!1,!1),t.content.msgType==studioChat.msgType.img&&$(".swipebox").swipebox()):studioChat.setContent(t,!1,!1)}),this.socket.on("notice",function(t){switch(t.type){case"onlineNum":var e=t.data,s=e.onlineUserInfo;e.online?studioChat.setOnlineUser(s):studioChat.userInfo.userId!=s.userId&&($("#userListId #"+s.userId).remove(),studioChat.setListScroll(".user_box")),$("#onLineSizeNum").text($("#userListId li").length),studioChat.setWhOnlineTip(s.userId,e.online,s);break;case"removeMsg":$("#"+t.data.replace(/,/g,",#")).remove(),studioChat.setTalkListScroll();break;case"leaveRoom":studioChat.leaveRoomTip(t.flag);break;case"approvalResult":var e=t.data;if(e.fromUserId==studioChat.userInfo.userId)if(e.isOK){var i=e.publishTimeArr;if(2==e.status){for(var a in i)$("#"+i[a]).remove();studioChat.setTalkListScroll()}else for(var a in i)$("#"+i[a]+" .approve").remove();$("#approveCheckAll").prop("checked",!1),0==$("#dialog_list .approve").size()&&$("#approveAllHandler").hide()}else alert("操作出现异常，请重新执行！");else if(e.refuseMsg){var i=e.publishTimeArr;for(var a in i)$("#"+i[a]).remove();studioChat.setTalkListScroll()}else{for(var a in e)studioChat.formatUserToContent(e[a]);studioChat.setTalkListScroll(!0)}}}),this.socket.on("loadMsg",function(t){$(".img-loading[pf=chatMessage]").hide();var e=t.msgData,s=t.isAdd;if(s||$("#content_ul").html(""),e&&$.isArray(e)){e.reverse();for(var i in e){var a=e[i];a.content.status=a.status,studioChat.formatUserToContent(a)}studioChat.setTalkListScroll(!0)}}),this.socket.on("loadWhMsg",function(t){var e=t.data;if("offline"==t.type){if(e&&!$.isEmptyObject(e)){studioChat.setWhBox(!0);var s="";for(var i in e)s=i,studioChat.setWhVisitors(e[i].userType,e[i].clientGroup,i,e[i].nickname,$("#userListId li[id='"+i+"']").length>0);var a=studioChat.userStoreInfoKey(studioChat.userInfo);studioChat.setWhTipStore(a,s)}}else if(e&&$.isArray(e)){var o=0,n=null;e.reverse();for(var r in e)n=e[r],studioChat.formatUserToContent(n,!0,t.toUserId),n.content.msgType==studioChat.msgType.img&&o++;o>0&&$(".swipebox").swipebox(),studioChat.setTalkListScroll(!0,$("#wh_msg_"+t.toUserId+" .wh-content"),"dark")}})},formatUserToContent:function(t,e,s){var i={userId:t.userId,nickname:t.nickname,avatar:t.avatar,userType:t.userType,groupId:t.groupId,clientGroup:t.clientGroup,publishTime:t.publishTime,toUser:t.toUser,avatar:t.avatar};e?(i.toWhUserId=s,studioChat.setWhContent({fromUser:i,content:t.content},!1,!0)):studioChat.setContent({fromUser:i,content:t.content},!1,!0)},updateWhTipStore:function(t,e){if(this.enable){for(var s=store.get(t),i=[],a=0;a<s.length;a++)s[a]==e?delete s[a]:s[a]&&i.push(s[a]);store.set(t,i)}},setWhTipStore:function(t,e){if(this.enable&&e){var s=store.get(t);common.isBlank(s)?(s=[],s.push(e)):-1==$.inArray(e,s)&&s.push(e),store.set(t,s),studioChat.loadWhTipStore(t)}},loadWhTipStore:function(t){if(this.enable){var e=store.get(t);if(e.length>0)for(var s=0;s<e.length;s++)e[s]&&studioChat.setWhTipInfo(e[s]);
}},whTipStoreUserIdFirst:function(t){return this.enable&&store.get(t).length?store.get(t)[0]:void 0},userStoreInfoKey:function(t){return studioChat.storeInfoKey+t.groupId+"_"+t.accountNo}};$(function(){studioChat.init()});