function openLive800Chat(e){var t="https://www.onlineservice-hk.com/k800/chatClient/chatbox.jsp?companyID=209&s=1";e?location.href=t:window.open(t,"Live800Chatindow","height=520,width=740,top=0,left=0,toolbar=no,menubar=no,scrollbars=no, resizable=no,location=no, status=no")}function openQQChatByCommonv3(){var e="http://crm2.qq.com/page/portalpage/wpa.php?uin=800018282&cref=&ref=&f=1&ty=1&ap=&as=";window.open(e,"QQChatindow","height=544, width=644,top=0,left=0,toolbar=no,menubar=no,scrollbars=no, resizable=no,location=no, status=no")}function openQQChatByCommonjs(){var e="http://wpa.b.qq.com/cgi/wpa.php?ln=2&uin=800018282";window.open(e)}function live800Prompt(e){window.onbeforeunload=null;var t="http://wpa.b.qq.com/cgi/wpa.php?ln=2&uin=800018886",o="http://onlinecustomer-service.gwghk.com/live800/chatClient/chatbox.jsp?companyID=283&enterurl=http%3A%2F%2Fwww%2Egwfx%2Ecom%2F&tm=1355377642406";if(2==e)try{UUID.prototype.createUUID();window.open(t,"Live800Chatindow","height=520,width=740,top=0,left=0,toolbar=no,menubar=no,scrollbars=no, resizable=no,location=no, status=no")}catch(i){window.open(t,"Live800Chatindow","height=520,width=740,top=0,left=0,toolbar=no,menubar=no,scrollbars=no, resizable=no,location=no, status=no")}else try{UUID.prototype.createUUID();window.open(o,"Live800Chatindow","height=520,width=740,top=0,left=0,toolbar=no,menubar=no,scrollbars=no, resizable=no,location=no, status=no")}catch(i){window.open(o)}}function qqPrompt(e){var t="http://wpa.b.qq.com/cgi/wpa.php?ln=2&uin=800018886";window.onbeforeunload=null;try{var o=UUID.prototype.createUUID();getGacookiesTrack(o,"2","1"),window.open(t,"Live800Chatindow","height=520,width=740,top=0,left=0,toolbar=no,menubar=no,scrollbars=no, resizable=no,location=no, status=no")}catch(i){window.open(t,"Live800Chatindow","height=520,width=740,top=0,left=0,toolbar=no,menubar=no,scrollbars=no, resizable=no,location=no, status=no")}}var common={daysCN:{0:"星期天",1:"星期一",2:"星期二",3:"星期三",4:"星期四",5:"星期五",6:"星期六"},remove:function(e,t){return isNaN(t)||t>e.length?!1:void e.splice(t,1)},joinSplit:function(e){return",".concat(e).concat(",")},isBlank:function(e){return void 0==e||null==e||"undefined"==e||"null"==e||""==$.trim(e)},isValid:function(e){return!this.isBlank(e)},trim:function(e){return this.isBlank(e)?"":e.toString().replace(/(^\s*)|(\s*$)/g,"")},escapeHtml:function(e){return document.createElement("div").appendChild(document.createTextNode(e)).parentNode.innerHTML.replace(/"/g,'\\"')},encodeHtml:function(e){return this.isBlank(e)?"":e.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&")},formatterDate:function(e,t){t||(t="-"),e instanceof Date||(e=new Date(e));var o=e.getFullYear()+t+(e.getMonth()+1>=10?e.getMonth()+1:"0"+(e.getMonth()+1))+t+(e.getDate()<10?"0"+e.getDate():e.getDate());return o},getHHMMSS:function(e){e instanceof Date||(e=new Date(e));var t=(e.getHours()<10?"0"+e.getHours():e.getHours())+":"+(e.getMinutes()<10?"0"+e.getMinutes():e.getMinutes())+":"+(e.getSeconds()<10?"0"+e.getSeconds():e.getSeconds());return t},getMMSS:function(e){return e instanceof Date||(e=new Date(e)),(e.getMinutes()<10?"0"+e.getMinutes():e.getMinutes())+":"+(e.getSeconds()<10?"0"+e.getSeconds():e.getSeconds())},getHHMM:function(e){e instanceof Date||(e=new Date(e));var t=(e.getHours()<10?"0"+e.getHours():e.getHours())+":"+(e.getMinutes()<10?"0"+e.getMinutes():e.getMinutes());return t},formatterDateTime:function(e,t){if(t||(t="-"),e instanceof Date||(e=new Date(e)),"Invalid Date"==e)return"";var o=e.getFullYear()+t+(e.getMonth()+1>=10?e.getMonth()+1:"0"+(e.getMonth()+1))+t+(e.getDate()<10?"0"+e.getDate():e.getDate())+" "+(e.getHours()<10?"0"+e.getHours():e.getHours())+":"+(e.getMinutes()<10?"0"+e.getMinutes():e.getMinutes())+":"+(e.getSeconds()<10?"0"+e.getSeconds():e.getSeconds());return o},longMsTimeToDateTime:function(e,t){var o=new Date(e);return this.formatterDateTime(o,t)},showBox:function(e,t){$(e).slideDown(),$(t||".layer-shadow").show()},hideBox:function(e,t){$(e).slideUp(),$(t||".layer-shadow").hide()},containSplitStr:function(e,t){return common.isBlank(e)||common.isBlank(t)?!1:-1!=(","+e+",").indexOf(","+t+",")},getJson:function(e,t,o,i,s){var r=null;return $.ajax({url:e,type:"POST",timeout:1e5,cache:!1,async:void 0!=i?i:!1,dataType:"json",data:t,success:"function"==typeof o?o:function(e){r=e},error:function(e,t){"function"==typeof s?s(t):common.isValid(e.responseText)&&"OK"!=e.statusText?alert(e.responseText):alert("请求超时,请重试!")}}),r},arraySort:function(e,t){return function(o,i){return t?o[e]<i[e]:o[e]>i[e]}},randomNumber:function(e){for(var t="",o=0;e>o;o++)t+=Math.floor(10*Math.random());return t},isMobilePhone:function(e){return/(^[0-9]{11})$|(^86(-){0,3}[0-9]{11})$/.test(e)},dateTimeWeekCheck:function(e,t,o){if(this.isBlank(e))return!!t;$.isPlainObject(e)||(e=JSON.parse(e));var i=o?new Date(o):new Date,s=!1,r=this.formatterDate(i);if(s=this.isBlank(e.beginDate)||r>=e.beginDate,s&&(s=this.isBlank(e.endDate)||r<=e.endDate),!s)return!1;var n=e.weekTime;if(this.isBlank(n))return s;var a=null,l=null,u=!1;for(var c in n)if(a=n[c],(!this.isValid(a.week)||i.getDay()==parseInt(a.week))&&(l=this.getHHMMSS(i),u=this.isBlank(a.beginTime)||l>=a.beginTime,u&&(u=this.isBlank(a.endTime)||l<=a.endTime),u))break;return u},arrayUnique:function(e){if(!e)return e;for(var t,o=[],i={},s=0;null!=(t=e[s]);s++)i[t]||(o.push(t),i[t]=!0);return o},isWebSocket:function(){return window.WebSocket},getSocket:function(e,t,o){return common.isWebSocket()?(console.log("used websocket!"),e.connect(t.webSocket+"/"+o,{transports:["websocket"]})):e.connect(t.socketIO+"/"+o)},refreshSession:function(){setInterval(function(){$.get("/refreshSession?t="+new Date,function(){})},9e5)},randomNumber:function(e){for(var t="",o=0;e>o;o++)t+=Math.floor(10*Math.random());return t},clearMsgHtml:function(e){var e=e.replace(/((^((&nbsp;)+))|\n|\t|\r)/g,"").replace(/<\/?(?!(img|IMG)\s+src="[^>"]+\/face\/[^>"]+"\s*>)[^>]*>/g,"");return e&&(e=$.trim(e)),e},formatToJson:function(e){return this.isBlank(e)?null:JSON.parse(e)},getSyllabusPlan:function(e,t){if(!e||!e.courses)return null;var o=function(e,t){if(e){var o=common.isMobile(),i=null;"object"!=typeof e&&(e=JSON.parse(e));for(var s in e)if(i=e[s],o){if(1==t&&3==i.code)return i.url}else if(i.code==t)return i.url}},i=function(t,i,s){var n=null,a=t.course;return a&&a.length>i?(n=a[i],0==n.status||common.isBlank(n.lecturerId)?null:(n.studioLink=o(e.studioLink,n.courseType),n.startTime=t.startTime,n.endTime=t.endTime,n.day=r[i].day,n.isNext=s,n)):null},s=null;s=this.isValid(e.courses)&&"object"!=typeof e.courses?JSON.parse(e.courses):e.courses;for(var r=s.days,n=s.timeBuckets,a=new Date(t).getDay(),l=common.getHHMM(t),u=null,c=!1,d=null,h=null,p=0;p<r.length;p++)if(0!=r[p].status)if(r[p].day>a){for(var m in n)if(u=n[m],h=i(u,p,!0))return h}else if(r[p].day==a)for(var m in n){if(u=n[m],u.startTime<=l&&(u.endTime>=l||"00:00"==u.endTime))return c=!0,i(u,p,!1);if(!c&&u.startTime>l)return c=!0,i(u,p,!0)}else if(!d)for(var m=0;m<n.length;m++)if(h=n[m].course,h&&0!=h[p].status&&!common.isBlank(h[p].lecturerId)){d={dayIndex:p,tmIndex:m};break}return!c&&d?i(n[d.tmIndex],d.dayIndex,!0):null},formatSyllabus:function(e,t,o,i){var s={dayCN:["星期天","星期一","星期二","星期三","星期四","星期五","星期六"],indexCN:["第一节","第二节","第三节","第四节","第五节","第六节","第七节","第八节"],courseCls:["prev","ing","next"],tableCls:"syllabus",courseType:{0:"文字在线",1:"视频在线",2:"ONE TV"}},r=new Date(t).getDay(),n=this.getHHMM(t),a=$.extend({},s,i),l=function(e,t,o,i){var s=0,l=(e+6)%7,u=(r+6)%7;return s=l>u?2:u>l?0:i?1:n>=o?0:t>n?2:1,a.courseCls[s]},u=[];try{if(e){var c=$.isPlainObject(e)?e:JSON.parse(e),d=c.days?c.days.length:0;if(d>0)if(1===o){var h={0:"文字",1:"视频",2:"oneTV"};u.push('<div class="sy_panel">');var p=t-864e5*((r+6)%7),m=null,f=null,g=null;u.push('<div class="sy_nav">');for(var v=' style="width:'+100/d+'%;"',S=0;d>S;S++)m=new Date(p+(c.days[S].day+6)%7*864e5),f=m.getFullYear()+"-"+(m.getMonth()<9?"0":"")+(m.getMonth()+1)+"-"+(m.getDate()<10?"0":"")+m.getDate(),g=c.days[S].day==r?' class="active"':"",u.push('<a href="javascript:void(0)" d="'+c.days[S].day+'"'+g+v+">"+a.dayCN[c.days[S].day]+"<br/><span>"+f+'</span><em class="dir">^</em></a>');u.push("</div>"),u.push('<div class="sy_cont"><div>'),u.push('<table cellpadding="0" cellspacing="0" border="0" class="'+a.tableCls+'">');for(var b=null,T=null,S=0;d>S;S++){if(u.push('<tbody d="'+c.days[S].day+'">'),0==c.days[S].status)T=l(c.days[S].day,null,null,!0),u.push('<tr class="'+T+'" width="100%"><td>休市</td></tr>');else for(var w=0,k=c.timeBuckets.length;k>w;w++)b=c.timeBuckets[w],T=l(c.days[S].day,b.startTime,b.endTime,!1),0==b.course[S].status?(u.push('<tr class="'+T+'">'),u.push('<td width="25%">'+b.startTime+"-"+b.endTime+"</td>"),u.push('<td colspan="2" width="75%">休市</td>'),u.push("</tr>")):b.course[S].lecturer&&(u.push('<tr class="'+T+'">'),u.push('<td width="25%">'+b.startTime+"-"+b.endTime+"【"+h[b.course[S].courseType]+"】</td>"),u.push('<td width="25%">'+b.course[S].lecturer+"</td>"),u.push('<td width="50%">'+b.course[S].title+"</td>"),u.push("</tr>"));u.push("</tbody>")}u.push("</table>"),u.push("</div></div>"),u.push("</div>")}else if(2===o){u.push('<table cellpadding="0" cellspacing="1" border="0" class="'+a.tableCls+'">'),u.push("<tr>"),u.push("<th>星期\\节次</th>");for(var k=c.timeBuckets?c.timeBuckets.length:0,b=null,T=null,w=0;k>w;w++)b=c.timeBuckets[w],u.push("<th>"+a.indexCN[w]+"<br><span>("+b.startTime+"-"+b.endTime+")</span></th>");u.push("</tr>");for(var y=null,S=0,I=c.days?c.days.length:0;I>S;S++){if(y=c.days[S],u.push("<tr>"),u.push("<th>"+a.dayCN[y.day]+"</th>"),0==y.status)T=l(y.day,null,null,!0),u.push('<td class="'+T+'" colspan="'+k+'">休市</td>');else for(var w=0;k>w;w++)b=c.timeBuckets[w],T=l(y.day,b.startTime,b.endTime,!1),u.push('<td class="'+T+'">'+(0==b.course[S].status?"休市":b.course[S].lecturer)+"</td>");u.push("</tr>")}u.push("</table>")}else if(3===o){var p=n-864e5*((r+6)%7),m=null,g=null,y=null,v=' style="width:'+100/d+'%;"';u.push("<tr>");for(var S=0;d>S;S++)y=c.days[S],m=new Date(p+(c.days[S].day+6)%7*864e5),g=c.days[S].day==r?' class="active"':"",u.push('<th d="'+c.days[S].day+'"'+g+v+">"+a.dayCN[c.days[S].day]+"<i></i></th>");u.push("</tr>"),u.push('<tr><td class="space" colspan="'+d+'"></td></tr>');for(var b=null,T=null,S=0;d>S;S++){if(y=c.days[S],u.push('<tr d="'+y.day+'"><td colspan="'+d+'">'),0==y.status)T=l(y.day,null,null,!0),u.push('<p class="'+T+'">休市</p>');else for(var w=0,k=c.timeBuckets?c.timeBuckets.length:0;k>w;w++)b=c.timeBuckets[w],b.course[S].lecturer&&(T=l(y.day,b.startTime,b.endTime,!1),u.push('<p class="'+T+'">'),u.push("<span>"+b.startTime+"-"+b.endTime+"</span>"),0==b.course[S].status?u.push("<span>休市</span>"):(u.push("<span>"+a.courseType[b.course[S].courseType]+"</span>"),u.push("<span>"+b.course[S].lecturer+"</span>"),u.push('<span class="item">'+b.course[S].title+"</span>")),u.push("</p>"));u.push("</td></tr>")}}}}catch(J){return console.error("formatSyllabus->"+J),""}return u.join("")},isMobile:function(){return/(iphone|ipod|ipad|android|mobile|playbook|bb10|meego)/.test(navigator.userAgent.toLowerCase())},copyObject:function(e,t,o){if(!t)return e;for(var i in e)t.hasOwnProperty(i)&&common.isValid(t[i])&&(e[i]=t[i]);if(o)for(var i in t)e.hasOwnProperty(i)||(e[i]=t[i])},isRightName:function(e){return!/^([0-9]{2,20})$/g.test(e)&&/^([\w\u4e00-\u9fa5]{2,20})$/g.test(e)},randomIndex:function(e){var t=parseInt(Math.round(Math.random()*e));return t==e&&(t=e-1),0>t?0:t},saveToDesktop:function(e,t){try{var o=new ActiveXObject("WScript.Shell"),i=o.CreateShortcut(o.SpecialFolders("Desktop")+"\\"+t+".url");i.TargetPath=e,i.Save()}catch(s){return!1}return!0}};window.console||(console=function(){function e(){}function t(){return null==o&&(o=new e),o}var o=null;return e.prototype={log:function(e){},error:function(e){}},t()}()),$.fn.focusEnd=function(){$(this).focus();var e=$("<span/>").appendTo($(this)),t=e.get(0),o=null,i=null;return document.selection?(o=document.body.createTextRange(),o.moveToElementText(t),o.select()):window.getSelection&&(o=document.createRange(),o.selectNode(t),i=window.getSelection(),i.removeAllRanges(),i.addRange(o)),e.remove(),this},String.prototype.formatStr=function(){if(0==arguments.length)return this;for(var e=this,t=0;t<arguments.length;t++)e=e.replace(new RegExp("\\{"+t+"\\}","g"),null==arguments[t]||void 0==arguments[t]?"":arguments[t]);return e};var roomJS={initSewise:!1,web24kPath:"",filePath:"",apiUrl:"",currStudioAuth:!1,visitorSpeak:!1,fromPlatform:null,serverTime:0,pushObj:{talkPush:[],talkPushInterval:null},msgType:{text:"text",img:"img",file:"file"},socket:null,socketUrl:"",userInfo:null,init:function(){this.serverTimeUp(),this.setVisitStore(),this.whTalk.initWH(),this.setSocket(),this.setEvent(),this.setVideoList(),studioMbPop.load(this.userInfo,this.fromPlatform,{onShow:function(){$("#tVideoDiv video").hide()},onHide:function(){$("#tVideoDiv video").show()}}),this.initRoom()},initRoom:function(){this.userInfo.nickname||this.refreshNickname(!1,"匿名_"+this.userInfo.userId.substring(8,12)),"visitor"==this.userInfo.clientGroup&&(this.currStudioAuth||studioMbPop.popBox("login",{groupId:roomJS.userInfo.groupId,clientGroup:roomJS.userInfo.clientGroup,clientStoreId:roomJS.userInfo.clientStoreId,platform:roomJS.fromPlatform,closeable:!1}))},refreshNickname:function(e,t){this.userInfo.isSetName=e,this.userInfo.nickname=t,$("#header_ui").text(t),studioMbPop.Person.refreshNickname(t)},serverTimeUp:function(){setInterval(function(){roomJS.serverTime+=1e3},1e3)},setVisitStore:function(){if(!store.enabled)return void console.log("Local storage is not supported by your browser.");var e="storeInfo_"+this.userInfo.groupType,t=store.get(e),o={};if(common.isBlank(t)){var i=common.randomNumber(6);o.clientStoreId=(new Date).getTime()+"_"+i,o.userId="visitor_"+i,o.nickname="游客_"+i,o.userType=-1,store.set(e,o),$(".collect-tip").fadeIn().delay(6e4).fadeOut()}else o=t;this.userInfo.clientStoreId=o.clientStoreId,this.userInfo.visitorId=o.userId,this.userInfo.loginId=o.loginId,this.userInfo.clientGroup&&"visitor"==this.userInfo.clientGroup?(this.userInfo.nickname=o.nickname,this.userInfo.userId=o.userId,this.visitorSpeak||($("#contentText").attr("contenteditable",!1).append('<span style="margin:15px 5px;">亲，<a id="contentText_login" href="javascript:void(0);" style="text-decoration: underline;color:#3F51B5;cursor: pointer;">登录</a>&nbsp;&nbsp;后可以发言哦~</span>'),$("#contentText_login").click(function(){studioMbPop.popBox("login",{groupId:roomJS.userInfo.groupId,clientStoreId:roomJS.userInfo.clientStoreId,platform:roomJS.fromPlatform})}))):(o.loginId=this.userInfo.userId,store.set(e,o)),this.isNeverLogin=!common.isValid(o.loginId)},setSocket:function(){studioMbPop.loadingBlock($("#talkBoxTab")),this.socket=common.getSocket(io,this.socketUrl,this.userInfo.groupType),this.socket.on("connect",function(){console.log("connected to server!"),roomJS.userInfo.socketId=roomJS.socket.id,roomJS.socket.emit("login",{userInfo:roomJS.userInfo,lastPublishTime:$("#dialog_list>li:last").attr("id"),fromPlatform:roomJS.fromPlatform,allowWhisper:roomJS.whTalk.enable},navigator.userAgent)}),this.socket.on("onlineUserList",function(e,t){if(roomJS.whTalk.enable){for(var o in e)3==e[o].userType&&roomJS.whTalk.setCSOnline(e[o].userId,!0);roomJS.whTalk.getCSList()}}),this.socket.on("disconnect",function(){console.log("disconnect")}),this.socket.on("error",function(e){console.error("e:"+e)}),this.socket.on("sendMsg",function(e){e.fromUser.toUser&&1==e.fromUser.toUser.talkStyle?roomJS.whTalk.receiveMsg(e,!1,!1):roomJS.setContent(e,!1,!1)}),this.socket.on("notice",function(e){switch(e.type){case"onlineNum":var t=e.data,o=t.onlineUserInfo;3==o.userType&&roomJS.whTalk.enable&&roomJS.whTalk.setCSOnline(o.userId,t.online);break;case"removeMsg":$("#"+e.data.replace(/,/g,",#")).remove(),roomJS.setTalkListScroll();break;case"leaveRoom":roomJS.leaveRoomTip(e.flag);break;case"approvalResult":var t=e.data,i=0;if(t.refuseMsg){var s=t.publishTimeArr;for(i in s)$("#"+s[i]+" .dialog em[class=ruleTipStyle]").html("已拒绝")}else{for(i in t)roomJS.formatUserToContent(t[i]);roomJS.setTalkListScroll()}break;case"pushInfo":var t=e.data;1==t.position?(roomJS.whTalk.pushObj={info:t.content,publishTime:t.publishTime,infoId:t.contentId},window.setTimeout(function(){roomJS.whTalk.pushMsg()},60*t.timeOut*1e3)):3==t.position&&roomJS.talkBoxPush.initTBP(t.infos);break;case"serverTime":roomJS.serverTime=e.data}}),this.socket.on("loadMsg",function(e){var t=e.msgData,o=e.isAdd;if(o||$("#content_ul").html(""),t&&$.isArray(t)){t.reverse();for(var i in t)roomJS.formatUserToContent(t[i]);studioMbPop.loadingBlock($("#talkBoxTab"),!0),roomJS.setTalkListScroll(),window.setTimeout(function(){roomJS.setTalkListScroll()},500)}}),this.socket.on("loadWhMsg",function(e){var t=e.data;if(t&&$.isArray(t))for(var o,i=0,s=t.length;s>i;i++)o=t[i],roomJS.formatUserToContent(o,!0,e.toUserId);studioMbPop.loadingBlock($("#whTalkBoxTab"),!0)})},setVideoList:function(){studioMbPop.loadingBlock($("#videosTab")),this.getArticleList("teach_video_base,teach_video_gw,teach_video_expert",this.userInfo.groupId,0,1,100,'{"sequence":"desc","publishStartDate":"desc"}',null,function(e){var t=$("#videosTab .boxcont");if(t.html(""),e&&0==e.result){for(var o=e.data,i=[],s=null,r=0,n=o?o.length:0;n>r;r++)r%5==0&&i.push('<ul class="teach-ul">'),s=o[r].detailList[0],i.push('<li><a title="'+s.title+'" href="javascript:void(0)" id="'+o[r]._id+'" vUrl="'+o[r].mediaUrl+'"><i></i><span>'+s.title+"</span></a></li>"),(r%5==4||r==n-1)&&i.push("</ul>"),t.html(i.join(""));t.find("li a").click(function(){$(this).is(".on")||($("#videosTab .boxcont li a.on").removeClass("on"),$(this).addClass("on")),roomJS.video.play("studio","mp4",$(this).attr("vUrl"),$(this).text())})}roomJS.video.start(),studioMbPop.loadingBlock($("#videosTab"),!0)})},setEvent:function(){this.setEventCen(),this.video.init(),this.setEventChat(),this.setHeight(),this.browserState.initBrowserState()},setHeight:function(){var e=0;e+=$(".videopart").height(),e+=$(".cen-ulist").is(":hidden")?0:$(".cen-ulist").height(),e+=$("#header").is(":hidden")?0:$("#header").height(),e=$(window).height()-e,$(".cen-pubox .boxcont:gt(1)").height(e),e-=$(".float-box").height(),$(".cen-pubox .boxcont:lt(2)").height(e)},setEventCen:function(){var e=new Swiper(".cen-qhbox",{loop:!1,autoplay:!1,onSlideChangeStart:function(e){$(".cen-ulist li").eq(e.activeIndex).trigger("click")}});$(".cen-ulist li").click(function(){$(".cen-ulist li.on").removeClass("on"),$(this).addClass("on");var t=$(this).attr("t");"talkBoxTab"==t?(roomJS.view.boardCtrl(1),roomJS.whTalk.whSwitch(!1)):"whTalkBoxTab"==t?(roomJS.whTalk.whSwitch(!0),roomJS.view.boardCtrl($.trim($("#contentText").html())?1:4)):(roomJS.whTalk.whSwitch(!1),roomJS.view.boardCtrl(0),"TradeArticleTab"==t&&roomJS.setTradeArticle()),e.slideTo($(this).index(),300,!1)}),$("#header_hb").bind("click",function(){window.location.href="/hxstudio/home"}),$("#header_ui").bind("click",function(){roomJS.userInfo&&roomJS.userInfo.isLogin?studioMbPop.popBox("person"):studioMbPop.popBox("login",{groupId:roomJS.userInfo.groupId,clientGroup:roomJS.userInfo.clientGroup,clientStoreId:roomJS.userInfo.clientStoreId,platform:roomJS.fromPlatform})})},setEventChat:function(){$("#msgFaceBtn").bind("click",function(){$(this).blur(),"whTalkBoxTab"==$("ul.cen-ulist>li.on").attr("t")?(roomJS.view.boardCtrl($("#facePanel").is(":hidden")?6:4),$.trim($("#contentText").html())&&roomJS.view.boardCtrl(2)):$("#facePanel").is(":hidden")?roomJS.view.boardCtrl(2):roomJS.view.boardCtrl(1),roomJS.face.init($("#facePanel"),$("#contentText"),roomJS.filePath+"/face/",!roomJS.visitorSpeak&&"visitor"==roomJS.userInfo.clientGroup)}),$("#talkBoxTab .view_select").click(function(){var e=$(this);e.is(".dw")?(e.removeClass("dw"),roomJS.view.viewSelect=!1):(e.addClass("dw"),roomJS.view.viewSelect=!0)}).find(".selectlist a").click(function(){if(!$(this).is(".on")){$("#talkBoxTab .view_select .selectlist a").removeClass("on"),$("#talkBoxTab .view_select .selected").text($(this).text()),$(this).addClass("on");var e=$(this).attr("t");roomJS.showViewSelect(e)}}),$(document).bind("touchstart",function(e){if(roomJS.view.viewSelect){var t=$("#talkBoxTab .view_select");t.is(e.target)||0!=t.find(e.target).length||t.trigger("click")}if(roomJS.whTalk.viewSelect){var t=$("#whThtalkBoxTab .view_select");t.is(e.target)||0!=t.find(e.target).length||t.trigger("click")}2==roomJS.view.viewBoard&&0==$(".float-box").find(e.target).length&&$("#contentText").trigger("blur")}),$("#contentText").keydown(function(e){var t=$(this).html();return 13==e.keyCode?(common.isValid(t)&&($(this).html(t.replace(/<div>|<\/div>/g,"")),$("#sendBtn").click()),!1):void 0}).keyup(function(e){if(8==e.keyCode){var t=$(this).find(".txt_dia");if($.trim($(this).text())==t.text()&&0==$(this).find("img").length)return t.remove(),$(this).html(""),!0}}).bind("input",function(){var e=(roomJS.visitorSpeak||"visitor"!=roomJS.userInfo.clientGroup)&&($.trim($(this).text())!=$(this).find(".txt_dia").text()||$(this).find("img").size()>0);"whTalkBoxTab"==$("ul.cen-ulist>li.on").attr("t")&&roomJS.view.boardCtrl(e?$("#facePanel").is(":hidden")===!0?1:2:4),e?$("#sendBtn").addClass("pressed"):$("#sendBtn").removeClass("pressed")}),$("#sendBtn").click(function(){if($(this).blur(),roomJS.view.boardCtrl(1),roomJS.visitorSpeak||"visitor"!=roomJS.userInfo.clientGroup){if(roomJS.userInfo.isSetName===!1)return void studioMbPop.popBox("set",{studioChatObj:roomJS});var e=roomJS.getToUser(),t=roomJS.getSendMsg();if(t!==!1){var o={uiId:roomJS.getUiId(),fromUser:roomJS.userInfo,content:{msgType:roomJS.msgType.text,value:t}};o.fromUser.toUser=e,roomJS.whTalk.tabCheck?roomJS.whTalk.sendWhMsg(o):(roomJS.socket.emit("sendMsg",o),roomJS.setContent(o,!0,!1)),$("#contentText").html("").trigger("input")}}}),$(".addpic-btn").click(function(){$(".add-img").is(":hidden")?roomJS.view.boardCtrl(5):roomJS.view.boardCtrl(4)}),$("#top_msg").click(function(){var e=$(this).find("label");$(this).slideUp(),roomJS.setDialog(e.attr("fuserId"),e.attr("fnickname"),0,e.attr("fuType"),null)}),$("#top_msg i").click(function(){return $("#top_msg").slideUp(),!1}),$(".file-img").click(function(){return FileReader?void 0:void alert("发送图片功能目前只支持Chrome、Firefox、IE10或以上版本的浏览器！")}),$(".file-img").bind("change",function(){var e=this,t=e.files[0];if(!t)return!1;if(0!=t.type.indexOf("image")||!t.type||!/\.(?:jpg|png|gif)$/.test(t.name.toLowerCase()))return alert("目前暂支持jpg,gif,png格式的图片！"),!1;var o=t.size;if(o>=1048576)return alert("发送的图片大小不要超过1MB."),!1;var i=new FileReader;i.readAsDataURL(t),i.onload=function(e){roomJS.setUploadImg(e.target.result,roomJS.getToUser())},i.onprogress=function(e){},i.onloadend=function(e){},$(this).val("")})},setUploadImg:function(e,t){var o=roomJS.getUiId(),i={};common.copyObject(i,roomJS.userInfo,!0),i.toUser=t;var s={uiId:o,fromUser:i,content:{msgType:this.msgType.img,value:"",needMax:0,maxValue:""}};roomJS.whTalk.tabCheck?roomJS.whTalk.sendWhMsg(s):this.setContent(s,!0,!1),s.content.value=e,this.zipImg(s,100,60,function(e,t){if(e.error)return alert(e.error),$("#"+o).remove(),!1;var i=$("#"+e.uiId+" span[contt='a'] a");i.attr("href",t).children("img").attr("src",t).attr("needMax",e.content.needMax),roomJS.dataUpload(e)})},zipImg:function(e,t,o,i){var s=new Image;s.onload=function(){var r=document.createElement("canvas");r||i({error:"发送图片功能目前只支持Chrome、Firefox、IE10或以上版本的浏览器！"});var n=s.width,a=s.height;if(a>=9*n)return i({error:"该图片高度太高，暂不支持发送！"}),!1;t>0&&(a>t||n>t)&&(e.content.needMax=1,a>t&&t>=n?(n=t/a*n,a=t):(a=t/n*a,n=t),s.height=a,s.width=n);var l=r.getContext("2d");r.width=n,r.height=a,l.clearRect(0,0,r.width,r.height),l.drawImage(s,0,0,n,a),i(e,r.toDataURL("image/jpeg",o/100))},s.src=e.content.value},dataUpload:function(e){var t=new XMLHttpRequest;t.open("POST","/hxstudio/uploadData"),t.addEventListener("progress",function(t){if(t.lengthComputable){var o=(t.loaded/t.total*100|0)+"%";$("#"+e.uiId+" .shadow-box").css({height:"'+ra+'"}),$("#"+e.uiId+" .shadow-conut").html(o)}},!1),t.setRequestHeader("Content-Type","application/json; charset=utf-8"),t.onreadystatechange=function(){4===t.readyState&&200===t.status&&console.log("dataUpload success!")},e.fromUser.socketId=this.socket.id,t.send(JSON.stringify(e))},view:{viewSelect:!1,viewBoard:1,boardCtrl:function(e){if(this.viewBoard!=e){this.viewBoard=e;var t={header:$("#header"),backToLive:$("#backToLive"),facePanel:$("#facePanel"),floatBox:$(".float-box"),publicChat:$(".public_chat"),privateChat:$(".private_chat"),imgBox:$(".add-img")};switch(e){case 0:t.floatBox.hide(),t.header.show(),t.backToLive.data("showBoard",!0).trigger("show");break;case 1:t.header.show(),t.backToLive.data("showBoard",!0).trigger("show"),t.floatBox.show(),t.facePanel.hide();break;case 2:t.header.hide(),t.backToLive.data("showBoard",!1).trigger("show"),t.floatBox.show(),t.facePanel.show();break;case 3:t.header.hide(),t.backToLive.data("showBoard",!1).trigger("show"),t.floatBox.show(),t.facePanel.hide();break;case 4:t.header.hide(),t.backToLive.data("showBoard",!1).trigger("show"),t.floatBox.show(),t.facePanel.hide(),t.privateChat.show(),t.publicChat.hide(),t.imgBox.hide();break;case 5:t.header.hide(),t.backToLive.data("showBoard",!1).trigger("show"),t.floatBox.show(),t.facePanel.hide(),t.privateChat.show(),t.publicChat.hide(),t.imgBox.show();break;case 6:t.backToLive.data("showBoard",!1).trigger("show"),t.floatBox.show(),t.facePanel.show(),t.privateChat.show(),t.publicChat.hide(),t.imgBox.hide()}t.privateChat.is(":hidden")===!1?$(".float-box").addClass("private"):$(".float-box").removeClass("private")}}},video:{initPlayer:!1,playerType:"",videoType:"",studioType:"",liveUrl:"http://ct.phgsa.cn:1935/live/01/playlist.m3u8",$panel:null,backToLivePos:{x:0,y:0},init:function(){navigator.userAgent.match(/Android/i)||-1!=navigator.userAgent.indexOf("iPhone")||-1!=navigator.userAgent.indexOf("iPod")||-1!=navigator.userAgent.indexOf("iPad")?this.playerType="video":this.playerType="sewise";var e=$(".videopart input:first");e.attr("yc"),e.attr("mc");this.$panel=$("#tVideoDiv"),this.$panel.css({"z-index":"inherit"}).height(.55*this.$panel.width()),this.setEvent()},start:function(e){var t=common.getSyllabusPlan(roomJS.syllabusData,roomJS.serverTime);!t||t.isNext||0!=t.courseType&&common.isBlank(t.studioLink)||2==t.courseType||0==t.courseType?e?studioMbPop.showMessage("目前还没有视频直播，详情请留意直播间的课程安排！"):t&&!t.isNext&&0==t.courseType?($(".videopart").hide().css({height:"0"}),roomJS.setHeight()):this.playMp4Vd():this.play("yy","",t.studioLink,"")},playMp4Vd:function(){if($("#studioTeachId a[class=on]").length<=0){var e=$("#videosTab li a"),t=$(e.get(common.randomIndex(e.length)));t.click()}},play:function(e,t,o,i){this.studioType=e;var s=$("#backToLive");if($(".videopart").is(":hidden")&&($(".videopart").show().css({height:"auto"}),roomJS.setHeight()),"studio"==e?s.data("showVideo",!0).trigger("show"):($("#videosTab li a.on").removeClass("on"),s.data("showVideo",!1).trigger("show")),"video"==this.playerType)if(this.initPlayer){var r=this.$panel.find("video");r[0].pause(),r.attr("src",o),r[0].play()}else{var n=$("body").attr("fp"),a="webui"!=n&&"app"!=n;this.$panel.append('<video src="'+o+'" controls="true" autoplay="'+a+'" style="width: 100%; height: 100%; background-color: rgb(0, 0, 0);"></video>'),a||this.$panel.find("video")[0].pause(),this.initPlayer=!0,this.setEventAd()}else if(this.initPlayer)SewisePlayer.toPlay(o,i,0,!0),this.videoType=t;else{var l=[];l.push("/base/lib/sewise.player.min.js?server=vod"),l.push("type="+t),l.push("videourl="+o),l.push("autostart=true"),l.push("logo="),l.push("title="+i),l.push("buffer=5");var u=l.join("&"),c=document.createElement("script");c.type="text/javascript",c.src=u,this.initPlayer=!0,this.videoType=t,this.$panel.get(0).appendChild(c),this.setEventAd()}},setEvent:function(){$(".ctrlblock div.replay a").bind("click",function(){var e=$("#videosTab li a.on");e.trigger("click")}),$(".ctrlblock div.nextbtn a").bind("click",function(){for(var e=$("#videosTab li a"),t=0,o=e.size();o>t;t++)if(e.eq(t).is(".on")){e.eq(o-1>t?t+1:0).trigger("click");break}}),$("#backToLive").css({left:function(){return $(window).width()-$(this).width()-10},top:function(){return $(window).height()-$("#header").height()-70}}).data("showBoard",!0).data("showVideo",!0).bind("show",function(){var e=$(this);e.data("showBoard")&&e.data("showVideo")?e.show():e.hide()});var e=function(e,t){return e=Math.max(e,10),Math.min(e,t-10)};util.toucher($("#backToLive")[0]).on("singleTap",function(){roomJS.socket.emit("serverTime"),window.setTimeout(function(){roomJS.video.start(!0)},1e3)}).on("swipeStart",function(){roomJS.video.backToLivePos.x=parseInt(this.style.left)||0,roomJS.video.backToLivePos.y=parseInt(this.style.top)||0,this.style.transition="none",this.style.background=" rgba(181,144,48,0.8)"}).on("swipe",function(t){return this.style.left=e(roomJS.video.backToLivePos.x+t.moveX,$(window).width()-this.clientWidth)+"px",this.style.top=e(roomJS.video.backToLivePos.y+t.moveY,$(window).height()-this.clientHeight)+"px",!1}).on("swipeEnd",function(){return this.style.background=" rgba(181,144,48,.6)",!1})},setEventAd:function(){if("sewise"==this.playerType){var e=function(){return window.SewisePlayer?(SewisePlayer.onPause(function(){"studio"==roomJS.video.studioType&&window.setTimeout(function(){SewisePlayer.duration()<=SewisePlayer.playTime()&&$(".ctrlblock").show()},1e3)}),void SewisePlayer.onStart(function(){$(".ctrlblock").hide()})):void window.setTimeout(e,500)};e()}else if("video"==this.playerType){var t=this.$panel.find("video");t.bind("ended",function(){"studio"==roomJS.video.studioType&&$(".ctrlblock").show()}).bind("loadstart",function(){$(".ctrlblock").hide()})}}},face:{initFace:!1,init:function(e,t,o,i){this.initFace||(this.build(e,o),new Swiper(e,{pagination:".swiper-pagination",paginationClickable:!0}),e.find("img").bind("click",{panel:e,assign:t,disabled:i},function(e){e.data.disabled||e.data.assign.append($(this).clone()).trigger("input")}),this.initFace=!0)},build:function(e,t){for(var o=[],i=7,s=1;75>=s;s+=21){o.push('<div class="swiper-slide"><table border="0" cellspacing="0" cellpadding="0">');for(var r=s,n=Math.min(s+20,75);n>=r;r++)r%i==1&&o.push("<tr>"),o.push('<td><img src="'+t+r+'.gif"/></td>'),(r%i==0||r==n)&&o.push("</tr>");o.push("</table></div>")}e.find("div.face").html(o.join(""))}},setTalkListScroll:function(){$("#talkPanel").scrollTop($("#talkPanel")[0].scrollHeight)},getUiId:function(){var e=new Date;return e.getTime()+"_ms"},getArticleList:function(e,t,o,i,s,r,n,a){try{var l={code:e,platform:t,hasContent:o,pageNo:i,pageSize:s,orderByStr:r};n&&(l.authorId=common.trim(n)),$.getJSON("/hxstudio/getArticleList",l,function(e){a(e)})}catch(u){console.error("getArticleList->"+u),a(null)}},setTradeArticle:function(){studioMbPop.loadingBlock($("#TradeArticleTab")),roomJS.getArticleList("trade_strategy_article",roomJS.userInfo.groupId,1,1,1,'{"createDate":"desc"}',null,function(e){var t=$("#TradeArticleTab ul:first"),o=[];if(e&&0==e.result){var i=e.data;if(i&&i.length>0)for(var s=null,r=null,n=0,a=i.length;a>n;n++)s=i[n].detailList[0],r=s.authorInfo||{},o.push("<li>"),o.push('<div class="himg"><img src="'+(r.avatar||"")+'"></div>'),o.push('<div class="detail">'),o.push("<h3>"+s.title+"</h3>"),o.push('<div class="subinfo">'),o.push("<span>"+(r.name||"")+"</span>"),o.push("<span>"+(i[n].publishStartDate?common.longMsTimeToDateTime(i[n].publishStartDate):"")+"</span>"),o.push("</div>"),o.push("<p>"+s.content+"</p>"),o.push("</div>")}t.html(o.join("")),$("#TradeArticleTab .detail p span").attr("style",""),studioMbPop.loadingBlock($("#TradeArticleTab"),!0)})},showViewSelect:function(e){var t=$("#dialog_list");"analyst"==e?(t.children("[utype!=2]").hide(),t.children("[utype=2]").show()):"me"==e?(t.children("[isme='false']").hide(),t.children("[isme='true']").show()):t.children().show(),roomJS.setTalkListScroll()},getSendMsg:function(e){
if(e=e||$("#contentText"),e.text().length+e.find("img").size()>140)return studioMbPop.showMessage("消息内容超过最大长度限制（140字以内）！"),!1;var t=e.html();return t=common.clearMsgHtml(t),common.isBlank(t)?(e.html(""),!1):(e.find(".txt_dia").length>0&&(e.find(".txt_dia").remove(),t=e.html(),t=t.replace(/^(&nbsp;){1,2}/,"")),t)},getToUser:function(){var e=$("#contentText .txt_dia");return e.length>0?{userId:e.attr("uid"),nickname:e.find("label").text(),talkStyle:0,userType:e.attr("utype"),avatar:e.attr("avatar")}:null},formatPublishTime:function(e){return common.isBlank(e)?"":common.getHHMM(Number(e.replace(/_.+/g,"")))},setDialog:function(e,t,o,i,s){(roomJS.visitorSpeak||"visitor"!=roomJS.userInfo.clientGroup)&&($("#contentText .txt_dia").remove(),$("#contentText").html($("#contentText").html().replace(/^((&nbsp;)+)/g,"")),$("#contentText").prepend('&nbsp;<span class="txt_dia" contenteditable="false" uid="'+e+'" utype="'+i+'" avatar="'+s+'">@<label>'+t+"</label></span>&nbsp;").focusEnd())},setContent:function(e,t,o){var i=e.fromUser;if(t&&(i.publishTime=e.uiId),e.isVisitor)return void $("#"+e.uiId).remove();if(o&&$("#"+i.publishTime).length>0)return $("#"+i.publishTime+" .dialog em[class=ruleTipStyle]").remove(),void $("#"+i.publishTime+" input").remove();if(e.rule)return void(e.value&&e.value.needApproval?$("#"+e.uiId).attr("id",i.publishTime):$("#"+e.uiId+" .dialog").append('<em class="ruleTipStyle">'+e.value.tip+"</em>"));if(t||roomJS.userInfo.userId!=i.userId||!e.serverSuccess){var s=roomJS.formatContentHtml(e,t,o,!1),r=$("#dialog_list"),n=$("#talkPanel"),a=n.scrollTop()+n.height()+30>=n.get(0).scrollHeight;r.append(s),a&&!o&&roomJS.setTalkListScroll(),this.formatMsgToLink(i.publishTime);var l=$("#talkBoxTab .view_select .selectlist a[class=on]").attr("t");"all"!=l&&roomJS.showViewSelect(l),$("#"+i.publishTime+" .c-menu a").click(function(){var e=$(this).parents(".c-menu");roomJS.setDialog(e.attr("uid"),e.attr("nk"),$(this).attr("t"),e.attr("utype"))}),$("#"+i.publishTime+" .headimg").click(function(){$("#"+i.publishTime+" .c-menu a[t=0]").trigger("click")}),$("#"+i.publishTime+" .txt_dia").click(function(){roomJS.setDialog($(this).attr("uid"),$(this).find("label").text(),0,$(this).attr("utype"))}),$("#"+i.publishTime+" .uname").click(function(){$("#"+i.publishTime+" .c-menu a[t=0]").trigger("click")})}else if($("#"+e.uiId+" .uname span").html(roomJS.formatPublishTime(i.publishTime)),$("#"+e.uiId).attr("id",i.publishTime),e.content.msgType==roomJS.msgType.img){roomJS.removeLoadDom(i.publishTime);var u=$("#"+i.publishTime+' span[contt="a"]>a'),c=e.content.needMax?"/hxstudio/getBigImg?publishTime="+i.publishTime+"&userId="+i.userId:u.children("img").attr("src");u.attr("href",c)}},formatContentHtml:function(e,t,o,i){var s,r="clearfix ",n="",a="false",l="",u=e.fromUser,c=e.content,d=u.nickname,h=u.toUser,p=[],m="";if(roomJS.userInfo.userId==u.userId&&t&&(u.publishTime=e.uiId,m='<em class="img-loading"></em><span class="shadow-box"></span><s class="shadow-conut"></s>'),c.msgType==roomJS.msgType.img){var f=i?"whimg-"+u.userId:"dialog-img";s=c.needMax?'<a href="/hxstudio/getBigImg?publishTime='+u.publishTime+"&userId="+u.userId+'" data-lightbox="'+f+'"><img src="'+c.value+'" alt="图片"/></a>':'<a href="'+c.value+'" data-lightbox="'+f+'"><img src="'+c.value+'" alt="图片" /></a>',s='<span contt="a">'+s+"</span>"+m}else s='<span contt="a">'+c.value+"</span>";h&&common.isValid(h.userId)?(i?p.push(s):common.isValid(h.question)?(p.push('<p class="question"><em>'),p.push('<strong class="asker" uid="'+h.userId+'" utype="'+h.userType+'">'+h.nickname+"</strong>"),p.push("提问：</em>"),p.push('<span contt="q">'+h.question+"</span>"),p.push("</p>"),p.push('<p class="reply"><span>回复：</span>'),p.push(s),p.push("</p>")):(p.push('<span class="txt_dia" uid="'+h.userId+'" utype="'+h.userType+'">'),p.push("@<label>"+h.nickname+"</label>"),p.push("</span>"),p.push(s)),roomJS.userInfo.userId==h.userId&&(a="true")):p.push(s),roomJS.userInfo.userId==u.userId?(r+="me-li",d="我",a="true",i&&h&&(l=" csid="+h.userId)):(3==u.userType?(d+="&nbsp;（助理）",r+="admin"):2==u.userType?r+="analyst":1==u.userType&&(r+="admin"),i&&(l=" csid="+u.userId),n=i?"":roomJS.getDialogHtml(u.userId,d,u.userType),!o&&h&&(roomJS.userInfo.userId!=h.userId||i||($("#top_msg label").html(u.nickname+":@"+h.nickname).attr("tId",h.userId).attr("fuType",u.userType).attr("fnickname",u.nickname).attr("fuserId",u.userId),$("#top_msg span").html(c.value),$("#top_msg").slideDown())));var g=[];return g.push('<li class="'+r+'" id="'+u.publishTime+'" isme="'+a+'" utype="'+u.userType+'" mType="'+c.msgType+'" t="header"'+l+">"),g.push('<div class="headimg" uid="'+u.userId+'">'),g.push(roomJS.getUserAImgCls(u.userId,u.clientGroup,u.userType,u.avatar)),g.push("</div>"),g.push('<div class="detail">'),g.push('<span class="uname">'),roomJS.userInfo.userId==u.userId?(g.push("<span>"+roomJS.formatPublishTime(u.publishTime)+"</span>"),g.push("<strong>"+d+"</strong>")):(g.push("<strong>"+d+"</strong>"),g.push("<span>"+roomJS.formatPublishTime(u.publishTime)+"</span>")),g.push("</span>"),g.push('<div class="dialog">'+p.join("")+"</div>"),g.push("</div>"),g.push(n),g.push("</li>"),g.join("")},formatMsgToLink:function(e){$("#"+e+' span[contt]:contains("http:"),#'+e+' span[contt]:contains("https:")').each(function(e,t){var o,i=$(t).html(),s=i.split(/<img src="\S+">/g);for(var r in s)if(o=s[r],!common.isBlank(o)){var n=o.replace(/(http:\/\/|https:\/\/)((\w|=|\?|\.|\/|\\&|-)+)(:\d+)?(\/|\S)+/g,function(e){return'<a href="'+e+'" target="_blank">'+e+"</a>"});t.innerHTML=t.innerHTML.replace(o,n)}})},removeLoadDom:function(e){$("#"+e+" .img-loading,#"+e+" .img-load-gan,#"+e+" .shadow-box,#"+e+" .shadow-conut").remove()},getUserAImgCls:function(e,t,o,i){var s="";if(common.isValid(i))return'<img src="'+i+'">';if("vip"==t)s="user_v";else{if("active"==t){var r=0;return e&&e.length>0&&(r+=e.charCodeAt(0)+e.charCodeAt(e.length-1)),r=(r+15)%45,'<img src="'+roomJS.filePath+"/upload/pic/header/chat/visitor/"+r+'.png">'}if("notActive"==t)s="user_r";else if("simulate"==t)s="user_d";else if("register"==t)s="user_m";else{if("visitor"==t||-1==o){e=e||"";var r=parseInt(e.substring(e.length-2),10);return isNaN(r)&&(r=100),r=(r+17)%45,'<img src="'+roomJS.filePath+"/upload/pic/header/chat/visitor/"+r+'.png">'}s="user_c"}}return'<img src="/hx/theme1/img/'+s+'.png">'},leaveRoomTip:function(e){if("roomClose"==e)studioMbPop.showMessage("注意：房间已停用，正自动登出..."),"visitor"==roomJS.userInfo.clientGroup?window.setTimeout(function(){studioMbPop.reload()},2e3):window.setTimeout(function(){LoginAuto.setAutoLogin(!1),window.location.href="/hxstudio/logout?platform="+roomJS.fromPlatform},2e3);else if("otherLogin"==e){if("visitor"==roomJS.userInfo.clientGroup)return;roomJS.socket.disconnect(),studioMbPop.popBox("msg",{msg:"注意：您的账号已在其他地方登陆，被踢出！",type:"logout"})}},getDialogHtml:function(e,t,o){if(roomJS.userInfo.userId!=e){var i=!1,s=$("#studioListId a[class~=ing]"),r='<div class="c-menu" style="display:none;" nk="'+t+'" uid="'+e+'" utype="'+o+'">';return r+="<ul>",(roomJS.visitorSpeak||-1==roomJS.userInfo.userId.indexOf("visitor_")&&e&&-1==e.indexOf("visitor_"))&&(r+='<li><a href="javascript:void(0)" t="0"><i></i>@TA</a></li>',i=!0),"true"==s.attr("aw")&&common.containSplitStr(s.attr("awr"),o)&&(r+='<li><a href="javascript:void(0)" t="1"><i></i>私信</a></li>',i=!0),r+="</ul>",i?r+"</div>":""}return""},formatUserToContent:function(e,t,o){var i={userId:e.userId,nickname:e.nickname,avatar:e.avatar,userType:e.userType,groupId:e.groupId,clientGroup:e.clientGroup,publishTime:e.publishTime,toUser:e.toUser,position:e.position};t?(i.toWhUserId=o,roomJS.whTalk.receiveMsg({fromUser:i,content:e.content},!1,!0)):roomJS.setContent({fromUser:i,content:e.content},!1,!0)},talkBoxPush:{initTBP:function(e){this.clear(),roomJS.pushObj.talkPush=e,this.start()},clear:function(){roomJS.pushObj.talkPushInterval&&(window.clearInterval(roomJS.pushObj.talkPushInterval),roomJS.pushObj.talkPushInterval=null);for(var e=roomJS.pushObj.talkPush,t=null,o=0,i=e.length;i>o;o++)t=e[o],t.timeoutId&&window.clearTimeout(t.timeoutId),t.intervalId&&window.clearInterval(t.intervalId)},start:function(){var e=roomJS.pushObj.talkPush;e&&e.length>0&&window.setInterval(function(){roomJS.talkBoxPush.check()},1e4)},check:function(){for(var e=roomJS.pushObj.talkPush,t=null,o=0,i=e.length;i>o;o++)t=e[o],t.startFlag||common.dateTimeWeekCheck(t.pushDate,!1,roomJS.serverTime)&&(t.startFlag=!0,window.setTimeout(roomJS.talkBoxPush.delayStartTask(t),60*(t.onlineMin||0)*1e3))},delayStartTask:function(e){return function(){roomJS.talkBoxPush.showMsg(e),e.intervalMin&&e.intervalMin>0&&(e.intervalId=window.setInterval(roomJS.talkBoxPush.startTask(e),60*e.intervalMin*1e3))}},startTask:function(e){return function(){common.dateTimeWeekCheck(e.pushDate,!1,roomJS.serverTime)?roomJS.talkBoxPush.showMsg(e):(window.clearInterval(e.intervalId),e.startFlag=!1)}},showMsg:function(e){var t=[];t.push('<li class="clearfix push">'),t.push(e.content),t.push("</div>");var o=$("#talkPanel"),i=o.scrollTop()+o.height()+30>=o.get(0).scrollHeight;$("#dialog_list").append(t.join("")),i&&roomJS.setTalkListScroll()}},browserState:{hiddenProperty:"hidden",visibilityStateProperty:"visibilityState",visibilityEvent:"visibilitychange",getBrowserPrefix:function(){if("hidden"in document)return null;for(var e=["moz","ms","o","webkit"],t=0;t<e.length;t++){var o=e[t]+"Hidden";if(o in document)return e[t]}return null},initBrowserState:function(){var e=this.getBrowserPrefix();e?(this.hiddenProperty=e+"Hidden",this.visibilityStateProperty=e+"VisibilityState",this.visibilityEvent=e+"visibilitychange"):(this.hiddenProperty="hidden",this.visibilityStateProperty="visibilityState",this.visibilityEvent="visibilitychange"),this.setBrowserStateEvent()},setBrowserStateEvent:function(){document.addEventListener(this.visibilityEvent,function(){"visible"===document[roomJS.browserState.visibilityStateProperty]&&roomJS.socket.emit("serverTime")})}},whTalk:{enable:!1,status:0,tabCheck:!1,CSMap:{},currCS:null,msgCnt:0,pushObj:null,askMsgObj:null,viewSelect:!1,initWH:function(){this.enable="true"==$("#currStudioInfo").attr("aw"),this.refreshTips(),$("#whTalkBoxTab .view_select").click(function(){var e=$(this);e.is(".dw")?(e.removeClass("dw"),roomJS.whTalk.viewSelect=!1):(e.addClass("dw"),roomJS.whTalk.viewSelect=!0)}).find(".selectlist a").live("click",function(){if(!$(this).is(".on")){var e=$(this).attr("uid");roomJS.whTalk.setCurrCS({userId:e})}})},whSwitch:function(e){e?(this.tabCheck=!0,this.msgCnt=0,this.refreshTips(),this.setWHTalkListScroll(),this.pushMsg()):this.tabCheck=!1},loadMsg:function(e){if(this.CSMap.hasOwnProperty(e)&&!this.CSMap[e].load){var t=this.CSMap[e];t.load=!0,studioMbPop.loadingBlock($("#whTalkBoxTab")),roomJS.socket.emit("getWhMsg",{clientStoreId:roomJS.userInfo.clientStoreId,userType:roomJS.userInfo.userType,groupId:roomJS.userInfo.groupId,groupType:roomJS.userInfo.groupType,userId:roomJS.userInfo.userId,toUser:{userId:t.userNo,userType:t.userType}})}},setCurrCS:function(e){var t=null;if(e&&e.userId)this.CSMap.hasOwnProperty(e.userId)?t=this.CSMap[e.userId]:(t={userNo:e.userId,userName:e.userName||e.nickname,online:!0,load:!1,userType:e.userType,avatar:e.avatar},this.CSMap[e.userId]=t);else{var o=null;for(var i in this.CSMap)o=this.CSMap[i],(!t||3!=t.userType&&3==o.userType||t.userType==o.userType&&!t.online&&o.online)&&(t=o)}if(!t)return null;if(t.load||this.loadMsg(t.userNo),t.userNo){this.currCS=t;var s=$("#whTalkBoxTab .view_select"),r=s.find("a[uid="+this.currCS.userNo+"]");return s.find(".selectlist a").removeClass("on"),0==r.size()?(s.find(".selectlist").append('<a href="javascript:void(0)" class="on" uid="'+this.currCS.userNo+'">'+this.currCS.userName+"</a>"),s.find(".selected").text(this.currCS.userName)):(r.addClass("on"),s.find(".selected").text(r.text())),s.find(".selectlist a").size()<=1?s.hide():(s.show(),$("#whDialog_list").children().hide(),$("#whDialog_list").children("[csid="+this.currCS.userNo+"]").show(),this.setWHTalkListScroll()),t}return null},getCSList:function(){try{$.getJSON("/hxstudio/getCS",{groupId:roomJS.userInfo.groupId},function(e){if(e&&e.length>0)for(var t,o,i=0,s=e.length;s>i;i++)t=e[i],roomJS.whTalk.CSMap.hasOwnProperty(t.userNo)?o=roomJS.whTalk.CSMap[t.userNo]:(o={online:!1},roomJS.whTalk.CSMap[t.userNo]=o),o.userNo=t.userNo,o.userName=t.userName,o.userType=3,o.avatar=common.isValid(t.avatar)?t.avatar:"/hx/theme1/img/cm.png",o.load=!1})}catch(e){console.error("getCSList->"+e)}},setCSOnline:function(e,t){var o=null;this.CSMap.hasOwnProperty(e)?o=this.CSMap[e]:(o={},this.CSMap[e]=o),o.online=t},refreshTips:function(){roomJS.whTalk.msgCnt>0?$(".wh_tips").text(roomJS.whTalk.msgCnt).show():$(".wh_tips").hide()},setWHTalkListScroll:function(){$("#whTalkPanel").scrollTop($("#whTalkPanel")[0].scrollHeight)},receiveMsg:function(e,t,o){var i=e.fromUser;if(t&&(i.publishTime=e.uiId),e.isVisitor)return void $("#"+e.uiId).remove();if(o&&$("#"+i.publishTime).length>0)return $("#"+i.publishTime+" .dialog em.ruleTipStyle").remove(),void $("#"+i.publishTime+" input").remove();if(e.rule)return void(e.value&&e.value.needApproval?$("#"+e.uiId).attr("id",i.publishTime):$("#"+e.uiId+" .dialog").append('<em class="ruleTipStyle">'+e.value.tip+"</em>"));if(t||roomJS.userInfo.userId!=i.userId||!e.serverSuccess){var s=roomJS.formatContentHtml(e,t,o,!0),r=$("#whTalkPanel"),n=r.scrollTop()+r.height()+30>=r.get(0).scrollHeight;if(o?$("#whDialog_list").prepend(s):$("#whDialog_list").append(s),n&&this.tabCheck&&roomJS.whTalk.setWHTalkListScroll(),roomJS.formatMsgToLink(i.publishTime),roomJS.userInfo.userId!=i.userId&&$("#"+i.publishTime+" .uname,#"+i.publishTime+" .headimg").click(function(){var e=$(this).parents("li:first"),t={userId:e.find(".headimg").attr("uid"),nickname:e.find(".uname strong").text(),userType:e.attr("utype"),avatar:e.find(".headimg img").attr("src")};roomJS.whTalk.setCurrCS(t)}),this.tabCheck||o||(roomJS.whTalk.msgCnt++,this.refreshTips()),o||roomJS.userInfo.userId==i.userId||this.setCurrCS(i),o||(this.askMsgObj=null),o&&i.toUser&&common.isValid(i.toUser.question)){var a=this.setCurrCS({userId:i.toUser.userId});this.receiveMsg({content:{maxValue:"",msgType:"text",status:1,value:i.toUser.question},fromUser:{nickname:a.userName,userId:a.userNo,userType:a.userType,avatar:a.avatar,publishTime:i.toUser.publishTime}},!1,!0)}}else if($("#"+e.uiId+" .uname span").html(roomJS.formatPublishTime(i.publishTime)),$("#"+e.uiId).attr("id",i.publishTime),e.content.msgType==roomJS.msgType.img){roomJS.removeLoadDom(i.publishTime);var l=$("#"+i.publishTime+' span[contt="a"]>a'),u=e.content.needMax?"/hxstudio/getBigImg?publishTime="+i.publishTime+"&userId="+i.userId:l.children("img").attr("src");l.attr("href",u)}},pushMsg:function(){this.currCS||this.setCurrCS(),this.pushObj&&this.currCS&&(this.receiveMsg({content:{maxValue:"",msgType:"text",status:1,value:this.pushObj.info},fromUser:{nickname:this.currCS.userName,userId:this.currCS.userNo,userType:this.currCS.userType,avatar:this.currCS.avatar,publishTime:this.pushObj.publishTime}},!1,!1),this.askMsgObj=this.pushObj,this.pushObj=null)},sendWhMsg:function(e){return this.currCS||this.setCurrCS(),this.currCS?(e.fromUser.toUser={userId:this.currCS.userNo,nickname:this.currCS.nickname,talkStyle:1,userType:this.currCS.userType},this.askMsgObj&&(e.fromUser.toUser.question=this.askMsgObj.info,e.fromUser.toUser.questionId=this.askMsgObj.infoId,e.fromUser.toUser.publishTime=this.askMsgObj.publishTime),roomJS.whTalk.receiveMsg(e,!0,!1),void(e.content.msgType!=roomJS.msgType.img&&roomJS.socket.emit("sendMsg",e))):void studioMbPop.showMessage("客服不在线，暂不可私聊！")}}};