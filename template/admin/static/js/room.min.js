var room={filePath:"",apiUrl:"",nwIsMinimize:!1,desktopNotice:null,nwWin:null,roomName:"",nwTray:null,msgType:{text:"text",img:"img",file:"file"},socket:null,socketUrl:"",userInfo:null,rmWin:null,whTipIntervalId:null,tipSoundObj:{key:"tip_sound",storageObj:{turn:"on"}},whHistoryUserObj:{key:"whUsers",whUserList:[]},init:function(){this.setSocket(),this.setVideo(),this.setEvent()},setVideo:function(){try{$.getJSON("/admin/getSyllabus?t="+(new Date).getTime(),{groupType:room.userInfo.groupType,groupId:room.userInfo.groupId},function(t){var e=t.data;if(e&&common.isValid(e.studioLink)){var i=JSON.parse(e.studioLink),o="";for(var s in i)if(1==i[s].code){o=i[s].url;break}if(common.isValid(o)&&0==$("#yyVideoDiv embed").length)if(-1!=o.indexOf("rtmp:")){var r='<div style="position: relative; width: 100%; height: 100%; left: 0px; top: 0px;"><object type="application/x-shockwave-flash" id="sewise_player" name="sewise_player" data="/base/lib/flash/SewisePlayer.swf" width="100%" height="100%"><param name="allowfullscreen" value="true"><param name="wmode" value="transparent"><param name="allowscriptaccess" value="always"><param name="flashvars" value="autoStart=true&amp;programId=&amp;shiftTime=&amp;lang=zh_CN&amp;type=rtmp&amp;serverApi=ServerApi.execute&amp;skin=/base/lib/flash/skins/liveOrange.swf&amp;title=&amp;draggable=true&amp;published=0&amp;streamUrl='+o+'&amp;duration=3600&amp;poster=&amp;flagDatas=&amp;videosJsonUrl=&amp;adsJsonData=&amp;statistics=&amp;customDatas=&amp;playerName=Sewise Player&amp;clarityButton=enable&amp;timeDisplay=disable&amp;controlBarDisplay=enable&amp;topBarDisplay=disable&amp;customStrings=&amp;volume=0.6&amp;key=&amp;trackCallback="></object></div>';$("#yyVideoDiv").html(r)}else $("#yyVideoDiv").html('<embed src="'+o+'" quality="high" width="100%" height="100%" align="middle" allowScriptAccess="never" allowFullScreen="true" mode="transparent" type="application/x-shockwave-flash"></embed>')}})}catch(t){console.error("setVideo has error:"+t)}},setTalkTop:function(t,e){if(t){var i=$("#groupInfoId"),o="true"==i.attr("aw")&&common.containSplitStr(i.attr("awr"),room.userInfo.userType),s=e.fromUser;$(".mymsg").show(),$(".mymsg em").hide(),$(".replybtn").attr("tm",s.publishTime).attr("uid",s.userId).attr("ts",s.talkStyle).attr("utype",s.userType),$(".sender").html(s.nickname);var r=e.content.value;e.content.msgType==room.msgType.img&&(r='<img src="'+e.content.value+'" />'),$(".xcont").html(r),$("#talk_top_id").prepend('<section class="ss-tk-info clearfix" tm="'+s.publishTime+'"><label><strong>'+s.nickname+'</strong>：</label><span style="margin-left:5px;text-align:justify;">'+r+'</span><button type="button">关闭</button><button type="button" uid="'+s.userId+'" utype="'+s.userType+'" '+(o?"":'style="display:none;"')+'" cg="'+s.clientGroup+'" nk="'+s.nickname+'" iswh="true">私聊</button><button type="button" uid="'+s.userId+'" utype="'+s.userType+'">回复</button></section>');var a=$("#talk_top_id .ss-tk-info[tm="+s.publishTime+"]");a.find("button").click(function(){var t=$(this).parents(".ss-tk-info"),e=$(this).attr("uid"),i=$(this).attr("iswh"),o=t.attr("tm");if(common.isValid(e)&&common.isBlank(i)){var s=$(this);room.setDialog(null,e,t.find("strong").addClass("reply-st").html(),s.attr("ts"),s.attr("utype"),o,s.siblings("span").html())}else common.isValid(i)&&i?room.setDialog($(this).attr("cg"),e,$(this).attr("nk"),"1",$(this).attr("utype"),o,""):(t.remove(),$("#show_top_btn strong,#top_num").text("【"+$("#talk_top_id .ss-tk-info").length+"】"),$(".mymsg .replybtn[tm="+o+"]").parent().hide(),$("#contentText .txt_dia[tm="+o+"]").length>0&&$("#contentText").html(""))})}else e.publishTime&&($("#talk_top_id .ss-tk-info[tm="+e.publishTime+"]").remove(),$(".mymsg .replybtn[tm="+e.publishTime+"]").parent().hide());$("#show_top_btn strong,#top_num").text("【"+$("#talk_top_id .ss-tk-info").length+"】")},getUiId:function(){var t=new Date;return t.getTime()+"_ms"},getVisitorList:function(t){if(!common.isBlank(t))try{$(".searchResult").hide(),$(".searchResult ul").html(""),$.getJSON("/admin/getVistiorByName",{groupType:room.userInfo.groupType,groupId:room.userInfo.groupId,nickname:t},function(t){if(t){$(".searchResult").show();var e=0,i="";for(var o in t)i=t[o].userId||t[o].visitorId,$(".searchResult ul li[uid="+i+"]").length>0||(e=t[o].onlineStatus,$(".searchResult ul").append('<li uid="'+i+'" cg="'+t[o].clientGroup+'"  '+(1==e?"":'class="off"')+"><label>"+t[o].nickname+"</label></li>"));$(".searchResult ul li").click(function(){$(".searchResult").hide();var t=$(this).attr("uid");room.setWhVisitors(-1!=t.indexOf("visitor_")?-1:0,$(this).attr("cg"),t,$(this).find("label").text(),!$(this).hasClass("off")),$(".visitorDiv .wh_tab_ul li[uid="+$(this).attr("uid")+"]").click()})}})}catch(e){alert("查询异常,请联系管理员！"),console.error("getVistiorByName->"+e)}},getWhToUser:function(){var t=$(".visitorDiv .wh_tab_ul li[class~=on]");return{userId:t.attr("uid"),nickname:t.find("label").text(),talkStyle:1,userType:t.attr("utype")}},sendWhMsg:function(t){var e=room.getWhToUser(),i={uiId:room.getUiId(),fromUser:room.userInfo,content:{}};i.fromUser.toUser=e;var o=t.find(".text-min-img img");if(o.size()>0){var s=o.attr("src");s.length>1048576?alert("发送的图片大小不要超过1MB."):(room.setUploadImg(s,e),o.remove())}var r=room.getSendMsg(t);return r===!1?(i.content={msgType:room.msgType.msg,value:""},room.setWhHistory(i),t.html(""),!1):(i.content={msgType:room.msgType.text,value:r},room.socket.emit("sendMsg",i),room.setWhHistory(i),room.setWhContent(i,!0,!1),void t.html(""))},setWhOnlineTip:function(t,e,i){if(e){if(i){var o="";"-1"==i.userType&&common.isValid(i.loginId)?(o=$(".visitorDiv ul li[uid="+i.loginId+"]"),o.length>0&&(o.attr("uid",i.userId),o.find(".wrtip").text(""),$("#wh_msg_"+i.loginId).attr("id","wh_msg_"+i.userId))):"0"==i.userType&&common.isValid(i.visitorId)&&(o=$(".visitorDiv ul li[uid="+i.visitorId+"]"),o.find(".wrtip").text(room.getWhUserCGTip(i.userType,i.clientGroup)),o.length>0&&(o.attr("uid",i.userId),$("#wh_msg_"+i.visitorId).attr("id","wh_msg_"+i.userId)));var s=$("#wh_msg_"+t+" .wh-title label").text(),r=$("#wh_msg_"+t+" .wh-title .title-tip");common.isValid(s)&&s!=i.nickname?r.text("账号转变:"+s+" --> "+i.nickname).show():r.text("").hide(),$(".visitorDiv ul li[uid="+t+"] label,#wh_msg_"+t+" .wh-title label").text(i.nickname)}$(".visitorDiv ul li[uid="+t+"]").removeClass("off"),$("#wh_msg_"+t+" .wh-title strong").text("在线")}else $(".visitorDiv ul li[uid="+t+"]").addClass("off"),$("#wh_msg_"+t+" .wh-title strong").text("离线")},getWhUserCGTip:function(t,e){return 0==t?"active"==e?"真实A":"notActive"==e?"真实N":"simulate"==e?"模拟":"register"==e?"注册":"":1==t?"管理员":2==t?"分析师":3==t?"客服":""},setWhVisitors:function(t,e,i,o,s,r){if(0==$(".visitorDiv .wh_tab_ul li[uid="+i+"]").length){var a=$("#userListId li[id='"+i+"']").attr("ismb");$(".visitorDiv .wh_tab_ul").append('<li uid="'+i+'"  '+(s?"":'class="off"')+' utype="'+t+'"><span  class="user-row"><label>'+o+'</label><em class="close ym" t="0"></em><em class="mb">'+("true"==a?"(mb)":"")+'</em><em class="wrtip">'+room.getWhUserCGTip(t,e)+"</em></span></li>"),room.setListScroll($(".visitorDiv .wh_tab_div"),{scrollbarPosition:"outside"});var n=$(".visitorDiv .wh_tab_ul li[uid="+i+"]");if(r){var l=n.find(".close"),m=parseInt(l.attr("t"))+1;l.attr("t",m).text(m).addClass("ym")}n.find(".close").click(function(){var t=$(this).parent().parent(),e=t.hasClass("on");t.remove(),$("#wh_msg_"+t.attr("uid")).remove();var i=$(".visitorDiv .wh_tab_ul li");e&&i.length>0&&i.eq(0).click(),0==i.length&&$(".visitorDiv .pub_tab_ul li").click()}),n.click(function(){$(".wh_msg_only").show(),$(".open_wh_box").is(":hidden")?($("#wh_msg_public,.right-teacher").addClass("dn"),$(".visitorDiv ul li").removeClass("on")):$(".visitorDiv .wh_tab_ul li").removeClass("on"),$(".wh_msg_only").children().addClass("dn"),$(this).addClass("on"),$(this).find(".close").attr("t",0).text("").removeClass("ym");var t=$(this).attr("uid"),e="wh_msg_"+t,i=$(this).attr("utype");if(0==$("#"+e).length){var o='<div id="'+e+'" class="wh-tab-msg" wid="newMsgShowBtn"><div class="wh-title"><span><label>'+$(this).find("label").text()+'</label>【<strong></strong>】</span><span class="title-tip"></span></div><div class="wh-content"></div><div class="wh-txt"><div class="toolbar"><a href="javascript:" class="facebtn">表情</a><label for="file_'+e+'" class="send-wh-img" title="发送图片"></label><input type="file" id="file_'+e+'" style="position:absolute;clip:rect(0 0 0 0);" class="fileBtn"/></div><div contenteditable="true" class="ctextarea" id="whTxt_'+t+'" data-placeholder="按回车键发送"></div></div></div>';$(".wh_msg_only").append(o),$("#"+e).find(".ctextarea").pastableTextarea().on("pasteImage",function(t,e){var i=$(this).find(".text-min-img");i.length>0?(i.attr("href",e.dataURL),i.find("img").attr("src",e.dataURL)):($(this).append('<a class="text-min-img" href="'+e.dataURL+'" data-lightbox="whSend-img"><img src="'+e.dataURL+'"/></a>'),$(this).focusEnd())}).keydown(function(t){return 13==t.keyCode?(room.sendWhMsg($(this)),!1):void 0}),$("#"+e).find(".facebtn").qqFace({id:"faceId_"+t,zIndex:1e6,assign:"whTxt_"+t,path:room.filePath+"/face/"}),$("#"+e).find(".fileBtn")[0].addEventListener("change",function(){var t=this,e=t.files[0];if(!e)return!1;if(0!=e.type.indexOf("image")||!e.type||!/\.(?:jpg|png|gif)$/.test(e.name.toLowerCase()))return alert("目前暂支持jpg,gif,png格式的图片！"),!1;var i=e.size;if(i>=5242880)return alert("发送的图片大小不要超过5MB."),!1;var o=new FileReader;o.readAsDataURL(e),o.onload=function(t){room.setUploadImg(t.target.result,room.getWhToUser())},o.onprogress=function(t){},o.onloadend=function(t){},$(this).val("")},!1),room.socket.emit("getWhMsg",{userType:room.userInfo.userType,groupId:room.userInfo.groupId,groupType:room.userInfo.groupType,userId:room.userInfo.userId,toUser:{userId:t,userType:i}})}else $("#"+e).removeClass("dn"),room.setTalkListScroll(!0,$("#"+e+" .wh-content"),"dark");room.widthCheck(),room.heightCalcu(),room.setWhOnlineTip(t,!$(this).hasClass("off"))})}},getWhBox:function(t){return $(".wh-middle #wh_msg_"+t)},setWhTipImgPlay:function(t){$("#userListId li[id="+t+"]").attr("k",1),room.whTipIntervalId=setInterval(function(){$("#userListId li[k=1]").toggleClass("have_op")},1e3)},closeWhTipMsg:function(t){$("#userListId li[id="+t+"]").attr("k",0).removeClass("have_op"),0==$("#userListId[k=1]").length&&room.whTipIntervalId&&clearInterval(room.whTipIntervalId)},fillWhBox:function(t,e,i,o,s,r){var a=$(".visitorDiv .wh_tab_ul li[uid="+i+"]"),n=this.getWhBox(i);if(0==n.length&&0==a.length)return room.setWhVisitors(t,e,i,o,!0,r),!1;if(0==a.length)return room.setWhVisitors(t,e,i,o,!0,r),!1;if(r&&!a.hasClass("on")){var l=a.find(".close"),m=parseInt(l.attr("t"))+1;return l.attr("t",m).text(m).addClass("ym"),!0}return!0},setWhContent:function(t,e,i){var o=t.fromUser,s="dialog whcontent ",r=t.content,a="",n="",l="";if(t.rule)return void $("#"+t.uiId+' span[contt="a"]').append('<em class="ruleTipStyle">'+t.value.tip+"</em>");if(i||(o.toWhUserId=o.userId),room.userInfo.userId==o.userId){if(e&&(o.publishTime=t.uiId,o.toWhUserId=o.toUser.userId,l='<em class="img-loading"></em>',n='<span class="shadow-box"></span><s class="shadow-conut"></s>'),t.serverSuccess){if($("#"+t.uiId+" .dtime").html(room.formatPublishTime(o.publishTime)),$("#"+t.uiId).attr("id",o.publishTime),t.content.msgType==room.msgType.img){room.removeLoadDom(o.publishTime);var m=$("#"+o.publishTime+" p"),u=t.content.needMax?"/admin/getBigImg?publishTime="+o.publishTime+"&userId="+o.userId:m.find("a img").attr("src");m.find("a[class=swipebox]").attr("href",u)}return}s+="mine",a='<span class="wh-dia-title"><label class="dtime">'+room.formatPublishTime(o.publishTime,i,"/")+'</label><label class="wh-nk">我</label></span>'}else{if(!i){room.tipSound(),room.setWhHistory(t);var d=this.fillWhBox(o.userType,o.clientGroup,o.userId,o.nickname,!0,!0);if(0==$(".visitorDiv .wh_tab_ul li[uid="+o.toWhUserId+"]").length&&$(".visitorDiv .wh_tab_ul").append($(".visitorDiv ul li[uid="+o.toWhUserId+"]")),!d)return}a='<span class="wh-dia-title"><label class="wh-nk">'+o.nickname+'</label><label class="dtime">'+room.formatPublishTime(o.publishTime,i,"/")+"</label></span>"}if(common.isBlank(o.toWhUserId))return void console.error("setWhContent->fromUser toWhUserId is null,please check!");var c="",p=$("#wh_msg_"+o.toWhUserId+" .wh-content"),h=p.find(".mCSB_container"),g="";r.msgType==room.msgType.img?(c=r.needMax?'<p><a href="/admin/getBigImg?publishTime='+o.publishTime+"&userId="+o.userId+'" class="swipebox"  data-lightbox="dialog-img"><img src="'+r.value+'" alt="图片"/></a>'+n+"</p>":'<p><a href="'+r.value+'" class="swipebox"  data-lightbox="dialog-img"><img src="'+r.value+'" alt="图片" /></a>'+n+"</p>",c+=l):(!e&&common.isValid(o.toUser.question)&&(g='<div class="dialog mine whcontent"><div><span class="wh-dia-title"><label class="dtime">'+room.formatPublishTime(o.toUser.publishTime,i,"/")+'</label><label class="wh-nk">我</label></span></div><div class="whblt">'+o.toUser.question+"</div></div>",h.length>0?h.append(g):p.append(g)),c='<p><span class="dcont" contt="a">'+r.value+"</span></p>"),g='<div class="'+s+'" id="'+o.publishTime+'" utype="'+o.userType+'" mType="'+r.msgType+'" t="header"><div style="margin-bottom:3px;">'+a+"</div>"+c+"</div>",h.length>0?h.append(g):p.append(g),this.formatMsgToLink(o.publishTime),i||room.setTalkListScroll(!0,p,"dark")},clearPasteImg:function(){$(".paste-img").is(":hidden")||$(".paste-img").hide().find("img").attr("src","").attr("h",120).attr("w",100)},setUploadImg:function(t,e){var i=e&&1==e.talkStyle,o=room.getUiId(),s={};common.copyObject(s,room.userInfo,!0),s.toUser=e;var r={uiId:o,fromUser:s,content:{msgType:room.msgType.img,value:"",needMax:0,maxValue:""}};i?(room.setWhHistory(r),room.setWhContent(r,!0,!1)):room.setContent(r,!0,!1),r.content.value=t,room.zipImg(r,100,60,function(t,e){if(t.error)return alert(t.error),$("#"+o).remove(),!1;var s=null;s=i?$("#"+t.uiId+" p .swipebox img"):$("#"+t.uiId+" span[contt=a] a[class=min_img] img"),s.attr("src",e).attr("needMax",t.content.needMax),room.dataUpload(t)})},zipImg:function(t,e,i,o){var s=new Image;s.onload=function(){var r=document.createElement("canvas");r||o({error:"发送图片功能目前只支持Chrome、Firefox、IE10或以上版本的浏览器！"});var a=s.width,n=s.height;if(n>=9*a)return o({error:"该图片高度太高，暂不支持发送！"}),!1;e>0&&(n>e||a>e)&&(t.content.needMax=1,n>e&&e>=a?(a=e/n*a,n=e):(n=e/a*n,a=e),s.height=n,s.width=a);var l=r.getContext("2d");r.width=a,r.height=n,l.clearRect(0,0,r.width,r.height),l.drawImage(s,0,0,a,n),o(t,r.toDataURL("image/jpeg",i/100))},s.src=t.content.value},dataUpload:function(t){var e=new XMLHttpRequest;e.open("POST","/admin/uploadData"),e.addEventListener("progress",function(e){if(e.lengthComputable){var i=(e.loaded/e.total*100|0)+"%";$("#"+t.uiId+" .shadow-box").css({height:"'+ra+'"}),$("#"+t.uiId+" .shadow-conut").html(i)}},!1),e.setRequestHeader("Content-Type","application/json; charset=utf-8"),e.onreadystatechange=function(){4===e.readyState&&200===e.status&&console.log("dataUpload success!")},t.fromUser.socketId=room.socket.id,e.send(JSON.stringify(t))},setEvent:function(){$(".openWhBoxBtn").click(function(){var t=$(".wh_out_div .wh_tab_ul li.on").attr("uid");$(".open_wh_box").is(":hidden")?($(this).hide(),$(".pub_tab_ul li").click(),$(".open_wh_box .visitorDiv").append($(".wh_out_div")),$(".open_wh_box .wh-middle").append($(".wh_msg_only")),$(".open_wh_box,.wh_msg_only").show(),$(".wh-history").css("float","right")):($(".local_box .visitorDiv").append($(".wh_out_div")),$(".local_box .wh-middle").append($(".wh_msg_only")),$(".open_wh_box").hide(),$(".local_box .openWhBoxBtn").show(),$(".wh-history").css("float","left")),room.widthCheck(),room.heightCalcu(),common.isValid(t)?$(".wh_out_div .wh_tab_ul li[uid="+t+"]").click():$(".wh_out_div .wh_tab_ul li:first").click()}),$(".open_wh_box").draggable({handle:".box_title",cursor:"move",containment:"document",scroll:!1}).resizable({minWidth:550,minHeight:450,maxWidth:1600,maxHeight:900}),$(".open_wh_box").resize(function(t){room.widthCheck(),room.heightCalcu()});var t=$("#groupInfoId"),e=t.attr("awr"),i=t.attr("aw");if("true"==i&&common.containSplitStr(e,room.userInfo.userType)&&$(".wh_out_div").removeClass("dn"),$(".pub_tab_ul li").click(function(){$(".open_wh_box").is(":hidden")&&($(".visitorDiv li").removeClass("on"),$(".wh_msg_only").hide()),$(this).addClass("on"),$("#wh_msg_public,.right-teacher").removeClass("dn"),room.widthCheck(),room.setTalkListScroll(!0)}),$("#publish_point").click(function(){$("#userListId li").removeClass("zin"),$(".point-list").addClass("dn"),$(".right-teacher .publish-point").removeClass("dn"),$(".point-list .point-list-content ul li .cancel-btn").click()}),$(".right-teacher .publish-point .publish-close,.right-teacher .point-list .point-close").click(function(){$(".right-teacher .publish-point,.right-teacher .point-list").addClass("dn"),$(".point-list .point-list-content ul li .cancel-btn").click()}),$(".publish-point .publish-btn").click(function(){$(this).attr("disabled","disabled"),room.publishViewPoint()}),$("#point_list").click(function(){$("#userListId li").removeClass("zin"),$(".right-teacher .publish-point").addClass("dn"),$(".point-list").removeClass("dn"),room.getArticleList("trade_strategy_article",room.userInfo.groupId,1,1,20,'{"createDate":"desc"}',room.userInfo.userId,function(t){var e=t.data.length,i="";if($(".point-list .point-list-content ul").html(""),t&&0==t.result&&t.data&&e>0){var o="",s=room.formatHtml("point-list");$.each(t.data,function(t,r){var a=r.detailList[0];t+1==e&&(i=' class="last"'),o+=s.formatStr(i,r._id,a.title,common.formatterDateTime(r.publishStartDate),common.formatterDateTime(r.publishEndDate),a.content)}),$(".point-list .point-list-content ul").html(o),room.teacherPointEdit(".point-list .point-list-content ul li .edit-btn",".point-list .point-list-content ul li .save-btn",".point-list .point-list-content ul li .cancel-btn"),room.setListScroll(".point-list .point-list-content",{scrollbarPosition:"outside"})}})}),$(".clearbtn").click(function(){$("#dialog_list").html(""),room.setTalkListScroll()}),$(".scrollbtn").click(function(){$(this).hasClass("on")?$(this).removeClass("on"):($(this).addClass("on"),room.setTalkListScroll(!0))}),$("#approveAllHandler button").click(function(){var t=[],e=[];return $("#dialog_list .approve input:checked").each(function(){var i=$(this).parents("div");t.push(i.attr("id"));for(var o=i.attr("fuId"),s=!1,r=0,a=e.length;a>r;r++)if(o===e[r]){s=!0;break}s||e.push(o)}),0==t.length?(alert("请选择聊天记录！"),!1):void room.socket.emit("approvalMsg",{fromUser:room.userInfo,status:$(this).attr("btnType"),publishTimeArr:t,fuIdArr:e})}),$("#approveCheckAll").click(function(){var t=$(this).prop("checked");$("#dialog_list .approve input[type=checkbox]").each(function(){$(this).prop("checked",t)})}),$("#close-top-box").click(function(){$(".top-box").addClass("dn")}),$("#show_top_btn").click(function(){$(".top-box").toggleClass("dn")}),$(document).click(function(t){$("div[id^=faceId]").hide(),$(t.target).hasClass("headimg")||$(t.target).parent().hasClass("headimg")||"header"==$(t.target).parent().attr("t")||$(t.target).hasClass("uname")||$(".dialogbtn").hide(),$(t.target).hasClass("searchResult")||$(".searchResult").hide()}),$(".facebtn").qqFace({id:"faceId",assign:"whTxt",path:room.filePath+"/face/"}),$(".replybtn").click(function(){room.setDialog(null,$(this).attr("uid"),$(".sender").html(),$(this).attr("ts"),$(this).attr("utype"),$(this).attr("tm"),$(this).parent().find(".xcont").html()),$(".mymsg em").show()}),$(".closebtn").click(function(){$(".mymsg,.mymsg em").hide()}),$("#vSearchTxt").keydown(function(t){13==t.keyCode&&room.getVisitorList(this.value)}),$("#vSearchTxtBtn").click(function(){room.getVisitorList($("#vSearchTxt").val())}),$("#wh_msg_public").find(".fileBtn")[0].addEventListener("change",function(){var t=this,e=t.files[0];if(!e)return!1;if(0!=e.type.indexOf("image")||!e.type||!/\.(?:jpg|png|gif)$/.test(e.name.toLowerCase()))return alert("目前暂支持jpg,gif,png格式的图片！"),!1;var i=e.size;if(i>=5242880)return alert("发送的图片大小不要超过5MB."),!1;var o=new FileReader;o.readAsDataURL(e),o.onload=function(t){room.setUploadImg(t.target.result,null)},o.onprogress=function(t){},o.onloadend=function(t){},$(this).val("")},!1),$("#wh_msg_public #whTxt").pastableTextarea().on("pasteImage",function(t,e){var i=$(this).find(".text-min-img");i.length>0?(i.attr("href",e.dataURL),i.find("img").attr("src",e.dataURL)):($(this).append('<a class="text-min-img" href="'+e.dataURL+'" data-lightbox="send-img"><img src="'+e.dataURL+'"/></a>'),$(this).focusEnd())}).keydown(function(t){var e=$(this).html();if(13==t.keyCode){if($(this).html(e.replace(/<div>|<\/div>/g,"")),$(".ui-autocomplete").is(":hidden")){var i=room.getToUser(),o=$("#wh_msg_public #whTxt .text-min-img img");if(o.size()>0){var s=o.attr("src");s.length>1048576?alert("发送的图片大小不要超过1MB."):(room.setUploadImg(s,i),o.remove())}var r=room.getSendMsg();if(r===!1)return $("#whTxt").html(""),!1;var a={uiId:room.getUiId(),fromUser:room.userInfo,content:{msgType:room.msgType.text,value:r}},n=$(".replybtn");i&&i.userId==n.attr("uid")&&0==i.talkStyle&&$(".mymsg,.mymsg em").hide(),a.fromUser.toUser=i,room.socket.emit("sendMsg",a),room.setContent(a,!0,!1),$("#whTxt").html("")}return!1}if(8==t.keyCode){var l=$(this).find(".txt_dia");if($.trim($(this).text())==l.text())return l.remove(),$(this).html(""),!0}}).autocomplete({source:function(t,e){/^@.*$/g.test(t.term)&&e(room.searchUserList(t.term.substring(1,t.term.length)))},delay:500,minLength:2,position:{my:"left bottom",at:"left top"},select:function(t,e){return $("#whTxt").html("").append('<span class="txt_dia" contenteditable="false" uid="'+e.item.value+'" utype="'+e.item.userType+'">@<label>'+e.item.label+"</label></span>&nbsp;").focusEnd(),!1}}).autocomplete("instance")._renderItem=function(t,e){return $("<li>").append("<a>"+e.label+"</a>").appendTo(t)},$(".right-teacher .teacher .open-video").click(function(){$(".video").removeClass("dn")}),$(".video .video-close").click(function(){$(".video").addClass("dn")}),$(".video").draggable({handle:".close-title"}).resizable({minWidth:450,minHeight:420,maxWidth:1024,maxHeight:900}),$(".video").resize(function(t){$(this).find(".mod_video").height($(this).height()-40)}),$(".not-talk .talk-title .talk-close,#btnCantTalkCancel").click(function(){$(".not-talk").addClass("dn")}),$("#btnCantTalk").click(function(){var t=room.getUserGagData();room.setUserGag(t.set,t.visitor)}),!store.enabled)return void console.log("Local storage is not supported by your browser.");if(room.tipSoundObj.storageObj=store.get(room.tipSoundObj.key),common.isBlank(room.tipSoundObj.storageObj)){var o={turn:"on"};store.set(room.tipSoundObj.key,o)}else"on"==room.tipSoundObj.storageObj.turn?$(".wh_out_div .tip-sound").removeClass("off"):$(".wh_out_div .tip-sound").addClass("off");$(".wh_out_div .tip-sound").click(function(){var t=room.tipSoundObj.storageObj=store.get(room.tipSoundObj.key),e={};common.isBlank(t)?e.turn="on":e=t,$(this).hasClass("off")?($(this).removeClass("off"),e.turn="on"):($(this).addClass("off"),e.turn="off"),store.set(room.tipSoundObj.key,e)}),$(".rightTitle a").click(function(){$(".onlineSearch").hasClass("dn")?$(".onlineSearch").removeClass("dn"):($(".onlineSearch").addClass("dn"),$("#userListId li").show(),$("#onlineSearchTxt").val("")),room.heightCalcu(),room.setListScroll(".user_box")}),$("#onlineSearchTxt").keydown(function(t){13==t.keyCode&&room.searchUser($(this).val())}),$("#onlineSearchTxtBtn").click(function(){room.searchUser($("#onlineSearchTxt").val())}),room.articleNote.setArticleNoteEvent(),$(".wh-history").click(function(){room.fillWhHistory(),$(".wh_tab_history_div").removeClass("dn")}),$("#wh_close").click(function(){return $(".wh_tab_history_div").addClass("dn"),!1})},articleNote:{articleEditor:null,setArticleNoteEvent:function(){var t=$("#publish_note");0!=t.size&&($("#publish_note_content").append('<script id="article_note_editor" name="content" type="text/plain" style="width:auto;height:auto;"></script>'),this.articleEditor=UE.getEditor("article_note_editor",{serverUrl:room.apiUrl+"/upload/editorUpload",customDomain:!0,initialFrameWidth:"100%",initialFrameHeight:"200"}),$("#publish_note").click(function(){$("#userListId li").removeClass("zin"),room.articleNote.articleEditor.execCommand("cleardoc"),$(".right-teacher .publish-note").show()}),$(".right-teacher .publish-note .publish-close").click(function(){$(".right-teacher .publish-note").hide()}),$(".publish-note .publish-btn").click(function(){$(this).prop("disabled",!0),room.articleNote.saveArticleNote()}))},saveArticleNote:function(){var t=this.articleEditor.getContent();if(!t)return room.showTipBox("笔记内容为空！"),void $(".publish-note .publish-btn").prop("disabled",!1);var e=room.apiUrl+"/common/getCourse?flag=S&groupType="+room.userInfo.groupType+"&groupId="+room.userInfo.groupId;$.getJSON(e,function(e){if(e&&"0"==e.result&&e.data&&e.data.length>0&&!e.data[0].isNext){var i=e.data[0],o=common.formatterDate(i.date,"-"),s={template:"note",category:"class_note",platform:room.userInfo.groupId,publishStartDate:o+" "+i.startTime+":00",publishEndDate:o+" "+i.endTime+":00",mediaUrl:"",mediaImgUrl:"",linkUrl:"",detailList:[{lang:"zh",title:i.title,content:t,authorInfo:{userId:i.lecturerId,name:i.lecturer,avatar:i.avatar,position:""}}]};common.getJson("/admin/addArticle",{data:JSON.stringify(s),isNotice:"Y"},function(t){t.isOK?t.id?(room.showTipBox("发布课堂笔记成功！"),$(".right-teacher .publish-note .publish-close").click()):room.showTipBox("发布课堂笔记失败！"):room.showTipBox(t.msg),$(".publish-note .publish-btn").prop("disabled",!1)})}else room.showTipBox("未找到相应课程信息！"),$(".publish-note .publish-btn").prop("disabled",!1)})}},searchUserList:function(t){var e=$("#userListId li[t!=14][t!=0]").map(function(){var e=$(this).find(".uname").text();return-1!=e.indexOf(t)?{value:this.id,label:e,userType:$(this).attr("utype")}:null}).get();return e},getSendMsg:function(t){var t=t?t:$("#whTxt"),e=t.find(".txt_dia");t.find(".txt_dia").length>0&&(room.setTalkTop(!1,{publishTime:e.attr("tm")}),t.find(".txt_dia").remove());var i=common.clearMsgHtml(t.html());return common.isBlank(i)?(t.html(""),!1):i},setListScroll:function(t,e){$(t).hasClass("mCustomScrollbar")?$(t).mCustomScrollbar("update"):(e=$.extend({scrollButtons:{enable:!0},theme:"dark"},e),$(t).mCustomScrollbar(e))},setTalkListScroll:function(t,e,i){var o=e?e:$("#chatMsgContentDiv");o.hasClass("mCustomScrollbar")?(o.mCustomScrollbar("update"),t&&o.mCustomScrollbar("scrollTo","bottom")):(o.mCustomScrollbar({scrollInertia:1,scrollButtons:{enable:!0},theme:i?i:"light-2"}),o.mCustomScrollbar("scrollTo","bottom"))},getToUser:function(){var t=$("#whTxt .txt_dia");if(t.length>0){var e={userId:t.attr("uid"),nickname:t.find("label").text(),talkStyle:0,userType:t.attr("utype")},i=t.find("input");return i.length>0&&(e.question=i.val()),e}return null},formatPublishTime:function(t,e,i){var o=Number(t.replace(/_.+/g,""));return common.isBlank(t)?"":e?common.formatterDateTime(o,i):common.getHHMM(o)},setDialog:function(t,e,i,o,s,r,a){if(1==o)room.fillWhBox(s,t,e,i,!1),room.getWhBox(e).removeClass("dn"),$(".visitorDiv ul li[uid="+e+"]").click();else if(3==o)if($(".not-talk .talk-title span").text("设置禁言【用户："+i+"；房间："+$("title").text()+"】"),$("#userGagForm input[name='utype']").val(s),$("#userGagForm input[name='memberId']").val(e),$("#userGagForm input[name='groupId']").val(room.userInfo.groupId),$("#userGagForm input[name='groupType']").val(room.userInfo.groupType),0==s)room.initGagDate(),$(".not-talk").removeClass("dn");else{$("#userGagForm input[name='memberId']").val(i);var n=room.getUserGagData();n.set.type="visitor_filter",$(".not-talk").addClass("dn"),room.setUserGag(n.set,n.visitor)}else{$("#whTxt .txt_dia").remove(),$("#whTxt").html($("#whTxt").html().replace(/^((&nbsp;)+)/g,""));var l="";if(a){l='<input type="hidden" value="">';var m=$("<div>"+a+"</div>");m.find(".txt_dia").remove(),a=m.html()}var u=$('<span class="txt_dia" contenteditable="false" uid="'+e+'" tm="'+r+'" utype="'+s+'">'+l+"@<label>"+i+"</label></span>");u.find("input").val(a),$("#whTxt").prepend("&nbsp;").prepend(u).focusEnd(),$("#talk_top_id .ss-tk-info[tm="+r+"]").find("strong").addClass("reply-st")}},setContent:function(t,e,i){var o=t.fromUser;t.content;if(e&&(o.publishTime=t.uiId),i&&$("#"+o.publishTime).length>0)return $("#"+o.publishTime+" span[contt] em[class=ruleTipStyle]").remove(),void $("#"+o.publishTime+" .approve").remove();if(t.rule)return void(t.value&&t.value.needApproval?$("#"+t.uiId).attr("id",o.publishTime):$("#"+t.uiId+' span[contt="a"]').append('<em class="ruleTipStyle">'+t.value.tip+"</em>"));if(!e&&room.userInfo.userId==o.userId&&t.serverSuccess){if($("#"+t.uiId+" .dtime").html(room.formatPublishTime(o.publishTime)),$("#"+t.uiId).attr("id",o.publishTime),t.content.msgType==room.msgType.img){room.removeLoadDom(o.publishTime);var s=$("#"+o.publishTime+" span[contt=a] a[class=min_img]"),r=t.content.needMax?"/admin/getBigImg?publishTime="+o.publishTime+"&userId="+o.userId:s.children("img").attr("src");s.attr("href",r)}return void this.removeTalkMsg(o.publishTime)}var a=room.formatContentHtml(t,e,i),n=$("#dialog_list");n.append(a),this.formatMsgToLink(o.publishTime);$(".view_select .selectlist a[class=on]").attr("t");!i&&$(".scrollbtn").hasClass("on")&&room.setTalkListScroll(!0),$("#"+o.publishTime+" .headimg").click(function(){var t=$(this).parent(),e=t.find(".dialogbtn");e.attr("tm",t.attr("id")),room.openDiaLog(e)}),$("#"+o.publishTime+" .uname").click(function(){var t=$(this).parent().parent(),e=t.find(".dialogbtn");e.attr("tm",t.attr("id")),room.openDiaLog(e),e.css("left","62px")}),$("#"+o.publishTime+" .txt_dia").click(function(){room.setDialog(null,$(this).attr("uid"),$(this).find("label").text(),0,$(this).attr("utype"))}),$("#"+o.publishTime+" .approve button").click(function(){var t=[],e=[],i=$(this).parents("div");t.push(i.attr("id")),e.push(i.attr("fuId")),room.socket.emit("approvalMsg",{fromUser:room.userInfo,status:$(this).attr("btnType"),publishTimeArr:t,fuIdArr:e})}),this.removeTalkMsg(o.publishTime)},removeTalkMsg:function(t){-1==t.indexOf("_ms")&&$("#"+t+" p .close").click(function(){if(confirm("确定删除该记录？")){var e={publishTimeArr:[t],groupId:room.userInfo.groupId};common.getJson("/admin/removeMsg",{data:JSON.stringify(e)},function(t){null!=t&&t.isOK?room.showTipBox("删除聊天记录成功！"):room.showTipBox("删除聊天记录失败！")})}})},openDiaLog:function(t){$(".dialogbtn").not(t).hide(),t.css("left","0");var e=t.parent();if(common.isValid(e.attr("utype"))){var i=0===e.next().size(),o=$("#userListId li").size();if(t.parent().hasClass("analyst"))t.css("top",i?"-67px":"53px");else if(1==o&&e.is("ul"))$("#userListId").css("margin-bottom","55px"),t.css("top","0px");else if(e.is("div")){var s=t.find("a").size();3===s?t.css({top:i?"-90px":"35px",left:"5px"}):4===s?t.css({top:i?"-120px":"10px",left:"5px"}):t.css({top:i?"-60px":"35px",left:"5px"})}else $("#userListId").css("margin-bottom","25px"),t.css("top",i?"12px":"39px")}return t.is(":hidden")?(t.show(),void("true"!=t.attr("sk")&&t.attr("sk","true").find("a").click(function(){var t=$(this).parent(),e="",i=$(this).attr("t");if("2"==i){i=0;var o=t.prev().find("span[contt='a']"),s=o.find("a[data-lightbox]").html();common.isValid(s)&&o.find("span:last").html(s),e=o.html()}room.setDialog(t.attr("cg"),t.attr("uId"),t.attr("nk"),i,t.attr("utype"),t.attr("tm"),e),t.hide()}))):(t.hide(),!1)},formatContentHtml:function(t,e,i){var o="dialog ",s="",r="",a="",n="",l="uname ",m="false",u=t.fromUser,d=t.content,c=u.nickname,p=u.toUser,h="";p&&common.isValid(p.userId)&&(h='<span class="txt_dia" uid="'+p.userId+'" utype="'+p.userType+'">@<label>'+p.nickname+"</label></span>",room.userInfo.userId==p.userId&&(m="true")),s=d.value,room.userInfo.userId==u.userId?(e&&(u.publishTime=t.uiId,a='<em class="img-loading"></em>',r='<span class="shadow-box"></span><s class="shadow-conut"></s>'),o+="mine",c="我",m="true"):(2==u.userType&&(o+="analyst"),
1==u.userType&&(o+="admin"),3==u.userType&&(o+="cs"),n=room.getDialogHtml(u.clientGroup,u.userId,c,u.userType,u.isMobile,!0),!i&&p&&room.userInfo.userId==p.userId&&room.setTalkTop(!0,t));var g="";d.msgType==room.msgType.img?(g='style="display:block;max-width:150px;"',s=d.needMax?"<span "+g+'><a href="/admin/getBigImg?publishTime='+u.publishTime+"&userId="+u.userId+'" data-lightbox="dialog-img"><img src="'+d.value+'" alt="图片"/></a>'+r+"</span>":"<span "+g+'><a href="'+d.value+'" class="min_img" data-lightbox="dialog-img"><img src="'+d.value+'" alt="图片" /></a>'+r+"</span>",s+=a):s=d.value;var f='<div class="'+o+'" id="'+u.publishTime+'" isMe="'+m+'" utype="'+u.userType+'" mType="'+d.msgType+'" t="header"><a href="javascript:" class="headimg" uId="'+u.userId+'">'+room.getUserAImgCls(u.clientGroup,u.userType,u.avatar)+'</a><i></i><p><a href="javascript:"  class="'+l+'">'+c+'</a><span class="dtime">'+room.formatPublishTime(u.publishTime)+'</span><a href="javascript:void(0);" class="close"></a>';return 0==d.status&&(f+='<span class="approve"><input type="checkbox"/><button btnType="1">通过</button><button btnType="2">拒绝</button></span>',$("#approveAllHandler").show()),f+=p&&common.isValid(p.question)?'<span class="dcont"><span uid="'+p.userId+'" utype="'+p.userType+'">'+p.nickname+'</span>提问：<span contt="q">'+p.question+'</span><span class="dialog_reply">回复：<span contt="a">'+s+"</span></span>":'<span class="dcont" contt="a">'+h+s+"</span>",f+="</span></p>"+n+"</div>"},formatMsgToLink:function(t){$("#"+t+' span[contt]:contains("http:"),#'+t+' span[contt]:contains("https:")').each(function(t,e){var i=$(e).html(),o=i.split(/<img[^>]*>|<a[^>]*>.*?<\/a>/g),s="";for(var r in o)if(s=o[r],!common.isBlank(s)){var a=s.replace(/(http:\/\/|https:\/\/)((\w|=|\?|\.|\/|\\&|-)+)(:\d+)?(\/|\S)+/g,function(t){return'<a href="'+t+'" target="_blank" style="color:#3181c6;">'+t+"</a>"});e.innerHTML=e.innerHTML.replace(s,a)}})},removeLoadDom:function(t){$("#"+t+" .img-loading,#"+t+" .img-load-gan,#"+t+" .shadow-box,#"+t+" .shadow-conut").remove()},getUserAImgCls:function(t,e,i){var o="";return e&&0!=e&&common.isValid(i)?'<img src="'+i+'">':(o="vip"==t?"user_v":"active"==t||"notActive"==t?"user_r":"simulate"==t?"user_d":"register"==t?"user_m":"user_c",'<img src="/admin/img/'+o+'.png">')},getDialogHtml:function(t,e,i,o,s,r){if(room.userInfo.userId!=e&&-1==room.userInfo.userId.indexOf("visitor_")){var a=$("#groupInfoId"),n=[],l="d2";return n.push('<div class="dialogbtn" style="display:none;" cg="'+t+'" nk="'+i+'" uId="'+e+'" utype="'+o+'">'),n.push('<a href="javascript:" class="d1" t="0"><span>@TA</span></a>'),"true"==a.attr("aw")&&common.containSplitStr(a.attr("awr"),room.userInfo.userType)&&(l=0>=o||r?"d1":"d2",n.push('<a href="javascript:" class="'+l+'" t="1"><span>私聊</span></a>')),r&&(l=0>=o?"d1":"d2",n.push('<a href="javascript:" class="'+l+'" t="2"><span>回复</span></a>')),0>=o&&n.push('<a href="javascript:" class="d3" t="3"><span>禁言</span></a>'),n.length>1?n.join("")+"</div>":""}return'<div class="dialogbtn" style="display:none;" cg="'+t+'" nk="'+i+'" uId="'+e+'" utype="'+o+'"></div>'},getOnlineUserDom:function(t){var e={notActive:"(N)",active:"(A)"},i=room.getDialogHtml(t.clientGroup,t.userId,t.nickname,t.userType,t.isMobile,!1),o="",s=t.sequence,r=common.isBlank(e[t.clientGroup])?"":e[t.clientGroup],a=t.isMobile?'<em class="mb-cls">(mb)'+r+"</em>":'<em class="mb-cls">'+r+"</em>";return room.userInfo.userId==t.userId&&(o="【我】",s=0),{isMe:common.isValid(o),hasDg:common.isValid(i),dom:'<li id="'+t.userId+'" t="'+s+'" utype="'+t.userType+'"  ismb="'+t.isMobile+'">'+i+'<a href="javascript:" t="header" class="uname"><div class="headimg">'+room.getUserAImgCls(t.clientGroup,t.userType,t.avatar)+'</div><label class="nk-lb">'+t.nickname+o+"</label>"+a+"</a></li>"}},setOnlineUser:function(t){2==t.userType&&($(".teacher .te_l").attr("uid",t.userId),$(".teacher .te_l img").attr("src",t.avatar),$(".teacher .te_l div span").text(t.nickname),$(".teacher .btn").removeClass("dn")),$("#userListId li[id='"+t.userId+"']").remove();var e=$("#userListId li"),i=this.getOnlineUserDom(t),o=i.dom;if(0==e.length)$("#userListId").append(o);else if(i.isMe)e.first().before(o);else{var s=!1,r=0,a="";e.each(function(){return r=parseInt($(this).attr("t")),t.sequence<r?($(this).before(o),s=!0,!1):t.sequence==r&&(a=$(this).find("a").text(),t.nickname<=a)?($(this).before(o),s=!0,!1):void 0}),s||$("#userListId").append(o)}return i.hasDg&&this.setUserListClick($("#userListId li[id="+t.userId+"] a[t=header]")),!0},setUserListClick:function(t){t.click(function(){if("0"==$(this).parent().attr("t"))$("#userListId li").removeClass("zin"),$(".dialogbtn").hide();else{var t=$(this).parent();$(".dialogbtn").hide(),$("#userListId li").removeClass("zin"),t.addClass("zin"),room.openDiaLog($(this).prev()),$(".dialogbtn",$(this).parent()).css("left","7px")}}).dblclick(function(){$(this).prev(".dialogbtn").find("a[t=1]").trigger("click")})},leaveRoomTip:function(t){if("visitor"!=room.userInfo.clientGroup){var e="";"roomClose"==t&&(e="房间已停用，"),"otherLogin"==t&&(e="您的账号已在其他地方进入该房间，"),"forcedOut"==t&&(e="您已被管理员强制退出房间，"),$("#tipMsgBox").fadeIn(0).delay(6e3).fadeOut(200).find("span").text("注意："+e+"正自动退出....."),window.setTimeout(function(){window.close()},3e3)}},setSocket:function(){this.socket=common.getSocket(io,this.socketUrl,this.userInfo.groupType),this.socket.on("connect",function(){console.log("connected to server!"),room.userInfo.socketId=room.socket.id;var t=$("#groupInfoId");room.socket.emit("login",{userInfo:room.userInfo,lastPublishTime:$("#content_ul li:last").attr("id"),fUserTypeStr:t.attr("awr"),allowWhisper:t.attr("aw")}),$(".img-loading[pf=chatMessage]").show()}),this.socket.on("onlineUserList",function(t,e){$("#userListId").html("");var i=null,o=[];for(var s in t)i=t[s],2==i.userType?room.setOnlineUser(i):o.push(room.getOnlineUserDom(i).dom);$("#userListId").append(o.join("")),room.setUserListClick($("#userListId li a[t=header]")),$("#onLineSizeNum").text($("#userListId li").length),room.setListScroll(".user_box")}),this.socket.on("disconnect",function(t){console.log("disconnect")}),this.socket.on("error",function(t){console.error("e:"+t)}),this.socket.on("sendMsg",function(t){if(common.isBlank(t.fromUser.toUser)||1!=t.fromUser.toUser.talkStyle){if(!t.serverSuccess&&room.userInfo.userId==t.fromUser.userId&&!t.rule)return;room.setContent(t,!1,!1)}else room.setWhContent(t,!1,!1),room.userInfo.userId!=t.fromUser.userId&&(room.setTaskBarNotice(t),room.setDesktopNotice(t))}),this.socket.on("notice",function(t){switch(t.type){case"onlineNum":var e=t.data,i=e.onlineUserInfo;if(e.online)room.setOnlineUser(i);else if(room.userInfo.userId!=i.userId&&($("#userListId #"+i.userId).remove(),room.setListScroll(".user_box")),2==i.userType){var o=$(".teacher .te_l[uid="+i.userId+"]");o.find("img").attr("src",""),o.find("div span").text("老师暂未上线")}$("#onLineSizeNum").text($("#userListId li").length),room.setWhOnlineTip(i.userId,e.online,i);break;case"removeMsg":$("#"+t.data.replace(/,/g,",#")).remove(),room.setTalkListScroll();break;case"leaveRoom":room.leaveRoomTip(t.flag);break;case"approvalResult":var e=t.data;if(e.fromUserId==room.userInfo.userId)if(e.isOK){var s=e.publishTimeArr;if(2==e.status){for(var r in s)$("#"+s[r]).remove();room.setTalkListScroll()}else for(var r in s)$("#"+s[r]+" .approve").remove();$("#approveCheckAll").prop("checked",!1),0==$("#dialog_list .approve").size()&&$("#approveAllHandler").hide()}else alert("操作出现异常，请重新执行！");else if(e.refuseMsg){var s=e.publishTimeArr;for(var r in s)$("#"+s[r]).remove();room.setTalkListScroll()}else{for(var r in e)room.formatUserToContent(e[r]);room.setTalkListScroll(!0)}}}),this.socket.on("loadMsg",function(t){$(".img-loading[pf=chatMessage]").hide();var e=t.msgData,i=t.isAdd;if(i||$("#content_ul").html(""),e&&$.isArray(e)){e.reverse();for(var o in e){var s=e[o];s.content.status=s.status,room.formatUserToContent(s)}room.setTalkListScroll(!0)}}),this.socket.on("loadWhMsg",function(t){var e=t.data;if("offline"==t.type){if(e&&!$.isEmptyObject(e)){var i="";for(var o in e)i=o,room.setWhVisitors(e[o].userType,e[o].clientGroup,o,e[o].nickname,$("#userListId li[id='"+o+"']").length>0)}}else if(e&&$.isArray(e)){var s=0,r=null;e.reverse();for(var a in e)r=e[a],room.formatUserToContent(r,!0,t.toUserId),r.content.msgType==room.msgType.img&&s++;room.setTalkListScroll(!0,$("#wh_msg_"+t.toUserId+" .wh-content"),"dark")}})},formatUserToContent:function(t,e,i){var o={userId:t.userId,nickname:t.nickname,avatar:t.avatar,userType:t.userType,groupId:t.groupId,clientGroup:t.clientGroup,publishTime:t.publishTime,toUser:t.toUser,avatar:t.avatar};e?(o.toWhUserId=i,room.setWhContent({fromUser:o,content:t.content},!1,!0)):room.setContent({fromUser:o,content:t.content},!1,!0)},hideMsg:function(){$("#popMsgBox").is(":visible")&&$("#popMsgBox").fadeOut("normal","swing",function(){$(".blackbg").hide()})},showTipBox:function(t){$(".tipsbox").fadeIn().delay(1e3).fadeOut(200).find(".cont").text(t)},showMsg:function(t){"string"==typeof t&&(t={msg:t}),t=$.extend({closeable:!0,title:"",msg:"",modal:!0,delay:0,btns:[{txt:"确定",fn:function(){room.hideMsg()}}]},t),$("#popMsgTit").text(t.title||""),$("#popMsgTxt").html(t.msg);var e=$("#popMsgCont");e.find("a.yesbtn").remove();for(var i=null,o=null,s=0,r=t.btns?t.btns.length:0;r>s;s++)i=t.btns[s],o=$('<a class="yesbtn" href="javascript:void(0)">'+i.txt+"</a>"),e.append(o),o.click(i.fn);t.closeable?$("#popMsgClo").show():$("#popMsgClo").hide(),$("#popMsgBox").show(),t.modal&&$(".blackbg").show(),t.delay&&window.setTimeout(function(){room.hideMsg()},t.delay)},publishViewPoint:function(){var t=$("#title").val(),e=$("#publishStartDateStr").val(),i=$("#publishEndDateStr").val(),o=$("#content").val();if(common.isBlank(t))return void room.showTipBox("请输入标题");if(common.isBlank(e))return void room.showTipBox("请输入发布开始时间");if(common.isBlank(i))return void room.showTipBox("请输入发布结束时间");if(common.isBlank(o))return void room.showTipBox("请输入需要发布的内容!");var s={category:"trade_strategy_article",platform:room.userInfo.groupId,publishStartDate:e,publishEndDate:i,mediaUrl:"",mediaImgUrl:"",linkUrl:"",detailList:[{lang:"zh",title:t,content:o,authorInfo:{userId:room.userInfo.userId,name:room.userInfo.nickname,avatar:room.userInfo.avatar,position:room.userInfo.position}}]};common.getJson("/admin/addArticle",{data:JSON.stringify(s)},function(t){t.isOK?t.id>0?(room.showTipBox("观点发布成功！"),$(".right-teacher .publish-point .publish-close").click(),$('.right-teacher .publish-point input[type="text"],.right-teacher .publish-point textarea').val("")):room.showTipBox("观点发布失败！"):room.showTipBox(t.msg),$(".publish-point .publish-btn").removeAttr("disabled")})},initGagDate:function(){var t=room.getUserGagData();$("#userGag_gagDate_div").empty();var e=common.formatterDate(new Date,"-");common.getJson("/admin/getUserGag",{data:JSON.stringify(t.set)},function(t){if(t){var i=t.gagDate;i=common.isBlank(i)?{beginDate:e,endDate:e,weekTime:[{week:"",beginTime:"00:00:00",endTime:"23:59:59"}]}:JSON.parse(i),$("#userGag_gagDate_div").dateTimeWeek({data:i}),$("#userGagForm input[name=gagTips]").val(t.gagTips),$("#userGagForm input[name=gagRemark]").val(t.gagRemark)}else{var i={beginDate:e,endDate:e,weekTime:[{week:"",beginTime:"00:00:00",endTime:"23:59:59"}]};$("#userGag_gagDate_div").dateTimeWeek({data:i})}})},getUserGagData:function(){$("#userGag_gagDate").val($("#userGag_gagDate_div").dateTimeWeek("getData"));var t=$.trim($("#userGag_gagDate").val()),e=$.trim($("#userGagForm input[name=groupType]").val()),i=$.trim($("#userGagForm input[name=memberId]").val()),o=$.trim($("#userGagForm input[name=groupId]").val()),s=$.trim($("#userGagForm input[name=gagTips]").val()),r=$.trim($("#userGagForm input[name=gagRemark]").val()),a={groupType:e,groupId:o,userId:i,gagDate:t,gagTips:s,gagRemark:r},n=0==$.trim($("#userGagForm input[name=utype]").val())?!1:!0;return{set:a,visitor:n}},setUserGag:function(t,e){common.getJson("/admin/setUserGag",{data:JSON.stringify(t),isvisitor:e},function(t){e?$("#userListId li div.dialogbtn").hide():$(".not-talk").addClass("dn"),t.isOK?room.showTipBox("设置禁言成功！"):room.showTipBox("设置禁言失败："+t.msg)})},setDesktopNotice:function(t){if(room.nwWin&&room.nwIsMinimize)try{room.nwTray.tooltip=room.roomName,this.desktopNotice?this.desktopNotice.update({type:"info",text:t.fromUser.nickname+"："+t.content.value,icon:t.fromUser.avatar}):(PNotify.desktop.permission(),this.desktopNotice=new PNotify({title:"新消息",text:t.fromUser.nickname+"："+t.content.value,desktop:{desktop:!0,icon:t.fromUser.avatar}}),this.desktopNotice.get().click(function(e){$(".visitorDiv ul li[uid="+t.fromUser.userId+"]").click(),room.nwWin.setAlwaysOnTop(!0),room.nwWin.show(),room.nwWin.setAlwaysOnTop(!1)}))}catch(e){console.log(e.message)}},setTaskBarNotice:function(t){room.nwWin&&!room.nwIsMinimize?(room.nwWin.focus(),room.nwWin.blur(),room.nwIsMinimize=!1):room.rmWin&&room.rmWin.open&&!room.rmWin.closed&&room.rmWin.focus()},tipSound:function(){if(!store.enabled)return void console.log("Local storage is not supported by your browser.");var t=$("#tipsound")[0];room.tipSoundObj.storageObj=store.get(room.tipSoundObj.key),common.isBlank(room.tipSoundObj.storageObj)||"on"==room.tipSoundObj.storageObj.turn&&t.play()},getArticleList:function(t,e,i,o,s,r,a,n){try{$.getJSON("/admin/getArticleList",{authorId:common.trim(a),code:t,platform:e,hasContent:i,pageNo:o,pageSize:s,orderByStr:r},function(t){n(t)})}catch(l){console.error("getArticleList->"+l),n(null)}},teacherPointEdit:function(t,e,i){$(t).click(function(){var t=$(this).parent().children("h4").hide(),e=t.text();t.after('<input type="text" name="title" class="edit-title" value="'+e+'" />'),$(this).parent().children("div").removeClass("dn");var i=$(this).parent().children("p").hide(),o=i.text();i.after('<textarea name="content">'+o+"</textarea>"),$(this).parent().children("input[type=button]").removeClass("dn"),$(this).addClass("dn"),room.setListScroll(".point-list .point-list-content ul",{scrollbarPosition:"outside"})}),$(e).click(function(){var t=$(this).parent().children('input[name="_id"]').val(),e=$(this).parent().children('input[name="title"]').val(),i=$(this).parent().find("input[name=publishStartDateStr]").val(),o=$(this).parent().find("input[name=publishEndDateStr]").val(),s=$(this).parent().children("textarea[name=content]").val(),r=$(this).next("input.cancel-btn");if(common.isBlank(e))return void room.showMsg({closeable:!1,msg:"标题不能为空",btns:[{txt:"确定",fn:function(){room.hideMsg()}}]});if(common.isBlank(i))return void room.showMsg({closeable:!1,msg:"发布开始时间不能为空",btns:[{txt:"确定",fn:function(){room.hideMsg()}}]});if(common.isBlank(o))return void room.showMsg({closeable:!1,msg:"发布结束时间为空",btns:[{txt:"确定",fn:function(){room.hideMsg()}}]});if(common.isBlank(s))return void room.showMsg({closeable:!1,msg:"内容不能为空",btns:[{txt:"确定",fn:function(){room.hideMsg()}}]});var a={publishStartDate:i,publishEndDate:o,title:e,content:s},n={_id:t,lang:"zh"};common.getJson("/admin/modifyArticle",{data:JSON.stringify(a),where:JSON.stringify(n)},function(t){t.isOK?(room.showTipBox("观点更新成功！"),r.click()):room.showTipBox("观点更新失败："+t.msg)})}),$(i).click(function(){var t=$(this).parent().children('input[name="title"]').val();$(this).parent().children("h4").show().html(t),$(this).parent().children("input[type!=button]").hide();var e=$(this).parent().children("textarea").hide().val();$(this).parent().children("div").addClass("dn"),$(this).parent().children("p").html(e).show(),$(this).parent().children("input[type=button]").addClass("dn"),$(this).parent().children("input.edit-btn").removeClass("dn"),room.setListScroll(".point-list .point-list-content ul",{scrollbarPosition:"outside"})})},searchUser:function(t){if(common.isValid(t)){$("#userListId li").hide();var e=$('#userListId li .uname label:contains("'+t+'")');$.each(e,function(t,e){$(e).parent().parent().show()})}else $("#userListId li").show()},getWhHistory:function(){return store.enabled?store.get(room.whHistoryUserObj.key+"_"+room.userInfo.groupId):void console.log("Local storage is not supported by your browser.")},setWhHistory:function(t){if(!store.enabled)return void console.log("Local storage is not supported by your browser.");if(room.whHistoryUserObj.whUserList=room.getWhHistory(),$.isArray(room.whHistoryUserObj.whUserList)||(room.whHistoryUserObj.whUserList=[]),t){var e={};room.userInfo.userId==t.fromUser.userId?(e.userId=t.fromUser.toUser.userId,e.utype=t.fromUser.toUser.userType,e.nk=t.fromUser.toUser.nickname,e.dt=common.formatterDateTime(parseInt(t.uiId.replace(/_\d*$/,""),10),"-")):(e.userId=t.fromUser.userId,e.utype=t.fromUser.userType,e.nk=t.fromUser.nickname,e.dt=common.formatterDateTime(parseInt(t.fromUser.publishTime.replace(/_\d*$/,""),10),"-")),e.cg=t.fromUser.clientGroup,e.value=t.content.value,t.content.msgType==room.msgType.img&&(e.value="[图片]");var i=room.whHistoryUserObj.whUserList.length;if(i>0){for(var o=0;i>o;o++){var s=room.whHistoryUserObj.whUserList[o];if(s.userId==e.userId&&(room.whHistoryUserObj.whUserList[o]={}),common.isBlank(s.userId))break}room.whHistoryUserObj.whUserList.unshift(e),i>50&&room.whHistoryUserObj.whUserList.splice(50,i-50),store.set(room.whHistoryUserObj.key+"_"+room.userInfo.groupId,room.whHistoryUserObj.whUserList)}}},fillWhHistory:function(){room.whHistoryUserObj.whUserList=room.getWhHistory();var t="",e=room.formatHtml("whHistory");if($.isArray(room.whHistoryUserObj.whUserList))$.each(room.whHistoryUserObj.whUserList,function(i,o){if(common.isValid(o.userId)){var s=o.dt.substring(5,16);t+=e.formatStr(o.userId,$("#userListId li[id='"+o.userId+"']").length>0?"":' class="off"',o.utype,o.nk,s,o.value)}}),room.setWhHistoryHtml(t);else{var i={groupType:room.userInfo.groupType,groupId:room.userInfo.groupId,userId:room.userInfo.userId};common.getJson("/admin/getLastTwoDaysMsg",{data:JSON.stringify(i)},function(i){i&&($.each(i,function(i,o){var s=common.formatterDateTime(parseInt(o.value.publishTime.replace(/_\d*$/,""),10),"-").substring(5,16),r="",a="",n=0;o.value.userId==room.userInfo.userId?(r=o.value.toUser.nickname,a=o.value.toUser.userId,n=o.value.toUser.userType):(r=o.value.nickname,a=o.value.userId,n=o.value.userType),t+=e.formatStr(a,$("#userListId li[id='"+a+"']").length>0?"":' class="off"',n,r,s,o.value.content.msgType==room.msgType.img?"[图片]":o.value.content.value)}),room.setWhHistoryHtml(t))})}},setWhHistoryHtml:function(t){$(".wh-history .wh_tab_history_div .wh_tab_history_ul").html(t),$(".wh-history .wh_tab_history_div .wh_tab_history_ul li").click(function(){return room.setWhVisitors($(this).attr("utype"),$(this).attr("cg"),$(this).attr("uid"),$(this).find("label:first").text(),!$(this).hasClass("off")),$(".visitorDiv .wh_tab_ul li[uid="+$(this).attr("uid")+"]").click(),$(".wh_tab_history_div").addClass("dn"),!1}),room.setListScroll($(".wh-history .wh_tab_history_div .wh_tab_history_list"))},widthCheck:function(t){var e=$(window).width();e>1680&&($("body").attr("class",""),$("body").addClass("wid1")),1680>=e&&e>1480&&($("body").attr("class",""),$("body").addClass("wid2")),1480>=e&&e>=1280&&($("body").attr("class",""),$("body").addClass("wid3")),1280>e&&($("body").attr("class",""),$("body").addClass("wid4")),$(".open_wh_box").is(":hidden")||t?$('.visitorDiv ul li[uid="public"]').hasClass("on")?$(".local_box .wh-middle").width(e-425):$(".local_box .wh-middle").width(e-210):$(".open_wh_box .wh-middle").width($(".open_wh_box").width()-210)},heightCalcu:function(t){var e=".local_box",i=$(window).height(),o=130,s=95;$(".open_wh_box").is(":hidden")||t?($(".onlineSearch").hasClass("dn")?$(".user_box").height(i-180).css("max-height",i-180+"px"):$(".user_box").height(i-205).css("max-height",i-205+"px"),$(".right-teacher").height(i-10),$(".wh_tab_history_div").css({top:"75px"})):(s=20,$(".wh_tab_history_div").css({top:"27px"}),i=$(".open_wh_box").height()-25,e=".open_wh_box",o=60),$(e+" .wh-left,"+e+" .wh-middle").height(i-10),$(e+" .visitorDiv .wh_tab_div").height($(e+" .wh-left").height()-o),$(e+" .visitorDiv .wh_tab_history_list").height($(e+" .wh-left").height()-s),$(e+" .wh-tab-msg").height(i-80),$(e+" .wh-content").height(i-230)},formatHtml:function(t){var e=[];switch(t){case"point-list":e.push("<li{0}>"),e.push('    <input type="hidden" name="_id" value="{1}" />'),e.push("    <h4>{2}</h4>"),e.push('    <div class="dn">'),e.push('        从<input type="text" name="publishStartDateStr" id="publishStartDateStr_{1}" class="date" onfocus="WdatePicker({maxDate:\'#F{$dp.$D(\\\'publishEndDateStr_{1}\\\')}\',dateFmt:\'yyyy-MM-dd HH:mm:ss\'})" value="{3}" />'),e.push('        到<input type="text" name="publishEndDateStr" id="publishEndDateStr_{1}" class="date" onfocus="WdatePicker({minDate:\'#F{$dp.$D(\\\'publishStartDateStr_{1}\\\')}\',dateFmt:\'yyyy-MM-dd HH:mm:ss\'})" value="{4}" />'),e.push("    </div>"),e.push("     <p>{5}</p>"),e.push('     <input type="button" value="编辑" class="edit-btn" />'),e.push('     <input type="button" value="提交" class="save-btn dn" />'),e.push('     <input type="button" value="取消" class="cancel-btn dn" />'),e.push("</li>");break;case"whHistory":e.push('<li uid="{0}"{1} utype="{2}"><span class="user-row"><label>{3}</label><label>{4}</label></span><span class="user-msg">{5}</span></li>')}return e.join("")}};$(function(){room.init()});